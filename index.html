<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroTik Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* GLOBÁLNY ZÁKAZ VŠETKÝCH ANIMÁCIÍ A HOVER EFEKTOV NA KARTÁCH */
        * {
            --tw-scale-x: 1 !important;
            --tw-scale-y: 1 !important;
        }
        
        /* Zakázať všetky možné transform efekty - ale NIE na tlačidlách */
        .card:not(.btn),
        .card *:not(.btn),
        .p-6:not(.btn),
        .rounded-lg:not(.btn),
        [class*="card"]:not(.btn) {
            transform: none !important;
            scale: 1 !important;
            transition: none !important;
            animation: none !important;
        }
        
        /* Zrušiť všetky hover efekty - ale NIE na tlačidlách */
        .card:hover:not(.btn),
        .card:focus:not(.btn),
        .card:active:not(.btn),
        .card *:hover:not(.btn),
        .card *:focus:not(.btn),
        .card *:active:not(.btn) {
            transform: none !important;
            scale: 1 !important;
            transition: none !important;
            animation: none !important;
        }
        
        :root { 
            --main-bg: #111827; --card-bg: #1f2937; --border-color: #374151; 
            --text-color: #d1d5db; --accent-color: #38bdf8; --accent-color-hover: #0ea5e9;
        }
        body { background-color: var(--main-bg); color: var(--text-color); font-family: 'Inter', sans-serif; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); transition: all 0.3s ease; }
        /* ÚPLNE zakázané hover efekty na kartách - žiadne animácie */
        .card {
            transition: none !important;
        }
        
        .card:hover {
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.1) !important;
            border-color: rgba(56, 189, 248, 0.3) !important;
            transform: none !important;
            transition: none !important;
            animation: none !important;
        }
        
        /* Úplný zákaz scale/transform animácií na kartách (NIE na tlačidlách) */
        .card:not(.btn),
        .card *:not(.btn),
        .card:hover:not(.btn),
        .card:focus:not(.btn),
        .card:active:not(.btn) {
            transform: none !important;
            scale: none !important;
            animation: none !important;
            transition: none !important;
        }
        
        /* Ale POVOLENÉ hover efekty na tlačidlách v kartách */
        .card .btn {
            font-weight: 600 !important;
            letter-spacing: 0.025em !important;
            /* Len jednoduché hover efekty bez fancy shadow */
        }
        
        .card .btn:hover {
            /* Animácia zo starej verzie - presne ako bola */
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Disabled stav pre tlačidlá */
        .card .btn:disabled {
            opacity: 0.6 !important;
            cursor: not-allowed !important;
        }
        
        /* GLOBÁLNE pravidlá pre všetky tlačidlá - ako v starej verzii */
        .btn { 
            transition: all 0.2s ease-in-out; 
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Zakázať hover efekty počas refresh operácií */
        .card.refreshing:hover { box-shadow: none !important; border-color: var(--border-color) !important; transform: none !important; }
        body.refreshing .card:hover { box-shadow: none !important; border-color: var(--border-color) !important; transform: none !important; }
        
        /* Zakázať transitions len na kartách (NIE na tlačidlách) počas refresh */
        body.refreshing .card:not(.btn) {
            transition: none !important;
            animation: none !important;
        }
        
        /* Zakázať hover animácie pre tlačidlá počas refresh operácií */
        body.refreshing .btn:hover {
            transform: none !important;
            box-shadow: none !important;
            transition-duration: 0s !important;
        }
        
        /* Základné pravidlá pre tlačidlá */
        .btn { transition: all 0.2s ease-in-out; }
        .btn-primary { background-color: var(--accent-color); color: #ffffff; }
        .btn-primary:hover { background-color: var(--accent-color-hover); }
        
        /* Hover animácie pre hlavné tlačidlá */
        #addDeviceBtn:hover, #backupAllBtn:hover, #stopAllBackupsBtn:hover, 
        #refreshAllSnmpBtn:hover, #snmpStatusBtn:hover, #monitoringBtn:hover, 
        #viewBackupsBtn:hover, #settingsBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Pridané: Line clamp pre konzistentné zobrazenie názvov zariadení */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Vlastná veľkosť písma pre tlačidlá zariadení - medzi xs a sm */
        .device-btn-text {
            font-size: 0.8125rem !important; /* 13px - medzi text-xs (12px) a text-sm (14px) */
        }
        .device-btn-icon {
            font-size: 0.8125rem !important; /* 13px - rovnaká veľkosť pre ikony */
        }
        
        /* Animácie pre svetlú tému */
        body.light-theme .btn:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        
        /* Zakázať hover animácie pre tlačidlá počas refresh operácií - svetlá téma */
        body.light-theme.refreshing .btn:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Zakázať hover efekty na kartách počas refresh operácií - svetlá téma */
        body.light-theme.refreshing .card:hover {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Zakázať všetky transitions v svetlej téme počas refresh */
        body.light-theme.refreshing .card,
        body.light-theme.refreshing .card *,
        body.light-theme.refreshing .btn,
        body.light-theme.refreshing .btn * {
            transition: none !important;
            animation: none !important;
        }
        
        /* Globálne potlačenie animácií v svetlej téme počas refresh */
        body.light-theme.refreshing *,
        body.light-theme.refreshing *:before,
        body.light-theme.refreshing *:after {
            animation-duration: 0s !important;
            animation-delay: 0s !important;
            transition-duration: 0s !important;
            transition-delay: 0s !important;
            transform: none !important;
        }
        
        /* Extra potlačenie pre svetlú tému */
        body.light-theme.refreshing .card,
        body.light-theme.refreshing .card *,
        body.light-theme.refreshing .card:hover,
        body.light-theme.refreshing .card *:hover {
            transition: none !important;
            animation: none !important;
            transform: none !important;
            opacity: 1 !important;
        }
        .status-online { color: #4ade80; }
        .status-offline { color: #f87171; }
        .status-unknown { color: #9ca3af; }
        
        /* Stavy zariadení v svetlej téme - menej saturované farby */
        body.light-theme .status-online {
            color: #16a34a !important; /* Tmavšia, menej saturovaná zelená */
        }
        
        body.light-theme .status-offline {
            color: #dc2626 !important; /* Tmavšia, menej saturovaná červená */
        }
        
        body.light-theme .status-unknown {
            color: #6b7280 !important; /* Tmavšia sivá pre lepší kontrast */
        }
        .log-info { border-left-color: #38bdf8; }
        .log-success { border-left-color: #4ade80; }
        .log-warning { border-left-color: #facc15; }
        .log-error { border-left-color: #f87171; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }
        .modal-content { animation: modal-fade-in 0.3s ease-out; }
        @keyframes modal-fade-in { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: var(--card-bg); }
        .modal-content::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 10px; border: 2px solid var(--card-bg); }
        
        /* Posuvník pre logy aktivít - tmavé téma */
        #logsContainer::-webkit-scrollbar { width: 8px; }
        #logsContainer::-webkit-scrollbar-track { background: #1f2937; border-radius: 4px; }
        #logsContainer::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; border: 1px solid #374151; }
        #logsContainer::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }
        #logsModalContent { scrollbar-width: thin; scrollbar-color: #4b5563 #1f2937; overflow-x: hidden; }
        #logsModalContent::-webkit-scrollbar { width: 8px; }
        #logsModalContent::-webkit-scrollbar-track { background: #1f2937; border-radius: 4px; }
        #logsModalContent::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; border: 1px solid #374151; }
        #logsModalContent::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }
        #logsModalList { word-break: break-word; }
        .mobile-logs-container { overflow-x: hidden; }

        /* Custom Dropdown (shared with monitoring) */
        .custom-select {
            position: relative;
            width: 100%;
            user-select: none;
        }

        .custom-select.open {
            z-index: 1500;
        }

        @media (min-width: 1024px) {
            .custom-select.expand-desktop .custom-select-dropdown {
                right: auto;
                width: auto;
                min-width: max(20rem, 100%);
                max-width: min(34rem, calc(100vw - 6rem));
            }

            .custom-select.expand-desktop .custom-select-option {
                white-space: nowrap;
            }
        }

        .custom-select-button {
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.95) 0%, rgba(17, 24, 39, 0.95) 100%);
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #f8fafc;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.35);
            width: 100%;
            font-size: 0.75rem;
        }

        .custom-select-button:hover,
        .custom-select.open .custom-select-button {
            border-color: rgba(148, 163, 184, 0.7);
            box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.3), 0 0 14px rgba(148, 163, 184, 0.22), 0 18px 32px rgba(15, 23, 42, 0.24);
        }

        .custom-select-text {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            flex: 1 1 auto;
        }

        .custom-select-arrow {
            color: #94a3b8;
            transition: transform 0.2s ease;
            font-size: 0.8rem;
        }

        .custom-select.open .custom-select-arrow {
            transform: rotate(-180deg);
        }

        .custom-select-dropdown {
            position: absolute;
            top: calc(100% + 0.4rem);
            left: 0;
            right: 0;
            background: rgba(28, 40, 64, 0.955);
            border: 1px solid #374151;
            border-radius: 0.75rem;
            box-shadow: 0 24px 55px rgba(15, 23, 42, 0.45);
            padding: 0.35rem;
            display: none;
            max-height: 260px;
            overflow-y: auto;
            z-index: 1400;
        }

        .custom-select.open .custom-select-dropdown {
            display: block;
        }

        .custom-select-option {
            padding: 0.35rem 0.6rem;
            border-radius: 0.55rem;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .custom-select-option:hover {
            background: rgba(71, 85, 105, 0.45);
            color: #f8fafc;
            box-shadow: 0 0 8px rgba(71, 85, 105, 0.18);
        }

        .custom-select-option.selected {
            background: rgba(100, 116, 139, 0.45);
            color: #ffffff;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.4), 0 0 10px rgba(148, 163, 184, 0.16);
        }

        .custom-select-option.disabled {
            opacity: 0.5;
            cursor: default;
            pointer-events: none;
        }

        .custom-select-dropdown::-webkit-scrollbar {
            width: 8px;
        }

        .custom-select-dropdown::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.85);
            border-radius: 999px;
        }

        .custom-select-dropdown::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.65);
            border-radius: 999px;
        }

        .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(191, 219, 254, 0.85);
        }

        /* Light theme adjustments */
        body.light-theme .custom-select-button {
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            border-color: #cbd5e1;
            color: #1f2937;
            box-shadow: 0 10px 25px rgba(148, 163, 184, 0.25);
        }

        body.light-theme .custom-select-button:hover,
        body.light-theme .custom-select.open .custom-select-button {
            border-color: rgba(148, 163, 184, 0.7);
            box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.3), 0 0 14px rgba(148, 163, 184, 0.16), 0 12px 28px rgba(148, 163, 184, 0.22);
        }

        body.light-theme .custom-select-dropdown {
            background: rgba(248, 250, 252, 0.98);
            border-color: rgba(203, 213, 225, 0.8);
            box-shadow: 0 24px 55px rgba(15, 23, 42, 0.12);
        }

        body.light-theme .custom-select-option {
            color: #1e293b;
        }

        body.light-theme .custom-select-option:hover {
            background: rgba(148, 163, 184, 0.2);
            color: #1f2937;
            box-shadow: 0 0 8px rgba(148, 163, 184, 0.18);
        }

        body.light-theme .custom-select-option.selected {
            background: rgba(148, 163, 184, 0.25);
            color: #0f172a;
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.3), 0 0 10px rgba(148, 163, 184, 0.14);
        }

        body.modal-open {
            overflow: hidden;
        }

        #logsModal .modal-content {
            min-height: calc(100vh - 1rem);
        }

        @media (max-width: 640px) {
            #logsModal {
                padding: 0;
            }
            #logsModal .modal-content {
                min-height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
        }
        
        /* Štýly pre log filtre */
        .filter-level-btn, .filter-level-btn-mobile { 
            transition: all 0.2s ease; 
            border: 1px solid transparent;
        }
        .filter-level-btn.active, .filter-level-btn-mobile.active { 
            border-color: #38bdf8; 
            box-shadow: 0 0 5px rgba(56, 189, 248, 0.3);
        }
        .log-entry { 
            transition: opacity 0.2s ease; 
        }
        .log-entry.filtered { 
            display: none; 
        }
        
        .mr-84 { margin-right: 0; }
        .activity-log { width: 100%; }
        .activity-right { right: auto; }
        .main-content-wrapper { display: flex; gap: 2rem; align-items: flex-start; }
        .left-content { flex: 1; }
        .right-sidebar { width: 24rem; min-width: 20rem; }
        @media (max-width: 1400px) {
            .right-sidebar { width: 20rem; min-width: 18rem; }
        }
        @media (max-width: 1200px) {
            .right-sidebar { width: 18rem; min-width: 16rem; }
        }
        @media (max-width: 1024px) {
            .main-content-wrapper {
                flex-direction: column;
                min-height: calc(100vh - 140px);
            }
            .right-sidebar { display: none !important; }
            #mobileLogs {
                display: block !important;
                margin-top: auto;
            }
            #userStatus { text-align: right !important; }
            .left-content {
                width: 100%;
                display: flex;
                flex-direction: column;
                flex: 1 0 auto;
            }
            .left-content > .card {
                flex-shrink: 0;
            }
            #devicesGrid {
                flex: 1 0 auto;
                min-height: clamp(220px, 45vh, 520px);
            }
        }
        @media (min-width: 1025px) {
            #mobileLogs { display: none !important; }
        }
        header h1 {
            margin-left: -2rem;
            text-align: center;
        }
        @media (max-width: 768px) {
            header h1 {
                margin-left: 0;
            }
        }
        
        /* Tlačidlo prepínača témy */
        .theme-toggle {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-toggle:hover {
            border-color: var(--accent-color);
            background-color: rgba(56, 189, 248, 0.1);
        }
        
        /* Responsive nastavenia pre theme toggle */
        @media (max-width: 768px) {
            .theme-toggle {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }
        }
        
        /* Header responsive nastavenia */
        @media (max-width: 768px) {
            .flex.justify-between.items-center h1 {
                font-size: 1.125rem;
            }
            .flex.justify-between.items-center h1 .fas {
                font-size: 1rem;
            }
            .hidden.sm\\:inline {
                display: none !important;
            }
        }
        
        /* Action buttons responsive nastavenia */
        @media (max-width: 640px) {
            /* Zmena na grid layout pre mobilné zariadenia */
            .action-buttons-container {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
                width: 100%;
            }
            
            .action-buttons-container button {
                width: 100%;
                padding: 0.5rem 0.375rem;
                font-size: 0.75rem;
                text-align: center;
                justify-content: center;
                min-height: 2rem;
                flex-direction: row;
                gap: 0.375rem;
                align-items: center;
            }
            
            .action-buttons-container button i {
                font-size: 0.75rem;
                margin-right: 0;
                margin-bottom: 0;
            }
            
            /* Skryté tlačidlá sa nezapočítavajú do grid layoutu */
            .action-buttons-container button.hidden {
                display: none;
            }
            
        }
        
        /* Pre trochu väčšie mobilné zariadenia (do 768px) */
        @media (min-width: 641px) and (max-width: 768px) {
            .action-buttons-container {
                display: grid !important;
                grid-template-columns: 1fr 1fr 1fr;
                gap: 0.75rem;
            }
            
            .action-buttons-container button {
                width: 100%;
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
        }
        
        /* Pre veľké obrazovky zachováme flex layout */
        @media (min-width: 769px) {
            .action-buttons-container {
                display: flex !important;
                flex-wrap: wrap;
                gap: 0.75rem;
            }
        }

        /* Activity log resize capability */
        .right-sidebar .card.resize-y {
            resize: vertical;
            overflow: hidden;
        }
        
        .right-sidebar .card.resize-y::-webkit-resizer {
            background: var(--accent-color);
            border-radius: 0 0 8px 0;
        }

        /* Svetlá téma */
        body.light-theme {
            --main-bg: #f1f5f9;
            --card-bg: #f8fafc;
            --border-color: #cbd5e1;
            --text-color: #334155;
            --accent-color: #0369a1;
            --accent-color-hover: #0284c7;
        }
        
        /* Texty v svetlej téme */
        body.light-theme h1,
        body.light-theme h2,
        body.light-theme h3,
        body.light-theme .text-white {
            color: var(--text-color) !important;
        }
        
        body.light-theme .text-gray-400,
        body.light-theme .text-gray-300 {
            color: #64748b !important;
        }
        
        body.light-theme .text-gray-200 {
            color: var(--text-color) !important;
        }
        
        body.light-theme .text-sky-400,
        body.light-theme .text-sky-500 {
            color: var(--accent-color) !important;
        }
        
        /* Input fields a select v svetlej téme */
        body.light-theme input,
        body.light-theme select,
        body.light-theme textarea {
            background-color: #ffffff !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }
        
        body.light-theme input:focus,
        body.light-theme select:focus,
        body.light-theme textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1) !important;
        }
        
        /* Log entries v svetlej téme */
        body.light-theme .log-entry {
            background-color: #ffffff !important;
            color: var(--text-color) !important;
        }
        
        body.light-theme .log-entry strong {
            color: #64748b !important;
        }
        
        /* Filter buttons v svetlej téme */
        body.light-theme .filter-level-btn,
        body.light-theme .filter-level-btn-mobile {
            background-color: #e2e8f0 !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }
        
        body.light-theme .filter-level-btn:hover,
        body.light-theme .filter-level-btn-mobile:hover {
            background-color: #cbd5e1 !important;
        }
        
        body.light-theme .filter-level-btn.active,
        body.light-theme .filter-level-btn-mobile.active {
            background-color: var(--accent-color) !important;
            color: #ffffff !important;
        }
        
        /* Tlačidlá v svetlej téme */
        body.light-theme .btn {
            color: #ffffff !important;
        }
        
        body.light-theme .btn-primary {
            background-color: var(--accent-color) !important;
            color: #ffffff !important;
        }
        
        body.light-theme .btn-primary:hover {
            background-color: var(--accent-color-hover) !important;
        }
        
        body.light-theme .bg-green-600 {
            background-color: #16a34a !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-green-600:hover,
        body.light-theme .hover\:bg-green-700:hover {
            background-color: #15803d !important;
        }
        
        body.light-theme .bg-blue-600 {
            background-color: #2563eb !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-blue-600:hover,
        body.light-theme .hover\:bg-blue-700:hover {
            background-color: #1d4ed8 !important;
        }
        
        body.light-theme .bg-red-600 {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-red-600:hover,
        body.light-theme .hover\:bg-red-700:hover {
            background-color: #b91c1c !important;
        }
        
        body.light-theme .bg-purple-600 {
            background-color: #9333ea !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-purple-600:hover,
        body.light-theme .hover\:bg-purple-700:hover {
            background-color: #7c3aed !important;
        }
        
        body.light-theme .bg-orange-600 {
            background-color: #ea580c !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-orange-600:hover,
        body.light-theme .hover\:bg-orange-700:hover {
            background-color: #c2410c !important;
        }
        
        body.light-theme .bg-gray-600 {
            background-color: #4b5563 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-gray-600:hover,
        body.light-theme .hover\:bg-gray-700:hover {
            background-color: #374151 !important;
        }
        
        body.light-theme .bg-yellow-500 {
            background-color: #eab308 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-yellow-500:hover,
        body.light-theme .hover\:bg-yellow-600:hover {
            background-color: #ca8a04 !important;
        }
        
        body.light-theme .bg-teal-600 {
            background-color: #0d9488 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-teal-600:hover,
        body.light-theme .hover\:bg-teal-700:hover {
            background-color: #0f766e !important;
        }
        
        body.light-theme .theme-toggle {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme #logsContainer::-webkit-scrollbar-track {
            background: #f8fafc;
        }
        
        body.light-theme #logsContainer::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border: 1px solid #e2e8f0;
        }
        
        body.light-theme #logsContainer::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        body.light-theme #logsModalContent { scrollbar-color: #94a3b8 #f1f5f9; }
        body.light-theme #logsModalContent::-webkit-scrollbar-track {
            background: #f8fafc;
        }
        body.light-theme #logsModalContent::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border: 1px solid #e2e8f0;
        }
        body.light-theme #logsModalContent::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        
        body.light-theme .modal-content::-webkit-scrollbar-track {
            background: var(--card-bg);
        }
        
        body.light-theme .modal-content::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border: 2px solid var(--card-bg);
        }

        .modal-content.no-outer-scrollbar::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }

        .modal-content.no-outer-scrollbar {
            scrollbar-width: none;
        }

        /* Layout pre modál zariadenia */
        .device-modal-content {
            max-width: 1100px;
        }

        .device-form-scroll {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 0.25rem;
        }

        @media (min-width: 1024px) {
            .device-form-scroll {
                max-height: none;
                overflow-y: visible;
            }
        }
        
        /* Modálne okná v svetlej téme */
        body.light-theme .modal-content,
        body.light-theme #deviceModal .card,
        body.light-theme #settingsModal .card,
        body.light-theme #changePasswordModal .card,
        body.light-theme #manage2faModal .card,
        body.light-theme #confirmPasswordModal .card,
        body.light-theme #backupCodesModal .card,
        body.light-theme #snmpStatusModal .card {
            background-color: #ffffff !important;
            border-color: var(--border-color) !important;
        }
        
        /* 2FA modály - svetlý režim texty */
        body.light-theme #manage2faModal h2,
        body.light-theme #manage2faModal h3,
        body.light-theme #confirmPasswordModal h2,
        body.light-theme #backupCodesModal h2 {
            color: var(--text-color) !important;
        }
        
        body.light-theme #manage2faModal p,
        body.light-theme #manage2faModal span,
        body.light-theme #confirmPasswordModal p,
        body.light-theme #backupCodesModal p {
            color: var(--text-color) !important;
        }
        
        body.light-theme #manage2faModal .text-gray-400,
        body.light-theme #manage2faModal .text-gray-300,
        body.light-theme #confirmPasswordModal .text-gray-400 {
            color: #6b7280 !important;
        }
        
        body.light-theme #manage2faModal .bg-gray-800 {
            background-color: #f3f4f6 !important;
            border: 1px solid #d1d5db !important;
        }

        body.light-theme #logsModal .card {
            background-color: #ffffff !important;
            border-color: var(--border-color) !important;
        }

        body.light-theme #logsModal .bg-gray-900 {
            background-color: #f3f4f6 !important;
            color: var(--text-color) !important;
            border-color: #d1d5db !important;
        }
        
        body.light-theme #confirmPasswordModal input,
        body.light-theme #backupCodesModal input {
            background-color: #f9fafb !important;
            border-color: #d1d5db !important;
            color: var(--text-color) !important;
        }
        
        body.light-theme #backupCodesModal .backup-code {
            background-color: #f9fafb !important;
            border-color: #d1d5db !important;
            color: var(--text-color) !important;
        }
        
        /* Labels v svetlej téme */
        body.light-theme label {
            color: var(--text-color) !important;
        }
        
        /* Sekčné nadpisy v svetlej téme */
        body.light-theme h3.text-sky-400 {
            color: var(--accent-color) !important;
            border-bottom-color: var(--border-color) !important;
        }
        
        /* Malé texty a pomocné texty v svetlej téme */
        body.light-theme small.text-gray-400 {
            color: #64748b !important;
        }
        
        /* Hranice v svetlej téme */
        body.light-theme .border-gray-600,
        body.light-theme .border-gray-700 {
            border-color: var(--border-color) !important;
        }
        
        /* Tlačidlá X v modálnych oknách - tmavá téma (základná) */
        #closeSnmpStatusBtn.btn.bg-gray-600,
        #refreshSnmpStatusBtn.btn.bg-gray-600,
        #closeSettingsBtn.btn.bg-gray-600 {
            background-color: #4b5563 !important;
            color: #ffffff !important;
            border: 1px solid #6b7280 !important;
        }
        
        #closeSnmpStatusBtn.btn.bg-gray-600:hover,
        #refreshSnmpStatusBtn.btn.bg-gray-600:hover,
        #closeSettingsBtn.btn.bg-gray-600:hover {
            background-color: #374151 !important;
            color: #ffffff !important;
        }
        
        /* Tlačidlá X v modálnych oknách - svetlá téma */
        body.light-theme #closeSnmpStatusBtn.btn.bg-gray-600,
        body.light-theme #refreshSnmpStatusBtn.btn.bg-gray-600 {
            background-color: #e2e8f0 !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        body.light-theme #closeSnmpStatusBtn.btn.bg-gray-600:hover,
        body.light-theme #refreshSnmpStatusBtn.btn.bg-gray-600:hover {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        /* Password Toggle Styles - ONLY for Password Tab */
        #tabPasswordContent .password-input-container {
            position: relative;
        }
        
        #tabPasswordContent .password-toggle {
            /* Center the eye icon perfectly inside the input field height */
            position: absolute;
            top: 0;
            bottom: 0;
            right: 10px;
            margin: auto 0; /* vertical centering */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 2rem; /* click target size */
            cursor: pointer;
            color: #9ca3af;
            font-size: 18px; /* slightly larger for clarity */
            z-index: 10;
            transition: color 0.2s ease;
            line-height: 1; /* prevent extra vertical bias */
        }
        
        #tabPasswordContent .password-toggle:hover {
            color: #60a5fa;
        }
        
        body.light-theme #tabPasswordContent .password-toggle {
            color: #6b7280;
        }
        
        body.light-theme #tabPasswordContent .password-toggle:hover {
            color: #3b82f6;
        }
        
        /* Account Management Tabs */
        .account-tab {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .account-tab.active {
            color: #38bdf8 !important;
            border-color: #38bdf8 !important;
        }
        
        .tab-content {
            display: block;
        }
        
        .tab-content.hidden {
            display: none;
        }
        
        body.light-theme .account-tab {
            color: #64748b !important;
        }
        
        body.light-theme .account-tab.active {
            color: #0ea5e9 !important;
            border-color: #0ea5e9 !important;
        }
        
        body.light-theme .account-tab:hover {
            color: #0ea5e9 !important;
        }
        
        body.light-theme #closeSettingsBtn.btn.bg-gray-600 {
            background-color: #e2e8f0 !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        body.light-theme #closeSettingsBtn.btn.bg-gray-600:hover {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        /* Nastavenia tlačidlo - svetlá téma */
        body.light-theme #settingsBtn.bg-gray-600 {
            background-color: #64748b !important;
            color: #ffffff !important;
        }
        
        body.light-theme #settingsBtn.bg-gray-600:hover {
            background-color: #475569 !important;
        }
        
        /* Tlačidlo Zrušiť v modálnych oknách - svetlá téma */
        body.light-theme #cancelDeviceBtn,
        body.light-theme #cancelSettingsBtn,
        body.light-theme #cancelPasswordChangeBtn,
        body.light-theme #cancelUsernameChangeBtn,
        body.light-theme #cancelAccountManageBtn {
            background-color: #9ca3af !important;
            color: #ffffff !important;
        }
        
        body.light-theme #cancelDeviceBtn:hover,
        body.light-theme #cancelSettingsBtn:hover,
        body.light-theme #cancelPasswordChangeBtn:hover,
        body.light-theme #cancelUsernameChangeBtn:hover,
        body.light-theme #cancelAccountManageBtn:hover {
            background-color: #6b7280 !important;
        }
        
        /* SNMP modal obsah v svetlej téme */
        body.light-theme #snmpStatusContent,
        body.light-theme #snmpStatusContent div,
        body.light-theme #snmpStatusContent span {
            background-color: transparent !important;
            color: var(--text-color) !important;
        }
        
        /* SNMP tabulky v svetlej téme */
        body.light-theme table,
        body.light-theme thead,
        body.light-theme tbody,
        body.light-theme tr,
        body.light-theme th,
        body.light-theme td {
            background-color: #ffffff !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }
        
        body.light-theme th {
            background-color: #f1f5f9 !important;
            font-weight: 600 !important;
        }
        
        body.light-theme tr:nth-child(even) td {
            background-color: #f8fafc !important;
        }
        
        body.light-theme tr:hover td {
            background-color: #e2e8f0 !important;
        }
        
        /* Všetky elementy v SNMP modáli - svetlá téma */
        body.light-theme #snmpStatusModal * {
            color: var(--text-color) !important;
        }
        
        body.light-theme #snmpStatusModal .bg-gray-800,
        body.light-theme #snmpStatusModal .bg-gray-700,
        body.light-theme #snmpStatusModal .bg-gray-600 {
            background-color: #ffffff !important;
        }

        /* Debug Panel Styles */
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 400px;
            max-height: 60vh;
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid #4b5563;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        
        .debug-panel.visible {
            display: flex;
        }
        
        .debug-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #4b5563;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(55, 65, 81, 0.8);
            border-radius: 8px 8px 0 0;
        }
        
        .debug-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #f3f4f6;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .debug-panel-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .debug-panel-btn {
            background: transparent;
            border: 1px solid #6b7280;
            color: #d1d5db;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .debug-panel-btn:hover {
            background: rgba(75, 85, 99, 0.5);
            border-color: #9ca3af;
            color: #ffffff;
        }
        
        .debug-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            background: rgba(17, 24, 39, 0.9);
            border-radius: 0 0 8px 8px;
        }
        
        .debug-log-entry {
            margin-bottom: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            border-left: 3px solid #6b7280;
            background: rgba(31, 41, 55, 0.6);
            word-break: break-word;
        }
        
        .debug-log-entry.debug-chart_operations {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .debug-log-entry.debug-api_calls {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .debug-log-entry.debug-websocket_frontend {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .debug-log-entry.debug-device_operations {
            border-left-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        
        .debug-log-entry .debug-timestamp {
            color: #9ca3af;
            font-size: 11px;
            margin-right: 8px;
        }
        
        .debug-log-entry .debug-type {
            color: #60a5fa;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .debug-log-entry .debug-message {
            color: #e5e7eb;
        }
        
        .debug-log-entry .debug-args {
            color: #d1d5db;
            font-style: italic;
            margin-top: 4px;
            padding-left: 16px;
            border-left: 2px solid #4b5563;
        }
        
        /* Light theme debug panel */
        body.light-theme .debug-panel {
            background: rgba(255, 255, 255, 0.95);
            border-color: #d1d5db;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        body.light-theme .debug-panel-header {
            background: rgba(248, 250, 252, 0.9);
            border-bottom-color: #d1d5db;
        }
        
        body.light-theme .debug-panel-title {
            color: #374151;
        }
        
        body.light-theme .debug-panel-btn {
            border-color: #9ca3af;
            color: #6b7280;
        }
        
        body.light-theme .debug-panel-btn:hover {
            background: rgba(229, 231, 235, 0.5);
            border-color: #6b7280;
            color: #374151;
        }
        
        body.light-theme .debug-panel-content {
            background: rgba(249, 250, 251, 0.9);
        }
        
        body.light-theme .debug-log-entry {
            background: rgba(255, 255, 255, 0.7);
            border-left-color: #9ca3af;
        }
        
        body.light-theme .debug-log-entry.debug-chart_operations {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }
        
        body.light-theme .debug-log-entry.debug-api_calls {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
        
        body.light-theme .debug-log-entry.debug-websocket_frontend {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }
        
        body.light-theme .debug-log-entry.debug-device_operations {
            border-left-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.05);
        }
        
        body.light-theme .debug-log-entry .debug-timestamp {
            color: #6b7280;
        }
        
        body.light-theme .debug-log-entry .debug-type {
            color: #2563eb;
        }
        
        body.light-theme .debug-log-entry .debug-message {
            color: #374151;
        }
        
        body.light-theme .debug-log-entry .debug-args {
            color: #6b7280;
            border-left-color: #d1d5db;
        }
        
        /* Mobile responsive debug panel */
        @media (max-width: 768px) {
            .debug-panel {
                position: fixed;
                top: 10px;
                left: 10px;
                right: 10px;
                width: auto;
                max-height: 50vh;
            }
            
            .debug-panel-header {
                padding: 8px 12px;
            }
            
            .debug-panel-title {
                font-size: 13px;
            }
            
            .debug-panel-btn {
                padding: 3px 6px;
                font-size: 11px;
            }
            
            .debug-panel-content {
                padding: 8px;
            }
            
            .debug-log-entry {
                margin-bottom: 6px;
                padding: 4px 6px;
                font-size: 11px;
            }
            
            .debug-log-entry .debug-timestamp,
            .debug-log-entry .debug-type {
                font-size: 10px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="w-full max-w-none mx-auto relative" style="max-width: 1600px;">
        <!-- Header with user info -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-white flex items-center">
                    <i class="fas fa-network-wired text-sky-400 mr-2"></i>
                    MikroTik Manager
                </h1>
                <span class="text-gray-400 text-sm hidden sm:inline">Správa, zálohovanie a monitoring vašich zariadení</span>
            </div>
            <div class="flex items-center gap-4">
                <button class="theme-toggle" id="themeToggleBtn" title="Prepnúť tému">
                    <i class="fas fa-sun" id="theme-icon"></i>
                </button>
                <div id="userStatus" class="flex items-center gap-2">
                    <!-- Táto časť sa naplní dynamicky cez JavaScript -->
                </div>
            </div>
        </div>

        <div class="main-content-wrapper">
            <div class="left-content">
                <!-- Action buttons -->
                <div class="card p-4 rounded-lg mb-6">
                    <div class="flex flex-wrap gap-3 items-center justify-start action-buttons-container">
                        <button id="addDeviceBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                            <i class="fas fa-plus"></i> Pridať zariadenie
                        </button>
                        <button id="backupAllBtn" class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                            <i class="fas fa-save"></i> Zálohovať všetky
                        </button>
                        <button id="stopAllBackupsBtn" class="btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm hidden">
                            <i class="fas fa-stop"></i> Zastaviť zálohy
                        </button>
                        <button id="refreshAllSnmpBtn" class="btn bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                            <i class="fas fa-sync"></i> Refresh SNMP
                        </button>
                        <button id="snmpStatusBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                            <i class="fas fa-info-circle"></i> SNMP Stav
                        </button>
                        <button id="monitoringBtn" class="btn bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                            <i class="fas fa-chart-line"></i> Monitoring
                        </button>
                        <button id="viewBackupsBtn" class="btn bg-slate-500 hover:bg-slate-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm" onclick="window.location.href='/backups'">
                            <i class="fas fa-archive"></i> Zálohy
                        </button>
                        <button id="settingsBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm">
                            <i class="fas fa-cog"></i> Nastavenia
                        </button>
                        <button id="activityQuickBtn" class="btn bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm sm:hidden" aria-label="Zobraziť aktivitu">
                            <i class="fas fa-clipboard-list"></i> Aktivita
                        </button>
                    </div>
                </div>

                <div id="devicesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8"></div>
            </div>

            <div class="right-sidebar lg:block hidden">
                <!-- Activity log - integrovaný do layoutu -->
                <div class="card p-4 rounded-lg flex flex-col sticky top-4 resize-y min-h-96" style="max-height: calc(100vh - 80px); height: calc(100vh - 160px);">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">📋 Aktivita</h2>
                        <div class="flex gap-1 items-center">
                            <button id="refreshLogsBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-2 rounded text-xs flex items-center gap-1">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="exportLogsBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-2 rounded text-xs flex items-center gap-1">
                                <i class="fas fa-download"></i>
                            </button>
                            <button id="logsFilterBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1.5 px-2 rounded text-xs flex items-center gap-1" aria-expanded="false">
                                <i class="fas fa-filter"></i>
                            </button>
                            <button id="logsExpandBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-1.5 px-2 rounded text-xs gap-1 hidden lg:flex" title="Zobraziť logy na celú obrazovku" aria-label="Zobraziť logy na celú obrazovku">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtre pre logy -->
                    <div id="logsFilters" class="mb-3 space-y-2 hidden">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="deviceFilter" class="p-1 rounded bg-gray-800 border border-gray-600 text-xs" data-custom-select data-placeholder="Všetky zariadenia" data-expand-dropdown="desktop">
                                <option value="">Všetky zariadenia</option>
                            </select>
                            <select id="typeFilter" class="p-1 rounded bg-gray-800 border border-gray-600 text-xs" data-custom-select data-placeholder="Všetky typy">
                                <option value="">Všetky typy</option>
                                <option value="backup">Zálohovanie</option>
                                <option value="notification">Notifikácie</option>
                                <option value="status">Online/Offline</option>
                                <option value="device">Zariadenie</option>
                                <option value="system">Systém</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-4 gap-1">
                            <button id="levelAll" class="filter-level-btn active p-1 rounded text-xs bg-gray-700 hover:bg-gray-600">Všetky</button>
                            <button id="levelInfo" class="filter-level-btn p-1 rounded text-xs bg-blue-700 hover:bg-blue-600">Info</button>
                            <button id="levelWarning" class="filter-level-btn p-1 rounded text-xs bg-yellow-700 hover:bg-yellow-600">Warn</button>
                            <button id="levelError" class="filter-level-btn p-1 rounded text-xs bg-red-700 hover:bg-red-600">Error</button>
                        </div>
                    </div>
                    
                    <div id="logsContainer" class="flex-1 overflow-y-auto space-y-1 pr-2 text-xs" style="min-height: 200px;"></div>
                </div>
            </div>
        </div>

        <!-- Mobilná verzia activity logu - zobrazuje sa pod hlavným obsahom -->
        <div id="mobileLogs" class="lg:hidden">
            <div class="card p-4 rounded-lg mt-1 sm:mt-8 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">📋 Aktivita</h2>
                    <div class="flex gap-1">
                        <button id="refreshLogsBtnMobile" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-2.5 rounded text-xs flex items-center gap-1">
                            <i class="fas fa-sync-alt text-sm"></i>
                        </button>
                        <button id="exportLogsBtnMobile" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-2.5 rounded text-xs flex items-center gap-1">
                            <i class="fas fa-download text-sm"></i>
                        </button>
                        <button id="logsFilterBtnMobile" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1.5 px-2.5 rounded text-xs flex items-center gap-1" aria-expanded="false">
                            <i class="fas fa-filter text-sm"></i>
                        </button>
                        <button id="logsExpandBtnMobile" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-1.5 px-2.5 rounded text-xs flex items-center gap-1 sm:hidden" title="Zobraziť logy na celú obrazovku" aria-label="Zobraziť logy na celú obrazovku">
                            <i class="fas fa-expand text-sm"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mobilné filtre pre logy -->
                <div id="logsFiltersMobile" class="mb-3 space-y-2 hidden">
                    <div class="grid grid-cols-1 gap-2">
                        <select id="deviceFilterMobile" class="p-2 rounded bg-gray-800 border border-gray-600 text-sm" data-custom-select data-placeholder="Všetky zariadenia">
                            <option value="">Všetky zariadenia</option>
                        </select>
                        <select id="typeFilterMobile" class="p-2 rounded bg-gray-800 border border-gray-600 text-sm" data-custom-select data-placeholder="Všetky typy">
                            <option value="">Všetky typy</option>
                            <option value="backup">Zálohovanie</option>
                            <option value="notification">Notifikácie</option>
                            <option value="status">Online/Offline</option>
                            <option value="device">Zariadenie</option>
                            <option value="system">Systém</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <button id="levelAllMobile" class="filter-level-btn-mobile active p-2 rounded text-sm bg-gray-700 hover:bg-gray-600">Všetky</button>
                        <button id="levelInfoMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-blue-700 hover:bg-blue-600">Info</button>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <button id="levelWarningMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-yellow-700 hover:bg-yellow-600">Warn</button>
                        <button id="levelErrorMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-red-700 hover:bg-red-600">Error</button>
                    </div>
                </div>
                
                <div id="logsContainerMobile" class="overflow-y-auto space-y-1 pr-2 text-xs mobile-logs-container" style="max-height: 400px;"></div>
            </div>
    </div>
        </div>

    <!-- Modals -->
    <div id="deviceModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-4xl modal-content device-modal-content">
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-white">Pridať/Upraviť zariadenie</h2>
            </div>
            <form id="deviceForm" class="space-y-6">
                <input type="hidden" id="deviceId">

                <div class="device-form-scroll space-y-6 pr-1">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label for="deviceName" class="block mb-1 font-semibold">Názov zariadenia</label>
                                <input type="text" id="deviceName" class="w-full p-3 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                            <div>
                                <label for="deviceIp" class="block mb-1 font-semibold">IP Adresa</label>
                                <input type="text" id="deviceIp" class="w-full p-3 rounded bg-gray-800 border border-gray-600" required>
                            </div>
                            <div>
                                <label for="deviceUsername" class="block mb-1 font-semibold">Používateľské meno</label>
                                <input type="text" id="deviceUsername" class="w-full p-3 rounded bg-gray-800 border border-gray-600" required>
                            </div>
                            <div>
                                <label for="devicePassword" class="block mb-1 font-semibold">Heslo</label>
                                <input type="password" id="devicePassword" class="w-full p-3 rounded bg-gray-800 border border-gray-600" placeholder="Zadajte heslo pre SSH pripojenie">
                            </div>
                            <div>
                                <label for="deviceSnmpCommunity" class="block mb-1 font-semibold">SNMP Community</label>
                                <input type="text" id="deviceSnmpCommunity" class="w-full p-3 rounded bg-gray-800 border border-gray-600" placeholder="public">
                            </div>
                        </div>

                        <div class="space-y-4 p-4 rounded-lg border border-gray-700 bg-gray-800/60">
                            <h3 class="text-lg font-semibold text-white mb-1">Intervaly</h3>
                            <div>
                                <label for="devicePingInterval" class="block mb-1 font-semibold">Ping interval (sekundy)</label>
                                <input type="number" id="devicePingInterval" class="w-full p-3 rounded bg-gray-800 border border-gray-600" value="0" min="0" max="86400" oninput="validateDevicePingInterval(this)">
                                <small class="text-gray-400 block mt-1 italic">Ovplyvňuje graf: Ping Latencia</small>
                                <small class="text-gray-400 block">0 = použiť globálne nastavenie, 20-86400 sekúnd (minimálne 20s, max 24 hodín).</small>
                            </div>
                            <div>
                                <label for="devicePingRetryInterval" class="block mb-1 font-semibold">Retry interval pri výpadku (sekundy)</label>
                                <input type="number" id="devicePingRetryInterval" class="w-full p-3 rounded bg-gray-800 border border-gray-600" value="0" min="0" max="120" oninput="validateDeviceRetryInterval(this)">
                                <small class="text-gray-400 block mt-1 italic">Počas výpadku sa zariadenie pingá týmto intervalom, kým sa nepotvrdí návrat online.</small>
                                <small class="text-gray-400 block">0 = globálne nastavenie zo sekcie Nastavenia, 5-120 sekúnd.</small>
                            </div>
                            <div>
                                <label for="deviceSnmpInterval" class="block mb-1 font-semibold">SNMP monitoring interval (minúty)</label>
                                <input type="number" id="deviceSnmpInterval" class="w-full p-3 rounded bg-gray-800 border border-gray-600" value="0" min="0" max="1440">
                                <small class="text-gray-400 block mt-1">0 = použiť globálne nastavenie, 1-1440 = vlastný interval v minútach</small>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="deviceLowMemory" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500">
                        <label for="deviceLowMemory" class="ml-2">Zariadenie s nízkou pamäťou (16MB)</label>
                    </div>
                </div>

                <div class="flex justify-end gap-4 pt-2">
                    <button type="button" id="cancelDeviceBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zrušiť</button>
                    <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Uložiť</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="card p-6 md:p-8 rounded-lg w-full max-w-sm md:max-w-4xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-white">⚙️ Nastavenia</h2>
                <button id="closeSettingsBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-lg md:inline-block hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="settingsForm" class="space-y-6 md:space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <!-- Ľavý stĺpec -->
                    <div class="space-y-6 md:space-y-8">
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">⏰ Automatické zálohovanie</h3>
                            <div class="space-y-4">
                                <div class="flex items-center"><input type="checkbox" id="backup_schedule_enabled" name="backup_schedule_enabled" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="backup_schedule_enabled" class="ml-2">Povoliť automatické zálohovanie</label></div>
                                <div><label for="backup_schedule_type" class="block mb-1">Interval</label><select id="backup_schedule_type" name="backup_schedule_type" class="w-full p-2 rounded bg-gray-800 border border-gray-600"><option value="daily">Denne</option><option value="weekly">Týždenne</option></select></div>
                                <div id="weeklySettings" class="hidden"><label for="backup_schedule_day" class="block mb-1">Deň v týždni</label><select id="backup_schedule_day" name="backup_schedule_day" class="w-full p-2 rounded bg-gray-800 border border-gray-600"><option value="monday">Pondelok</option><option value="tuesday">Utorok</option><option value="wednesday">Streda</option><option value="thursday">Štvrtok</option><option value="friday">Piatok</option><option value="saturday">Sobota</option><option value="sunday">Nedeľa</option></select></div>
                                <div><label for="backup_schedule_time" class="block mb-1">Čas (HH:MM)</label><input type="time" id="backup_schedule_time" name="backup_schedule_time" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="backup_retention_count" class="block mb-1 font-semibold">Počet uchovávaných záloh (na zariadenie)</label><input type="number" id="backup_retention_count" name="backup_retention_count" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="10" min="1"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📦 Hromadné zálohovanie</h3>
                            <div class="space-y-4">
                                <div><label for="backup_delay_seconds" class="block mb-1 font-semibold">Oneskorenie medzi zálohami (sekundy)</label><input type="number" id="backup_delay_seconds" name="backup_delay_seconds" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="30" min="5" max="300"><small class="text-gray-400 block mt-1">Odporúčaný rozsah: 30-60 sekúnd. Kratší čas môže preťažiť sieť.</small></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📊 SNMP Monitoring</h3>
                            <div class="space-y-4">
                                <div><label for="snmp_check_interval_minutes" class="block mb-1 font-semibold">Globálny interval SNMP kontroly (minúty)</label><input type="number" id="snmp_check_interval_minutes" name="snmp_check_interval_minutes" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="10" min="1" max="1440"><small class="text-gray-400 block mt-1">Predvolený interval pre zariadenia, ktoré nemajú nastavený vlastný interval. Rozsah: 1-1440 minút</small>
                                <div class="mt-2 p-3 bg-blue-900/30 border border-blue-500/50 rounded-lg">
                                    <div class="flex items-start gap-2">
                                        <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                                        <div class="text-sm text-blue-200">
                                            <strong>📱 Pushover notifikácie:</strong> Notifikácie o online/offline stave zariadení sú založené na <strong>SNMP monitoringu</strong> a tomto intervale, nie na ICMP ping monitoringu z detailnej monitoring stránky.
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="p-3 bg-gray-800/50 border border-gray-700 rounded-lg">
                                        <div class="flex items-start justify-between gap-3">
                                            <div>
                                                <label for="snmp_health_check_enabled" class="block font-medium mb-1">Automatický SNMP health check</label>
                                                <p class="text-xs text-gray-400">Stráži plánovanie SNMP úloh a reštartuje chýbajúce alebo zaseknuté položky.</p>
                                            </div>
                                            <label for="snmp_health_check_enabled" class="inline-flex items-center cursor-pointer select-none">
                                                <input type="checkbox" id="snmp_health_check_enabled" name="snmp_health_check_enabled" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500">
                                                <span class="ml-2 text-xs font-medium">Zapnuté</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="snmp_health_check_interval_minutes" class="block mb-1 font-semibold">Frekvencia health checku (minúty)</label>
                                        <input type="number" id="snmp_health_check_interval_minutes" name="snmp_health_check_interval_minutes" class="w-full p-2 rounded bg-gray-800 border border-gray-600 transition-opacity" value="15" min="1" max="1440">
                                        <small class="text-gray-400 block mt-1">Definuje, ako často sa má spustiť kontrola plánovača SNMP úloh. Odporúčané 15 minút.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">🏓 ICMP Ping Monitoring</h3>
                            <div class="space-y-4">
                                <div class="flex items-center"><input type="checkbox" id="ping_monitor_enabled" name="ping_monitor_enabled" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="ping_monitor_enabled" class="ml-2">Povoliť ICMP ping monitoring</label><small class="text-gray-400 block mt-1">Ak je vypnuté, ping monitoring sa nezachytáva</small></div>
                                <div><label for="ping_check_interval_seconds" class="block mb-1 font-semibold">Interval ping kontroly (sekundy)</label><input type="number" id="ping_check_interval_seconds" name="ping_check_interval_seconds" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="120" min="1" max="86400"><small class="text-gray-400 block mt-1">Interval medzi ping kontrolami. Rozsah: 1 sekunda až 24 hodín (86400 sekúnd). Odporúčané: 30-300 sekúnd.</small></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📋 Správa logov a dát</h3>
                            <div class="space-y-4">
                                <div class="flex items-center"><input type="checkbox" id="backup_detailed_logging" name="backup_detailed_logging" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="backup_detailed_logging" class="ml-2">Detailné logovanie zálohového procesu</label><small class="text-gray-400 block mt-1">Ak je vypnuté, zobrazujú sa len základné správy o spustení a dokončení zálohy</small></div>
                                <div><label for="log_retention_days" class="block mb-1 font-semibold">Počet dní uchovávania logov</label><input type="number" id="log_retention_days" name="log_retention_days" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="30" min="1" max="365"><small class="text-gray-400 block mt-1">Logy staršie ako tento počet dní budú automaticky vymazané. Rozsah: 1-365 dní</small></div>
                                <div><label for="ping_retention_days" class="block mb-1 font-semibold">Počet dní uchovávania ping dát</label><input type="number" id="ping_retention_days" name="ping_retention_days" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="30" min="1" max="365"><small class="text-gray-400 block mt-1">Ping história pre grafy. Viac dní = väčšia databáza. Rozsah: 1-365 dní</small></div>
                                <div><label for="snmp_retention_days" class="block mb-1 font-semibold">Počet dní uchovávania SNMP dát</label><input type="number" id="snmp_retention_days" name="snmp_retention_days" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="30" min="1" max="365"><small class="text-gray-400 block mt-1">SNMP história (CPU, teplota, pamäť). Viac dní = väčšia databáza. Rozsah: 1-365 dní</small></div>
                                <div><label for="log_max_entries" class="block mb-1 font-semibold">Maximum logov v pamäti</label><input type="number" id="log_max_entries" name="log_max_entries" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="2000" min="100" max="20000"><small class="text-gray-400 block mt-1">Maximálny počet logov načítaných do prehliadača. Vyššie číslo = viac RAM. Rozsah: 100-20000</small></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pravý stĺpec -->
                    <div class="space-y-6 md:space-y-8">
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📁 FTP Server</h3>
                            <div class="space-y-4">
                                <div><label for="ftp_server" class="block mb-1">FTP Server IP</label><input type="text" id="ftp_server" name="ftp_server" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="ftp_username" class="block mb-1">FTP Používateľ</label><input type="text" id="ftp_username" name="ftp_username" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="ftp_password" class="block mb-1">FTP Heslo</label><input type="password" id="ftp_password" name="ftp_password" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="ftp_directory" class="block mb-1">FTP Adresár</label><input type="text" id="ftp_directory" name="ftp_directory" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📱 Inteligentné Notifikácie (Pushover)</h3>
                            <div class="mb-4 p-3 bg-amber-900/30 border border-amber-500/50 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-exclamation-triangle text-amber-400 mt-0.5"></i>
                                    <div class="text-sm text-amber-200">
                                        <strong>Dôležité:</strong> Notifikácie o online/offline stave zariadení sú spúšťané <strong>SNMP monitoringom</strong> (viď sekcia "📊 SNMP Monitoring"), nie ICMP ping testami z monitoring stránky.
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div><label for="pushover_app_key" class="block mb-1 font-semibold">Pushover App Key/Token</label><input type="text" id="pushover_app_key" name="pushover_app_key" class="w-full p-2 rounded bg-gray-800 border border-gray-600" placeholder="Váš App Key z Pushover"></div>
                                <div><label for="pushover_user_key" class="block mb-1 font-semibold">Pushover User Key</label><input type="text" id="pushover_user_key" name="pushover_user_key" class="w-full p-2 rounded bg-gray-800 border border-gray-600" placeholder="Váš User Key z Pushover"></div>
                                <h4 class="font-semibold pt-2">Typy notifikácií</h4>
                                <div id="notificationTypes" class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2"></div>
                                <h4 class="font-semibold pt-2">Kritické limity</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label for="temp_critical_threshold" class="block mb-1">Teplota (°C)</label><input type="number" id="temp_critical_threshold" name="temp_critical_threshold" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                    <div><label for="cpu_critical_threshold" class="block mb-1">CPU (%)</label><input type="number" id="cpu_critical_threshold" name="cpu_critical_threshold" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                    <div><label for="memory_critical_threshold" class="block mb-1">Pamäť (%)</label><input type="number" id="memory_critical_threshold" name="memory_critical_threshold" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                </div>
                                <h4 class="font-semibold pt-2">Obmedzenia</h4>
                                <div class="flex items-center"><input type="checkbox" id="quiet_hours_enabled" name="quiet_hours_enabled" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="quiet_hours_enabled" class="ml-2">Povoliť "Quiet Hours" (tichý režim)</label></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="quiet_hours_start" class="block mb-1">Tichý režim od</label><input type="time" id="quiet_hours_start" name="quiet_hours_start" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                    <div><label for="quiet_hours_end" class="block mb-1">Tichý režim do</label><input type="time" id="quiet_hours_end" name="quiet_hours_end" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                </div>
                                <div><button type="button" id="testPushoverBtn" class="btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg w-full flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> Otestovať Notifikáciu</button></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-6 border-t border-gray-700"><button type="button" id="cancelSettingsBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zrušiť</button><button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Uložiť nastavenia</button></div>
            </form>
        </div>
    </div>

    <div id="manageAccountModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-2xl modal-content max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-white mb-6">👤 Správa používateľského účtu</h2>
            <div id="accountManageMessage" class="hidden p-3 rounded-md mb-4 text-sm"></div>
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-600 mb-6">
                <button id="tabUsername" class="account-tab active px-4 py-2 text-sky-400 border-b-2 border-sky-400">Používateľské meno</button>
                <button id="tabPassword" class="account-tab px-4 py-2 text-gray-400 border-b-2 border-transparent hover:text-sky-400">Heslo</button>
                <button id="tab2FA" class="account-tab px-4 py-2 text-gray-400 border-b-2 border-transparent hover:text-sky-400">2FA</button>
            </div>
            
            <!-- Username Tab -->
            <div id="tabUsernameContent" class="tab-content">
                <form id="changeUsernameForm" class="space-y-4">
                    <div>
                        <label for="currentUsernameDisplay" class="block mb-1 font-semibold">Aktuálne používateľské meno</label>
                        <input type="text" id="currentUsernameDisplay" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-gray-400" readonly>
                    </div>
                    <div>
                        <label for="newUsername" class="block mb-1 font-semibold">Nové používateľské meno</label>
                        <input type="text" id="newUsername" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required 
                               placeholder="Len písmená, číslice, _ a -" pattern="[a-zA-Z0-9_-]+">
                        <small class="text-gray-400 text-xs">Minimálne 3 znaky, maximálne 50 znakov</small>
                    </div>
                    <div>
                        <label for="confirmPasswordUsername" class="block mb-1 font-semibold">Potvrdenie hesla</label>
                        <input type="password" id="confirmPasswordUsername" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Zmeniť používateľské meno</button>
                    </div>
                </form>
            </div>
            
            <!-- Password Tab -->
            <div id="tabPasswordContent" class="tab-content hidden">
                <form id="changePasswordForm" class="space-y-4">
                    <div>
                        <label for="oldPassword" class="block mb-1 font-semibold">Staré heslo</label>
                        <div class="password-input-container">
                            <input type="password" id="oldPassword" class="w-full p-2 pr-10 rounded bg-gray-800 border border-gray-600" required>
                            <i class="fas fa-eye password-toggle" data-target="oldPassword"></i>
                        </div>
                    </div>
                    <div>
                        <label for="newPassword" class="block mb-1 font-semibold">Nové heslo</label>
                        <div class="password-input-container">
                            <input type="password" id="newPassword" class="w-full p-2 pr-10 rounded bg-gray-800 border border-gray-600" required>
                            <i class="fas fa-eye password-toggle" data-target="newPassword"></i>
                        </div>
                    </div>
                    <div>
                        <label for="newPasswordConfirm" class="block mb-1 font-semibold">Potvrdenie nového hesla</label>
                        <div class="password-input-container">
                            <input type="password" id="newPasswordConfirm" class="w-full p-2 pr-10 rounded bg-gray-800 border border-gray-600" required>
                            <i class="fas fa-eye password-toggle" data-target="newPasswordConfirm"></i>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Zmeniť heslo</button>
                    </div>
                </form>
            </div>
            
            <!-- 2FA Tab -->
            <div id="tab2FAContent" class="tab-content hidden">
                <div id="backup2faControls" class="space-y-4">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-white mb-2">📱 Záložné kódy</h3>
                        <p class="text-gray-400 text-sm mb-3">Záložné kódy umožňujú prístup k vášmu účtu aj keď nemáte k dispozícii svoje zariadenie s autentifikátorom.</p>
                        <div id="backupCodesInfo" class="mb-3">
                            <p class="text-sm text-gray-300">Zostáva vám: <span id="remainingCodes" class="font-semibold text-sky-400">-</span> kódov</p>
                        </div>
                        <button id="generateBackupCodesBtn" class="btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg">
                            <i class="fas fa-key mr-2"></i>Regenerovať záložné kódy
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 pt-6 border-t border-gray-700 mt-6">
                <button type="button" id="cancelAccountManageBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zatvoriť</button>
            </div>
        </div>
    </div>

    <!-- Password Confirmation Modal for Backup Codes -->
    <div id="confirmPasswordModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-md modal-content">
            <h2 class="text-xl font-bold text-white mb-4">Potvrdenie hesla</h2>
            <p class="text-gray-400 text-sm mb-4">Pre regeneráciu záložných kódov je potrebné potvrdiť vaše heslo.</p>
            <div id="confirmPasswordMessage" class="hidden p-3 rounded-md mb-4 text-sm"></div>
            <form id="confirmPasswordForm" class="space-y-4">
                <div>
                    <label for="confirmPasswordInput" class="block mb-1 font-semibold">Heslo</label>
                    <input type="password" id="confirmPasswordInput" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancelConfirmPasswordBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zrušiť</button>
                    <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Potvrdiť</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Backup Codes Display Modal -->
    <div id="backupCodesModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-lg modal-content">
            <h2 class="text-xl font-bold text-white mb-4">🔑 Vaše nové záložné kódy</h2>
            <div class="bg-red-800 p-4 rounded-lg mb-4">
                <p class="text-red-200 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i><strong>Dôležité:</strong> Uložte si tieto kódy na bezpečné miesto. Každý kód možno použiť iba jedenkrát!</p>
            </div>
            <div id="backupCodesDisplay" class="grid grid-cols-2 gap-2 mb-6 font-mono text-sm">
                <!-- Backup codes will be inserted here -->
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="downloadCodesBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i>Stiahnuť ako súbor
                </button>
                <button id="printCodesBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                    <i class="fas fa-print mr-2"></i>Vytlačiť
                </button>
            </div>
            <div class="flex justify-end">
                <button id="closeBackupCodesBtn" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Dokončiť</button>
            </div>
        </div>
    </div>

    <div id="snmpStatusModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="card p-8 rounded-lg w-full max-w-4xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">🛡️ SNMP Monitoring Stav</h2>
                <div class="flex gap-2">
                    <button id="refreshSnmpStatusBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-lg text-sm opacity-70 hover:opacity-100 transition-opacity" title="Obnoviť SNMP stav">
                        <i class="fas fa-sync-alt text-xs"></i>
                    </button>
                    <button id="closeSnmpStatusBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="snmpStatusContent">
                <div class="flex justify-center items-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-sky-500 mr-3"></i>
                    <span class="text-lg">Načítavam SNMP stav...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="logsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-2 overflow-hidden">
        <div class="card w-full h-full sm:h-auto max-w-full sm:max-w-6xl modal-content no-outer-scrollbar rounded-none sm:rounded-lg flex flex-col overflow-visible sm:overflow-hidden p-2 sm:p-8" style="max-height: calc(100vh - 1rem);">
            <div class="flex items-center justify-between flex-wrap gap-2 mb-3 sm:mb-6 px-2 sm:px-0">
                <h2 class="text-lg sm:text-2xl font-bold text-white">📋 Aktivita</h2>
                <div class="modal-actions flex items-center gap-2 flex-wrap ml-auto">
                    <button id="logsModalRefreshBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded text-sm flex items-center gap-2" title="Obnoviť" aria-label="Obnoviť logy">
                        <i class="fas fa-sync-alt text-xs sm:text-sm"></i><span class="hidden sm:inline">Obnoviť</span>
                    </button>
                    <button id="logsModalExportBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded text-sm flex items-center gap-2" title="Stiahnuť" aria-label="Stiahnuť logy">
                        <i class="fas fa-download text-xs sm:text-sm"></i><span class="hidden sm:inline">Stiahnuť</span>
                    </button>
                    <button id="logsModalFilterBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-3 rounded text-sm flex items-center gap-2" title="Filtre" aria-label="Zobraziť filtre" aria-expanded="false">
                        <i class="fas fa-filter text-xs sm:text-sm"></i><span class="hidden sm:inline">Filtre</span>
                    </button>
                    <button id="closeLogsModalBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-3 rounded text-sm flex items-center gap-2" title="Zavrieť" aria-label="Zavrieť">
                        <i class="fas fa-times text-xs sm:text-sm"></i>
                    </button>
                </div>
            </div>
            <div id="logsModalFilters" class="mb-4 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
            <select id="deviceFilterModal" class="p-2 rounded bg-gray-900 border border-gray-700 text-sm" data-custom-select data-placeholder="Všetky zariadenia">
                <option value="">Všetky zariadenia</option>
            </select>
            <select id="typeFilterModal" class="p-2 rounded bg-gray-900 border border-gray-700 text-sm" data-custom-select data-placeholder="Všetky typy">
                <option value="">Všetky typy</option>
                <option value="backup">Zálohovanie</option>
                        <option value="notification">Notifikácie</option>
                        <option value="status">Online/Offline</option>
                        <option value="device">Zariadenie</option>
                        <option value="system">Systém</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button id="levelAllModal" class="filter-level-btn btn bg-gray-700 hover:bg-gray-600 text-white py-1.5 px-3 sm:py-2 sm:px-4 rounded text-xs sm:text-sm">Všetky</button>
                    <button id="levelInfoModal" class="filter-level-btn btn bg-blue-700 hover:bg-blue-600 text-white py-1.5 px-3 sm:py-2 sm:px-4 rounded text-xs sm:text-sm">Info</button>
                    <button id="levelWarningModal" class="filter-level-btn btn bg-yellow-700 hover:bg-yellow-600 text-white py-1.5 px-3 sm:py-2 sm:px-4 rounded text-xs sm:text-sm">Warn</button>
                    <button id="levelErrorModal" class="filter-level-btn btn bg-red-700 hover:bg-red-600 text-white py-1.5 px-3 sm:py-2 sm:px-4 rounded text-xs sm:text-sm">Error</button>
                </div>
            </div>
            <div id="logsModalContent" class="bg-gray-900 border border-gray-700 rounded-lg overflow-y-auto flex-1" style="height: 100%; max-height: calc(100vh - 5rem); padding: 0.5rem 0.25rem 0.5rem 0.5rem;">
                <div id="logsModalList" class="space-y-1 text-sm"></div>
            </div>
        </div>
    </div>

<script>
// Funkcie pre správu refresh stavu
const setRefreshingState = (enable = true) => {
    if (enable) {
        document.body.classList.add('refreshing');
    } else {
        document.body.classList.remove('refreshing');
    }
};

document.addEventListener('DOMContentLoaded', () => {
    // Optimalizovaný startup - minimálny loading overlay
    setRefreshingState(true);
    
    // Veľmi rýchlo vypneme - umožníme používateľovi interakciu čo najskôr
    setTimeout(() => {
        setRefreshingState(false);
    }, 300); // Ešte kratšie - len 300ms
    
    const API_URL = '';
    const devicesGrid = document.getElementById('devicesGrid');
    const logsContainer = document.getElementById('logsContainer');
    const deviceModal = document.getElementById('deviceModal');
    const settingsModal = document.getElementById('settingsModal');
    const manageAccountModal = document.getElementById('manageAccountModal');
    const confirmPasswordModal = document.getElementById('confirmPasswordModal');
    const backupCodesModal = document.getElementById('backupCodesModal');
    const snmpStatusModal = document.getElementById('snmpStatusModal');
    const logsModal = document.getElementById('logsModal');
    const logsModalList = document.getElementById('logsModalList');
    const closeLogsModalBtn = document.getElementById('closeLogsModalBtn');
    const logsExpandBtn = document.getElementById('logsExpandBtn');
    const activityQuickBtn = document.getElementById('activityQuickBtn');
    const logsModalRefreshBtn = document.getElementById('logsModalRefreshBtn');
    const logsModalExportBtn = document.getElementById('logsModalExportBtn');
    const logsModalFilterBtn = document.getElementById('logsModalFilterBtn');
    const logsModalFilters = document.getElementById('logsModalFilters');
    const deviceFilterModal = document.getElementById('deviceFilterModal');
    const typeFilterModal = document.getElementById('typeFilterModal');
    const deviceFilter = document.getElementById('deviceFilter');
    const typeFilter = document.getElementById('typeFilter');
    const deviceFilterMobile = document.getElementById('deviceFilterMobile');
    const typeFilterMobile = document.getElementById('typeFilterMobile');
    const logsExpandBtnMobile = document.getElementById('logsExpandBtnMobile');
    const logsFilters = document.getElementById('logsFilters');
    const logsFiltersMobile = document.getElementById('logsFiltersMobile');
    const logsFilterBtn = document.getElementById('logsFilterBtn');
    const logsFilterBtnMobile = document.getElementById('logsFilterBtnMobile');
    const deviceForm = document.getElementById('deviceForm');
    const settingsForm = document.getElementById('settingsForm');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const changeUsernameForm = document.getElementById('changeUsernameForm');
    const notificationTypes = {
        notify_device_offline: "🔴 Zariadenie offline", notify_device_online: "✅ Zariadenie online",
        notify_backup_success: "✅ Záloha úspešná",
        notify_high_temperature: "🌡️ Vysoká teplota", notify_high_cpu: "⚡ Vysoké CPU",
        notify_low_memory: "💾 Málo pamäte",
        notify_reboot_detected: "🔄 Reboot detekovaný", notify_version_change: "🆕 Zmena verzie OS",
    };

    // Formátovanie času zálohy – korekcia ak backend posiela "naive" lokálny čas
    function formatLocalDate(value) {
        try {
            if(!value) return '';
            // Ak už reťazec obsahuje 'Z' alebo +/-, necháme JS spracovať priamo
            const hasTZ = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(value);
            let dateObj;
            if (hasTZ) {
                dateObj = new Date(value);
            } else {
                // Predpoklad: backend uložil timestamp ako lokálny server čas (napr. UTC) bez 'Z'
                // Zoberieme komponenty a vytvoríme Date v lokálnej zóne, potom zobrazíme lokálne
                // Ak je to ISO bez ms: YYYY-MM-DDTHH:MM:SS
                const isoLike = value.match(/^(\d{4}-\d{2}-\d{2})[T ](\d{2}:\d{2}:\d{2})/);
                if (isoLike) {
                    // Rozdelíme a vytvoríme ako local
                    dateObj = new Date(value.replace(' ', 'T'));
                } else {
                    dateObj = new Date(value);
                }
            }
            if (isNaN(dateObj.getTime())) return value;
            return dateObj.toLocaleString('sk-SK', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        } catch(e){ return value; }
    }

    // --- Štandardizovaný pomocník pre API volania ---
    const api = {
        _handleResponse: async (res) => {
            if (res.status === 401) {
                window.location.href = '/login';
                return {};
            }
            
            try {
                const data = await res.json();
                
                // Ak server vráti chybu, ale JSON je validný
                if (!res.ok) {
                    throw new Error(data.message || `HTTP ${res.status}: ${res.statusText}`);
                }
                
                return data;
            } catch (error) {
                // Ak JSON parsing zlyhá
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                throw error;
            }
        },
        
        get: async function(endpoint) {
            const res = await fetch(`${API_URL}/api/${endpoint}`);
            return this._handleResponse(res);
        },
        
        post: async function(endpoint, body) {
            const res = await fetch(`${API_URL}/api/${endpoint}`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(body) 
            });
            return this._handleResponse(res);
        },
        
        delete: async function(endpoint) {
            const res = await fetch(`${API_URL}/api/${endpoint}`, { method: 'DELETE' });
            return this._handleResponse(res);
        }
    };    const loadUserStatus = async () => {
        try {
            const data = await api.get('user/status');
            if (data.username) {
                document.getElementById('userStatus').innerHTML = `
                    <span class="text-sm text-gray-400 mr-4 hidden md:inline">Prihlásený ako: <strong class="font-semibold text-gray-200">${data.username}</strong></span>
                    <div class="flex items-center gap-2 text-sm">
                        <a href="#" id="manageAccountLink" class="text-sky-500 hover:text-sky-400 hover:underline">Upraviť</a>
                        <span class="text-gray-600">|</span>
                        <a href="/logout" class="text-sky-500 hover:text-sky-400 hover:underline">Odhlásiť</a>
                    </div>
                `;
                document.getElementById('manageAccountLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    // Fill current username display
                    document.getElementById('currentUsernameDisplay').value = data.username;
                    manageAccountModal.classList.remove('hidden');
                });
            }
        } catch (error) {
            console.error('Chyba pri načítaní stavu používateľa:', error);
        }
    };

    // === WebSocket SNMP Refresh Progress Handler ===
    let isSnmpRefreshRunning = false;
    
    const updateSnmpRefreshButton = (status, current = 0, total = 0, message = '') => {
        const btn = document.getElementById('refreshAllSnmpBtn');
        const icon = btn.querySelector('i');
        
        switch (status) {
            case 'started':
            case 'processing':
                isSnmpRefreshRunning = true;
                icon.classList.add('fa-spin');
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${current}/${total}`;
                break;
                
            case 'completed':
            case 'stopped':
            case 'error':
                isSnmpRefreshRunning = false;
                icon.classList.remove('fa-spin');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync"></i> Refresh SNMP';
                break;
        }
    };

    const socket = io();
    let isWebSocketConnected = false;
    
    // WebSocket event handlers
    socket.on('connect', () => {
        isWebSocketConnected = true;
        // Logy sa načítajú v initializeApp(), nie tu
    });
    
    socket.on('disconnect', () => {
        isWebSocketConnected = false;
        // Logy sa budú obnovovať len manuálne cez refresh tlačidlo
    });
    
    socket.on('log_update', (log) => {
        // Pridáme log len ak je WebSocket pripojený
        if (isWebSocketConnected) {
            addLog(log.level, log.message, log.device_ip, log.timestamp);
        }
    });
    
    socket.on('snmp_update', ({ id, data, status }) => {
        // Zastavíme spinning efekt na SNMP tlačidle po update
        const card = document.querySelector(`[data-id="${id}"]`);
        if (card) {
            const snmpBtn = card.querySelector('.snmp-btn');
            if (snmpBtn) {
                const icon = snmpBtn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-spin');
                }
                snmpBtn.disabled = false;
            }
        }
        updateDeviceCard(id, { last_snmp_data: JSON.stringify(data), status });
    });
    
    socket.on('snmp_refresh_progress', (progressData) => {
        updateSnmpRefreshButton(progressData.status, progressData.current, progressData.total, progressData.message);
        
        // Ak máme informácie o aktuálnom zariadení, zobrazíme spinning efekt
        if (progressData.status === 'processing' && progressData.current_device) {
            const card = document.querySelector(`[data-id="${progressData.current_device.id}"]`);
            if (card) {
                const snmpBtn = card.querySelector('.snmp-btn');
                const snmpIcon = snmpBtn?.querySelector('i');
                if (snmpIcon) {
                    snmpIcon.classList.add('fa-spin');
                }
                if (snmpBtn) {
                    snmpBtn.disabled = true;
                }
            }
        }
    });
    socket.on('backup_status', ({ ip, id, status, last_backup }) => {
        const card = document.querySelector(`[data-id="${id}"]`);
        if (card) {
            card.querySelector('.backup-btn i').classList.remove('spinning');
            if (last_backup) card.querySelector('.last-backup-val').textContent = new Date(last_backup).toLocaleString('sk-SK');
            
            // Ak bola záloha zastavená, zobrazíme správu
            if (status === 'stopped') {
                addLog('warning', `Záloha pre ${ip} bola zastavená používateľom.`, ip);
            } else if (status === 'stop_requested') {
                addLog('warning', `Požiadavka na zastavenie zálohy pre ${ip} bola prijatá (prebiehajúca úloha sa dokončí).`, ip);
            }
        }
    });

    const createDeviceCard = (device) => {
        const snmpData = device.last_snmp_data ? JSON.parse(device.last_snmp_data) : {};
        const deviceStatus = device.status || 'unknown';
        const statusClass = deviceStatus === 'online' ? 'status-online' : 
                           deviceStatus === 'offline' ? 'status-offline' : 'status-unknown';
        const card = document.createElement('div');
        card.className = 'card p-6 rounded-lg flex flex-col gap-4';
        card.dataset.id = device.id;
        card.dataset.ip = device.ip;
        const snmpIntervalDisplay = device.snmp_interval_minutes ? `${device.snmp_interval_minutes}min` : 'globálny';
        const icmpIntervalDisplay = device.ping_interval_seconds ? `${device.ping_interval_seconds}s` : 'globálny';
        const lastBackupDisplay = device.last_backup ? formatLocalDate(device.last_backup) : 'Nikdy';
        card.innerHTML = `
            <div class="h-20 flex flex-col justify-between">
                <div class="grid grid-cols-[1fr_auto] gap-4 items-start">
                    <h3 class="text-xl font-bold text-white leading-tight line-clamp-2">${device.name}</h3>
                    <span class="font-mono text-sm font-semibold ${statusClass} whitespace-nowrap flex items-center flex-shrink-0"><i class="fas fa-circle mr-2"></i>${deviceStatus}</span>
                </div>
                <p class="font-mono text-gray-400 mt-auto">${device.ip}</p>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <p><strong>Verzia:</strong> <span class="font-mono text-gray-300">${snmpData.version || 'N/A'}</span></p>
                <p><strong>Board:</strong> <span class="font-mono text-gray-300">${snmpData.board_name || 'N/A'}</span></p>
                <p><strong>Uptime:</strong> <span class="font-mono text-gray-300">${snmpData.uptime || 'N/A'}</span></p>
                <p><strong>CPU:</strong> <span class="font-mono text-gray-300">${snmpData.cpu_load || 'N/A'}%</span></p>
                <p><strong>Teplota:</strong> <span class="font-mono text-gray-300">${snmpData.temperature || 'N/A'} °C</span></p>
                <p><strong>CPU jadrá:</strong> <span class="font-mono text-gray-300">${snmpData.cpu_count || 'N/A'}</span></p>
                <div class="col-span-2 grid grid-cols-2 gap-2 text-sm">
                    <div class="flex flex-col">
                        <strong>SNMP interval:</strong>
                        <span class="font-mono text-gray-300 snmp-interval-val">${snmpIntervalDisplay}</span>
                    </div>
                    <div class="flex flex-col">
                        <strong>ICMP interval:</strong>
                        <span class="font-mono text-gray-300 icmp-interval-val">${icmpIntervalDisplay}</span>
                    </div>
                </div>
                <div class="col-span-2"><strong>Posl. záloha:</strong><br><span class="font-mono text-gray-300 last-backup-val">${lastBackupDisplay}</span></div>
            </div>
            <div class="flex gap-2 mt-auto pt-4 border-t border-gray-700">
                <button class="backup-btn btn flex-grow bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-1 px-1.5 rounded-lg device-btn-text flex items-center justify-center gap-1.5"><i class="fas fa-save device-btn-icon"></i> Zálohovať</button>
                <button class="snmp-btn btn flex-grow bg-sky-600 hover:bg-sky-700 text-white font-semibold py-1 px-1.5 rounded-lg device-btn-text flex items-center justify-center gap-1.5"><i class="fas fa-sync device-btn-icon"></i> SNMP</button>
                <button class="edit-btn btn bg-amber-500 hover:bg-amber-600 text-white font-semibold py-1 px-1.5 rounded-lg text-xs"><i class="fas fa-pencil-alt text-xs"></i></button>
                <button class="delete-btn btn bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-1.5 rounded-lg text-xs"><i class="fas fa-trash text-xs"></i></button>
            </div>`;
        card.querySelector('.backup-btn').addEventListener('click', (e) => { e.currentTarget.querySelector('i').classList.add('spinning'); api.post(`backup/${device.id}`); });
        card.querySelector('.snmp-btn').addEventListener('click', (e) => { 
            const btn = e.currentTarget;
            const icon = btn.querySelector('i');
            icon.classList.add('fa-spin');
            btn.disabled = true;
            api.get(`snmp/${device.id}`).catch(error => {
                // Pri chybe zastavíme spinning manuálne
                icon.classList.remove('fa-spin');
                btn.disabled = false;
            });
            // Socket handler automaticky zastaví spinning pri úspešnom update
        });
        card.querySelector('.edit-btn').addEventListener('click', () => openDeviceModal(device));
        card.querySelector('.delete-btn').addEventListener('click', () => deleteDevice(device.id, device.ip));
        return card;
    };
    
    const updateDeviceCard = (id, data) => {
        const card = document.querySelector(`[data-id="${id}"]`);
        if (!card) return;
        
        // Aktualizujeme údaje PRIAMO bez akýchkoľvek vizuálnych efektov
        if (data.last_snmp_data) {
            const snmpData = JSON.parse(data.last_snmp_data);
            const statusEl = card.querySelector('.font-mono.text-sm.font-semibold.whitespace-nowrap');
            
            // Priama aktualizácia statusu bez animácií
            statusEl.innerHTML = `<i class="fas fa-circle mr-2"></i>${data.status}`;
            statusEl.className = `font-mono text-sm font-semibold status-${data.status} whitespace-nowrap flex items-center flex-shrink-0`;
            
            // Priama aktualizácia hodnôt bez animácií
            const updateValueDirect = (selector, newValue) => {
                const element = card.querySelector(selector);
                if (element) {
                    element.textContent = newValue;
                }
            };
            
            updateValueDirect('p:nth-child(1) span', snmpData.version || 'N/A');
            updateValueDirect('p:nth-child(2) span', snmpData.board_name || 'N/A');
            updateValueDirect('p:nth-child(3) span', snmpData.uptime || 'N/A');
            updateValueDirect('p:nth-child(4) span', (snmpData.cpu_load || 'N/A') + '%');
            updateValueDirect('p:nth-child(5) span', (snmpData.temperature || 'N/A') + ' °C');
            updateValueDirect('p:nth-child(6) span', snmpData.cpu_count || 'N/A');
        }
        
        if (data.last_backup) {
            const backupEl = card.querySelector('.last-backup-val');
            if (backupEl) {
                backupEl.textContent = new Date(data.last_backup).toLocaleString('sk-SK');
            }
        }
    };

    // Filtrovanie logov
    let currentFilters = {
        device: '',
        type: '',
        level: 'all'
    };
    
    // Flag pre potlačenie automatického skrolovania počas refresh operácie
    let suppressAutoScroll = false;

    // Globálne nastavenia načítané zo servera
    let globalSettings = {
        log_retention_days: 30, // default hodnota
        ping_retention_days: 30, // default hodnota  
        snmp_retention_days: 30 // default hodnota
    };

    const LOG_FILTERS_KEY = 'mikrotik-log-filters';
    const LOG_FILTERS_STATE_KEY = 'mikrotik-log-filters-visible';

    const customSelectRegistry = {};

    function closeAllCustomSelects(exceptId = null) {
        Object.entries(customSelectRegistry).forEach(([id, instance]) => {
            if (id !== exceptId) {
                instance.wrapper.classList.remove('open');
                instance.button.setAttribute('aria-expanded', 'false');
            }
        });
    }

    function updateCustomSelectDisplay(selectId) {
        const instance = customSelectRegistry[selectId];
        if (!instance) return;
        const { select, textSpan, dropdown, placeholder } = instance;
        const value = select.value;
        const selectedOption = Array.from(select.options).find(opt => opt.value === value);
        textSpan.textContent = selectedOption ? selectedOption.textContent : placeholder;
        dropdown.querySelectorAll('.custom-select-option').forEach(optionEl => {
            const isSelected = optionEl.dataset.value === value;
            optionEl.classList.toggle('selected', isSelected);
            optionEl.setAttribute('aria-selected', isSelected ? 'true' : 'false');
        });
    }

    function buildCustomSelectOptions(selectId) {
        const instance = customSelectRegistry[selectId];
        if (!instance) return;
        const { select, dropdown } = instance;
        dropdown.innerHTML = '';
        Array.from(select.options).forEach(option => {
            const optionEl = document.createElement('div');
            optionEl.className = 'custom-select-option';
            optionEl.dataset.value = option.value;
            optionEl.textContent = option.textContent;
            optionEl.setAttribute('role', 'option');
            optionEl.setAttribute('aria-selected', option.value === select.value ? 'true' : 'false');
            if (option.disabled) {
                optionEl.classList.add('disabled');
            }
            dropdown.appendChild(optionEl);
        });
        updateCustomSelectDisplay(selectId);
    }

    function createCustomSelect(select) {
        if (!select || !select.id) return;
        const selectId = select.id;
        const placeholder = select.dataset.placeholder || 'Vyberte možnosť';
        if (customSelectRegistry[selectId]) {
            buildCustomSelectOptions(selectId);
            return;
        }

        select.classList.add('hidden');

        const wrapper = document.createElement('div');
        wrapper.className = 'custom-select w-full';
        if (select.dataset.expandDropdown === 'desktop') {
            wrapper.classList.add('expand-desktop');
        }
        wrapper.dataset.selectId = selectId;

        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'custom-select-button';
        button.setAttribute('aria-haspopup', 'listbox');
        button.setAttribute('aria-expanded', 'false');
        button.setAttribute('aria-label', placeholder);

        const textSpan = document.createElement('span');
        textSpan.className = 'custom-select-text';
        textSpan.textContent = placeholder;

        const arrowIcon = document.createElement('i');
        arrowIcon.className = 'fas fa-chevron-down custom-select-arrow';

        button.append(textSpan, arrowIcon);

        const dropdown = document.createElement('div');
        dropdown.className = 'custom-select-dropdown';
        dropdown.setAttribute('role', 'listbox');

        wrapper.append(button, dropdown);
        select.insertAdjacentElement('afterend', wrapper);

        customSelectRegistry[selectId] = {
            select,
            wrapper,
            button,
            dropdown,
            textSpan,
            placeholder
        };

        button.addEventListener('click', (event) => {
            event.stopPropagation();
            const wasOpen = wrapper.classList.contains('open');
            closeAllCustomSelects();
            if (!wasOpen) {
                wrapper.classList.add('open');
                button.setAttribute('aria-expanded', 'true');
            }
        });

        dropdown.addEventListener('click', (event) => {
            event.stopPropagation();
            const optionEl = event.target.closest('.custom-select-option');
            if (!optionEl || optionEl.classList.contains('disabled')) return;
            const value = optionEl.dataset.value;
            if (select.value !== value) {
                select.value = value;
                select.dispatchEvent(new Event('change', { bubbles: true }));
            }
            wrapper.classList.remove('open');
            button.setAttribute('aria-expanded', 'false');
        });

        select.addEventListener('change', () => updateCustomSelectDisplay(selectId));

        buildCustomSelectOptions(selectId);
    }

    function initializeCustomSelects() {
        document.querySelectorAll('select[data-custom-select]').forEach(select => {
            createCustomSelect(select);
        });
    }

    function refreshCustomSelect(selectId) {
        if (customSelectRegistry[selectId]) {
            buildCustomSelectOptions(selectId);
        } else {
            const select = document.getElementById(selectId);
            if (select) {
                createCustomSelect(select);
            }
        }
    }

document.addEventListener('click', () => closeAllCustomSelects());
document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
        closeAllCustomSelects();
    }
});
window.addEventListener('resize', () => closeAllCustomSelects());
    
    // Funkcia na kategorizáciu logov podľa typu
    const categorizeLogMessage = (message) => {
        const msgLower = message.toLowerCase();
        // Pushover notifikácie majú prioritu a zostávajú v kategórii notification
        if (msgLower.includes('notifikácia') || msgLower.includes('notification') || msgLower.includes('pushover')) return 'notification';
        // Všetky zálohovacie správy vrátane "spúšťam pokročilú zálohu" (okrem Pushover)
        const extendedBackupKeywords = [
            'spúšťam čistenie starých záloh',
            'nahraný na ftp',
            'súbory úspešne stiahnuté',
            'zariadenie nemá /flash',
            'priamy export úspešne získaný',
            'získavam priamy ssh export',
            'ssh pripojenie úspešne'
        ];
        if (msgLower.includes('záloha') || msgLower.includes('backup') || 
            msgLower.includes('spúšťam pokročilú zálohu') || msgLower.includes('spúšťam zálohu') ||
            extendedBackupKeywords.some(keyword => msgLower.includes(keyword))) return 'backup';
        // Udalosti týkajúce sa zariadenia (reštart, kritické hodnoty, verzia)
        const deviceKeywords = ['reštartovan', 'reštart', 'kritick', 'verziu', 'uptime', 'routeros', 'cpu', 'pamät', 'pamäte', 'teplot'];
        const isDeviceEvent = msgLower.includes('mikrotik') &&
            deviceKeywords.some(keyword => msgLower.includes(keyword)) &&
            !msgLower.includes('online') &&
            !msgLower.includes('offline');
        if (isDeviceEvent) return 'device';
        // Online/Offline správy (okrem Pushover notifikácií)
        if (msgLower.includes('online') || msgLower.includes('offline') || msgLower.includes('pripojené') || msgLower.includes('nedostupné')) return 'status';
        return 'system';
    };

    const sanitizeLogMessageByType = (type, message) => {
        if (type === 'device') {
            return message.replace(/^\s*[\p{Extended_Pictographic}]+\s*/u, '');
        }
        return message;
    };

    const syncLogsModalContent = () => {
        if (!logsModal || logsModal.classList.contains('hidden') || !logsModalList) return;
        logsModalList.innerHTML = logsContainer.innerHTML;
    };

    const setFilterPanelVisibility = (panel, button, visible) => {
        if (!panel) return;
        if (visible) {
            panel.classList.remove('hidden');
        } else {
            panel.classList.add('hidden');
            closeAllCustomSelects();
        }
        if (button) {
            button.setAttribute('aria-expanded', visible ? 'true' : 'false');
        }
    };

    const persistFiltersVisibility = () => {
        try {
            const state = {
                desktop: logsFilters ? !logsFilters.classList.contains('hidden') : false,
                mobile: logsFiltersMobile ? !logsFiltersMobile.classList.contains('hidden') : false
            };
            localStorage.setItem(LOG_FILTERS_STATE_KEY, JSON.stringify(state));
        } catch (error) {
            console.error('Nepodarilo sa uložiť zobrazenie filtrov:', error);
        }
    };

    const syncFilterControls = () => {
        const deviceValue = currentFilters.device || '';
        [deviceFilter, deviceFilterMobile, deviceFilterModal].forEach(select => {
            if (select) {
                select.value = deviceValue;
            }
        });

        const typeValue = currentFilters.type || '';
        [typeFilter, typeFilterMobile, typeFilterModal].forEach(select => {
            if (select) {
                select.value = typeValue;
            }
        });

        const targetLevel = (currentFilters.level || 'all');
        const capitalizedLevel = targetLevel.charAt(0).toUpperCase() + targetLevel.slice(1);
        const allLevelButtons = document.querySelectorAll('.filter-level-btn');
        const allLevelButtonsMobile = document.querySelectorAll('.filter-level-btn-mobile');
        [...allLevelButtons, ...allLevelButtonsMobile].forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll(`#level${capitalizedLevel}, #level${capitalizedLevel}Mobile, #level${capitalizedLevel}Modal`).forEach(btn => btn?.classList.add('active'));

        ['deviceFilter', 'deviceFilterMobile', 'deviceFilterModal', 'typeFilter', 'typeFilterMobile', 'typeFilterModal'].forEach(updateCustomSelectDisplay);
    };

    const closeLogsModal = () => {
        if (!logsModal) return;
        logsModal.classList.add('hidden');
        logsModalFilterBtn?.setAttribute('aria-expanded', 'false');
        logsModalFilterBtn?.classList.remove('ring-2', 'ring-purple-300');
        closeAllCustomSelects();
        document.body.classList.remove('modal-open');
    };

    const openLogsModal = () => {
        if (!logsModal) return;
        logsModal.classList.remove('hidden');
        if (logsModalFilters) {
            logsModalFilters.classList.remove('hidden');
        }
        if (logsModalFilterBtn) {
            logsModalFilterBtn.setAttribute('aria-expanded', 'true');
            logsModalFilterBtn.classList.add('ring-2', 'ring-purple-300');
        }
        document.body.classList.add('modal-open');
        closeAllCustomSelects();
        syncLogsModalContent();
        syncFilterControls();
    };

    const addLogToContainer = (level, message, device_ip = '', timestamp = new Date().toISOString()) => {
        // Offline správy budú warning
        if (message.toLowerCase().includes('offline') || message.toLowerCase().includes('nedostupné')) {
            level = 'warning';
        }
        
        const logType = categorizeLogMessage(message);
        const displayMessage = sanitizeLogMessageByType(logType, message);
        const createLogEntry = () => {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry p-2 border-l-4 log-${level} bg-gray-800 text-sm`;
            logEntry.setAttribute('data-level', level);
            logEntry.setAttribute('data-device', device_ip || '');
            logEntry.setAttribute('data-type', logType);
            logEntry.setAttribute('data-timestamp', timestamp);
            
            logEntry.innerHTML = `<p><strong class="text-gray-400">${new Date(timestamp).toLocaleString('sk-SK')}</strong> ${device_ip ? `<span class="font-mono text-sky-400">${device_ip}</span>` : ''}: ${displayMessage}</p>`;
            return logEntry;
        };
        
        // Desktop logs - pridávame na začiatok
        const desktopLogEntry = createLogEntry();
        logsContainer.prepend(desktopLogEntry);
        
        // Mobile logs - pridávame na začiatok
        const mobileLogsContainer = document.getElementById('logsContainerMobile');
        if (mobileLogsContainer) {
            const mobileLogEntry = createLogEntry();
            mobileLogsContainer.prepend(mobileLogEntry);
            
            // Udržujeme maximálne počet logov podľa nastavení (default 1000 ak nie je nastavené)
            const maxLogs = globalSettings.log_retention_days ? Math.min(globalSettings.log_retention_days * 50, 5000) : 1000;
            while (mobileLogsContainer.children.length > maxLogs) {
                mobileLogsContainer.lastChild.remove();
            }
        }
        
        // Udržujeme maximálne počet logov podľa nastavení (default 1000 ak nie je nastavené)
        const maxLogs = globalSettings.log_retention_days ? Math.min(globalSettings.log_retention_days * 50, 5000) : 1000;
        while (logsContainer.children.length > maxLogs) {
            logsContainer.lastChild.remove();
        }

        syncLogsModalContent();
    };

    // Globálna pamäť pre dôležité správy - ODSTRÁNENÁ (zjednodušujeme logging)
    
    const addLog = (level, message, device_ip = '', timestamp = new Date().toISOString()) => {
        // Úplne ignorujeme startup správy
        if (message.includes('MikroTik Manager') && message.includes('úspešne načítaný!')) {
            return; // Túto správu už nezobrazujeme vôbec
        }
        
        // Offline správy budú warning
        if (message.toLowerCase().includes('offline') || message.toLowerCase().includes('nedostupné')) {
            level = 'warning';
        }
        
        const logType = categorizeLogMessage(message);
        const displayMessage = sanitizeLogMessageByType(logType, message);
        const createLogEntry = () => {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry p-2 border-l-4 log-${level} bg-gray-800 text-sm`;
            logEntry.setAttribute('data-level', level);
            logEntry.setAttribute('data-device', device_ip || '');
            logEntry.setAttribute('data-type', logType);
            logEntry.setAttribute('data-timestamp', timestamp);
            
            logEntry.innerHTML = `<p><strong class="text-gray-400">${new Date(timestamp).toLocaleString('sk-SK')}</strong> ${device_ip ? `<span class="font-mono text-sky-400">${device_ip}</span>` : ''}: ${displayMessage}</p>`;
            return logEntry;
        };
        
        // Desktop logs
        const desktopLogEntry = createLogEntry();
        logsContainer.prepend(desktopLogEntry);
        
        // Mobile logs
        const mobileLogsContainer = document.getElementById('logsContainerMobile');
        if (mobileLogsContainer) {
            const mobileLogEntry = createLogEntry();
            mobileLogsContainer.prepend(mobileLogEntry);
            
            // Udržujeme maximálne počet logov podľa nastavení (default 1000 ak nie je nastavené)
            const maxLogs = globalSettings.log_retention_days ? Math.min(globalSettings.log_retention_days * 50, 5000) : 1000;
            while (mobileLogsContainer.children.length > maxLogs) {
                mobileLogsContainer.lastChild.remove();
            }
        }
        
        // Udržujeme maximálne počet logov podľa nastavení (default 1000 ak nie je nastavené)
        const maxLogs = globalSettings.log_retention_days ? Math.min(globalSettings.log_retention_days * 50, 5000) : 1000;
        while (logsContainer.children.length > maxLogs) {
            logsContainer.lastChild.remove();
        }

        // Aplikujeme filtre na nové logy
        applyLogFilters();

        // Automatické skrolovanie k najnovšiemu logu (len ak je log viditeľný a nie je potlačené)
        if (!desktopLogEntry.classList.contains('filtered') && !suppressAutoScroll) {
            desktopLogEntry.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        syncLogsModalContent();
    };
    


    const clearDeviceValidation = () => {
        ['devicePingInterval', 'devicePingRetryInterval'].forEach(id => {
            const input = document.getElementById(id);
            if (!input) return;
            input.style.borderColor = '#6b7280';
            // odstráň chybové hlášky
            const error = input.parentElement.querySelector('.ping-interval-error, .retry-interval-error');
            if (error) error.remove();
        });
    };

    const openDeviceModal = (device = null) => {
        deviceForm.reset();
        document.getElementById('deviceId').value = device ? device.id : '';
        document.getElementById('deviceName').value = device ? device.name : '';
        document.getElementById('deviceIp').value = device ? device.ip : '';
        document.getElementById('deviceUsername').value = device ? device.username : ''; 
        document.getElementById('deviceSnmpCommunity').value = device ? (device.snmp_community || '') : '';
        document.getElementById('deviceSnmpInterval').value = device ? (device.snmp_interval_minutes || 0) : 0;
        document.getElementById('devicePingInterval').value = device ? (device.ping_interval_seconds || 0) : 0;
        document.getElementById('devicePingRetryInterval').value = device ? (device.ping_retry_interval_seconds || 0) : 0;
        document.getElementById('deviceLowMemory').checked = device ? device.low_memory : false;
        // Heslo sa nikdy neposiela späť na frontend, takže ho nevyplňujeme
        document.getElementById('devicePassword').value = '';
        document.getElementById('devicePassword').required = !device; // Heslo je povinné len pre nové zariadenia
        
        // Dynamický placeholder text pre heslo
        const passwordField = document.getElementById('devicePassword');
        if (device) {
            passwordField.placeholder = '●●●●●●●●';
        } else {
            passwordField.placeholder = 'Zadajte heslo pre SSH pripojenie';
        }
        
        // Dynamický placeholder text pre SNMP Community
        const snmpCommunityField = document.getElementById('deviceSnmpCommunity');
        if (device && device.snmp_community) {
            snmpCommunityField.value = device.snmp_community;
            snmpCommunityField.placeholder = '';
        } else {
            snmpCommunityField.value = '';
            snmpCommunityField.placeholder = 'public';
        }
        
        clearDeviceValidation();
        deviceModal.classList.remove('hidden');
    };
    
    const openSettingsModal = async () => {
        const settings = await api.get('settings');
        Object.keys(settings).forEach(key => {
            const el = document.getElementById(key);
            if (el) el.type === 'checkbox' ? el.checked = (settings[key] === 'true') : el.value = settings[key];
        });
        Object.keys(notificationTypes).forEach(key => {
            const el = document.getElementById(key);
            if(el) el.checked = settings[key] === 'true';
        });
        toggleWeeklySettings();
        toggleSnmpHealthInterval();
        settingsModal.classList.remove('hidden');
    };

    const closeModal = () => {
        deviceModal.classList.add('hidden');
        settingsModal.classList.add('hidden');
        manageAccountModal.classList.add('hidden');
        snmpStatusModal.classList.add('hidden');
    };

    const loadDevices = async () => {
        try {
            const devices = await api.get('devices');
            if (!devices) return;
            devicesGrid.innerHTML = '';
            devices.forEach(device => devicesGrid.appendChild(createDeviceCard(device)));
            // Aktualizuj device filtre po načítaní zariadení
            await updateDeviceFilters();
        } catch (error) {
            console.error('Chyba pri načítaní zariadení:', error);
        }
    };

    const loadLogs = async () => {
        try {
            // Potlačíme automatické skrolovanie počas načítavania logov
            suppressAutoScroll = true;
            
            // Pridáme timeout pre API request
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 sekúnd timeout
            
            const logs = await fetch(`${API_URL}/api/logs`, { 
                signal: controller.signal 
            }).then(res => {
                clearTimeout(timeoutId);
                return api._handleResponse(res);
            });
            
            if (!logs || !Array.isArray(logs)) {
                console.warn('Nepodarilo sa načítať logy alebo neplatný formát');
                return;
            }
            
            // Vyčistíme existujúce logy
            logsContainer.innerHTML = '';
            const mobileLogsContainer = document.getElementById('logsContainerMobile');
            if (mobileLogsContainer) {
                mobileLogsContainer.innerHTML = '';
            }
            
            // Jednoducho pridáme všetky logy chronologicky (najnovšie prvé)
            const reversedLogs = logs.reverse();
            
            reversedLogs.forEach(log => {
                // Ignorujeme len startup správy
                if (!(log.message.includes('MikroTik Manager') && log.message.includes('úspešne načítaný!'))) {
                    addLogToContainer(log.level, log.message, log.device_ip, log.timestamp);
                }
            });
            
            // Po načítaní logov aplikujeme aktuálne filtre
            applyLogFilters();
            syncLogsModalContent();
            
        } catch (error) {
            if (error.name === 'AbortError') {
                console.warn('Načítanie logov bolo prerušené kvôli timeout');
                addLogToContainer('warning', 'Načítanie logov trvalo príliš dlho a bolo prerušené', '', new Date().toISOString());
            } else {
                console.error('Chyba pri načítaní logov:', error);
                addLogToContainer('error', 'Chyba pri načítaní logov zo servera', '', new Date().toISOString());
            }
        } finally {
            // Obnovíme automatické skrolovanie po dokončení načítavania (vrátane error stavov)
            suppressAutoScroll = false;
        }
    };

    const deleteDevice = async (id, ip) => {
        const confirmation = await showConfirmation(`Naozaj chcete odstrániť zariadenie ${ip}?`);
        if (confirmation) {
            await api.delete(`devices/${id}`);
            loadDevices();
        }
    };
    
    const showConfirmation = (message) => {
        return new Promise((resolve) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="card p-8 rounded-lg w-full max-w-sm modal-content text-center">
                    <p class="text-lg mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button class="btn-cancel btn bg-gray-600 hover:bg-gray-700 py-2 px-6 rounded-lg">Zrušiť</button>
                        <button class="btn-confirm btn btn-primary font-bold py-2 px-6 rounded-lg">Potvrdiť</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
            confirmModal.querySelector('.btn-confirm').onclick = () => {
                resolve(true);
                document.body.removeChild(confirmModal);
            };
            confirmModal.querySelector('.btn-cancel').onclick = () => {
                resolve(false);
                document.body.removeChild(confirmModal);
            };
        });
    };

    const toggleWeeklySettings = () => {
        document.getElementById('weeklySettings').style.display = document.getElementById('backup_schedule_type').value === 'weekly' ? 'block' : 'none';
    };

    const toggleSnmpHealthInterval = () => {
        const toggle = document.getElementById('snmp_health_check_enabled');
        const intervalField = document.getElementById('snmp_health_check_interval_minutes');
        if (!toggle || !intervalField) return;
        const shouldDisable = !toggle.checked;
        intervalField.readOnly = shouldDisable;
        intervalField.classList.toggle('opacity-50', shouldDisable);
        intervalField.classList.toggle('cursor-not-allowed', shouldDisable);
    };
    
    const populateNotificationTypes = () => {
        const container = document.getElementById('notificationTypes');
        container.innerHTML = Object.entries(notificationTypes).map(([key, label]) => `
            <div class="flex items-center">
                <input type="checkbox" id="${key}" name="${key}" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500">
                <label for="${key}" class="ml-2 text-sm">${label}</label>
            </div>`).join('');
    };
    
    // Funkcie pre filtrovanie logov
    const updateDeviceFilters = async () => {
        const devices = await api.get('devices');
        const options = '<option value="">Všetky zariadenia</option>' + 
            devices.map(device => `<option value="${device.ip}">${device.name} (${device.ip})</option>`).join('');
        
        if (deviceFilter) deviceFilter.innerHTML = options;
        if (deviceFilterMobile) deviceFilterMobile.innerHTML = options;
        if (deviceFilterModal) deviceFilterModal.innerHTML = options;
        refreshCustomSelect('deviceFilter');
        refreshCustomSelect('deviceFilterMobile');
        refreshCustomSelect('deviceFilterModal');
        syncFilterControls();
    };
    
    const applyLogFilters = () => {
        const entries = document.querySelectorAll('.log-entry');
        
        entries.forEach(entry => {
            const deviceFilter = entry.getAttribute('data-device');
            const typeFilter = entry.getAttribute('data-type');
            const levelFilter = entry.getAttribute('data-level');
            const messageText = entry.textContent || '';

            let visible = true;
            
            // Filter by device - hľadáme IP aj v data-device aj v texte správy
            if (currentFilters.device) {
                const deviceMatches = deviceFilter === currentFilters.device || 
                                    messageText.includes(currentFilters.device);
                if (!deviceMatches) {
                    visible = false;
                }
            }
            
            // Filter by type
            if (currentFilters.type && typeFilter !== currentFilters.type) {
                visible = false;
            }
            
            // Filter by level
            if (currentFilters.level !== 'all' && levelFilter !== currentFilters.level) {
                visible = false;
            }
            
            entry.classList.toggle('filtered', !visible);
        });
        syncLogsModalContent();
    };
    
    const persistFilters = () => {
        try {
            const payload = JSON.stringify(currentFilters);
            localStorage.setItem(LOG_FILTERS_KEY, payload);
        } catch (error) {
            console.error('Nepodarilo sa uložiť filtre logov:', error);
        }
    };

    const setupLogFilters = () => {
        try {
            const savedFilters = localStorage.getItem(LOG_FILTERS_KEY);
            if (savedFilters) {
                const parsed = JSON.parse(savedFilters);
                currentFilters = {
                    device: parsed.device || '',
                    type: parsed.type || '',
                    level: parsed.level || 'all'
                };
            }
        } catch (error) {
            console.warn('Nepodarilo sa načítať filtre logov:', error);
        }

        try {
            const savedVisibility = localStorage.getItem(LOG_FILTERS_STATE_KEY);
            if (savedVisibility) {
                const parsed = JSON.parse(savedVisibility);
                setFilterPanelVisibility(logsFilters, logsFilterBtn, !!parsed.desktop);
                setFilterPanelVisibility(logsFiltersMobile, logsFilterBtnMobile, !!parsed.mobile);
            } else {
                setFilterPanelVisibility(logsFilters, logsFilterBtn, false);
                setFilterPanelVisibility(logsFiltersMobile, logsFilterBtnMobile, false);
            }
        } catch (error) {
            console.warn('Nepodarilo sa načítať zobrazenie filtrov:', error);
            setFilterPanelVisibility(logsFilters, logsFilterBtn, false);
            setFilterPanelVisibility(logsFiltersMobile, logsFilterBtnMobile, false);
        }
        const deviceFilters = [deviceFilter, deviceFilterMobile, deviceFilterModal].filter(Boolean);
        const typeFilters = [typeFilter, typeFilterMobile, typeFilterModal].filter(Boolean);
        const levelButtons = document.querySelectorAll('.filter-level-btn');
        const levelButtonsMobile = document.querySelectorAll('.filter-level-btn-mobile');

        deviceFilters.forEach(filter => {
            filter.addEventListener('change', (e) => {
                currentFilters.device = e.target.value;
                applyLogFilters();
                syncFilterControls();
                persistFilters();
            });
        });

        typeFilters.forEach(filter => {
            filter.addEventListener('change', (e) => {
                currentFilters.type = e.target.value;
                applyLogFilters();
                syncFilterControls();
                persistFilters();
            });
        });

        [...levelButtons, ...levelButtonsMobile].forEach(btn => {
            btn.addEventListener('click', (e) => {
                const level = e.target.id
                    .replace('level', '')
                    .replace('Mobile', '')
                    .replace('Modal', '')
                    .toLowerCase();
                currentFilters.level = level || 'all';

                syncFilterControls();
                applyLogFilters();
                persistFilters();
            });
        });

        syncFilterControls();
    };

    document.getElementById('addDeviceBtn').addEventListener('click', () => openDeviceModal());
    document.getElementById('settingsBtn').addEventListener('click', () => window.location.href = '/settings.html');
    document.getElementById('cancelDeviceBtn').addEventListener('click', closeModal);
    document.getElementById('cancelSettingsBtn').addEventListener('click', closeModal);
    document.getElementById('cancelAccountManageBtn').addEventListener('click', closeModal);
    document.getElementById('closeSnmpStatusBtn').addEventListener('click', closeModal);
    document.getElementById('refreshSnmpStatusBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshSnmpStatusBtn');
        const icon = btn.querySelector('i');
        const contentDiv = document.getElementById('snmpStatusContent');
        
        // Animácia len refresh tlačidla - žiadny overlay
        icon.classList.add('fa-spin');
        btn.disabled = true;
        
        try {
            const status = await api.get('snmp/status');
            
            // Vytvoríme obsah pre modál (rovnaký kód ako v hlavnom event listeneri)
            let content = `
                <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                    <h3 class="text-lg font-semibold text-sky-400 mb-3">📊 Globálne informácie</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Globálny interval:</strong> <span class="text-green-400">${status.global_interval} minút</span></div>
                        <div><strong>Čas kontroly:</strong> <span class="text-gray-300">${new Date(status.current_time).toLocaleString('sk-SK')}</span></div>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold text-sky-400 mb-4">🔧 Stav zariadení</h3>
                <div class="grid gap-4">
            `;
            
            status.devices.forEach(device => {
                const intervalText = device.interval_setting > 0 
                    ? `${device.interval_setting} min (vlastný)` 
                    : `${status.global_interval} min (globálny)`;
                const statusClass = device.is_due ? 'text-red-400' : 'text-green-400';
                const statusIcon = device.is_due ? '🔴' : '🟢';
                const statusText = device.is_due ? 'TREBA KONTROLA' : 'Čaká';
                
                content += `
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-sky-300">${device.name}</h4>
                            <span class="font-mono text-sm text-gray-400">${device.ip}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><strong>Interval:</strong> <span class="text-gray-300">${intervalText}</span></div>
                            <div><strong>Posledná kontrola:</strong> <span class="text-gray-300">${device.last_check}</span></div>
                            <div><strong>Ďalšia kontrola:</strong> <span class="text-gray-300">${device.next_check}</span></div>
                            <div><strong>Stav:</strong> <span class="${statusClass}">${statusIcon} ${statusText}</span></div>
                        </div>
                    </div>
                `;
            });
            
            content += `</div>`;
            
            // Priamo nastavíme nový obsah modálu - žiadne fade efekty
            contentDiv.innerHTML = content;
            
        } catch (error) {
            // Zobrazíme chybu bez fade efektov
            contentDiv.innerHTML = `
                <div class="bg-red-900/20 border border-red-500 p-4 rounded-lg text-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-400 font-semibold">Chyba pri obnovovaní SNMP stavu</p>
                    <p class="text-gray-400 text-sm mt-2">Skúste to znova alebo skontrolujte pripojenie k serveru.</p>
                </div>
            `;
        } finally {
            // Vrátime tlačidlo do normálneho stavu
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }
    });
    const backupAllBtn = document.getElementById('backupAllBtn');
    const stopAllBackupsBtn = document.getElementById('stopAllBackupsBtn');
    const backupAllDefaultText = '<i class="fas fa-save"></i> Zálohovať všetky';
    let backupStatusInterval = null;
    // Persist stop request cez refresh, vyčistí sa až keď nič nebeží
    let backupStopRequested = localStorage.getItem('backupStopRequested') === 'true';

    const stopBackupStatusPolling = () => {
        if (backupStatusInterval) {
            clearInterval(backupStatusInterval);
            backupStatusInterval = null;
        }
    };

    const renderBackupStatus = (status = {}) => {
        const totalRunning = status.total_running || 0;
        const seqRunning = status.sequential_backup_running;
        const seqTotal = status.sequential_backup_total || 0;
        const seqCurrent = status.sequential_backup_current || 0;
        const isRunning = totalRunning > 0 || seqRunning;

        if (isRunning) {
            const hasSequentialTotal = seqRunning && seqTotal > 0;
            const activeCount = hasSequentialTotal ? (seqCurrent || totalRunning || 0) : totalRunning;
            const progressLabel = hasSequentialTotal ? `${activeCount}/${seqTotal}` : activeCount;
            backupAllBtn.innerHTML = `<i class="fas fa-clock"></i> Prebieha (${progressLabel})`;
            backupAllBtn.disabled = true;
            if (!backupStopRequested) {
                stopAllBackupsBtn.classList.remove('hidden');
            } else {
                stopAllBackupsBtn.classList.add('hidden');
            }
        } else {
            backupAllBtn.innerHTML = backupAllDefaultText;
            backupAllBtn.disabled = false;
            stopAllBackupsBtn.classList.add('hidden');
            backupStopRequested = false; // reset flag keď nič nebeží
            localStorage.removeItem('backupStopRequested');
        }

        return isRunning;
    };

    const fetchAndApplyBackupStatus = async () => {
        try {
            const status = await api.get('backup/status');
            const running = renderBackupStatus(status);
            if (running && !backupStatusInterval) {
                startBackupStatusPolling();
            }
            if (!running) {
                stopBackupStatusPolling();
            }
            return status;
        } catch (error) {
            console.error('Chyba pri načítaní stavu záloh:', error);
            return null;
        }
    };

    const startBackupStatusPolling = () => {
        if (backupStatusInterval) return;
        backupStatusInterval = setInterval(fetchAndApplyBackupStatus, 5000);
    };

    // Pri načítaní stránky obnovíme stav tlačidla ak už beží hromadná záloha
    fetchAndApplyBackupStatus().then((status) => {
        // Ak status signalizuje bežiacu úlohu, spustíme pravidelný refresh
        if (status && (status.total_running || status.sequential_backup_running)) {
            startBackupStatusPolling();
        }
    }).catch(() => {});

    backupAllBtn.addEventListener('click', async () => {
        backupStopRequested = false;
        localStorage.removeItem('backupStopRequested');
        const originalText = backupAllBtn.innerHTML;
        backupAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Spúšťam...';
        backupAllBtn.disabled = true;
        
        try {
            const result = await api.post('backup/all');
            if (result.status === 'success') {
                const totalDevices = result.total_devices || 0;
                const initialLabel = totalDevices ? `0/${totalDevices}` : '...';
                backupAllBtn.innerHTML = `<i class="fas fa-clock"></i> Prebieha (${initialLabel})`;
                stopAllBackupsBtn.classList.remove('hidden');
                startBackupStatusPolling();
                fetchAndApplyBackupStatus();
            } else {
                backupAllBtn.innerHTML = originalText;
                backupAllBtn.disabled = false;
            }
        } catch (error) {
            backupAllBtn.innerHTML = originalText;
            backupAllBtn.disabled = false;
            stopAllBackupsBtn.classList.add('hidden');
        }
    });

    stopAllBackupsBtn.addEventListener('click', async () => {
        backupStopRequested = true;
        localStorage.setItem('backupStopRequested', 'true');
        stopAllBackupsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Zastavujem...';
        stopAllBackupsBtn.disabled = true;
        stopAllBackupsBtn.classList.add('hidden'); // schovať hneď po kliknutí
        backupAllBtn.innerHTML = '<i class="fas fa-clock"></i> Dokončujem…';
        backupAllBtn.disabled = true;
        
        try {
            const result = await api.post('backup/stop-all');
            addLog('warning', result.message || 'Zálohy boli zastavené.');
            await fetchAndApplyBackupStatus();
        } catch (error) {
            addLog('error', 'Chyba pri zastavovaní záloh.');
        } finally {
            stopAllBackupsBtn.innerHTML = '<i class="fas fa-stop"></i> Zastaviť zálohy';
            stopAllBackupsBtn.disabled = false;
        }
    });
    document.getElementById('refreshAllSnmpBtn').addEventListener('click', async () => {
        // Skontrolujeme či už prebieha refresh
        if (isSnmpRefreshRunning) {
            return;
        }
        
        const btn = document.getElementById('refreshAllSnmpBtn');
        const icon = btn.querySelector('i');
        
        try {
            // Spustíme backend API pre hromadný refresh
            const response = await api.post('snmp/refresh-all');
            
            if (response.status === 'success') {
                // Backend API spustilo úlohu, progress bude riadený cez WebSocket
            } else {
                // Chyba zo servera
                console.error('Chyba pri spustení SNMP refresh:', response.message);
                addLog('error', response.message || 'Chyba pri spustení hromadného SNMP refresh');
            }
        } catch (error) {
            console.error('Chyba pri API volaní pre SNMP refresh:', error);
            addLog('error', 'Chyba komunikácie so serverom pri SNMP refresh');
            
            // Pri chybe vrátime tlačidlo do normálu
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }
    });
    document.getElementById('snmpStatusBtn').addEventListener('click', async () => {
        // Otvoríme modál s loading stavom
        snmpStatusModal.classList.remove('hidden');
        document.getElementById('snmpStatusContent').innerHTML = `
            <div class="flex justify-center items-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-sky-500 mr-3"></i>
                <span class="text-lg">Načítavam SNMP stav...</span>
            </div>
        `;
        
        try {
            const status = await api.get('snmp/status');
            
            // Vytvoríme obsah pre modál
            let content = `
                <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                    <h3 class="text-lg font-semibold text-sky-400 mb-3">📊 Globálne informácie</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Globálny interval:</strong> <span class="text-green-400">${status.global_interval} minút</span></div>
                        <div><strong>Čas kontroly:</strong> <span class="text-gray-300">${new Date(status.current_time).toLocaleString('sk-SK')}</span></div>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold text-sky-400 mb-4">🔧 Stav zariadení</h3>
                <div class="grid gap-4">
            `;
            
            status.devices.forEach(device => {
                const intervalText = device.interval_setting > 0 
                    ? `${device.interval_setting} min (vlastný)` 
                    : `${status.global_interval} min (globálny)`;
                const statusClass = device.is_due ? 'text-red-400' : 'text-green-400';
                const statusIcon = device.is_due ? '🔴' : '🟢';
                const statusText = device.is_due ? 'TREBA KONTROLA' : 'Čaká';
                
                content += `
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-sky-300">${device.name}</h4>
                            <span class="font-mono text-sm text-gray-400">${device.ip}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><strong>Interval:</strong> <span class="text-gray-300">${intervalText}</span></div>
                            <div><strong>Posledná kontrola:</strong> <span class="text-gray-300">${device.last_check}</span></div>
                            <div><strong>Ďalšia kontrola:</strong> <span class="text-gray-300">${device.next_check}</span></div>
                            <div><strong>Stav:</strong> <span class="${statusClass}">${statusIcon} ${statusText}</span></div>
                        </div>
                    </div>
                `;
            });
            
            content += `</div>`;
            
            // Nastavíme obsah modálu
            document.getElementById('snmpStatusContent').innerHTML = content;
            
        } catch (error) {
            document.getElementById('snmpStatusContent').innerHTML = `
                <div class="bg-red-900/20 border border-red-500 p-4 rounded-lg text-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-400 font-semibold">Chyba pri načítaní SNMP stavu</p>
                    <p class="text-gray-400 text-sm mt-2">Skúste to znova alebo skontrolujte pripojenie k serveru.</p>
                </div>
            `;
        }
    });

    logsExpandBtn?.addEventListener('click', openLogsModal);
    logsExpandBtnMobile?.addEventListener('click', openLogsModal);
    activityQuickBtn?.addEventListener('click', openLogsModal);

    logsModalRefreshBtn?.addEventListener('click', async () => {
        if (!logsModalRefreshBtn) return;
        const modalIcon = logsModalRefreshBtn.querySelector('i');
        const mainRefreshBtn = document.getElementById('refreshLogsBtn');
        const mainIcon = mainRefreshBtn?.querySelector('i');

        modalIcon?.classList.add('fa-spin');
        logsModalRefreshBtn.disabled = true;
        if (mainRefreshBtn && mainIcon) {
            mainIcon.classList.add('fa-spin');
            mainRefreshBtn.disabled = true;
        }

        try {
            await loadLogs();
        } catch (error) {
            addLog('error', 'Chyba pri obnove logov.');
        } finally {
            modalIcon?.classList.remove('fa-spin');
            logsModalRefreshBtn.disabled = false;
            if (mainRefreshBtn && mainIcon) {
                mainIcon.classList.remove('fa-spin');
                mainRefreshBtn.disabled = false;
            }
        }
    });

    logsModalExportBtn?.addEventListener('click', async () => {
        const mainExportBtn = document.getElementById('exportLogsBtn');
        const mainIcon = mainExportBtn?.querySelector('i');
        const modalIcon = logsModalExportBtn?.querySelector('i');

        if (logsModalExportBtn) {
            logsModalExportBtn.disabled = true;
        }
        modalIcon?.classList.add('fa-spin');
        if (mainExportBtn && mainIcon) {
            mainExportBtn.disabled = true;
            mainIcon.classList.add('fa-spin');
        }

        try {
            const link = document.createElement('a');
            link.href = '/api/logs/export';
            link.download = `mikrotik_logy_${new Date().toISOString().slice(0, 19).replace(/[T:]/g, '_')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            addLog('error', 'Chyba pri exporte logov');
        } finally {
            modalIcon?.classList.remove('fa-spin');
            if (logsModalExportBtn) {
                logsModalExportBtn.disabled = false;
            }
            if (mainExportBtn && mainIcon) {
                mainExportBtn.disabled = false;
                mainIcon.classList.remove('fa-spin');
            }
        }
    });

    logsModalFilterBtn?.addEventListener('click', () => {
        if (!logsModalFilters) return;
        const willShow = logsModalFilters.classList.contains('hidden');
        logsModalFilters.classList.toggle('hidden');
        logsModalFilterBtn.setAttribute('aria-expanded', willShow ? 'true' : 'false');
        logsModalFilterBtn.classList.toggle('ring-2', willShow);
        logsModalFilterBtn.classList.toggle('ring-purple-300', willShow);
        if (willShow) {
            syncFilterControls();
        }
    });

    closeLogsModalBtn?.addEventListener('click', closeLogsModal);

    logsModal?.addEventListener('click', (event) => {
        if (event.target === logsModal) {
            closeLogsModal();
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && logsModal && !logsModal.classList.contains('hidden')) {
            closeLogsModal();
        }
    });
    document.getElementById('monitoringBtn').addEventListener('click', () => {
        // Otvoríme monitoring stránku v aktuálnej záložke
        window.location.href = '/monitoring.html';
    });
    document.getElementById('backup_schedule_type').addEventListener('change', toggleWeeklySettings);
    document.getElementById('snmp_health_check_enabled').addEventListener('change', toggleSnmpHealthInterval);
    document.getElementById('testPushoverBtn').addEventListener('click', () => api.post('notifications/test'));
    
    // Event listenery pre logy
    document.getElementById('refreshLogsBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshLogsBtn');
        const icon = btn.querySelector('i');
        
        // Animácia refresh tlačidla
        icon.classList.add('fa-spin');
        btn.disabled = true;
        
        try {
            // Zavoláme pôvodnú loadLogs funkciu
            await loadLogs();
            
        } catch (error) {
            // Pôvodná funkcionalita pre chyby
            addLog('error', 'Chyba pri obnovovaní logov');
        } finally {
            // Vrátime tlačidlo do normálneho stavu
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }
    });
    
    // Filter tlačidlá pre logy
    logsFilterBtn?.addEventListener('click', () => {
        if (!logsFilters) return;
        const willShow = logsFilters.classList.contains('hidden');
        setFilterPanelVisibility(logsFilters, logsFilterBtn, willShow);
        persistFiltersVisibility();
    });

    logsFilterBtnMobile?.addEventListener('click', () => {
        if (!logsFiltersMobile) return;
        const willShow = logsFiltersMobile.classList.contains('hidden');
        setFilterPanelVisibility(logsFiltersMobile, logsFilterBtnMobile, willShow);
        persistFiltersVisibility();
    });

    // Event listenery pre mobilné tlačidlá
    document.getElementById('refreshLogsBtnMobile').addEventListener('click', () => {
        document.getElementById('refreshLogsBtn').click();
    });
    
    document.getElementById('exportLogsBtnMobile').addEventListener('click', () => {
        document.getElementById('exportLogsBtn').click();
    });
    
    // Export logov do CSV
    document.getElementById('exportLogsBtn').addEventListener('click', async () => {
        const btn = document.getElementById('exportLogsBtn');
        const icon = btn.querySelector('i');
        
        // Animácia export tlačidla
        icon.classList.add('fa-spin');
        btn.disabled = true;
        
        try {
            // Vytvoríme skrytý link pre stiahnutie
            const link = document.createElement('a');
            link.href = '/api/logs/export';
            link.download = `mikrotik_logy_${new Date().toISOString().slice(0, 19).replace(/[T:]/g, '_')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch (error) {
            addLog('error', 'Chyba pri exporte logov');
        } finally {
            // Vrátime tlačidlo do normálneho stavu
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }
    });

    deviceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const snmpCommunityValue = document.getElementById('deviceSnmpCommunity').value.trim();
        const pingIntervalInput = document.getElementById('devicePingInterval');
        const retryIntervalInput = document.getElementById('devicePingRetryInterval');
        const pingInterval = isNaN(parseInt(pingIntervalInput.value, 10)) ? 0 : parseInt(pingIntervalInput.value, 10);
        const retryInterval = isNaN(parseInt(retryIntervalInput.value, 10)) ? 0 : parseInt(retryIntervalInput.value, 10);

        const pingInvalid = pingInterval > 0 && pingInterval < 20;
        const retryInvalid = retryInterval !== 0 && (retryInterval < 5 || retryInterval > 120);

        if (pingInvalid || retryInvalid) {
            // zobrazíme chyby a neodošleme
            validateDevicePingInterval(pingIntervalInput);
            validateDeviceRetryInterval(retryIntervalInput);
            return;
        }

        const body = {
            id: document.getElementById('deviceId').value,
            name: document.getElementById('deviceName').value,
            ip: document.getElementById('deviceIp').value,
            username: document.getElementById('deviceUsername').value,
            password: document.getElementById('devicePassword').value,
            snmp_community: snmpCommunityValue || 'public', // Ak je prázdne, použije sa "public"
            snmp_interval_minutes: parseInt(document.getElementById('deviceSnmpInterval').value) || 0,
            ping_interval_seconds: pingInterval || 0,
            ping_retry_interval_seconds: retryInterval || 0,
            low_memory: document.getElementById('deviceLowMemory').checked,
        };
        const result = await api.post('devices', body);
        closeModal();
        loadDevices();
        
        // Ak je to nové zariadenie (bez ID), automaticky spusť SNMP check
        if (!body.id && result.status === 'success' && result.device_id) {
            setTimeout(() => {
                api.get(`snmp/${result.device_id}`);
            }, 1000); // Krátke oneskorenie pre načítanie zariadenia
        }
    });
    
    settingsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {};
        new FormData(settingsForm).forEach((value, key) => body[key] = value);
        settingsForm.querySelectorAll('input[type="checkbox"]').forEach(cb => body[cb.name] = cb.checked.toString());
        const result = await api.post('settings', body);
        
        // Aktualizujeme globálne nastavenia pre frontend
        if (body.log_retention_days) {
            globalSettings.log_retention_days = parseInt(body.log_retention_days);
        }
        
        closeModal();
        
        // Správa "Nastavenia boli uložené." sa už odosiela zo servera
        // addLog('success', 'Nastavenia boli uložené.');
    });

    // === Account Management Tabs ===
    const accountTabs = document.querySelectorAll('.account-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    accountTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active class from all tabs
            accountTabs.forEach(t => {
                t.classList.remove('active');
                t.classList.remove('text-sky-400', 'border-sky-400');
                t.classList.add('text-gray-400', 'border-transparent');
            });
            
            // Add active class to clicked tab
            tab.classList.add('active');
            tab.classList.remove('text-gray-400', 'border-transparent');
            tab.classList.add('text-sky-400', 'border-sky-400');
            
            // Hide all tab contents
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // Show corresponding content
            const tabId = tab.id.replace('tab', 'tab') + 'Content';
            document.getElementById(tabId).classList.remove('hidden');
            
            // Load 2FA status only when 2FA tab is clicked
            if (tab.id === 'tab2FA') {
                load2faStatus();
            }
            
            // Clear any previous messages when switching tabs
            const messageDiv = document.getElementById('accountManageMessage');
            messageDiv.classList.add('hidden');
        });
    });

    // === Password Toggle Functionality - ONLY for Password Tab ===
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('password-toggle') && 
            e.target.closest('#tabPasswordContent')) {
            const targetId = e.target.getAttribute('data-target');
            const passwordInput = document.getElementById(targetId);
            const toggleIcon = e.target;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }
    });

    // === Form Handlers ===
    changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageDiv = document.getElementById('accountManageMessage');
        
        const body = {
            old_password: document.getElementById('oldPassword').value,
            new_password: document.getElementById('newPassword').value,
            new_password_confirm: document.getElementById('newPasswordConfirm').value,
        };
        
        try {
            const result = await api.post('user/change-password', body);
            
            messageDiv.textContent = result.message;
            messageDiv.classList.remove('hidden', 'bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
            if (result.status === 'success') {
                messageDiv.classList.add('bg-green-900/50', 'text-green-300');
                changePasswordForm.reset();
                setTimeout(() => {
                    closeModal();
                    messageDiv.classList.add('hidden');
                }, 2000);
            } else {
                messageDiv.classList.add('bg-red-900/50', 'text-red-300');
            }
        } catch (error) {
            console.error('Password change error:', error);
            messageDiv.textContent = 'Nastala chyba pri zmene hesla.';
            messageDiv.classList.remove('hidden', 'bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
            messageDiv.classList.add('bg-red-900/50', 'text-red-300');
        }
    });

    changeUsernameForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageDiv = document.getElementById('accountManageMessage');
        const body = {
            new_username: document.getElementById('newUsername').value,
            password: document.getElementById('confirmPasswordUsername').value,
        };
        
        try {
            const result = await api.post('user/change-username', body);
            
            messageDiv.textContent = result.message;
            messageDiv.classList.remove('hidden', 'bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
            if (result.status === 'success') {
                messageDiv.classList.add('bg-green-900/50', 'text-green-300');
                changeUsernameForm.reset();
                setTimeout(() => {
                    closeModal();
                    messageDiv.classList.add('hidden');
                    // Refresh user status to show updated username
                    loadUserStatus();
                }, 2000);
            } else {
                messageDiv.classList.add('bg-red-900/50', 'text-red-300');
            }
        } catch (error) {
            console.error('Username change error:', error);
            messageDiv.textContent = 'Nastala chyba pri zmene používateľského mena.';
            messageDiv.classList.remove('hidden', 'bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
            messageDiv.classList.add('bg-red-900/50', 'text-red-300');
        }
    });

    // Validácia ping intervalov v device modale – rovnaké pravidlá ako v monitoring.html
    function validateDevicePingInterval(input) {
        const value = parseInt(input.value);
        const errorElement = input.parentElement.querySelector('.ping-interval-error');
        
        if (errorElement) {
            errorElement.remove();
        }
        
        if (input.value !== '' && value > 0 && value < 20) {
            const error = document.createElement('div');
            error.className = 'ping-interval-error text-xs text-red-400 mt-1';
            error.textContent = 'Ping interval musí byť 0 (globálne) alebo minimálne 20 sekúnd';
            input.parentElement.appendChild(error);
            input.style.borderColor = '#f87171';
        } else {
            input.style.borderColor = '#6b7280';
        }
    }

    function validateDeviceRetryInterval(input) {
        const value = parseInt(input.value);
        const errorElement = input.parentElement.querySelector('.retry-interval-error');
        
        if (errorElement) {
            errorElement.remove();
        }
        
        if (input.value !== '' && value !== 0 && (value < 5 || value > 120)) {
            const error = document.createElement('div');
            error.className = 'retry-interval-error text-xs text-red-400 mt-1';
            error.textContent = 'Retry interval musí byť 0 (globálne) alebo v rozsahu 5-120 sekúnd';
            input.parentElement.appendChild(error);
            input.style.borderColor = '#f87171';
        } else {
            input.style.borderColor = '#6b7280';
        }
    }

    // === 2FA Management Functions ===
    
    // Load 2FA status
    const load2faStatus = async () => {
        try {
            const data = await api.get('user/backup-codes');
            
            if (data && typeof data.remaining_codes !== 'undefined') {
                const remainingCodes = data.remaining_codes || 0;
                const remainingCodesElement = document.getElementById('remainingCodes');
                if (remainingCodesElement) {
                    remainingCodesElement.textContent = remainingCodes;
                }
            }
            
        } catch (error) {
            console.error('Chyba pri načítavaní 2FA stavu:', error);
            
            // Ak nie je 2FA aktivované, jednoducho nezobrazíme nič
            if (error.message.includes('403') || error.message.includes('2FA nie je aktivované')) {
                const remainingCodesElement = document.getElementById('remainingCodes');
                if (remainingCodesElement) {
                    remainingCodesElement.textContent = '2FA nie je aktivované';
                }
            }
        }
    };
    
    // Generate backup codes
    const generateBackupCodes = async (password) => {
        const messageDiv = document.getElementById('confirmPasswordMessage');
        
        try {
            // Skryje predchádzajúce chybové správy
            messageDiv.classList.add('hidden');
            
            const data = await api.post('user/backup-codes', { password });
            
            if (data && data.status === 'success' && data.backup_codes) {
                displayBackupCodes(data.backup_codes);
                confirmPasswordModal.classList.add('hidden');
                backupCodesModal.classList.remove('hidden');
                return true;
            } else {
                throw new Error(data?.message || 'Neplatná odpoveď zo servera');
            }
        } catch (error) {
            console.error('Chyba pri generovaní záložných kódov:', error);
            
            let errorMessage = 'Chyba pri generovaní záložných kódov';
            
            if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                errorMessage = 'Nesprávne heslo';
            } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                errorMessage = 'Nemáte oprávnenie na túto operáciu';
            } else if (error.message.includes('500')) {
                errorMessage = 'Chyba servera. Skúste to znova neskôr.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            messageDiv.textContent = errorMessage;
            messageDiv.classList.remove('hidden', 'bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
            messageDiv.classList.add('bg-red-900/50', 'text-red-300');
            return false;
        }
    };
    
    // Display backup codes
    const displayBackupCodes = (codes) => {
        const container = document.getElementById('backupCodesDisplay');
        container.innerHTML = '';
        
        codes.forEach(code => {
            const codeDiv = document.createElement('div');
            codeDiv.className = 'bg-gray-800 p-2 rounded text-center text-gray-200';
            codeDiv.textContent = code;
            container.appendChild(codeDiv);
        });
    };
    
    // Download backup codes as file
    const downloadBackupCodes = () => {
        const codes = Array.from(document.getElementById('backupCodesDisplay').children)
            .map(div => div.textContent)
            .join('\n');
        
        const blob = new Blob([
            `MikroTik Manager - Záložné kódy pre 2FA\n` +
            `Vygenerované: ${new Date().toLocaleString('sk-SK')}\n\n` +
            `DÔLEŽITÉ:\n` +
            `- Každý kód možno použiť iba jedenkrát\n` +
            `- Uložte si tieto kódy na bezpečné miesto\n` +
            `- Nikomu ich neposkytujte\n\n` +
            `Záložné kódy:\n${codes}`
        ], { type: 'text/plain' });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mikrotik-backup-codes-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };
    
    // Print backup codes
    const printBackupCodes = () => {
        const codes = Array.from(document.getElementById('backupCodesDisplay').children)
            .map(div => div.textContent);
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>MikroTik Manager - Záložné kódy</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .warning { background-color: #fee; border: 1px solid #fcc; padding: 15px; margin: 20px 0; border-radius: 5px; }
                        .codes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
                        .code { background-color: #f9f9f9; padding: 10px; text-align: center; font-family: monospace; font-size: 14px; border: 1px solid #ddd; border-radius: 3px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>MikroTik Manager</h1>
                        <h2>Záložné kódy pre dvojfaktorové overenie</h2>
                        <p>Vygenerované: ${new Date().toLocaleString('sk-SK')}</p>
                    </div>
                    <div class="warning">
                        <h3>⚠️ DÔLEŽITÉ UPOZORNENIE</h3>
                        <ul>
                            <li>Každý kód možno použiť iba jedenkrát</li>
                            <li>Uložte si tieto kódy na bezpečné miesto</li>
                            <li>Nikomu ich neposkytujte</li>
                            <li>Po použití kódu ho vyškrtnite zo zoznamu</li>
                        </ul>
                    </div>
                    <div class="codes">
                        ${codes.map(code => `<div class="code">${code}</div>`).join('')}
                    </div>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    };
    
    // Event listeners for 2FA functionality
    document.getElementById('generateBackupCodesBtn').addEventListener('click', () => {
        manageAccountModal.classList.add('hidden');
        confirmPasswordModal.classList.remove('hidden');
        document.getElementById('confirmPasswordInput').focus();
    });
    
    document.getElementById('cancelConfirmPasswordBtn').addEventListener('click', () => {
        confirmPasswordModal.classList.add('hidden');
        manageAccountModal.classList.remove('hidden');
        document.getElementById('confirmPasswordForm').reset();
        document.getElementById('confirmPasswordMessage').classList.add('hidden');
    });
    
    document.getElementById('confirmPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('confirmPasswordInput').value;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generujem...';
        
        try {
            await generateBackupCodes(password);
        } finally {
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
    
    document.getElementById('closeBackupCodesBtn').addEventListener('click', () => {
        backupCodesModal.classList.add('hidden');
        manageAccountModal.classList.remove('hidden');
        
        // Automatically switch to 2FA tab
        const accountTabs = document.querySelectorAll('.account-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const tab2FA = document.getElementById('tab2FA');
        
        // Remove active class from all tabs
        accountTabs.forEach(t => {
            t.classList.remove('active');
            t.classList.remove('text-sky-400', 'border-sky-400');
            t.classList.add('text-gray-400', 'border-transparent');
        });
        
        // Add active class to 2FA tab
        tab2FA.classList.add('active');
        tab2FA.classList.remove('text-gray-400', 'border-transparent');
        tab2FA.classList.add('text-sky-400', 'border-sky-400');
        
        // Hide all tab contents
        tabContents.forEach(content => content.classList.add('hidden'));
        
        // Show 2FA tab content
        document.getElementById('tab2FAContent').classList.remove('hidden');
        
        // Refresh the status
        load2faStatus();
        
        document.getElementById('confirmPasswordForm').reset();
        document.getElementById('confirmPasswordMessage').classList.add('hidden');
    });
    
    document.getElementById('downloadCodesBtn').addEventListener('click', downloadBackupCodes);
    document.getElementById('printCodesBtn').addEventListener('click', printBackupCodes);
    
    // Close modals when clicking outside
    [confirmPasswordModal, backupCodesModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                manageAccountModal.classList.remove('hidden');
            }
        });
    });

    // Inicializácia aplikácie
    const initializeApp = async () => {
        try {
            // Načítame globálne nastavenia pre frontend limity
            try {
                const settings = await api.get('settings');
                if (settings && settings.log_retention_days) {
                    globalSettings.log_retention_days = parseInt(settings.log_retention_days);
                }
            } catch (error) {
                console.warn('Nepodarilo sa načítať nastavenia, používam predvolené hodnoty');
            }
            
            // Načítavame postupne, nie všetko naraz
            await loadUserStatus();
            populateNotificationTypes();
            setupLogFilters();
            initializeCustomSelects();
            ['deviceFilter', 'deviceFilterMobile', 'deviceFilterModal', 'typeFilter', 'typeFilterMobile', 'typeFilterModal'].forEach(refreshCustomSelect);
            
            // Malé oneskorenie medzi operáciami
            await new Promise(resolve => setTimeout(resolve, 100));
            await updateDeviceFilters();
            
            await new Promise(resolve => setTimeout(resolve, 100));
            await loadDevices();
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Načítanie logov bez startup správy
            await loadLogs();
            
            // Skontrolujeme stav SNMP refresh na backend-e
            setTimeout(async () => {
                try {
                    const refreshStatus = await api.get('snmp/refresh-all/status');
                    if (refreshStatus.is_running) {
                        // Ak prebieha refresh, aktualizujeme UI
                        updateSnmpRefreshButton('processing', 
                            refreshStatus.progress.current, 
                            refreshStatus.progress.total);
                        isSnmpRefreshRunning = true;
                    }
                } catch (error) {
                    console.warn('Nepodarilo sa načítať stav SNMP refresh:', error);
                }
            }, 500); // Malé oneskorenie aby sa všetko stihlo načítať
        } catch (error) {
            console.error('Chyba pri inicializácii aplikácie:', error);
            addLogToContainer('error', 'Chyba pri inicializácii aplikácie', '', new Date().toISOString());
        }
    };
    
    // Spustenie inicializácie
    initializeApp();

    // Funkcie pre prepínanie témy
    function initTheme() {
        const savedTheme = localStorage.getItem('mikrotik-theme') || 'dark';
        document.body.className = savedTheme === 'light' ? 'light-theme p-4 md:p-8' : 'p-4 md:p-8';
        updateThemeIcon();
    }
    
    function toggleTheme() {
        const isLight = document.body.classList.contains('light-theme');
        if (isLight) {
            document.body.className = 'p-4 md:p-8';
            localStorage.setItem('mikrotik-theme', 'dark');
        } else {
            document.body.className = 'light-theme p-4 md:p-8';
            localStorage.setItem('mikrotik-theme', 'light');
        }
        updateThemeIcon();
    }
    
    function updateThemeIcon() {
        const icon = document.getElementById('theme-icon');
        const isLight = document.body.classList.contains('light-theme');
        icon.className = isLight ? 'fas fa-moon' : 'fas fa-sun';
    }
    
    // Inicializácia témy pri načítaní stránky
    initTheme();
    
    // Event listener pre prepínač témy
    document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);
});
</script>

<!-- Debug Panel -->
<div id="debugPanel" class="debug-panel">
    <div class="debug-panel-header">
        <div class="debug-panel-title">
            <i class="fas fa-bug"></i>
            Debug Logs
        </div>
        <div class="debug-panel-controls">
            <button id="debugClearBtn" class="debug-panel-btn" title="Vymazať logy">
                <i class="fas fa-trash"></i>
            </button>
            <button id="debugCopyBtn" class="debug-panel-btn" title="Kopírovať všetky logy">
                <i class="fas fa-copy"></i>
            </button>
            <button id="debugMinimizeBtn" class="debug-panel-btn" title="Minimalizovať">
                <i class="fas fa-minus"></i>
            </button>
            <button id="debugCloseBtn" class="debug-panel-btn" title="Zavrieť">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div id="debugPanelContent" class="debug-panel-content">
        <!-- Debug logs will be inserted here -->
    </div>
</div>

<script>
// Debug Panel Implementation for index.html
let debugSettings = {};
let debugPanelLogs = [];
let debugPanelVisible = false;

// Load debug settings
const loadDebugSettings = async () => {
    try {
        const response = await fetch('/api/settings');
        const settings = await response.json();
        debugSettings = settings;
        
        // Show debug panel automatically if enabled in settings
        const showDebugPanel = settings.debug_chart_frontend_panel === 'true' || settings.debug_master_switch === 'true';
        
        if (showDebugPanel && !debugPanelVisible) {
            document.getElementById('debugPanel').classList.add('visible');
            debugPanelVisible = true;
        } else if (!showDebugPanel && debugPanelVisible) {
            document.getElementById('debugPanel').classList.remove('visible');
            debugPanelVisible = false;
        }
    } catch (error) {
        console.error('Failed to load debug settings:', error);
    }
};

// Debug logging function
function debugLog(debugType, message, ...args) {
    // Check if any debug is enabled
    if (debugSettings[debugType] !== 'true' && debugSettings['debug_master_switch'] !== 'true') {
        return;
    }
    
    // If debug panel is enabled, log to panel
    if (debugSettings.debug_chart_frontend_panel === 'true' || debugSettings.debug_master_switch === 'true') {
        addLogToPanel(debugType, message, args);
    }
}

// Add log to debug panel
function addLogToPanel(debugType, message, args) {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = {
        timestamp,
        type: debugType,
        message,
        args: args.length > 0 ? args : null
    };
    
    debugPanelLogs.push(logEntry);
    
    // Limit to last 100 logs
    if (debugPanelLogs.length > 100) {
        debugPanelLogs.shift();
    }
    
    updateDebugPanelContent();
}

// Update debug panel content
function updateDebugPanelContent() {
    const content = document.getElementById('debugPanelContent');
    if (!content) return;
    
    content.innerHTML = debugPanelLogs.map(log => {
        const argsHtml = log.args ? `<div class="debug-args">${JSON.stringify(log.args, null, 2)}</div>` : '';
        return `
            <div class="debug-log-entry ${log.type}">
                <span class="debug-timestamp">${log.timestamp}</span>
                <span class="debug-type">[${log.type.toUpperCase()}]</span>
                <span class="debug-message">${log.message}</span>
                ${argsHtml}
            </div>
        `;
    }).join('');
    
    // Auto scroll to bottom
    content.scrollTop = content.scrollHeight;
}

// Debug panel controls
document.addEventListener('DOMContentLoaded', function() {
    loadDebugSettings();
    
    // Check for debug settings changes when user returns to page
    window.addEventListener('focus', function() {
        if (!window._lastDebugCheck || Date.now() - window._lastDebugCheck > 5000) {
            loadDebugSettings();
            window._lastDebugCheck = Date.now();
        }
    });
    
    // Debug panel controls
    document.getElementById('debugClearBtn')?.addEventListener('click', function() {
        debugPanelLogs = [];
        updateDebugPanelContent();
        debugLog('debug_device_operations', 'Debug panel cleared');
    });
    
    document.getElementById('debugCopyBtn')?.addEventListener('click', function() {
        const logsText = debugPanelLogs.map(log => {
            const argsText = log.args ? ` | ${JSON.stringify(log.args)}` : '';
            return `${log.timestamp} [${log.type.toUpperCase()}] ${log.message}${argsText}`;
        }).join('\n');
        
        navigator.clipboard.writeText(logsText).then(() => {
            debugLog('debug_device_operations', 'Debug logs copied to clipboard');
        });
    });
    
    document.getElementById('debugMinimizeBtn')?.addEventListener('click', function() {
        const panel = document.getElementById('debugPanel');
        const content = panel.querySelector('.debug-panel-content');
        const isMinimized = panel.style.height === '40px';
        
        if (isMinimized) {
            panel.style.height = '';
            content.style.display = 'flex';
        } else {
            panel.style.height = '40px';
            content.style.display = 'none';
        }
    });
    
    document.getElementById('debugCloseBtn')?.addEventListener('click', function() {
        document.getElementById('debugPanel').classList.remove('visible');
        debugPanelVisible = false;
    });
    
    // Keyboard shortcut Ctrl+D - only works if debug panel is enabled
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'd') {
            e.preventDefault();
            const showDebugPanel = debugSettings.debug_chart_frontend_panel === 'true' || debugSettings.debug_master_switch === 'true';
            if (showDebugPanel) {
                const panel = document.getElementById('debugPanel');
                if (debugPanelVisible) {
                    panel.classList.remove('visible');
                    debugPanelVisible = false;
                } else {
                    panel.classList.add('visible');
                    debugPanelVisible = true;
                }
            }
        }
    });
});

// Export debugLog to window scope for use in other scripts
window.debugLog = debugLog;
</script>

</body>
</html>
