<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroTik Backup Manager v2.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --main-bg: #111827; --card-bg: #1f2937; --border-color: #374151; 
            --text-color: #d1d5db; --accent-color: #38bdf8; --accent-color-hover: #0ea5e9;
        }
        body { background-color: var(--main-bg); color: var(--text-color); font-family: 'Inter', sans-serif; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 0 15px rgba(56, 189, 248, 0.1); border-color: rgba(56, 189, 248, 0.3); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn-primary { background-color: var(--accent-color); color: #ffffff; }
        .btn-primary:hover { background-color: var(--accent-color-hover); }
        
        /* Hover anim√°cie pre hlavn√© tlaƒçidl√° */
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Anim√°cie pre svetl√∫ t√©mu */
        body.light-theme .btn:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .status-online { color: #4ade80; }
        .status-offline { color: #f87171; }
        .status-unknown { color: #9ca3af; }
        
        /* Stavy zariaden√≠ v svetlej t√©me - menej saturovan√© farby */
        body.light-theme .status-online {
            color: #16a34a !important; /* Tmav≈°ia, menej saturovan√° zelen√° */
        }
        
        body.light-theme .status-offline {
            color: #dc2626 !important; /* Tmav≈°ia, menej saturovan√° ƒçerven√° */
        }
        
        body.light-theme .status-unknown {
            color: #6b7280 !important; /* Tmav≈°ia siv√° pre lep≈°√≠ kontrast */
        }
        .log-info { border-left-color: #38bdf8; }
        .log-success { border-left-color: #4ade80; }
        .log-warning { border-left-color: #facc15; }
        .log-error { border-left-color: #f87171; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }
        .modal-content { animation: modal-fade-in 0.3s ease-out; }
        @keyframes modal-fade-in { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: var(--card-bg); }
        .modal-content::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 10px; border: 2px solid var(--card-bg); }
        
        /* Posuvn√≠k pre logy aktiv√≠t - tmav√© t√©ma */
        #logsContainer::-webkit-scrollbar { width: 8px; }
        #logsContainer::-webkit-scrollbar-track { background: #1f2937; border-radius: 4px; }
        #logsContainer::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; border: 1px solid #374151; }
        #logsContainer::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }
        
        /* ≈†t√Ωly pre log filtre */
        .filter-level-btn, .filter-level-btn-mobile { 
            transition: all 0.2s ease; 
            border: 1px solid transparent;
        }
        .filter-level-btn.active, .filter-level-btn-mobile.active { 
            border-color: #38bdf8; 
            box-shadow: 0 0 5px rgba(56, 189, 248, 0.3);
        }
        .log-entry { 
            transition: opacity 0.2s ease; 
        }
        .log-entry.filtered { 
            display: none; 
        }
        
        .mr-84 { margin-right: 0; }
        .activity-log { width: 100%; }
        .activity-right { right: auto; }
        .main-content-wrapper { display: flex; gap: 2rem; align-items: flex-start; }
        .left-content { flex: 1; }
        .right-sidebar { width: 24rem; min-width: 20rem; }
        @media (max-width: 1400px) {
            .right-sidebar { width: 20rem; min-width: 18rem; }
        }
        @media (max-width: 1200px) {
            .right-sidebar { width: 18rem; min-width: 16rem; }
        }
        @media (max-width: 1024px) {
            .main-content-wrapper { flex-direction: column; }
            .right-sidebar { display: none !important; }
            #mobileLogs { display: block !important; }
            #userStatus { text-align: right !important; }
        }
        @media (min-width: 1025px) {
            #mobileLogs { display: none !important; }
        }
        header h1 {
            margin-left: -2rem;
            text-align: center;
        }
        @media (max-width: 768px) {
            header h1 {
                margin-left: 0;
            }
        }
        
        /* Tlaƒçidlo prep√≠naƒça t√©my */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .theme-toggle:hover {
            border-color: var(--accent-color);
            background-color: rgba(56, 189, 248, 0.1);
        }

        /* Svetl√° t√©ma */
        body.light-theme {
            --main-bg: #f1f5f9;
            --card-bg: #f8fafc;
            --border-color: #cbd5e1;
            --text-color: #334155;
            --accent-color: #0369a1;
            --accent-color-hover: #0284c7;
        }
        
        /* Texty v svetlej t√©me */
        body.light-theme h1,
        body.light-theme h2,
        body.light-theme h3,
        body.light-theme .text-white {
            color: var(--text-color) !important;
        }
        
        body.light-theme .text-gray-400,
        body.light-theme .text-gray-300 {
            color: #64748b !important;
        }
        
        body.light-theme .text-gray-200 {
            color: var(--text-color) !important;
        }
        
        body.light-theme .text-sky-400,
        body.light-theme .text-sky-500 {
            color: var(--accent-color) !important;
        }
        
        /* Input fields a select v svetlej t√©me */
        body.light-theme input,
        body.light-theme select,
        body.light-theme textarea {
            background-color: #ffffff !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }
        
        body.light-theme input:focus,
        body.light-theme select:focus,
        body.light-theme textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1) !important;
        }
        
        /* Log entries v svetlej t√©me */
        body.light-theme .log-entry {
            background-color: #ffffff !important;
            color: var(--text-color) !important;
        }
        
        body.light-theme .log-entry strong {
            color: #64748b !important;
        }
        
        /* Filter buttons v svetlej t√©me */
        body.light-theme .filter-level-btn,
        body.light-theme .filter-level-btn-mobile {
            background-color: #e2e8f0 !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }
        
        body.light-theme .filter-level-btn:hover,
        body.light-theme .filter-level-btn-mobile:hover {
            background-color: #cbd5e1 !important;
        }
        
        body.light-theme .filter-level-btn.active,
        body.light-theme .filter-level-btn-mobile.active {
            background-color: var(--accent-color) !important;
            color: #ffffff !important;
        }
        
        /* Tlaƒçidl√° v svetlej t√©me */
        body.light-theme .btn {
            color: #ffffff !important;
        }
        
        body.light-theme .btn-primary {
            background-color: var(--accent-color) !important;
            color: #ffffff !important;
        }
        
        body.light-theme .btn-primary:hover {
            background-color: var(--accent-color-hover) !important;
        }
        
        body.light-theme .bg-green-600 {
            background-color: #16a34a !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-green-600:hover,
        body.light-theme .hover\:bg-green-700:hover {
            background-color: #15803d !important;
        }
        
        body.light-theme .bg-blue-600 {
            background-color: #2563eb !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-blue-600:hover,
        body.light-theme .hover\:bg-blue-700:hover {
            background-color: #1d4ed8 !important;
        }
        
        body.light-theme .bg-red-600 {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-red-600:hover,
        body.light-theme .hover\:bg-red-700:hover {
            background-color: #b91c1c !important;
        }
        
        body.light-theme .bg-purple-600 {
            background-color: #9333ea !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-purple-600:hover,
        body.light-theme .hover\:bg-purple-700:hover {
            background-color: #7c3aed !important;
        }
        
        body.light-theme .bg-orange-600 {
            background-color: #ea580c !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-orange-600:hover,
        body.light-theme .hover\:bg-orange-700:hover {
            background-color: #c2410c !important;
        }
        
        body.light-theme .bg-gray-600 {
            background-color: #4b5563 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-gray-600:hover,
        body.light-theme .hover\:bg-gray-700:hover {
            background-color: #374151 !important;
        }
        
        body.light-theme .bg-yellow-500 {
            background-color: #eab308 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-yellow-500:hover,
        body.light-theme .hover\:bg-yellow-600:hover {
            background-color: #ca8a04 !important;
        }
        
        body.light-theme .bg-teal-600 {
            background-color: #0d9488 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-teal-600:hover,
        body.light-theme .hover\:bg-teal-700:hover {
            background-color: #0f766e !important;
        }
        
        body.light-theme .theme-toggle {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme #logsContainer::-webkit-scrollbar-track {
            background: #f8fafc;
        }
        
        body.light-theme #logsContainer::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border: 1px solid #e2e8f0;
        }
        
        body.light-theme #logsContainer::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        
        body.light-theme .modal-content::-webkit-scrollbar-track {
            background: var(--card-bg);
        }
        
        body.light-theme .modal-content::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border: 2px solid var(--card-bg);
        }
        
        /* Mod√°lne okn√° v svetlej t√©me */
        body.light-theme .modal-content,
        body.light-theme #deviceModal .card,
        body.light-theme #settingsModal .card,
        body.light-theme #changePasswordModal .card,
        body.light-theme #manage2faModal .card,
        body.light-theme #confirmPasswordModal .card,
        body.light-theme #backupCodesModal .card,
        body.light-theme #snmpStatusModal .card {
            background-color: #ffffff !important;
            border-color: var(--border-color) !important;
        }
        
        /* 2FA mod√°ly - svetl√Ω re≈æim texty */
        body.light-theme #manage2faModal h2,
        body.light-theme #manage2faModal h3,
        body.light-theme #confirmPasswordModal h2,
        body.light-theme #backupCodesModal h2 {
            color: var(--text-color) !important;
        }
        
        body.light-theme #manage2faModal p,
        body.light-theme #manage2faModal span,
        body.light-theme #confirmPasswordModal p,
        body.light-theme #backupCodesModal p {
            color: var(--text-color) !important;
        }
        
        body.light-theme #manage2faModal .text-gray-400,
        body.light-theme #manage2faModal .text-gray-300,
        body.light-theme #confirmPasswordModal .text-gray-400 {
            color: #6b7280 !important;
        }
        
        body.light-theme #manage2faModal .bg-gray-800 {
            background-color: #f3f4f6 !important;
            border: 1px solid #d1d5db !important;
        }
        
        body.light-theme #confirmPasswordModal input,
        body.light-theme #backupCodesModal input {
            background-color: #f9fafb !important;
            border-color: #d1d5db !important;
            color: var(--text-color) !important;
        }
        
        body.light-theme #backupCodesModal .backup-code {
            background-color: #f9fafb !important;
            border-color: #d1d5db !important;
            color: var(--text-color) !important;
        }
        
        /* Labels v svetlej t√©me */
        body.light-theme label {
            color: var(--text-color) !important;
        }
        
        /* Sekƒçn√© nadpisy v svetlej t√©me */
        body.light-theme h3.text-sky-400 {
            color: var(--accent-color) !important;
            border-bottom-color: var(--border-color) !important;
        }
        
        /* Mal√© texty a pomocn√© texty v svetlej t√©me */
        body.light-theme small.text-gray-400 {
            color: #64748b !important;
        }
        
        /* Hranice v svetlej t√©me */
        body.light-theme .border-gray-600,
        body.light-theme .border-gray-700 {
            border-color: var(--border-color) !important;
        }
        
        /* Tlaƒçidl√° X v mod√°lnych okn√°ch - tmav√° t√©ma (z√°kladn√°) */
        #closeSnmpStatusBtn.btn.bg-gray-600,
        #refreshSnmpStatusBtn.btn.bg-gray-600,
        #closeSettingsBtn.btn.bg-gray-600 {
            background-color: #4b5563 !important;
            color: #ffffff !important;
            border: 1px solid #6b7280 !important;
        }
        
        #closeSnmpStatusBtn.btn.bg-gray-600:hover,
        #refreshSnmpStatusBtn.btn.bg-gray-600:hover,
        #closeSettingsBtn.btn.bg-gray-600:hover {
            background-color: #374151 !important;
            color: #ffffff !important;
        }
        
        /* Tlaƒçidl√° X v mod√°lnych okn√°ch - svetl√° t√©ma */
        body.light-theme #closeSnmpStatusBtn.btn.bg-gray-600,
        body.light-theme #refreshSnmpStatusBtn.btn.bg-gray-600 {
            background-color: #e2e8f0 !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        body.light-theme #closeSnmpStatusBtn.btn.bg-gray-600:hover,
        body.light-theme #refreshSnmpStatusBtn.btn.bg-gray-600:hover {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        body.light-theme #closeSettingsBtn.btn.bg-gray-600 {
            background-color: #e2e8f0 !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        body.light-theme #closeSettingsBtn.btn.bg-gray-600:hover {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        /* Nastavenia tlaƒçidlo - svetl√° t√©ma */
        body.light-theme #settingsBtn.bg-gray-600 {
            background-color: #64748b !important;
            color: #ffffff !important;
        }
        
        body.light-theme #settingsBtn.bg-gray-600:hover {
            background-color: #475569 !important;
        }
        
        /* Tlaƒçidlo Zru≈°i≈• v mod√°lnych okn√°ch - svetl√° t√©ma */
        body.light-theme #cancelDeviceBtn,
        body.light-theme #cancelSettingsBtn,
        body.light-theme #cancelPasswordChangeBtn {
            background-color: #9ca3af !important;
            color: #ffffff !important;
        }
        
        body.light-theme #cancelDeviceBtn:hover,
        body.light-theme #cancelSettingsBtn:hover,
        body.light-theme #cancelPasswordChangeBtn:hover {
            background-color: #6b7280 !important;
        }
        
        /* SNMP modal obsah v svetlej t√©me */
        body.light-theme #snmpStatusContent,
        body.light-theme #snmpStatusContent div,
        body.light-theme #snmpStatusContent span {
            background-color: transparent !important;
            color: var(--text-color) !important;
        }
        
        /* SNMP tabulky v svetlej t√©me */
        body.light-theme table,
        body.light-theme thead,
        body.light-theme tbody,
        body.light-theme tr,
        body.light-theme th,
        body.light-theme td {
            background-color: #ffffff !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }
        
        body.light-theme th {
            background-color: #f1f5f9 !important;
            font-weight: 600 !important;
        }
        
        body.light-theme tr:nth-child(even) td {
            background-color: #f8fafc !important;
        }
        
        body.light-theme tr:hover td {
            background-color: #e2e8f0 !important;
        }
        
        /* V≈°etky elementy v SNMP mod√°li - svetl√° t√©ma */
        body.light-theme #snmpStatusModal * {
            color: var(--text-color) !important;
        }
        
        body.light-theme #snmpStatusModal .bg-gray-800,
        body.light-theme #snmpStatusModal .bg-gray-700,
        body.light-theme #snmpStatusModal .bg-gray-600 {
            background-color: #ffffff !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Prep√≠naƒç t√©my -->
    <button class="theme-toggle" id="themeToggleBtn" title="Prepn√∫≈• t√©mu">
        <i class="fas fa-sun" id="theme-icon"></i>
    </button>
    
    <div id="app" class="container mx-auto relative">
        <!-- User info -->
        <div id="userStatus" class="text-right p-4 mb-4">
            <!-- T√°to ƒças≈• sa napln√≠ dynamicky cez JavaScript -->
        </div>

        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-white mb-2">üõ°Ô∏è MikroTik Backup Manager v2.8</h1>
            <p class="text-lg text-gray-400">Spr√°va, z√°lohovanie a monitoring va≈°ich MikroTik zariaden√≠.</p>
        </header>

        <div class="main-content-wrapper">
            <div class="left-content">
                <div class="card p-4 rounded-lg mb-8 flex flex-wrap gap-4 items-center justify-center">
                    <button id="addDeviceBtn" class="btn btn-primary font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Prida≈• zariadenie</button>
                    <button id="backupAllBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-save"></i> Z√°lohova≈• v≈°etky</button>
                    <button id="stopAllBackupsBtn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 hidden"><i class="fas fa-stop"></i> Zastavi≈• z√°lohy</button>
                    <button id="refreshAllSnmpBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-sync"></i> Refresh SNMP</button>
                    <button id="snmpStatusBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-info-circle"></i> SNMP Stav</button>
                    <button id="viewBackupsBtn" class="btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2" onclick="window.location.href='/backups'"><i class="fas fa-archive"></i> Z√°lohy</button>
                    <button id="settingsBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-cog"></i> Nastavenia</button>
                </div>

                <div id="devicesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8"></div>
            </div>

            <div class="right-sidebar lg:block hidden">
                <!-- Activity log - integrovan√Ω do layoutu -->
                <div class="card p-4 rounded-lg flex flex-col sticky top-4" style="max-height: calc(100vh - 120px);">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">üìã Aktivita</h2>
                        <div class="flex gap-1">
                            <button id="refreshLogsBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs flex items-center gap-1">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="logsFilterBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-2 rounded text-xs flex items-center gap-1">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtre pre logy -->
                    <div id="logsFilters" class="mb-3 space-y-2 hidden">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="deviceFilter" class="p-1 rounded bg-gray-800 border border-gray-600 text-xs">
                                <option value="">V≈°etky zariadenia</option>
                            </select>
                            <select id="typeFilter" class="p-1 rounded bg-gray-800 border border-gray-600 text-xs">
                                <option value="">V≈°etky typy</option>
                                <option value="backup">Z√°lohovanie</option>
                                <option value="notification">Notifik√°cie</option>
                                <option value="status">Online/Offline</option>
                                <option value="system">Syst√©m</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-4 gap-1">
                            <button id="levelAll" class="filter-level-btn active p-1 rounded text-xs bg-gray-700 hover:bg-gray-600">V≈°etky</button>
                            <button id="levelInfo" class="filter-level-btn p-1 rounded text-xs bg-blue-700 hover:bg-blue-600">Info</button>
                            <button id="levelSuccess" class="filter-level-btn p-1 rounded text-xs bg-green-700 hover:bg-green-600">OK</button>
                            <button id="levelWarning" class="filter-level-btn p-1 rounded text-xs bg-yellow-700 hover:bg-yellow-600">Warn</button>
                        </div>
                        <div class="grid grid-cols-1 gap-1">
                            <button id="levelError" class="filter-level-btn p-1 rounded text-xs bg-red-700 hover:bg-red-600">Error</button>
                        </div>
                    </div>
                    
                    <div id="logsContainer" class="flex-1 overflow-y-auto space-y-1 pr-2 text-xs" style="max-height: calc(100vh - 320px);"></div>
                </div>
            </div>
        </div>

        <!-- Mobiln√° verzia activity logu - zobrazuje sa pod hlavn√Ωm obsahom -->
        <div id="mobileLogs" class="lg:hidden">
            <div class="card p-4 rounded-lg mt-8 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">üìã Aktivita</h2>
                    <div class="flex gap-1">
                        <button id="refreshLogsBtnMobile" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs flex items-center gap-1">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="logsFilterBtnMobile" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-2 rounded text-xs flex items-center gap-1">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mobiln√© filtre pre logy -->
                <div id="logsFiltersMobile" class="mb-3 space-y-2 hidden">
                    <div class="grid grid-cols-1 gap-2">
                        <select id="deviceFilterMobile" class="p-2 rounded bg-gray-800 border border-gray-600 text-sm">
                            <option value="">V≈°etky zariadenia</option>
                        </select>
                        <select id="typeFilterMobile" class="p-2 rounded bg-gray-800 border border-gray-600 text-sm">
                            <option value="">V≈°etky typy</option>
                            <option value="backup">Z√°lohovanie</option>
                            <option value="notification">Notifik√°cie</option>
                            <option value="status">Online/Offline</option>
                            <option value="system">Syst√©m</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <button id="levelAllMobile" class="filter-level-btn-mobile active p-2 rounded text-sm bg-gray-700 hover:bg-gray-600">V≈°etky</button>
                        <button id="levelInfoMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-blue-700 hover:bg-blue-600">Info</button>
                        <button id="levelSuccessMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-green-700 hover:bg-green-600">OK</button>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <button id="levelWarningMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-yellow-700 hover:bg-yellow-600">Warn</button>
                        <button id="levelErrorMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-red-700 hover:bg-red-600">Error</button>
                    </div>
                </div>
                
                <div id="logsContainerMobile" class="overflow-y-auto space-y-1 pr-2 text-xs" style="max-height: 400px;"></div>
            </div>
        </div>
        </div>

    <!-- Modals -->
    <div id="deviceModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-md modal-content">
            <h2 class="text-2xl font-bold text-white mb-6">Prida≈•/Upravi≈• zariadenie</h2>
            <form id="deviceForm" class="space-y-4">
                <input type="hidden" id="deviceId">
                <div><label for="deviceName" class="block mb-1 font-semibold">N√°zov zariadenia</label><input type="text" id="deviceName" class="w-full p-2 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500" required></div>
                <div><label for="deviceIp" class="block mb-1 font-semibold">IP Adresa</label><input type="text" id="deviceIp" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required></div>
                <div><label for="deviceUsername" class="block mb-1 font-semibold">Pou≈æ√≠vateƒæsk√© meno</label><input type="text" id="deviceUsername" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required></div>
                <div><label for="devicePassword" class="block mb-1 font-semibold">Heslo</label><input type="password" id="devicePassword" class="w-full p-2 rounded bg-gray-800 border border-gray-600" placeholder="Zadajte heslo pre SSH pripojenie"></div>
                <div><label for="deviceSnmpCommunity" class="block mb-1 font-semibold">SNMP Community</label><input type="text" id="deviceSnmpCommunity" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="public"></div>
                <div><label for="deviceSnmpInterval" class="block mb-1 font-semibold">SNMP monitoring interval (min√∫ty)</label><input type="number" id="deviceSnmpInterval" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="0" min="0" max="1440"><small class="text-gray-400 block mt-1">0 = pou≈æi≈• glob√°lne nastavenie, 1-1440 = vlastn√Ω interval v min√∫tach</small></div>
                <div class="flex items-center"><input type="checkbox" id="deviceLowMemory" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="deviceLowMemory" class="ml-2">Zariadenie s n√≠zkou pam√§≈•ou (16MB)</label></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="cancelDeviceBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zru≈°i≈•</button><button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Ulo≈æi≈•</button></div>
            </form>
        </div>
    </div>
    
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="card p-6 md:p-8 rounded-lg w-full max-w-sm md:max-w-4xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-white">‚öôÔ∏è Nastavenia</h2>
                <button id="closeSettingsBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-lg md:inline-block hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="settingsForm" class="space-y-6 md:space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <!-- ƒΩav√Ω stƒ∫pec -->
                    <div class="space-y-6 md:space-y-8">
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">‚è∞ Automatick√© z√°lohovanie</h3>
                            <div class="space-y-4">
                                <div class="flex items-center"><input type="checkbox" id="backup_schedule_enabled" name="backup_schedule_enabled" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="backup_schedule_enabled" class="ml-2">Povoli≈• automatick√© z√°lohovanie</label></div>
                                <div><label for="backup_schedule_type" class="block mb-1">Interval</label><select id="backup_schedule_type" name="backup_schedule_type" class="w-full p-2 rounded bg-gray-800 border border-gray-600"><option value="daily">Denne</option><option value="weekly">T√Ω≈ædenne</option></select></div>
                                <div id="weeklySettings" class="hidden"><label for="backup_schedule_day" class="block mb-1">De≈à v t√Ω≈ædni</label><select id="backup_schedule_day" name="backup_schedule_day" class="w-full p-2 rounded bg-gray-800 border border-gray-600"><option value="monday">Pondelok</option><option value="tuesday">Utorok</option><option value="wednesday">Streda</option><option value="thursday">≈†tvrtok</option><option value="friday">Piatok</option><option value="saturday">Sobota</option><option value="sunday">Nedeƒæa</option></select></div>
                                <div><label for="backup_schedule_time" class="block mb-1">ƒåas (HH:MM)</label><input type="time" id="backup_schedule_time" name="backup_schedule_time" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="backup_retention_count" class="block mb-1 font-semibold">Poƒçet uchov√°van√Ωch z√°loh (na zariadenie)</label><input type="number" id="backup_retention_count" name="backup_retention_count" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="10" min="1"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">üì¶ Hromadn√© z√°lohovanie</h3>
                            <div class="space-y-4">
                                <div><label for="backup_delay_seconds" class="block mb-1 font-semibold">Oneskorenie medzi z√°lohami (sekundy)</label><input type="number" id="backup_delay_seconds" name="backup_delay_seconds" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="30" min="5" max="300"><small class="text-gray-400 block mt-1">Odpor√∫ƒçan√Ω rozsah: 30-60 sek√∫nd. Krat≈°√≠ ƒças m√¥≈æe pre≈•a≈æi≈• sie≈•.</small></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">üìä SNMP Monitoring</h3>
                            <div class="space-y-4">
                                <div><label for="snmp_check_interval_minutes" class="block mb-1 font-semibold">Glob√°lny interval SNMP kontroly (min√∫ty)</label><input type="number" id="snmp_check_interval_minutes" name="snmp_check_interval_minutes" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="10" min="1" max="1440"><small class="text-gray-400 block mt-1">Predvolen√Ω interval pre zariadenia, ktor√© nemaj√∫ nastaven√Ω vlastn√Ω interval. Rozsah: 1-1440 min√∫t</small></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">üìã Spr√°va logov</h3>
                            <div class="space-y-4">
                                <div class="flex items-center"><input type="checkbox" id="backup_detailed_logging" name="backup_detailed_logging" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="backup_detailed_logging" class="ml-2">Detailn√© logovanie z√°lohov√©ho procesu</label><small class="text-gray-400 block mt-1">Ak je vypnut√©, zobrazuj√∫ sa len z√°kladn√© spr√°vy o spusten√≠ a dokonƒçen√≠ z√°lohy</small></div>
                                <div><label for="log_retention_days" class="block mb-1 font-semibold">Poƒçet dn√≠ uchov√°vania logov</label><input type="number" id="log_retention_days" name="log_retention_days" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="30" min="1" max="365"><small class="text-gray-400 block mt-1">Logy star≈°ie ako tento poƒçet dn√≠ bud√∫ automaticky vymazan√©. Rozsah: 1-365 dn√≠</small></div>
                                <div><label for="log_max_entries" class="block mb-1 font-semibold">Maximum logov v pam√§ti</label><input type="number" id="log_max_entries" name="log_max_entries" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="1000" min="100" max="5000"><small class="text-gray-400 block mt-1">Maxim√°lny poƒçet logov naƒç√≠tan√Ωch do prehliadaƒça. Vy≈°≈°ie ƒç√≠slo = viac RAM. Rozsah: 100-5000</small></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prav√Ω stƒ∫pec -->
                    <div class="space-y-6 md:space-y-8">
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">üìÅ FTP Server</h3>
                            <div class="space-y-4">
                                <div><label for="ftp_server" class="block mb-1">FTP Server IP</label><input type="text" id="ftp_server" name="ftp_server" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="ftp_username" class="block mb-1">FTP Pou≈æ√≠vateƒæ</label><input type="text" id="ftp_username" name="ftp_username" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="ftp_password" class="block mb-1">FTP Heslo</label><input type="password" id="ftp_password" name="ftp_password" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="ftp_directory" class="block mb-1">FTP Adres√°r</label><input type="text" id="ftp_directory" name="ftp_directory" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">üì± Inteligentn√© Notifik√°cie (Pushover)</h3>
                            <div class="space-y-4">
                                <div><label for="pushover_app_key" class="block mb-1 font-semibold">Pushover App Key/Token</label><input type="text" id="pushover_app_key" name="pushover_app_key" class="w-full p-2 rounded bg-gray-800 border border-gray-600" placeholder="V√°≈° App Key z Pushover"></div>
                                <div><label for="pushover_user_key" class="block mb-1 font-semibold">Pushover User Key</label><input type="text" id="pushover_user_key" name="pushover_user_key" class="w-full p-2 rounded bg-gray-800 border border-gray-600" placeholder="V√°≈° User Key z Pushover"></div>
                                <h4 class="font-semibold pt-2">Typy notifik√°ci√≠</h4>
                                <div id="notificationTypes" class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2"></div>
                                <h4 class="font-semibold pt-2">Kritick√© limity</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label for="temp_critical_threshold" class="block mb-1">Teplota (¬∞C)</label><input type="number" id="temp_critical_threshold" name="temp_critical_threshold" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                    <div><label for="cpu_critical_threshold" class="block mb-1">CPU (%)</label><input type="number" id="cpu_critical_threshold" name="cpu_critical_threshold" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                    <div><label for="memory_critical_threshold" class="block mb-1">Pam√§≈• (%)</label><input type="number" id="memory_critical_threshold" name="memory_critical_threshold" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                </div>
                                <h4 class="font-semibold pt-2">Obmedzenia</h4>
                                <div class="flex items-center"><input type="checkbox" id="quiet_hours_enabled" name="quiet_hours_enabled" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="quiet_hours_enabled" class="ml-2">Povoli≈• "Quiet Hours" (tich√Ω re≈æim)</label></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="quiet_hours_start" class="block mb-1">Tich√Ω re≈æim od</label><input type="time" id="quiet_hours_start" name="quiet_hours_start" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                    <div><label for="quiet_hours_end" class="block mb-1">Tich√Ω re≈æim do</label><input type="time" id="quiet_hours_end" name="quiet_hours_end" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                </div>
                                <div><button type="button" id="testPushoverBtn" class="btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg w-full flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> Otestova≈• Notifik√°ciu</button></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-6 border-t border-gray-700"><button type="button" id="cancelSettingsBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zru≈°i≈•</button><button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Ulo≈æi≈• nastavenia</button></div>
            </form>
        </div>
    </div>

    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-md modal-content">
            <h2 class="text-2xl font-bold text-white mb-6">Zmeni≈• heslo</h2>
            <div id="passwordChangeMessage" class="hidden p-3 rounded-md mb-4 text-sm"></div>
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label for="oldPassword" class="block mb-1 font-semibold">Star√© heslo</label>
                    <input type="password" id="oldPassword" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                </div>
                <div>
                    <label for="newPassword" class="block mb-1 font-semibold">Nov√© heslo</label>
                    <input type="password" id="newPassword" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                </div>
                <div>
                    <label for="newPasswordConfirm" class="block mb-1 font-semibold">Potvrdenie nov√©ho hesla</label>
                    <input type="password" id="newPasswordConfirm" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancelPasswordChangeBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zru≈°i≈•</button>
                    <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Ulo≈æi≈• zmeny</button>
                </div>
            </form>
        </div>
    </div>

    <div id="manage2faModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-lg modal-content">
            <h2 class="text-2xl font-bold text-white mb-6">üîê Spr√°va dvojfaktorov√©ho overenia</h2>
            <div id="manage2faMessage" class="hidden p-3 rounded-md mb-4 text-sm"></div>
            
            <div id="backup2faStatus" class="mb-6">
                <div class="flex justify-center items-center py-4">
                    <i class="fas fa-spinner fa-spin text-2xl text-sky-500 mr-3"></i>
                    <span class="text-lg">Naƒç√≠tavam stav 2FA...</span>
                </div>
            </div>
            
            <div id="backup2faControls" class="hidden space-y-4">
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-white mb-2">üì± Z√°lo≈æn√© k√≥dy</h3>
                    <p class="text-gray-400 text-sm mb-3">Z√°lo≈æn√© k√≥dy umo≈æ≈àuj√∫ pr√≠stup k v√°≈°mu √∫ƒçtu aj keƒè nem√°te k dispoz√≠cii svoje zariadenie s autentifik√°torom.</p>
                    <div id="backupCodesInfo" class="mb-3">
                        <p class="text-sm text-gray-300">Zost√°va v√°m: <span id="remainingCodes" class="font-semibold text-sky-400">-</span> k√≥dov</p>
                    </div>
                    <button id="generateBackupCodesBtn" class="btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg">
                        <i class="fas fa-key mr-2"></i>Regenerova≈• z√°lo≈æn√© k√≥dy
                    </button>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" id="close2faModalBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zatvori≈•</button>
            </div>
        </div>
    </div>

    <!-- Password Confirmation Modal for Backup Codes -->
    <div id="confirmPasswordModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-md modal-content">
            <h2 class="text-xl font-bold text-white mb-4">Potvrdenie hesla</h2>
            <p class="text-gray-400 text-sm mb-4">Pre regener√°ciu z√°lo≈æn√Ωch k√≥dov je potrebn√© potvrdi≈• va≈°e heslo.</p>
            <div id="confirmPasswordMessage" class="hidden p-3 rounded-md mb-4 text-sm"></div>
            <form id="confirmPasswordForm" class="space-y-4">
                <div>
                    <label for="confirmPasswordInput" class="block mb-1 font-semibold">Heslo</label>
                    <input type="password" id="confirmPasswordInput" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancelConfirmPasswordBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zru≈°i≈•</button>
                    <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Potvrdi≈•</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Backup Codes Display Modal -->
    <div id="backupCodesModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-lg modal-content">
            <h2 class="text-xl font-bold text-white mb-4">üîë Va≈°e nov√© z√°lo≈æn√© k√≥dy</h2>
            <div class="bg-red-800 p-4 rounded-lg mb-4">
                <p class="text-red-200 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i><strong>D√¥le≈æit√©:</strong> Ulo≈æte si tieto k√≥dy na bezpeƒçn√© miesto. Ka≈æd√Ω k√≥d mo≈æno pou≈æi≈• iba jedenkr√°t!</p>
            </div>
            <div id="backupCodesDisplay" class="grid grid-cols-2 gap-2 mb-6 font-mono text-sm">
                <!-- Backup codes will be inserted here -->
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="downloadCodesBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i>Stiahnu≈• ako s√∫bor
                </button>
                <button id="printCodesBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                    <i class="fas fa-print mr-2"></i>Vytlaƒçi≈•
                </button>
            </div>
            <div class="flex justify-end">
                <button id="closeBackupCodesBtn" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Dokonƒçi≈•</button>
            </div>
        </div>
    </div>

    <div id="snmpStatusModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="card p-8 rounded-lg w-full max-w-4xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">üõ°Ô∏è SNMP Monitoring Stav</h2>
                <div class="flex gap-2">
                    <button id="refreshSnmpStatusBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-lg text-sm opacity-70 hover:opacity-100 transition-opacity" title="Obnovi≈• SNMP stav">
                        <i class="fas fa-sync-alt text-xs"></i>
                    </button>
                    <button id="closeSnmpStatusBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="snmpStatusContent">
                <div class="flex justify-center items-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-sky-500 mr-3"></i>
                    <span class="text-lg">Naƒç√≠tavam SNMP stav...</span>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = '';
    const devicesGrid = document.getElementById('devicesGrid');
    const logsContainer = document.getElementById('logsContainer');
    const deviceModal = document.getElementById('deviceModal');
    const settingsModal = document.getElementById('settingsModal');
    const changePasswordModal = document.getElementById('changePasswordModal');
    const manage2faModal = document.getElementById('manage2faModal');
    const confirmPasswordModal = document.getElementById('confirmPasswordModal');
    const backupCodesModal = document.getElementById('backupCodesModal');
    const snmpStatusModal = document.getElementById('snmpStatusModal');
    const deviceForm = document.getElementById('deviceForm');
    const settingsForm = document.getElementById('settingsForm');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const notificationTypes = {
        notify_device_offline: "üî¥ Zariadenie offline", notify_device_online: "‚úÖ Zariadenie online",
        notify_backup_success: "‚úÖ Z√°loha √∫spe≈°n√°",
        notify_high_temperature: "üå°Ô∏è Vysok√° teplota", notify_high_cpu: "‚ö° Vysok√© CPU",
        notify_low_memory: "üíæ M√°lo pam√§te",
        notify_reboot_detected: "üîÑ Reboot detekovan√Ω", notify_version_change: "üÜï Zmena verzie OS",
    };

    // --- ≈†tandardizovan√Ω pomocn√≠k pre API volania ---
    const api = {
        _handleResponse: async (res) => {
            if (res.status === 401) {
                window.location.href = '/login';
                return {};
            }
            
            try {
                const data = await res.json();
                
                // Ak server vr√°ti chybu, ale JSON je validn√Ω
                if (!res.ok) {
                    throw new Error(data.message || `HTTP ${res.status}: ${res.statusText}`);
                }
                
                return data;
            } catch (error) {
                // Ak JSON parsing zlyh√°
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                throw error;
            }
        },
        
        get: async function(endpoint) {
            const res = await fetch(`${API_URL}/api/${endpoint}`);
            return this._handleResponse(res);
        },
        
        post: async function(endpoint, body) {
            const res = await fetch(`${API_URL}/api/${endpoint}`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(body) 
            });
            return this._handleResponse(res);
        },
        
        delete: async function(endpoint) {
            const res = await fetch(`${API_URL}/api/${endpoint}`, { method: 'DELETE' });
            return this._handleResponse(res);
        }
    };    const loadUserStatus = async () => {
        try {
            const data = await api.get('user/status');
            if (data.username) {
                document.getElementById('userStatus').innerHTML = `
                    <p class="text-sm text-gray-400">Prihl√°sen√Ω ako: <strong class="font-semibold text-gray-200">${data.username}</strong></p>
                    <div>
                        <a href="#" id="changePasswordLink" class="text-sm text-sky-500 hover:text-sky-400 hover:underline">Zmeni≈• heslo</a>
                        <span class="text-gray-600 mx-1">|</span>
                        <a href="#" id="manage2faLink" class="text-sm text-sky-500 hover:text-sky-400 hover:underline">Spr√°va 2FA</a>
                        <span class="text-gray-600 mx-1">|</span>
                        <a href="/logout" class="text-sm text-sky-500 hover:text-sky-400 hover:underline">Odhl√°si≈• sa</a>
                    </div>
                `;
                document.getElementById('changePasswordLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    changePasswordModal.classList.remove('hidden');
                });
                
                document.getElementById('manage2faLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    manage2faModal.classList.remove('hidden');
                    load2faStatus();
                });
            }
        } catch (error) {
            console.error('Chyba pri naƒç√≠tan√≠ stavu pou≈æ√≠vateƒæa:', error);
        }
    };

    const socket = io();
    let isWebSocketConnected = false;
    
    // WebSocket event handlers
    socket.on('connect', () => {
        console.log('WebSocket pripojenie nadviazan√©.');
        isWebSocketConnected = true;
        // Logy sa naƒç√≠taj√∫ v initializeApp(), nie tu
    });
    
    socket.on('disconnect', () => {
        console.log('WebSocket pripojenie preru≈°en√©.');
        isWebSocketConnected = false;
        // Logy sa bud√∫ obnovova≈• len manu√°lne cez refresh tlaƒçidlo
    });
    
    socket.on('log_update', (log) => {
        // Prid√°me log len ak je WebSocket pripojen√Ω
        if (isWebSocketConnected) {
            addLog(log.level, log.message, log.device_ip, log.timestamp);
        }
    });
    
    socket.on('snmp_update', ({ id, data, status }) => updateDeviceCard(id, { last_snmp_data: JSON.stringify(data), status }));
    socket.on('backup_status', ({ ip, id, status, last_backup }) => {
        const card = document.querySelector(`[data-id="${id}"]`);
        if (card) {
            card.querySelector('.backup-btn i').classList.remove('spinning');
            if (last_backup) card.querySelector('.last-backup-val').textContent = new Date(last_backup).toLocaleString('sk-SK');
            
            // Ak bola z√°loha zastaven√°, zobraz√≠me spr√°vu
            if (status === 'stopped') {
                addLog('warning', `Z√°loha pre ${ip} bola zastaven√° pou≈æ√≠vateƒæom.`, ip);
            }
        }
    });

    const createDeviceCard = (device) => {
        const snmpData = device.last_snmp_data ? JSON.parse(device.last_snmp_data) : {};
        const statusClass = device.status === 'online' ? 'status-online' : 'status-offline';
        const card = document.createElement('div');
        card.className = 'card p-6 rounded-lg flex flex-col gap-4';
        card.dataset.id = device.id;
        card.dataset.ip = device.ip;
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold text-white">${device.name}</h3>
                    <span class="font-mono text-sm font-semibold ${statusClass}"><i class="fas fa-circle mr-2"></i>${device.status}</span>
                </div>
                <p class="font-mono text-gray-400">${device.ip}</p>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <p><strong>Verzia:</strong> <span class="font-mono text-gray-300">${snmpData.version || 'N/A'}</span></p>
                <p><strong>Board:</strong> <span class="font-mono text-gray-300">${snmpData.board_name || 'N/A'}</span></p>
                <p><strong>Uptime:</strong> <span class="font-mono text-gray-300">${snmpData.uptime || 'N/A'}</span></p>
                <p><strong>CPU:</strong> <span class="font-mono text-gray-300">${snmpData.cpu_load || 'N/A'}%</span></p>
                <p><strong>Teplota:</strong> <span class="font-mono text-gray-300">${snmpData.temperature || 'N/A'} ¬∞C</span></p>
                <p><strong>CPU jadr√°:</strong> <span class="font-mono text-gray-300">${snmpData.cpu_count || 'N/A'}</span></p>
                <p><strong>SNMP interval:</strong> <span class="font-mono text-gray-300">${device.snmp_interval_minutes ? device.snmp_interval_minutes + 'min' : 'glob√°lny'}</span></p>
                <p><strong>Posl. z√°loha:</strong> <span class="font-mono text-gray-300 last-backup-val">${device.last_backup ? new Date(device.last_backup).toLocaleString('sk-SK') : 'Nikdy'}</span></p>
            </div>
            <div class="flex gap-2 mt-auto pt-4 border-t border-gray-700">
                <button class="backup-btn btn flex-grow bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-sm flex items-center justify-center gap-2"><i class="fas fa-save"></i> Z√°lohova≈•</button>
                <button class="snmp-btn btn flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm flex items-center justify-center gap-2"><i class="fas fa-sync"></i> SNMP</button>
                <button class="edit-btn btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-pencil-alt"></i></button>
                <button class="delete-btn btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-trash"></i></button>
            </div>`;
        card.querySelector('.backup-btn').addEventListener('click', (e) => { e.currentTarget.querySelector('i').classList.add('spinning'); api.post(`backup/${device.id}`); });
        card.querySelector('.snmp-btn').addEventListener('click', () => api.get(`snmp/${device.id}`));
        card.querySelector('.edit-btn').addEventListener('click', () => openDeviceModal(device));
        card.querySelector('.delete-btn').addEventListener('click', () => deleteDevice(device.id, device.ip));
        return card;
    };
    
    const updateDeviceCard = (id, data) => {
        const card = document.querySelector(`[data-id="${id}"]`);
        if (!card) return;
        
        // Prid√°me subtle updating anim√°ciu
        card.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
        card.style.opacity = '0.8';
        card.style.transform = 'scale(0.98)';
        
        // Po kr√°tkom oneskoren√≠ aktualizujeme √∫daje
        setTimeout(() => {
            if (data.last_snmp_data) {
                const snmpData = JSON.parse(data.last_snmp_data);
                const statusEl = card.querySelector('.font-mono.text-sm.font-semibold');
                
                // Plynul√° zmena statusu
                statusEl.style.transition = 'color 0.3s ease-in-out';
                statusEl.innerHTML = `<i class="fas fa-circle mr-2"></i>${data.status}`;
                statusEl.className = `font-mono text-sm font-semibold status-${data.status}`;
                
                // Aktualizujeme hodnoty s plynulou anim√°ciou
                const updateValueWithAnimation = (selector, newValue) => {
                    const element = card.querySelector(selector);
                    if (element && element.textContent !== newValue) {
                        element.style.transition = 'opacity 0.2s ease-in-out';
                        element.style.opacity = '0.5';
                        setTimeout(() => {
                            element.textContent = newValue;
                            element.style.opacity = '1';
                        }, 100);
                    } else if (element) {
                        element.textContent = newValue;
                    }
                };
                
                updateValueWithAnimation('p:nth-child(1) span', snmpData.version || 'N/A');
                updateValueWithAnimation('p:nth-child(2) span', snmpData.board_name || 'N/A');
                updateValueWithAnimation('p:nth-child(3) span', snmpData.uptime || 'N/A');
                updateValueWithAnimation('p:nth-child(4) span', (snmpData.cpu_load || 'N/A') + '%');
                updateValueWithAnimation('p:nth-child(5) span', (snmpData.temperature || 'N/A') + ' ¬∞C');
                updateValueWithAnimation('p:nth-child(6) span', snmpData.cpu_count || 'N/A');
            }
            
            if (data.last_backup) {
                const backupEl = card.querySelector('.last-backup-val');
                if (backupEl) {
                    backupEl.style.transition = 'opacity 0.2s ease-in-out';
                    backupEl.style.opacity = '0.5';
                    setTimeout(() => {
                        backupEl.textContent = new Date(data.last_backup).toLocaleString('sk-SK');
                        backupEl.style.opacity = '1';
                    }, 100);
                }
            }
            
            // Vr√°time kartu do norm√°lneho stavu
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'scale(1)';
            }, 150);
        }, 100);
    };

    // Filtrovanie logov
    let currentFilters = {
        device: '',
        type: '',
        level: 'all'
    };
    
    // Funkcia na kategoriz√°ciu logov podƒæa typu
    const categorizeLogMessage = (message) => {
        const msgLower = message.toLowerCase();
        // Najprv kontrolujeme notifik√°cie (m√° prioritu pred backup)
        if (msgLower.includes('notifik√°cia') || msgLower.includes('notification') || msgLower.includes('pushover')) return 'notification';
        // V≈°etky z√°lohovacie spr√°vy vr√°tane "sp√∫≈°≈•am pokroƒçil√∫ z√°lohu"
        if (msgLower.includes('z√°loha') || msgLower.includes('backup') || msgLower.includes('sp√∫≈°≈•am pokroƒçil√∫ z√°lohu')) return 'backup';
        if (msgLower.includes('online') || msgLower.includes('offline') || msgLower.includes('pripojen√©') || msgLower.includes('nedostupn√©')) return 'status';
        return 'system';
    };

    const addLogToContainer = (level, message, device_ip = '', timestamp = new Date().toISOString(), isSticky = false) => {
        // Uprav√≠me level pre zelen√© spr√°vy
        if (message.includes('Automatick√© z√°lohovanie je akt√≠vne:')) {
            level = 'success'; // Zelen√° farba
            isSticky = true; // Automaticky oznaƒç√≠me ako sticky
        }
        if (message.includes('Nastavenia boli ulo≈æen√©.')) {
            level = 'success'; // Zelen√° farba
            isSticky = true; // Automaticky oznaƒç√≠me ako sticky
        }
        // Startup spr√°vu u≈æ nezobrazujeme
        
        const logType = categorizeLogMessage(message);
        const createLogEntry = () => {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry p-2 border-l-4 log-${level} bg-gray-800 text-sm`;
            logEntry.setAttribute('data-level', level);
            logEntry.setAttribute('data-device', device_ip || '');
            logEntry.setAttribute('data-type', logType);
            logEntry.setAttribute('data-timestamp', timestamp);
            
            // Pre sticky spr√°vy prid√°me ≈°peci√°lny atrib√∫t
            if (isSticky) {
                if (message.includes('Automatick√© z√°lohovanie je akt√≠vne:')) {
                    logEntry.setAttribute('data-sticky', 'backup_schedule');
                } else if (message.includes('Nastavenia boli ulo≈æen√©.')) {
                    logEntry.setAttribute('data-sticky', 'settings_saved');
                }
            }
            
            logEntry.innerHTML = `<p><strong class="text-gray-400">${new Date(timestamp).toLocaleTimeString('sk-SK')}</strong> ${device_ip ? `<span class="font-mono text-sky-400">${device_ip}</span>` : ''}: ${message}</p>`;
            return logEntry;
        };
        
        // Desktop logs - prid√°vame na zaƒçiatok rovnako ako v addLog
        const desktopLogEntry = createLogEntry();
        logsContainer.prepend(desktopLogEntry);
        
        // Mobile logs - prid√°vame na zaƒçiatok rovnako ako v addLog
        const mobileLogsContainer = document.getElementById('logsContainerMobile');
        if (mobileLogsContainer) {
            const mobileLogEntry = createLogEntry();
            mobileLogsContainer.prepend(mobileLogEntry);
            
            // Udr≈æujeme maxim√°lne 200 logov v mobile UI, ale chr√°nime sticky spr√°vy
            while (mobileLogsContainer.children.length > 200) {
                const lastChild = mobileLogsContainer.lastChild;
                if (!lastChild.getAttribute('data-sticky')) {
                    lastChild.remove();
                } else {
                    break;
                }
            }
        }
        
        // Udr≈æujeme maxim√°lne 200 logov v desktop UI, ale chr√°nime sticky spr√°vy
        while (logsContainer.children.length > 200) {
            const lastChild = logsContainer.lastChild;
            if (!lastChild.getAttribute('data-sticky')) {
                lastChild.remove();
            } else {
                break;
            }
        }
    };

    // Glob√°lna pam√§≈• pre d√¥le≈æit√© spr√°vy - naƒç√≠taj z localStorage ak existuje
    let stickyMessages = new Map();
    
    // Funkcia na ulo≈æenie sticky spr√°v do localStorage
    const saveStickyMessages = () => {
        const stickyArray = Array.from(stickyMessages.entries());
        localStorage.setItem('mikrotik_sticky_messages', JSON.stringify(stickyArray));
    };
    
    // Funkcia na naƒç√≠tanie sticky spr√°v z localStorage
    const loadStickyMessages = () => {
        try {
            const saved = localStorage.getItem('mikrotik_sticky_messages');
            if (saved) {
                const stickyArray = JSON.parse(saved);
                stickyMessages = new Map(stickyArray);
                console.log(`Naƒç√≠tan√© sticky spr√°vy z localStorage: ${stickyMessages.size}`);
            }
        } catch (error) {
            console.warn('Chyba pri naƒç√≠tan√≠ sticky spr√°v z localStorage:', error);
            stickyMessages = new Map();
        }
    };
    
    // Naƒç√≠taj sticky spr√°vy pri ≈°tarte
    loadStickyMessages();
    
    // Odstr√°≈à startup spr√°vu ak existuje
    if (stickyMessages.has('startup_message')) {
        stickyMessages.delete('startup_message');
        saveStickyMessages();
    }
    
    const addLog = (level, message, device_ip = '', timestamp = new Date().toISOString()) => {
        // √öplne ignorujeme startup spr√°vy
        if (message.includes('MikroTik Backup Manager') && message.includes('√∫spe≈°ne naƒç√≠tan√Ω!')) {
            return; // T√∫to spr√°vu u≈æ nezobrazujeme v√¥bec
        }
        
        // Uprav√≠me level pre zelen√© spr√°vy
        if (message.includes('Automatick√© z√°lohovanie je akt√≠vne:')) {
            level = 'success'; // Zelen√° farba
            // Ulo≈æ√≠me si t√∫to d√¥le≈æit√∫ spr√°vu
            stickyMessages.set('backup_schedule', { level, message, device_ip, timestamp });
            saveStickyMessages(); // Ulo≈æ√≠me do localStorage
        }
        
        // Ulo≈æ√≠me si aj "Nastavenia boli ulo≈æen√©" ako sticky spr√°vu
        if (message.includes('Nastavenia boli ulo≈æen√©.')) {
            level = 'success'; // Zelen√° farba
            stickyMessages.set('settings_saved', { level, message, device_ip, timestamp });
            saveStickyMessages(); // Ulo≈æ√≠me do localStorage
        }
        
        // Filtruj len menej d√¥le≈æit√© duplicitn√© spr√°vy
        const duplicateMessages = [
            { pattern: 'Nastavenia boli aktualizovan√©.', timeWindow: 30 } // 30 min√∫t
        ];
        
        // Pre backup schedule spr√°vy - len aktualizuj existuj√∫cu, ale neodstra≈àuj
        if (message.includes('Automatick√© z√°lohovanie je akt√≠vne:')) {
            const existingEntries = logsContainer.querySelectorAll('.log-entry');
            for (let entry of existingEntries) {
                const entryMessage = entry.textContent || '';
                if (entryMessage.includes('Automatick√© z√°lohovanie je akt√≠vne:')) {
                    // Aktualizuj ƒças v existuj√∫cej spr√°ve
                    const timeElement = entry.querySelector('strong');
                    if (timeElement) {
                        timeElement.textContent = new Date(timestamp).toLocaleTimeString('sk-SK');
                        entry.setAttribute('data-timestamp', timestamp);
                    }
                    // Aktualizuj aj v mobile kontajneri
                    const mobileContainer = document.getElementById('logsContainerMobile');
                    if (mobileContainer) {
                        const mobileEntries = mobileContainer.querySelectorAll('.log-entry');
                        mobileEntries.forEach(mobileEntry => {
                            const mobileMessage = mobileEntry.textContent || '';
                            if (mobileMessage.includes('Automatick√© z√°lohovanie je akt√≠vne:')) {
                                const mobileTimeElement = mobileEntry.querySelector('strong');
                                if (mobileTimeElement) {
                                    mobileTimeElement.textContent = new Date(timestamp).toLocaleTimeString('sk-SK');
                                    mobileEntry.setAttribute('data-timestamp', timestamp);
                                }
                            }
                        });
                    }
                    return; // Ukonƒç√≠me, spr√°va je u≈æ aktualizovan√°
                }
            }
        }
        
        // Pre "Nastavenia boli ulo≈æen√©" - tie≈æ len aktualizuj existuj√∫cu
        if (message.includes('Nastavenia boli ulo≈æen√©.')) {
            const existingEntries = logsContainer.querySelectorAll('.log-entry');
            for (let entry of existingEntries) {
                const entryMessage = entry.textContent || '';
                if (entryMessage.includes('Nastavenia boli ulo≈æen√©.')) {
                    // Aktualizuj ƒças v existuj√∫cej spr√°ve
                    const timeElement = entry.querySelector('strong');
                    if (timeElement) {
                        timeElement.textContent = new Date(timestamp).toLocaleTimeString('sk-SK');
                        entry.setAttribute('data-timestamp', timestamp);
                    }
                    // Aktualizuj aj v mobile kontajneri
                    const mobileContainer = document.getElementById('logsContainerMobile');
                    if (mobileContainer) {
                        const mobileEntries = mobileContainer.querySelectorAll('.log-entry');
                        mobileEntries.forEach(mobileEntry => {
                            const mobileMessage = mobileEntry.textContent || '';
                            if (mobileMessage.includes('Nastavenia boli ulo≈æen√©.')) {
                                const mobileTimeElement = mobileEntry.querySelector('strong');
                                if (mobileTimeElement) {
                                    mobileTimeElement.textContent = new Date(timestamp).toLocaleTimeString('sk-SK');
                                    mobileEntry.setAttribute('data-timestamp', timestamp);
                                }
                            }
                        });
                    }
                    return; // Ukonƒç√≠me, spr√°va je u≈æ aktualizovan√°
                }
            }
        }
        
        // Standardn√© duplik√°tov√© filtrovanie pre ostatn√© spr√°vy
        for (let duplicateInfo of duplicateMessages) {
            if (message.includes(duplicateInfo.pattern)) {
                const existingEntries = logsContainer.querySelectorAll('.log-entry');
                const timeWindowAgo = Date.now() - (duplicateInfo.timeWindow * 60 * 1000);
                
                for (let entry of existingEntries) {
                    const entryTime = new Date(entry.getAttribute('data-timestamp')).getTime();
                    const entryMessage = entry.textContent || '';
                    
                    if (entryTime > timeWindowAgo && entryMessage.includes(duplicateInfo.pattern)) {
                        entry.remove();
                        const mobileContainer = document.getElementById('logsContainerMobile');
                        if (mobileContainer) {
                            const mobileEntries = mobileContainer.querySelectorAll('.log-entry');
                            mobileEntries.forEach(mobileEntry => {
                                const mobileMessage = mobileEntry.textContent || '';
                                if (mobileMessage.includes(duplicateInfo.pattern)) {
                                    mobileEntry.remove();
                                }
                            });
                        }
                        break;
                    }
                }
                break;
            }
        }
        
        const logType = categorizeLogMessage(message);
        const createLogEntry = () => {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry p-2 border-l-4 log-${level} bg-gray-800 text-sm`;
            logEntry.setAttribute('data-level', level);
            logEntry.setAttribute('data-device', device_ip || '');
            logEntry.setAttribute('data-type', logType);
            logEntry.setAttribute('data-timestamp', timestamp);
            
            // Pre d√¥le≈æit√© spr√°vy prid√°me ≈°peci√°lny atrib√∫t
            if (message.includes('Automatick√© z√°lohovanie je akt√≠vne:')) {
                logEntry.setAttribute('data-sticky', 'backup_schedule');
            }
            if (message.includes('Nastavenia boli ulo≈æen√©.')) {
                logEntry.setAttribute('data-sticky', 'settings_saved');
            }
            // Startup spr√°vu u≈æ nezobrazujeme
            
            logEntry.innerHTML = `<p><strong class="text-gray-400">${new Date(timestamp).toLocaleTimeString('sk-SK')}</strong> ${device_ip ? `<span class="font-mono text-sky-400">${device_ip}</span>` : ''}: ${message}</p>`;
            return logEntry;
        };
        
        // Desktop logs
        const desktopLogEntry = createLogEntry();
        logsContainer.prepend(desktopLogEntry);
        
        // Mobile logs
        const mobileLogsContainer = document.getElementById('logsContainerMobile');
        if (mobileLogsContainer) {
            const mobileLogEntry = createLogEntry();
            mobileLogsContainer.prepend(mobileLogEntry);
            
            // Udr≈æujeme maxim√°lne 200 logov v mobile UI, ale chr√°nime sticky spr√°vy
            while (mobileLogsContainer.children.length > 200) {
                const lastChild = mobileLogsContainer.lastChild;
                if (!lastChild.getAttribute('data-sticky')) {
                    lastChild.remove();
                } else {
                    break; // Ak je posledn√Ω element sticky, zastav√≠me mazanie
                }
            }
        }
        
        // Udr≈æujeme maxim√°lne 200 logov v desktop UI, ale chr√°nime sticky spr√°vy
        while (logsContainer.children.length > 200) {
            const lastChild = logsContainer.lastChild;
            if (!lastChild.getAttribute('data-sticky')) {
                lastChild.remove();
            } else {
                break; // Ak je posledn√Ω element sticky, zastav√≠me mazanie
            }
        }
        
        // Aplikujeme filtre na nov√© logy
        applyLogFilters();
        
        // Automatick√© skrolovanie k najnov≈°iemu logu (len ak je log viditeƒæn√Ω)
        if (!desktopLogEntry.classList.contains('filtered')) {
            desktopLogEntry.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    };

    const openDeviceModal = (device = null) => {
        deviceForm.reset();
        document.getElementById('deviceId').value = device ? device.id : '';
        document.getElementById('deviceName').value = device ? device.name : '';
        document.getElementById('deviceIp').value = device ? device.ip : '';
        document.getElementById('deviceUsername').value = device ? device.username : ''; 
        document.getElementById('deviceSnmpCommunity').value = device ? device.snmp_community : 'public';
        document.getElementById('deviceSnmpInterval').value = device ? (device.snmp_interval_minutes || 0) : 0;
        document.getElementById('deviceLowMemory').checked = device ? device.low_memory : false;
        // Heslo sa nikdy neposiela sp√§≈• na frontend, tak≈æe ho nevypl≈àujeme
        document.getElementById('devicePassword').value = '';
        document.getElementById('devicePassword').required = !device; // Heslo je povinn√© len pre nov√© zariadenia
        
        // Dynamick√Ω placeholder text pre heslo
        const passwordField = document.getElementById('devicePassword');
        if (device) {
            passwordField.placeholder = '‚óè‚óè‚óè‚óè‚óè‚óè‚óè‚óè';
        } else {
            passwordField.placeholder = 'Zadajte heslo pre SSH pripojenie';
        }
        
        deviceModal.classList.remove('hidden');
    };
    
    const openSettingsModal = async () => {
        const settings = await api.get('settings');
        Object.keys(settings).forEach(key => {
            const el = document.getElementById(key);
            if (el) el.type === 'checkbox' ? el.checked = (settings[key] === 'true') : el.value = settings[key];
        });
        Object.keys(notificationTypes).forEach(key => {
            const el = document.getElementById(key);
            if(el) el.checked = settings[key] === 'true';
        });
        toggleWeeklySettings();
        settingsModal.classList.remove('hidden');
    };

    const closeModal = () => {
        deviceModal.classList.add('hidden');
        settingsModal.classList.add('hidden');
        changePasswordModal.classList.add('hidden');
        snmpStatusModal.classList.add('hidden');
    };

    const loadDevices = async () => {
        const devices = await api.get('devices');
        if (!devices) return;
        devicesGrid.innerHTML = '';
        devices.forEach(device => devicesGrid.appendChild(createDeviceCard(device)));
        // Aktualizuj device filtre po naƒç√≠tan√≠ zariaden√≠
        await updateDeviceFilters();
    };

    const loadLogs = async () => {
        try {
            // Prid√°me timeout pre API request
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 sek√∫nd timeout
            
            const logs = await fetch(`${API_URL}/api/logs`, { 
                signal: controller.signal 
            }).then(res => {
                clearTimeout(timeoutId);
                return api._handleResponse(res);
            });
            
            if (!logs || !Array.isArray(logs)) {
                console.warn('Nepodarilo sa naƒç√≠ta≈• logy alebo neplatn√Ω form√°t');
                return;
            }
            
            // Vyƒçist√≠me existuj√∫ce logy len ak m√°me nov√© d√°ta
            logsContainer.innerHTML = '';
            const mobileLogsContainer = document.getElementById('logsContainerMobile');
            if (mobileLogsContainer) {
                mobileLogsContainer.innerHTML = '';
            }
            
            // Prefiltrujeme duplicitn√© logy pred pridan√≠m
            const filteredLogs = [];
            const seenMessages = new Map();
            
            // Ideme od najnov≈°√≠ch k najstar≈°√≠m
            const reversedLogs = logs.reverse();
            
            for (let log of reversedLogs) {
                let shouldAdd = true;
                
                // ≈†peci√°lne spracovanie pre sticky spr√°vy - aktualizuj v Map-ke ale nepridal do filteredLogs
                if (log.message.includes('Automatick√© z√°lohovanie je akt√≠vne:')) {
                    // Aktualizuj sticky spr√°vu v Map-ke
                    stickyMessages.set('backup_schedule', {
                        level: 'success',
                        message: log.message,
                        device_ip: log.device_ip,
                        timestamp: log.timestamp
                    });
                    saveStickyMessages(); // Ulo≈æ√≠me do localStorage
                    shouldAdd = false; // Nepridal do be≈æn√Ωch logov
                } else if (log.message.includes('Nastavenia boli ulo≈æen√©.')) {
                    // Aktualizuj sticky spr√°vu v Map-ke
                    stickyMessages.set('settings_saved', {
                        level: 'success',
                        message: log.message,
                        device_ip: log.device_ip,
                        timestamp: log.timestamp
                    });
                    saveStickyMessages(); // Ulo≈æ√≠me do localStorage
                    shouldAdd = false; // Nepridal do be≈æn√Ωch logov
                } else if (log.message.includes('MikroTik Backup Manager') && log.message.includes('√∫spe≈°ne naƒç√≠tan√Ω!')) {
                    // Startup spr√°vu u≈æ v√¥bec nezobrazujeme ani neuklad√°me
                    shouldAdd = false; // Nepridal do be≈æn√Ωch logov
                } else {
                    // Kontrolujeme duplicitn√© spr√°vy pre ostatn√© typy (nie sticky spr√°vy)
                    const duplicatePatterns = [
                        'Nastavenia boli aktualizovan√©.'
                    ];
                    
                    for (let pattern of duplicatePatterns) {
                        if (log.message.includes(pattern)) {
                            const logTime = new Date(log.timestamp).getTime();
                            
                            // Skontrolujeme ƒçi u≈æ m√°me podobn√∫ spr√°vu
                            if (seenMessages.has(pattern)) {
                                const existingTime = seenMessages.get(pattern);
                                const timeDiff = Math.abs(logTime - existingTime) / (1000 * 60); // v min√∫tach
                                
                                // Ak je rozdiel men≈°√≠ ako 30 min√∫t, preskoƒç√≠me
                                if (timeDiff < 30) {
                                    shouldAdd = false;
                                    break;
                                }
                            }
                            
                            // Zapam√§t√°me si ƒças tejto spr√°vy
                            seenMessages.set(pattern, logTime);
                            break;
                        }
                    }
                }
                
                if (shouldAdd) {
                    filteredLogs.push(log);
                }
            }
            
            // Najprv prid√°me zvy≈°n√© filtrovan√© logy (v obr√°tenom porad√≠)
            const batchSize = 50;
            for (let i = 0; i < filteredLogs.length; i += batchSize) {
                const batch = filteredLogs.slice(i, i + batchSize);
                batch.forEach(log => {
                    // Prid√°me v≈°etky filtrovan√© logy (sticky spr√°vy u≈æ nie s√∫ vo filteredLogs)
                    addLogToContainer(log.level, log.message, log.device_ip, log.timestamp);
                });
                
                // Mal√© oneskorenie medzi batch-mi aby neblokoval UI
                if (i + batchSize < filteredLogs.length) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            // NAMIESTO prid√°vania sticky spr√°v na koniec, vlo≈æ√≠me ich do spr√°vneho chronologick√©ho poradia
            // Z√≠skame v≈°etky existuj√∫ce logy s ich ƒçasmi
            const allLogEntries = Array.from(logsContainer.children);
            const stickyMessagesToInsert = Array.from(stickyMessages.entries());
            
            // Pre ka≈æd√∫ sticky spr√°vu n√°jdeme spr√°vne miesto podƒæa ƒçasu
            for (let [key, stickyMsg] of stickyMessagesToInsert) {
                const stickyTime = new Date(stickyMsg.timestamp).getTime();
                let insertIndex = 0;
                
                // N√°jdeme poz√≠ciu kde vlo≈æi≈• sticky log (hƒæad√°me prv√Ω log ƒço je star≈°√≠)
                for (let i = 0; i < allLogEntries.length; i++) {
                    const entryTime = new Date(allLogEntries[i].getAttribute('data-timestamp')).getTime();
                    if (stickyTime > entryTime) {
                        insertIndex = i;
                        break;
                    }
                    insertIndex = i + 1;
                }
                
                // Vytvor√≠me sticky log element
                const stickyElement = document.createElement('div');
                stickyElement.className = `log-entry p-2 border-l-4 log-success bg-gray-800 text-sm`;
                stickyElement.setAttribute('data-level', stickyMsg.level);
                stickyElement.setAttribute('data-device', stickyMsg.device_ip || '');
                stickyElement.setAttribute('data-type', 'system');
                stickyElement.setAttribute('data-timestamp', stickyMsg.timestamp);
                stickyElement.setAttribute('data-sticky', key);
                stickyElement.innerHTML = `<p><strong class="text-gray-400">${new Date(stickyMsg.timestamp).toLocaleTimeString('sk-SK')}</strong> ${stickyMsg.device_ip ? `<span class="font-mono text-sky-400">${stickyMsg.device_ip}</span>` : ''}: ${stickyMsg.message}</p>`;
                
                // Vlo≈æ√≠me na spr√°vne miesto
                if (insertIndex >= allLogEntries.length) {
                    logsContainer.appendChild(stickyElement);
                } else {
                    logsContainer.insertBefore(stickyElement, allLogEntries[insertIndex]);
                }
                
                // Aktualizujeme pole pre ƒèal≈°ie iter√°cie
                allLogEntries.splice(insertIndex, 0, stickyElement);
            }
            
            // Sprav√≠me to ist√© pre mobile kontajner
            const mobileLogs = document.getElementById('logsContainerMobile');
            if (mobileLogs) {
                const allMobileLogEntries = Array.from(mobileLogs.children);
                
                for (let [key, stickyMsg] of stickyMessagesToInsert) {
                    const stickyTime = new Date(stickyMsg.timestamp).getTime();
                    let insertIndex = 0;
                    
                    for (let i = 0; i < allMobileLogEntries.length; i++) {
                        const entryTime = new Date(allMobileLogEntries[i].getAttribute('data-timestamp')).getTime();
                        if (stickyTime > entryTime) {
                            insertIndex = i;
                            break;
                        }
                        insertIndex = i + 1;
                    }
                    
                    const stickyMobileElement = document.createElement('div');
                    stickyMobileElement.className = `log-entry p-2 border-l-4 log-success bg-gray-800 text-sm`;
                    stickyMobileElement.setAttribute('data-level', stickyMsg.level);
                    stickyMobileElement.setAttribute('data-device', stickyMsg.device_ip || '');
                    stickyMobileElement.setAttribute('data-type', 'system');
                    stickyMobileElement.setAttribute('data-timestamp', stickyMsg.timestamp);
                    stickyMobileElement.setAttribute('data-sticky', key);
                    stickyMobileElement.innerHTML = `<p><strong class="text-gray-400">${new Date(stickyMsg.timestamp).toLocaleTimeString('sk-SK')}</strong> ${stickyMsg.device_ip ? `<span class="font-mono text-sky-400">${stickyMsg.device_ip}</span>` : ''}: ${stickyMsg.message}</p>`;
                    
                    if (insertIndex >= allMobileLogEntries.length) {
                        mobileLogs.appendChild(stickyMobileElement);
                    } else {
                        mobileLogs.insertBefore(stickyMobileElement, allMobileLogEntries[insertIndex]);
                    }
                    
                    allMobileLogEntries.splice(insertIndex, 0, stickyMobileElement);
                }
            }
            
            // Po naƒç√≠tan√≠ logov aplikujeme aktu√°lne filtre
            applyLogFilters();
            
            console.log(`Naƒç√≠tan√Ωch ${filteredLogs.length} z ${logs.length} logov (${logs.length - filteredLogs.length} duplicitn√Ωch odfiltrovan√Ωch), sticky: ${stickyMessages.size}`);
        } catch (error) {
            if (error.name === 'AbortError') {
                console.warn('Naƒç√≠tanie logov bolo preru≈°en√© kv√¥li timeout');
                addLogToContainer('warning', 'Naƒç√≠tanie logov trvalo pr√≠li≈° dlho a bolo preru≈°en√©', '', new Date().toISOString());
            } else {
                console.error('Chyba pri naƒç√≠tan√≠ logov:', error);
                addLogToContainer('error', 'Chyba pri naƒç√≠tan√≠ logov zo servera', '', new Date().toISOString());
            }
        }
    };

    const deleteDevice = async (id, ip) => {
        const confirmation = await showConfirmation(`Naozaj chcete odstr√°ni≈• zariadenie ${ip}?`);
        if (confirmation) {
            await api.delete(`devices/${id}`);
            loadDevices();
        }
    };
    
    const showConfirmation = (message) => {
        return new Promise((resolve) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="card p-8 rounded-lg w-full max-w-sm modal-content text-center">
                    <p class="text-lg mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button class="btn-cancel btn bg-gray-600 hover:bg-gray-700 py-2 px-6 rounded-lg">Zru≈°i≈•</button>
                        <button class="btn-confirm btn btn-primary font-bold py-2 px-6 rounded-lg">Potvrdi≈•</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
            confirmModal.querySelector('.btn-confirm').onclick = () => {
                resolve(true);
                document.body.removeChild(confirmModal);
            };
            confirmModal.querySelector('.btn-cancel').onclick = () => {
                resolve(false);
                document.body.removeChild(confirmModal);
            };
        });
    };

    const toggleWeeklySettings = () => {
        document.getElementById('weeklySettings').style.display = document.getElementById('backup_schedule_type').value === 'weekly' ? 'block' : 'none';
    };
    
    const populateNotificationTypes = () => {
        const container = document.getElementById('notificationTypes');
        container.innerHTML = Object.entries(notificationTypes).map(([key, label]) => `
            <div class="flex items-center">
                <input type="checkbox" id="${key}" name="${key}" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500">
                <label for="${key}" class="ml-2 text-sm">${label}</label>
            </div>`).join('');
    };
    
    // Funkcie pre filtrovanie logov
    const updateDeviceFilters = async () => {
        const devices = await api.get('devices');
        const deviceSelect = document.getElementById('deviceFilter');
        const deviceSelectMobile = document.getElementById('deviceFilterMobile');
        
        const options = '<option value="">V≈°etky zariadenia</option>' + 
            devices.map(device => `<option value="${device.ip}">${device.name} (${device.ip})</option>`).join('');
        
        deviceSelect.innerHTML = options;
        deviceSelectMobile.innerHTML = options;
    };
    
    const applyLogFilters = () => {
        const entries = document.querySelectorAll('.log-entry');
        
        entries.forEach(entry => {
            const deviceFilter = entry.getAttribute('data-device');
            const typeFilter = entry.getAttribute('data-type');
            const levelFilter = entry.getAttribute('data-level');
            const messageText = entry.textContent || '';
            
            let visible = true;
            
            // Filter by device - hƒæad√°me IP aj v data-device aj v texte spr√°vy
            if (currentFilters.device) {
                const deviceMatches = deviceFilter === currentFilters.device || 
                                    messageText.includes(currentFilters.device);
                if (!deviceMatches) {
                    visible = false;
                }
            }
            
            // Filter by type
            if (currentFilters.type && typeFilter !== currentFilters.type) {
                visible = false;
            }
            
            // Filter by level
            if (currentFilters.level !== 'all' && levelFilter !== currentFilters.level) {
                visible = false;
            }
            
            entry.classList.toggle('filtered', !visible);
        });
    };
    
    const setupLogFilters = () => {
        // Desktop filtre
        const deviceFilter = document.getElementById('deviceFilter');
        const typeFilter = document.getElementById('typeFilter');
        const levelButtons = document.querySelectorAll('.filter-level-btn');
        
        // Mobile filtre
        const deviceFilterMobile = document.getElementById('deviceFilterMobile');
        const typeFilterMobile = document.getElementById('typeFilterMobile');
        const levelButtonsMobile = document.querySelectorAll('.filter-level-btn-mobile');
        
        // Device filter events
        [deviceFilter, deviceFilterMobile].forEach(filter => {
            filter.addEventListener('change', (e) => {
                currentFilters.device = e.target.value;
                applyLogFilters();
                // Sync both selects
                deviceFilter.value = e.target.value;
                deviceFilterMobile.value = e.target.value;
            });
        });
        
        // Type filter events
        [typeFilter, typeFilterMobile].forEach(filter => {
            filter.addEventListener('change', (e) => {
                currentFilters.type = e.target.value;
                applyLogFilters();
                // Sync both selects
                typeFilter.value = e.target.value;
                typeFilterMobile.value = e.target.value;
            });
        });
        
        // Level filter events
        [...levelButtons, ...levelButtonsMobile].forEach(btn => {
            btn.addEventListener('click', (e) => {
                const level = e.target.id.replace('level', '').replace('Mobile', '').toLowerCase();
                currentFilters.level = level;
                
                // Update active states
                [...levelButtons, ...levelButtonsMobile].forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`#level${level.charAt(0).toUpperCase() + level.slice(1)}, #level${level.charAt(0).toUpperCase() + level.slice(1)}Mobile`).forEach(b => b.classList.add('active'));
                
                applyLogFilters();
            });
        });
    };

    document.getElementById('addDeviceBtn').addEventListener('click', () => openDeviceModal());
    document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
    document.getElementById('cancelDeviceBtn').addEventListener('click', closeModal);
    document.getElementById('cancelSettingsBtn').addEventListener('click', closeModal);
    document.getElementById('closeSettingsBtn').addEventListener('click', closeModal);
    document.getElementById('cancelPasswordChangeBtn').addEventListener('click', closeModal);
    document.getElementById('closeSnmpStatusBtn').addEventListener('click', closeModal);
    document.getElementById('refreshSnmpStatusBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshSnmpStatusBtn');
        const icon = btn.querySelector('i');
        const contentDiv = document.getElementById('snmpStatusContent');
        
        // Anim√°cia len refresh tlaƒçidla - ≈æiadny overlay
        icon.classList.add('fa-spin');
        btn.disabled = true;
        
        try {
            const status = await api.get('snmp/status');
            
            // Vytvor√≠me obsah pre mod√°l (rovnak√Ω k√≥d ako v hlavnom event listeneri)
            let content = `
                <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                    <h3 class="text-lg font-semibold text-sky-400 mb-3">üìä Glob√°lne inform√°cie</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Glob√°lny interval:</strong> <span class="text-green-400">${status.global_interval} min√∫t</span></div>
                        <div><strong>ƒåas kontroly:</strong> <span class="text-gray-300">${new Date(status.current_time).toLocaleString('sk-SK')}</span></div>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold text-sky-400 mb-4">üîß Stav zariaden√≠</h3>
                <div class="grid gap-4">
            `;
            
            status.devices.forEach(device => {
                const intervalText = device.interval_setting > 0 
                    ? `${device.interval_setting} min (vlastn√Ω)` 
                    : `${status.global_interval} min (glob√°lny)`;
                const statusClass = device.is_due ? 'text-red-400' : 'text-green-400';
                const statusIcon = device.is_due ? 'üî¥' : 'üü¢';
                const statusText = device.is_due ? 'TREBA KONTROLA' : 'ƒåak√°';
                
                content += `
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-sky-300">${device.name}</h4>
                            <span class="font-mono text-sm text-gray-400">${device.ip}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><strong>Interval:</strong> <span class="text-gray-300">${intervalText}</span></div>
                            <div><strong>Posledn√° kontrola:</strong> <span class="text-gray-300">${device.last_check}</span></div>
                            <div><strong>ƒéal≈°ia kontrola:</strong> <span class="text-gray-300">${device.next_check}</span></div>
                            <div><strong>Stav:</strong> <span class="${statusClass}">${statusIcon} ${statusText}</span></div>
                        </div>
                    </div>
                `;
            });
            
            content += `</div>`;
            
            // Priamo nastav√≠me nov√Ω obsah mod√°lu - ≈æiadne fade efekty
            contentDiv.innerHTML = content;
            
        } catch (error) {
            // Zobraz√≠me chybu bez fade efektov
            contentDiv.innerHTML = `
                <div class="bg-red-900/20 border border-red-500 p-4 rounded-lg text-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-400 font-semibold">Chyba pri obnovovan√≠ SNMP stavu</p>
                    <p class="text-gray-400 text-sm mt-2">Sk√∫ste to znova alebo skontrolujte pripojenie k serveru.</p>
                </div>
            `;
        } finally {
            // Vr√°time tlaƒçidlo do norm√°lneho stavu
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }
    });
    document.getElementById('backupAllBtn').addEventListener('click', async () => {
        const btn = document.getElementById('backupAllBtn');
        const stopBtn = document.getElementById('stopAllBackupsBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sp√∫≈°≈•am...';
        btn.disabled = true;
        
        try {
            const result = await api.post('backup/all');
            if (result.status === 'success') {
                btn.innerHTML = '<i class="fas fa-clock"></i> Prebieha...';
                stopBtn.classList.remove('hidden'); // Zobraz√≠me stop tlaƒçidlo
                
                // Ka≈æd√Ωch 5 sek√∫nd kontrolujeme stav
                const checkStatus = setInterval(async () => {
                    const status = await api.get('backup/status');
                    if (status.total_running === 0 && !status.sequential_backup_running) {
                        clearInterval(checkStatus);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        stopBtn.classList.add('hidden'); // Skryjeme stop tlaƒçidlo
                    } else {
                        btn.innerHTML = `<i class="fas fa-clock"></i> Prebieha (${status.total_running})`;
                    }
                }, 5000);
            } else {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (error) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            stopBtn.classList.add('hidden');
        }
    });

    document.getElementById('stopAllBackupsBtn').addEventListener('click', async () => {
        const stopBtn = document.getElementById('stopAllBackupsBtn');
        const backupBtn = document.getElementById('backupAllBtn');
        
        stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Zastavujem...';
        stopBtn.disabled = true;
        
        try {
            const result = await api.post('backup/stop-all');
            addLog('warning', result.message || 'Z√°lohy boli zastaven√©.');
            
            // Skryjeme stop tlaƒçidlo a obnov√≠me backup tlaƒçidlo
            stopBtn.classList.add('hidden');
            backupBtn.innerHTML = '<i class="fas fa-save"></i> Z√°lohova≈• v≈°etky';
            backupBtn.disabled = false;
        } catch (error) {
            addLog('error', 'Chyba pri zastavovan√≠ z√°loh.');
        } finally {
            stopBtn.innerHTML = '<i class="fas fa-stop"></i> Zastavi≈• z√°lohy';
            stopBtn.disabled = false;
        }
    });
    document.getElementById('refreshAllSnmpBtn').addEventListener('click', () => {
        const btn = document.getElementById('refreshAllSnmpBtn');
        const icon = btn.querySelector('i');
        const originalText = btn.innerHTML;
        
        // Anim√°cia tlaƒçidla
        icon.classList.add('fa-spin');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aktualizujem...';
        
        // Postupn√Ω refresh v≈°etk√Ωch SNMP namiesto s√∫ƒçasn√©ho
        const cards = document.querySelectorAll('[data-id]');
        let completedRequests = 0;
        
        cards.forEach((card, index) => {
            // Prid√°me visual feedback pre ka≈æd√∫ kartu
            setTimeout(() => {
                // Subtle loading indik√°tor na kartu
                card.style.opacity = '0.7';
                card.style.transition = 'opacity 0.3s ease-in-out';
                
                api.get(`snmp/${card.dataset.id}`).then(() => {
                    // Po dokonƒçen√≠ requesto vr√°time kartu do norm√°lneho stavu
                    setTimeout(() => {
                        card.style.opacity = '1';
                    }, 200);
                    
                    completedRequests++;
                    
                    // Ak s√∫ v≈°etky requesty dokonƒçen√©, vr√°time tlaƒçidlo do norm√°lneho stavu
                    if (completedRequests === cards.length) {
                        setTimeout(() => {
                            icon.classList.remove('fa-spin');
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }, 500); // Mal√© oneskorenie pre lep≈°√≠ UX
                    }
                }).catch(() => {
                    // Aj pri chybe vr√°time kartu do norm√°lneho stavu
                    card.style.opacity = '1';
                    completedRequests++;
                    
                    if (completedRequests === cards.length) {
                        setTimeout(() => {
                            icon.classList.remove('fa-spin');
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }, 500);
                    }
                });
            }, index * 750); // Zv√Ω≈°en√© na 750ms medzi ka≈æd√Ωm requestom
        });
        
        // Fallback timeout pre pr√≠pad, ≈æe niektor√© requesty nezodpovedaj√∫
        setTimeout(() => {
            icon.classList.remove('fa-spin');
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            // Vr√°time v≈°etky karty do norm√°lneho stavu
            cards.forEach(card => {
                card.style.opacity = '1';
            });
        }, cards.length * 750 + 5000); // Poƒçk√°me na v≈°etky requesty + 5 sek√∫nd buffer
    });
    document.getElementById('snmpStatusBtn').addEventListener('click', async () => {
        // Otvor√≠me mod√°l s loading stavom
        snmpStatusModal.classList.remove('hidden');
        document.getElementById('snmpStatusContent').innerHTML = `
            <div class="flex justify-center items-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-sky-500 mr-3"></i>
                <span class="text-lg">Naƒç√≠tavam SNMP stav...</span>
            </div>
        `;
        
        try {
            const status = await api.get('snmp/status');
            
            // Vytvor√≠me obsah pre mod√°l
            let content = `
                <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                    <h3 class="text-lg font-semibold text-sky-400 mb-3">üìä Glob√°lne inform√°cie</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Glob√°lny interval:</strong> <span class="text-green-400">${status.global_interval} min√∫t</span></div>
                        <div><strong>ƒåas kontroly:</strong> <span class="text-gray-300">${new Date(status.current_time).toLocaleString('sk-SK')}</span></div>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold text-sky-400 mb-4">üîß Stav zariaden√≠</h3>
                <div class="grid gap-4">
            `;
            
            status.devices.forEach(device => {
                const intervalText = device.interval_setting > 0 
                    ? `${device.interval_setting} min (vlastn√Ω)` 
                    : `${status.global_interval} min (glob√°lny)`;
                const statusClass = device.is_due ? 'text-red-400' : 'text-green-400';
                const statusIcon = device.is_due ? 'üî¥' : 'üü¢';
                const statusText = device.is_due ? 'TREBA KONTROLA' : 'ƒåak√°';
                
                content += `
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-sky-300">${device.name}</h4>
                            <span class="font-mono text-sm text-gray-400">${device.ip}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><strong>Interval:</strong> <span class="text-gray-300">${intervalText}</span></div>
                            <div><strong>Posledn√° kontrola:</strong> <span class="text-gray-300">${device.last_check}</span></div>
                            <div><strong>ƒéal≈°ia kontrola:</strong> <span class="text-gray-300">${device.next_check}</span></div>
                            <div><strong>Stav:</strong> <span class="${statusClass}">${statusIcon} ${statusText}</span></div>
                        </div>
                    </div>
                `;
            });
            
            content += `</div>`;
            
            // Nastav√≠me obsah mod√°lu
            document.getElementById('snmpStatusContent').innerHTML = content;
            
        } catch (error) {
            document.getElementById('snmpStatusContent').innerHTML = `
                <div class="bg-red-900/20 border border-red-500 p-4 rounded-lg text-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-400 font-semibold">Chyba pri naƒç√≠tan√≠ SNMP stavu</p>
                    <p class="text-gray-400 text-sm mt-2">Sk√∫ste to znova alebo skontrolujte pripojenie k serveru.</p>
                </div>
            `;
        }
    });
    document.getElementById('backup_schedule_type').addEventListener('change', toggleWeeklySettings);
    document.getElementById('testPushoverBtn').addEventListener('click', () => api.post('notifications/test'));
    
    // Event listenery pre logy
    document.getElementById('refreshLogsBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshLogsBtn');
        const icon = btn.querySelector('i');
        const logsContainer = document.getElementById('logsContainer');
        const mobileLogsContainer = document.getElementById('logsContainerMobile');
        const originalText = btn.innerHTML;
        
        // Anim√°cia refresh tlaƒçidla
        icon.classList.add('fa-spin');
        btn.disabled = true;
        
        // Prid√°me velmi diskr√©tny loading overlay bez zmeny obsahu
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'logsLoadingOverlay';
        loadingOverlay.className = 'absolute top-2 right-2 z-10 opacity-0';
        loadingOverlay.style.transition = 'opacity 0.2s ease-in-out';
        loadingOverlay.innerHTML = `
            <div class="bg-gray-800/80 backdrop-blur-sm p-1 rounded border border-gray-600/40">
                <i class="fas fa-spinner fa-spin text-xs text-sky-500"></i>
            </div>
        `;
        
        // Pre mobile logy - rovnako diskr√©tny
        const mobileLoadingOverlay = document.createElement('div');
        mobileLoadingOverlay.id = 'mobileLogsLoadingOverlay';
        mobileLoadingOverlay.className = 'absolute top-2 right-2 z-10 opacity-0';
        mobileLoadingOverlay.style.transition = 'opacity 0.2s ease-in-out';
        mobileLoadingOverlay.innerHTML = `
            <div class="bg-gray-800/80 backdrop-blur-sm p-1 rounded border border-gray-600/40">
                <i class="fas fa-spinner fa-spin text-xs text-sky-500"></i>
            </div>
        `;
        
        // Nastav√≠me relat√≠vnu poz√≠ciu pre kontajnery ak ju nemaj√∫
        const logsCardParent = logsContainer.closest('.card');
        const mobileLogsCardParent = mobileLogsContainer ? mobileLogsContainer.closest('.card') : null;
        
        if (logsCardParent) {
            logsCardParent.style.position = 'relative';
            logsCardParent.appendChild(loadingOverlay);
            // Postupne zobraz√≠me overlay v rohu
            setTimeout(() => loadingOverlay.style.opacity = '1', 50);
        }
        
        if (mobileLogsCardParent) {
            mobileLogsCardParent.style.position = 'relative';
            mobileLogsCardParent.appendChild(mobileLoadingOverlay);
            // Postupne zobraz√≠me overlay v rohu
            setTimeout(() => mobileLoadingOverlay.style.opacity = '1', 50);
        }
        
        try {
            // Zavol√°me p√¥vodn√∫ loadLogs funkciu - NEMENEN√â!
            await loadLogs();
            
        } catch (error) {
            // P√¥vodn√° funkcionalita pre chyby - NEMENEN√â!
            addLog('error', 'Chyba pri obnovovan√≠ logov');
        } finally {
            // Jemne odstr√°nime loading overlay
            if (loadingOverlay && loadingOverlay.parentNode) {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    if (loadingOverlay.parentNode) {
                        loadingOverlay.remove();
                    }
                }, 150);
            }
            
            if (mobileLoadingOverlay && mobileLoadingOverlay.parentNode) {
                mobileLoadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    if (mobileLoadingOverlay.parentNode) {
                        mobileLoadingOverlay.remove();
                    }
                }, 150);
            }
            
            // Vr√°time tlaƒçidlo do norm√°lneho stavu
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }
    });
    
    // Filter tlaƒçidl√° pre logy
    document.getElementById('logsFilterBtn').addEventListener('click', () => {
        const filters = document.getElementById('logsFilters');
        filters.classList.toggle('hidden');
    });
    
    document.getElementById('logsFilterBtnMobile').addEventListener('click', () => {
        const filters = document.getElementById('logsFiltersMobile');
        filters.classList.toggle('hidden');
    });

    // Event listenery pre mobiln√© tlaƒçidl√°
    document.getElementById('refreshLogsBtnMobile').addEventListener('click', () => {
        document.getElementById('refreshLogsBtn').click();
    });

    deviceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
            id: document.getElementById('deviceId').value,
            name: document.getElementById('deviceName').value,
            ip: document.getElementById('deviceIp').value,
            username: document.getElementById('deviceUsername').value,
            password: document.getElementById('devicePassword').value,
            snmp_community: document.getElementById('deviceSnmpCommunity').value,
            snmp_interval_minutes: parseInt(document.getElementById('deviceSnmpInterval').value) || 0,
            low_memory: document.getElementById('deviceLowMemory').checked,
        };
        const result = await api.post('devices', body);
        closeModal();
        loadDevices();
        
        // Ak je to nov√© zariadenie (bez ID), automaticky spus≈• SNMP check
        if (!body.id && result.status === 'success' && result.device_id) {
            setTimeout(() => {
                api.get(`snmp/${result.device_id}`);
            }, 1000); // Kr√°tke oneskorenie pre naƒç√≠tanie zariadenia
        }
    });
    
    settingsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {};
        new FormData(settingsForm).forEach((value, key) => body[key] = value);
        settingsForm.querySelectorAll('input[type="checkbox"]').forEach(cb => body[cb.name] = cb.checked.toString());
        const result = await api.post('settings', body);
        closeModal();
        
        // Zobraz√≠me √∫spe≈°n√© ulo≈æenie nastaven√≠
        addLog('success', 'Nastavenia boli ulo≈æen√©.');
        
        // Ak m√°me inform√°cie o pl√°ne automatick√©ho z√°lohovania, zobraz√≠me ich
        if (result && result.schedule_info) {
            addLog('info', result.schedule_info);
        }
    });

    changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageDiv = document.getElementById('passwordChangeMessage');
        const body = {
            old_password: document.getElementById('oldPassword').value,
            new_password: document.getElementById('newPassword').value,
            new_password_confirm: document.getElementById('newPasswordConfirm').value,
        };
        const result = await api.post('user/change-password', body);
        messageDiv.textContent = result.message;
        messageDiv.classList.remove('hidden', 'bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
        if (result.status === 'success') {
            messageDiv.classList.add('bg-green-900/50', 'text-green-300');
            changePasswordForm.reset();
            setTimeout(() => {
                closeModal();
                messageDiv.classList.add('hidden');
            }, 2000);
        } else {
            messageDiv.classList.add('bg-red-900/50', 'text-red-300');
        }
    });

    // === 2FA Management Functions ===
    
    // Load 2FA status
    const load2faStatus = async () => {
        try {
            const statusDiv = document.getElementById('backup2faStatus');
            const controlsDiv = document.getElementById('backup2faControls');
            
            const data = await api.get('user/backup-codes');
            
            if (data && typeof data.remaining_codes !== 'undefined') {
                const remainingCodes = data.remaining_codes || 0;
                document.getElementById('remainingCodes').textContent = remainingCodes;
                
                statusDiv.classList.add('hidden');
                controlsDiv.classList.remove('hidden');
            } else {
                throw new Error('Neplatn√° odpoveƒè zo servera');
            }
            
        } catch (error) {
            console.error('Chyba pri naƒç√≠tavan√≠ 2FA stavu:', error);
            const statusDiv = document.getElementById('backup2faStatus');
            
            let errorMessage = 'Chyba pri naƒç√≠tavan√≠ stavu 2FA';
            if (error.message.includes('404')) {
                errorMessage = '2FA nie je aktivovan√© pre tento √∫ƒçet';
            } else if (error.message.includes('500')) {
                errorMessage = 'Chyba servera. Sk√∫ste obnovi≈• str√°nku.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            statusDiv.innerHTML = `<div class="text-red-400 text-center">${errorMessage}</div>`;
        }
    };
    
    // Generate backup codes
    const generateBackupCodes = async (password) => {
        const messageDiv = document.getElementById('confirmPasswordMessage');
        
        try {
            // Skryje predch√°dzaj√∫ce chybov√© spr√°vy
            messageDiv.classList.add('hidden');
            
            const data = await api.post('user/backup-codes', { password });
            
            if (data && data.status === 'success' && data.backup_codes) {
                displayBackupCodes(data.backup_codes);
                confirmPasswordModal.classList.add('hidden');
                backupCodesModal.classList.remove('hidden');
                return true;
            } else {
                throw new Error(data?.message || 'Neplatn√° odpoveƒè zo servera');
            }
        } catch (error) {
            console.error('Chyba pri generovan√≠ z√°lo≈æn√Ωch k√≥dov:', error);
            
            let errorMessage = 'Chyba pri generovan√≠ z√°lo≈æn√Ωch k√≥dov';
            
            if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                errorMessage = 'Nespr√°vne heslo';
            } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                errorMessage = 'Nem√°te opr√°vnenie na t√∫to oper√°ciu';
            } else if (error.message.includes('500')) {
                errorMessage = 'Chyba servera. Sk√∫ste to znova nesk√¥r.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            messageDiv.textContent = errorMessage;
            messageDiv.classList.remove('hidden', 'bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
            messageDiv.classList.add('bg-red-900/50', 'text-red-300');
            return false;
        }
    };
    
    // Display backup codes
    const displayBackupCodes = (codes) => {
        const container = document.getElementById('backupCodesDisplay');
        container.innerHTML = '';
        
        codes.forEach(code => {
            const codeDiv = document.createElement('div');
            codeDiv.className = 'bg-gray-800 p-2 rounded text-center text-gray-200';
            codeDiv.textContent = code;
            container.appendChild(codeDiv);
        });
    };
    
    // Download backup codes as file
    const downloadBackupCodes = () => {
        const codes = Array.from(document.getElementById('backupCodesDisplay').children)
            .map(div => div.textContent)
            .join('\n');
        
        const blob = new Blob([
            `MikroTik Manager - Z√°lo≈æn√© k√≥dy pre 2FA\n` +
            `Vygenerovan√©: ${new Date().toLocaleString('sk-SK')}\n\n` +
            `D√îLE≈ΩIT√â:\n` +
            `- Ka≈æd√Ω k√≥d mo≈æno pou≈æi≈• iba jedenkr√°t\n` +
            `- Ulo≈æte si tieto k√≥dy na bezpeƒçn√© miesto\n` +
            `- Nikomu ich neposkytujte\n\n` +
            `Z√°lo≈æn√© k√≥dy:\n${codes}`
        ], { type: 'text/plain' });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mikrotik-backup-codes-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };
    
    // Print backup codes
    const printBackupCodes = () => {
        const codes = Array.from(document.getElementById('backupCodesDisplay').children)
            .map(div => div.textContent);
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>MikroTik Manager - Z√°lo≈æn√© k√≥dy</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .warning { background-color: #fee; border: 1px solid #fcc; padding: 15px; margin: 20px 0; border-radius: 5px; }
                        .codes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
                        .code { background-color: #f9f9f9; padding: 10px; text-align: center; font-family: monospace; font-size: 14px; border: 1px solid #ddd; border-radius: 3px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>MikroTik Manager</h1>
                        <h2>Z√°lo≈æn√© k√≥dy pre dvojfaktorov√© overenie</h2>
                        <p>Vygenerovan√©: ${new Date().toLocaleString('sk-SK')}</p>
                    </div>
                    <div class="warning">
                        <h3>‚ö†Ô∏è D√îLE≈ΩIT√â UPOZORNENIE</h3>
                        <ul>
                            <li>Ka≈æd√Ω k√≥d mo≈æno pou≈æi≈• iba jedenkr√°t</li>
                            <li>Ulo≈æte si tieto k√≥dy na bezpeƒçn√© miesto</li>
                            <li>Nikomu ich neposkytujte</li>
                            <li>Po pou≈æit√≠ k√≥du ho vy≈°krtnite zo zoznamu</li>
                        </ul>
                    </div>
                    <div class="codes">
                        ${codes.map(code => `<div class="code">${code}</div>`).join('')}
                    </div>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    };
    
    // Event listeners for 2FA modals
    document.getElementById('close2faModalBtn').addEventListener('click', () => {
        manage2faModal.classList.add('hidden');
    });
    
    document.getElementById('generateBackupCodesBtn').addEventListener('click', () => {
        manage2faModal.classList.add('hidden');
        confirmPasswordModal.classList.remove('hidden');
        document.getElementById('confirmPasswordInput').focus();
    });
    
    document.getElementById('cancelConfirmPasswordBtn').addEventListener('click', () => {
        confirmPasswordModal.classList.add('hidden');
        manage2faModal.classList.remove('hidden');
        document.getElementById('confirmPasswordForm').reset();
        document.getElementById('confirmPasswordMessage').classList.add('hidden');
    });
    
    document.getElementById('confirmPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('confirmPasswordInput').value;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generujem...';
        
        try {
            await generateBackupCodes(password);
        } finally {
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
    
    document.getElementById('closeBackupCodesBtn').addEventListener('click', () => {
        backupCodesModal.classList.add('hidden');
        manage2faModal.classList.remove('hidden');
        load2faStatus(); // Refresh the status
        document.getElementById('confirmPasswordForm').reset();
        document.getElementById('confirmPasswordMessage').classList.add('hidden');
    });
    
    document.getElementById('downloadCodesBtn').addEventListener('click', downloadBackupCodes);
    document.getElementById('printCodesBtn').addEventListener('click', printBackupCodes);
    
    // Close modals when clicking outside
    [manage2faModal, confirmPasswordModal, backupCodesModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                if (modal === confirmPasswordModal || modal === backupCodesModal) {
                    manage2faModal.classList.remove('hidden');
                }
            }
        });
    });

    // Inicializ√°cia aplik√°cie
    const initializeApp = async () => {
        try {
            // Naƒç√≠tavame postupne, nie v≈°etko naraz
            await loadUserStatus();
            populateNotificationTypes();
            setupLogFilters();
            
            // Mal√© oneskorenie medzi oper√°ciami
            await new Promise(resolve => setTimeout(resolve, 100));
            await updateDeviceFilters();
            
            await new Promise(resolve => setTimeout(resolve, 100));
            await loadDevices();
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Naƒç√≠tanie logov bez startup spr√°vy
            await loadLogs();
        } catch (error) {
            console.error('Chyba pri inicializ√°cii aplik√°cie:', error);
            addLogToContainer('error', 'Chyba pri inicializ√°cii aplik√°cie', '', new Date().toISOString());
        }
    };
    
    // Spustenie inicializ√°cie
    initializeApp();

    // Po naƒç√≠tan√≠ str√°nky automaticky obnov SNMP pre v≈°etky zariadenia - postupne
    window.addEventListener('DOMContentLoaded', function() {
        // Oneskorenie pred SNMP refresh, aby sa stihla naƒç√≠ta≈• aplik√°cia
        setTimeout(() => {
            fetch('/api/devices')
                .then(resp => resp.json())
                .then(devices => {
                    // SNMP refresh pre ka≈æd√© zariadenie s oneskoren√≠m
                    devices.forEach((device, index) => {
                        setTimeout(() => {
                            fetch(`/api/snmp/${device.id}`)
                                .then(() => {/* SNMP refresh prebehol */})
                                .catch(() => {/* Ignoruj chyby */});
                        }, index * 1500); // Zv√Ω≈°en√© na 1.5 sekundy medzi requestmi
                    });
                })
                .catch(error => console.error('Chyba pri automatickom SNMP refresh:', error));
        }, 3000); // Zv√Ω≈°en√© na 3 sekundy po naƒç√≠tan√≠ aplik√°cie
    });
    
    // Funkcie pre prep√≠nanie t√©my
    function initTheme() {
        const savedTheme = localStorage.getItem('mikrotik-theme') || 'dark';
        document.body.className = savedTheme === 'light' ? 'light-theme p-4 md:p-8' : 'p-4 md:p-8';
        updateThemeIcon();
    }
    
    function toggleTheme() {
        const isLight = document.body.classList.contains('light-theme');
        if (isLight) {
            document.body.className = 'p-4 md:p-8';
            localStorage.setItem('mikrotik-theme', 'dark');
        } else {
            document.body.className = 'light-theme p-4 md:p-8';
            localStorage.setItem('mikrotik-theme', 'light');
        }
        updateThemeIcon();
    }
    
    function updateThemeIcon() {
        const icon = document.getElementById('theme-icon');
        const isLight = document.body.classList.contains('light-theme');
        icon.className = isLight ? 'fas fa-moon' : 'fas fa-sun';
    }
    
    // Inicializ√°cia t√©my pri naƒç√≠tan√≠ str√°nky
    initTheme();
    
    // Event listener pre prep√≠naƒç t√©my
    document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);
});
</script>
</body>
</html>