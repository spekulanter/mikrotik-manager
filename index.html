<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroTik Backup Manager v2.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --main-bg: #111827; --card-bg: #1f2937; --border-color: #374151; 
            --text-color: #d1d5db; --accent-color: #38bdf8; --accent-color-hover: #0ea5e9;
        }
        body { background-color: var(--main-bg); color: var(--text-color); font-family: 'Inter', sans-serif; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 0 15px rgba(56, 189, 248, 0.1); border-color: rgba(56, 189, 248, 0.3); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn-primary { background-color: var(--accent-color); color: #ffffff; }
        .btn-primary:hover { background-color: var(--accent-color-hover); }
        
        /* Hover animácie pre hlavné tlačidlá */
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Animácie pre svetlú tému */
        body.light-theme .btn:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .status-online { color: #4ade80; }
        .status-offline { color: #f87171; }
        .status-unknown { color: #9ca3af; }
        
        /* Stavy zariadení v svetlej téme - menej saturované farby */
        body.light-theme .status-online {
            color: #16a34a !important; /* Tmavšia, menej saturovaná zelená */
        }
        
        body.light-theme .status-offline {
            color: #dc2626 !important; /* Tmavšia, menej saturovaná červená */
        }
        
        body.light-theme .status-unknown {
            color: #6b7280 !important; /* Tmavšia sivá pre lepší kontrast */
        }
        .log-info { border-left-color: #38bdf8; }
        .log-success { border-left-color: #4ade80; }
        .log-warning { border-left-color: #facc15; }
        .log-error { border-left-color: #f87171; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }
        .modal-content { animation: modal-fade-in 0.3s ease-out; }
        @keyframes modal-fade-in { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: var(--card-bg); }
        .modal-content::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 10px; border: 2px solid var(--card-bg); }
        
        /* Posuvník pre logy aktivít - tmavé téma */
        #logsContainer::-webkit-scrollbar { width: 8px; }
        #logsContainer::-webkit-scrollbar-track { background: #1f2937; border-radius: 4px; }
        #logsContainer::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 4px; border: 1px solid #374151; }
        #logsContainer::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }
        
        /* Štýly pre log filtre */
        .filter-level-btn, .filter-level-btn-mobile { 
            transition: all 0.2s ease; 
            border: 1px solid transparent;
        }
        .filter-level-btn.active, .filter-level-btn-mobile.active { 
            border-color: #38bdf8; 
            box-shadow: 0 0 5px rgba(56, 189, 248, 0.3);
        }
        .log-entry { 
            transition: opacity 0.2s ease; 
        }
        .log-entry.filtered { 
            display: none; 
        }
        
        .mr-84 { margin-right: 0; }
        .activity-log { width: 100%; }
        .activity-right { right: auto; }
        .main-content-wrapper { display: flex; gap: 2rem; align-items: flex-start; }
        .left-content { flex: 1; }
        .right-sidebar { width: 24rem; min-width: 20rem; }
        @media (max-width: 1400px) {
            .right-sidebar { width: 20rem; min-width: 18rem; }
        }
        @media (max-width: 1200px) {
            .right-sidebar { width: 18rem; min-width: 16rem; }
        }
        @media (max-width: 1024px) {
            .main-content-wrapper { flex-direction: column; }
            .right-sidebar { display: none !important; }
            #mobileLogs { display: block !important; }
            #userStatus { text-align: right !important; }
        }
        @media (min-width: 1025px) {
            #mobileLogs { display: none !important; }
        }
        header h1 {
            margin-left: -2rem;
            text-align: center;
        }
        @media (max-width: 768px) {
            header h1 {
                margin-left: 0;
            }
        }
        
        /* Tlačidlo prepínača témy */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .theme-toggle:hover {
            border-color: var(--accent-color);
            background-color: rgba(56, 189, 248, 0.1);
        }

        /* Svetlá téma */
        body.light-theme {
            --main-bg: #f1f5f9;
            --card-bg: #f8fafc;
            --border-color: #cbd5e1;
            --text-color: #334155;
            --accent-color: #0369a1;
            --accent-color-hover: #0284c7;
        }
        
        /* Texty v svetlej téme */
        body.light-theme h1,
        body.light-theme h2,
        body.light-theme h3,
        body.light-theme .text-white {
            color: var(--text-color) !important;
        }
        
        body.light-theme .text-gray-400,
        body.light-theme .text-gray-300 {
            color: #64748b !important;
        }
        
        body.light-theme .text-gray-200 {
            color: var(--text-color) !important;
        }
        
        body.light-theme .text-sky-400,
        body.light-theme .text-sky-500 {
            color: var(--accent-color) !important;
        }
        
        /* Input fields a select v svetlej téme */
        body.light-theme input,
        body.light-theme select,
        body.light-theme textarea {
            background-color: #ffffff !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }
        
        body.light-theme input:focus,
        body.light-theme select:focus,
        body.light-theme textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1) !important;
        }
        
        /* Log entries v svetlej téme */
        body.light-theme .log-entry {
            background-color: #ffffff !important;
            color: var(--text-color) !important;
        }
        
        body.light-theme .log-entry strong {
            color: #64748b !important;
        }
        
        /* Filter buttons v svetlej téme */
        body.light-theme .filter-level-btn,
        body.light-theme .filter-level-btn-mobile {
            background-color: #e2e8f0 !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }
        
        body.light-theme .filter-level-btn:hover,
        body.light-theme .filter-level-btn-mobile:hover {
            background-color: #cbd5e1 !important;
        }
        
        body.light-theme .filter-level-btn.active,
        body.light-theme .filter-level-btn-mobile.active {
            background-color: var(--accent-color) !important;
            color: #ffffff !important;
        }
        
        /* Tlačidlá v svetlej téme */
        body.light-theme .btn {
            color: #ffffff !important;
        }
        
        body.light-theme .btn-primary {
            background-color: var(--accent-color) !important;
            color: #ffffff !important;
        }
        
        body.light-theme .btn-primary:hover {
            background-color: var(--accent-color-hover) !important;
        }
        
        body.light-theme .bg-green-600 {
            background-color: #16a34a !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-green-600:hover,
        body.light-theme .hover\:bg-green-700:hover {
            background-color: #15803d !important;
        }
        
        body.light-theme .bg-blue-600 {
            background-color: #2563eb !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-blue-600:hover,
        body.light-theme .hover\:bg-blue-700:hover {
            background-color: #1d4ed8 !important;
        }
        
        body.light-theme .bg-red-600 {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-red-600:hover,
        body.light-theme .hover\:bg-red-700:hover {
            background-color: #b91c1c !important;
        }
        
        body.light-theme .bg-purple-600 {
            background-color: #9333ea !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-purple-600:hover,
        body.light-theme .hover\:bg-purple-700:hover {
            background-color: #7c3aed !important;
        }
        
        body.light-theme .bg-orange-600 {
            background-color: #ea580c !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-orange-600:hover,
        body.light-theme .hover\:bg-orange-700:hover {
            background-color: #c2410c !important;
        }
        
        body.light-theme .bg-gray-600 {
            background-color: #4b5563 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-gray-600:hover,
        body.light-theme .hover\:bg-gray-700:hover {
            background-color: #374151 !important;
        }
        
        body.light-theme .bg-yellow-500 {
            background-color: #eab308 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-yellow-500:hover,
        body.light-theme .hover\:bg-yellow-600:hover {
            background-color: #ca8a04 !important;
        }
        
        body.light-theme .bg-teal-600 {
            background-color: #0d9488 !important;
            color: #ffffff !important;
        }
        
        body.light-theme .bg-teal-600:hover,
        body.light-theme .hover\:bg-teal-700:hover {
            background-color: #0f766e !important;
        }
        
        body.light-theme .theme-toggle {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body.light-theme #logsContainer::-webkit-scrollbar-track {
            background: #f8fafc;
        }
        
        body.light-theme #logsContainer::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border: 1px solid #e2e8f0;
        }
        
        body.light-theme #logsContainer::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        
        body.light-theme .modal-content::-webkit-scrollbar-track {
            background: var(--card-bg);
        }
        
        body.light-theme .modal-content::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border: 2px solid var(--card-bg);
        }
        
        /* Modálne okná v svetlej téme */
        body.light-theme .modal-content,
        body.light-theme #deviceModal .card,
        body.light-theme #settingsModal .card,
        body.light-theme #changePasswordModal .card,
        body.light-theme #manage2faModal .card,
        body.light-theme #confirmPasswordModal .card,
        body.light-theme #backupCodesModal .card,
        body.light-theme #snmpStatusModal .card {
            background-color: #ffffff !important;
            border-color: var(--border-color) !important;
        }
        
        /* 2FA modály - svetlý režim texty */
        body.light-theme #manage2faModal h2,
        body.light-theme #manage2faModal h3,
        body.light-theme #confirmPasswordModal h2,
        body.light-theme #backupCodesModal h2 {
            color: var(--text-color) !important;
        }
        
        body.light-theme #manage2faModal p,
        body.light-theme #manage2faModal span,
        body.light-theme #confirmPasswordModal p,
        body.light-theme #backupCodesModal p {
            color: var(--text-color) !important;
        }
        
        body.light-theme #manage2faModal .text-gray-400,
        body.light-theme #manage2faModal .text-gray-300,
        body.light-theme #confirmPasswordModal .text-gray-400 {
            color: #6b7280 !important;
        }
        
        body.light-theme #manage2faModal .bg-gray-800 {
            background-color: #f3f4f6 !important;
            border: 1px solid #d1d5db !important;
        }
        
        body.light-theme #confirmPasswordModal input,
        body.light-theme #backupCodesModal input {
            background-color: #f9fafb !important;
            border-color: #d1d5db !important;
            color: var(--text-color) !important;
        }
        
        body.light-theme #backupCodesModal .backup-code {
            background-color: #f9fafb !important;
            border-color: #d1d5db !important;
            color: var(--text-color) !important;
        }
        
        /* Labels v svetlej téme */
        body.light-theme label {
            color: var(--text-color) !important;
        }
        
        /* Sekčné nadpisy v svetlej téme */
        body.light-theme h3.text-sky-400 {
            color: var(--accent-color) !important;
            border-bottom-color: var(--border-color) !important;
        }
        
        /* Malé texty a pomocné texty v svetlej téme */
        body.light-theme small.text-gray-400 {
            color: #64748b !important;
        }
        
        /* Hranice v svetlej téme */
        body.light-theme .border-gray-600,
        body.light-theme .border-gray-700 {
            border-color: var(--border-color) !important;
        }
        
        /* Tlačidlá X v modálnych oknách - tmavá téma (základná) */
        #closeSnmpStatusBtn.btn.bg-gray-600,
        #refreshSnmpStatusBtn.btn.bg-gray-600,
        #closeSettingsBtn.btn.bg-gray-600 {
            background-color: #4b5563 !important;
            color: #ffffff !important;
            border: 1px solid #6b7280 !important;
        }
        
        #closeSnmpStatusBtn.btn.bg-gray-600:hover,
        #refreshSnmpStatusBtn.btn.bg-gray-600:hover,
        #closeSettingsBtn.btn.bg-gray-600:hover {
            background-color: #374151 !important;
            color: #ffffff !important;
        }
        
        /* Tlačidlá X v modálnych oknách - svetlá téma */
        body.light-theme #closeSnmpStatusBtn.btn.bg-gray-600,
        body.light-theme #refreshSnmpStatusBtn.btn.bg-gray-600 {
            background-color: #e2e8f0 !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        body.light-theme #closeSnmpStatusBtn.btn.bg-gray-600:hover,
        body.light-theme #refreshSnmpStatusBtn.btn.bg-gray-600:hover {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        body.light-theme #closeSettingsBtn.btn.bg-gray-600 {
            background-color: #e2e8f0 !important;
            color: var(--text-color) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        body.light-theme #closeSettingsBtn.btn.bg-gray-600:hover {
            background-color: #dc2626 !important;
            color: #ffffff !important;
        }
        
        /* Nastavenia tlačidlo - svetlá téma */
        body.light-theme #settingsBtn.bg-gray-600 {
            background-color: #64748b !important;
            color: #ffffff !important;
        }
        
        body.light-theme #settingsBtn.bg-gray-600:hover {
            background-color: #475569 !important;
        }
        
        /* Tlačidlo Zrušiť v modálnych oknách - svetlá téma */
        body.light-theme #cancelDeviceBtn,
        body.light-theme #cancelSettingsBtn,
        body.light-theme #cancelPasswordChangeBtn {
            background-color: #9ca3af !important;
            color: #ffffff !important;
        }
        
        body.light-theme #cancelDeviceBtn:hover,
        body.light-theme #cancelSettingsBtn:hover,
        body.light-theme #cancelPasswordChangeBtn:hover {
            background-color: #6b7280 !important;
        }
        
        /* SNMP modal obsah v svetlej téme */
        body.light-theme #snmpStatusContent,
        body.light-theme #snmpStatusContent div,
        body.light-theme #snmpStatusContent span {
            background-color: transparent !important;
            color: var(--text-color) !important;
        }
        
        /* SNMP tabulky v svetlej téme */
        body.light-theme table,
        body.light-theme thead,
        body.light-theme tbody,
        body.light-theme tr,
        body.light-theme th,
        body.light-theme td {
            background-color: #ffffff !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }
        
        body.light-theme th {
            background-color: #f1f5f9 !important;
            font-weight: 600 !important;
        }
        
        body.light-theme tr:nth-child(even) td {
            background-color: #f8fafc !important;
        }
        
        body.light-theme tr:hover td {
            background-color: #e2e8f0 !important;
        }
        
        /* Všetky elementy v SNMP modáli - svetlá téma */
        body.light-theme #snmpStatusModal * {
            color: var(--text-color) !important;
        }
        
        body.light-theme #snmpStatusModal .bg-gray-800,
        body.light-theme #snmpStatusModal .bg-gray-700,
        body.light-theme #snmpStatusModal .bg-gray-600 {
            background-color: #ffffff !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Prepínač témy -->
    <button class="theme-toggle" id="themeToggleBtn" title="Prepnúť tému">
        <i class="fas fa-sun" id="theme-icon"></i>
    </button>
    
    <div id="app" class="container mx-auto relative">
        <!-- User info -->
        <div id="userStatus" class="text-right p-4 mb-4">
            <!-- Táto časť sa naplní dynamicky cez JavaScript -->
        </div>

        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-white mb-2">🛡️ MikroTik Backup Manager v2.8</h1>
            <p class="text-lg text-gray-400">Správa, zálohovanie a monitoring vašich MikroTik zariadení.</p>
        </header>

        <div class="main-content-wrapper">
            <div class="left-content">
                <div class="card p-4 rounded-lg mb-8 flex flex-wrap gap-4 items-center justify-center">
                    <button id="addDeviceBtn" class="btn btn-primary font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Pridať zariadenie</button>
                    <button id="backupAllBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-save"></i> Zálohovať všetky</button>
                    <button id="stopAllBackupsBtn" class="btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 hidden"><i class="fas fa-stop"></i> Zastaviť zálohy</button>
                    <button id="refreshAllSnmpBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-sync"></i> Refresh SNMP</button>
                    <button id="snmpStatusBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-info-circle"></i> SNMP Stav</button>
                    <button id="viewBackupsBtn" class="btn bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2" onclick="window.location.href='/backups'"><i class="fas fa-archive"></i> Zálohy</button>
                    <button id="settingsBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><i class="fas fa-cog"></i> Nastavenia</button>
                </div>

                <div id="devicesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8"></div>
            </div>

            <div class="right-sidebar lg:block hidden">
                <!-- Activity log - integrovaný do layoutu -->
                <div class="card p-4 rounded-lg flex flex-col sticky top-4" style="max-height: calc(100vh - 120px);">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">📋 Aktivita</h2>
                        <div class="flex gap-1">
                            <button id="refreshLogsBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs flex items-center gap-1">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="logsFilterBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-2 rounded text-xs flex items-center gap-1">
                                <i class="fas fa-filter"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtre pre logy -->
                    <div id="logsFilters" class="mb-3 space-y-2 hidden">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="deviceFilter" class="p-1 rounded bg-gray-800 border border-gray-600 text-xs">
                                <option value="">Všetky zariadenia</option>
                            </select>
                            <select id="typeFilter" class="p-1 rounded bg-gray-800 border border-gray-600 text-xs">
                                <option value="">Všetky typy</option>
                                <option value="backup">Zálohovanie</option>
                                <option value="notification">Notifikácie</option>
                                <option value="status">Online/Offline</option>
                                <option value="system">Systém</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-4 gap-1">
                            <button id="levelAll" class="filter-level-btn active p-1 rounded text-xs bg-gray-700 hover:bg-gray-600">Všetky</button>
                            <button id="levelInfo" class="filter-level-btn p-1 rounded text-xs bg-blue-700 hover:bg-blue-600">Info</button>
                            <button id="levelSuccess" class="filter-level-btn p-1 rounded text-xs bg-green-700 hover:bg-green-600">OK</button>
                            <button id="levelWarning" class="filter-level-btn p-1 rounded text-xs bg-yellow-700 hover:bg-yellow-600">Warn</button>
                        </div>
                        <div class="grid grid-cols-1 gap-1">
                            <button id="levelError" class="filter-level-btn p-1 rounded text-xs bg-red-700 hover:bg-red-600">Error</button>
                        </div>
                    </div>
                    
                    <div id="logsContainer" class="flex-1 overflow-y-auto space-y-1 pr-2 text-xs" style="max-height: calc(100vh - 320px);"></div>
                </div>
            </div>
        </div>

        <!-- Mobilná verzia activity logu - zobrazuje sa pod hlavným obsahom -->
        <div id="mobileLogs" class="lg:hidden">
            <div class="card p-4 rounded-lg mt-8 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">📋 Aktivita</h2>
                    <div class="flex gap-1">
                        <button id="refreshLogsBtnMobile" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs flex items-center gap-1">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button id="logsFilterBtnMobile" class="btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-2 rounded text-xs flex items-center gap-1">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mobilné filtre pre logy -->
                <div id="logsFiltersMobile" class="mb-3 space-y-2 hidden">
                    <div class="grid grid-cols-1 gap-2">
                        <select id="deviceFilterMobile" class="p-2 rounded bg-gray-800 border border-gray-600 text-sm">
                            <option value="">Všetky zariadenia</option>
                        </select>
                        <select id="typeFilterMobile" class="p-2 rounded bg-gray-800 border border-gray-600 text-sm">
                            <option value="">Všetky typy</option>
                            <option value="backup">Zálohovanie</option>
                            <option value="notification">Notifikácie</option>
                            <option value="status">Online/Offline</option>
                            <option value="system">Systém</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-3 gap-1">
                        <button id="levelAllMobile" class="filter-level-btn-mobile active p-2 rounded text-sm bg-gray-700 hover:bg-gray-600">Všetky</button>
                        <button id="levelInfoMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-blue-700 hover:bg-blue-600">Info</button>
                        <button id="levelSuccessMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-green-700 hover:bg-green-600">OK</button>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <button id="levelWarningMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-yellow-700 hover:bg-yellow-600">Warn</button>
                        <button id="levelErrorMobile" class="filter-level-btn-mobile p-2 rounded text-sm bg-red-700 hover:bg-red-600">Error</button>
                    </div>
                </div>
                
                <div id="logsContainerMobile" class="overflow-y-auto space-y-1 pr-2 text-xs" style="max-height: 400px;"></div>
            </div>
        </div>
        </div>

    <!-- Modals -->
    <div id="deviceModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-md modal-content">
            <h2 class="text-2xl font-bold text-white mb-6">Pridať/Upraviť zariadenie</h2>
            <form id="deviceForm" class="space-y-4">
                <input type="hidden" id="deviceId">
                <div><label for="deviceName" class="block mb-1 font-semibold">Názov zariadenia</label><input type="text" id="deviceName" class="w-full p-2 rounded bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500" required></div>
                <div><label for="deviceIp" class="block mb-1 font-semibold">IP Adresa</label><input type="text" id="deviceIp" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required></div>
                <div><label for="deviceUsername" class="block mb-1 font-semibold">Používateľské meno</label><input type="text" id="deviceUsername" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required></div>
                <div><label for="devicePassword" class="block mb-1 font-semibold">Heslo</label><input type="password" id="devicePassword" class="w-full p-2 rounded bg-gray-800 border border-gray-600" placeholder="Zadajte heslo pre SSH pripojenie"></div>
                <div><label for="deviceSnmpCommunity" class="block mb-1 font-semibold">SNMP Community</label><input type="text" id="deviceSnmpCommunity" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="public"></div>
                <div><label for="deviceSnmpInterval" class="block mb-1 font-semibold">SNMP monitoring interval (minúty)</label><input type="number" id="deviceSnmpInterval" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="0" min="0" max="1440"><small class="text-gray-400 block mt-1">0 = použiť globálne nastavenie, 1-1440 = vlastný interval v minútach</small></div>
                <div class="flex items-center"><input type="checkbox" id="deviceLowMemory" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="deviceLowMemory" class="ml-2">Zariadenie s nízkou pamäťou (16MB)</label></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="cancelDeviceBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zrušiť</button><button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Uložiť</button></div>
            </form>
        </div>
    </div>
    
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="card p-6 md:p-8 rounded-lg w-full max-w-sm md:max-w-4xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl md:text-2xl font-bold text-white">⚙️ Nastavenia</h2>
                <button id="closeSettingsBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-lg md:inline-block hidden">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="settingsForm" class="space-y-6 md:space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <!-- Ľavý stĺpec -->
                    <div class="space-y-6 md:space-y-8">
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">⏰ Automatické zálohovanie</h3>
                            <div class="space-y-4">
                                <div class="flex items-center"><input type="checkbox" id="backup_schedule_enabled" name="backup_schedule_enabled" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="backup_schedule_enabled" class="ml-2">Povoliť automatické zálohovanie</label></div>
                                <div><label for="backup_schedule_type" class="block mb-1">Interval</label><select id="backup_schedule_type" name="backup_schedule_type" class="w-full p-2 rounded bg-gray-800 border border-gray-600"><option value="daily">Denne</option><option value="weekly">Týždenne</option></select></div>
                                <div id="weeklySettings" class="hidden"><label for="backup_schedule_day" class="block mb-1">Deň v týždni</label><select id="backup_schedule_day" name="backup_schedule_day" class="w-full p-2 rounded bg-gray-800 border border-gray-600"><option value="monday">Pondelok</option><option value="tuesday">Utorok</option><option value="wednesday">Streda</option><option value="thursday">Štvrtok</option><option value="friday">Piatok</option><option value="saturday">Sobota</option><option value="sunday">Nedeľa</option></select></div>
                                <div><label for="backup_schedule_time" class="block mb-1">Čas (HH:MM)</label><input type="time" id="backup_schedule_time" name="backup_schedule_time" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="backup_retention_count" class="block mb-1 font-semibold">Počet uchovávaných záloh (na zariadenie)</label><input type="number" id="backup_retention_count" name="backup_retention_count" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="10" min="1"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📦 Hromadné zálohovanie</h3>
                            <div class="space-y-4">
                                <div><label for="backup_delay_seconds" class="block mb-1 font-semibold">Oneskorenie medzi zálohami (sekundy)</label><input type="number" id="backup_delay_seconds" name="backup_delay_seconds" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="30" min="5" max="300"><small class="text-gray-400 block mt-1">Odporúčaný rozsah: 30-60 sekúnd. Kratší čas môže preťažiť sieť.</small></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📊 SNMP Monitoring</h3>
                            <div class="space-y-4">
                                <div><label for="snmp_check_interval_minutes" class="block mb-1 font-semibold">Globálny interval SNMP kontroly (minúty)</label><input type="number" id="snmp_check_interval_minutes" name="snmp_check_interval_minutes" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="10" min="1" max="1440"><small class="text-gray-400 block mt-1">Predvolený interval pre zariadenia, ktoré nemajú nastavený vlastný interval. Rozsah: 1-1440 minút</small></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📋 Správa logov</h3>
                            <div class="space-y-4">
                                <div class="flex items-center"><input type="checkbox" id="backup_detailed_logging" name="backup_detailed_logging" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="backup_detailed_logging" class="ml-2">Detailné logovanie zálohového procesu</label><small class="text-gray-400 block mt-1">Ak je vypnuté, zobrazujú sa len základné správy o spustení a dokončení zálohy</small></div>
                                <div><label for="log_retention_days" class="block mb-1 font-semibold">Počet dní uchovávania logov</label><input type="number" id="log_retention_days" name="log_retention_days" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="30" min="1" max="365"><small class="text-gray-400 block mt-1">Logy staršie ako tento počet dní budú automaticky vymazané. Rozsah: 1-365 dní</small></div>
                                <div><label for="log_max_entries" class="block mb-1 font-semibold">Maximum logov v pamäti</label><input type="number" id="log_max_entries" name="log_max_entries" class="w-full p-2 rounded bg-gray-800 border border-gray-600" value="1000" min="100" max="5000"><small class="text-gray-400 block mt-1">Maximálny počet logov načítaných do prehliadača. Vyššie číslo = viac RAM. Rozsah: 100-5000</small></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pravý stĺpec -->
                    <div class="space-y-6 md:space-y-8">
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📁 FTP Server</h3>
                            <div class="space-y-4">
                                <div><label for="ftp_server" class="block mb-1">FTP Server IP</label><input type="text" id="ftp_server" name="ftp_server" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="ftp_username" class="block mb-1">FTP Používateľ</label><input type="text" id="ftp_username" name="ftp_username" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="ftp_password" class="block mb-1">FTP Heslo</label><input type="password" id="ftp_password" name="ftp_password" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                <div><label for="ftp_directory" class="block mb-1">FTP Adresár</label><input type="text" id="ftp_directory" name="ftp_directory" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg md:text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-sky-400">📱 Inteligentné Notifikácie (Pushover)</h3>
                            <div class="space-y-4">
                                <div><label for="pushover_app_key" class="block mb-1 font-semibold">Pushover App Key/Token</label><input type="text" id="pushover_app_key" name="pushover_app_key" class="w-full p-2 rounded bg-gray-800 border border-gray-600" placeholder="Váš App Key z Pushover"></div>
                                <div><label for="pushover_user_key" class="block mb-1 font-semibold">Pushover User Key</label><input type="text" id="pushover_user_key" name="pushover_user_key" class="w-full p-2 rounded bg-gray-800 border border-gray-600" placeholder="Váš User Key z Pushover"></div>
                                <h4 class="font-semibold pt-2">Typy notifikácií</h4>
                                <div id="notificationTypes" class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2"></div>
                                <h4 class="font-semibold pt-2">Kritické limity</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label for="temp_critical_threshold" class="block mb-1">Teplota (°C)</label><input type="number" id="temp_critical_threshold" name="temp_critical_threshold" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                    <div><label for="cpu_critical_threshold" class="block mb-1">CPU (%)</label><input type="number" id="cpu_critical_threshold" name="cpu_critical_threshold" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                    <div><label for="memory_critical_threshold" class="block mb-1">Pamäť (%)</label><input type="number" id="memory_critical_threshold" name="memory_critical_threshold" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                </div>
                                <h4 class="font-semibold pt-2">Obmedzenia</h4>
                                <div class="flex items-center"><input type="checkbox" id="quiet_hours_enabled" name="quiet_hours_enabled" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500"><label for="quiet_hours_enabled" class="ml-2">Povoliť "Quiet Hours" (tichý režim)</label></div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label for="quiet_hours_start" class="block mb-1">Tichý režim od</label><input type="time" id="quiet_hours_start" name="quiet_hours_start" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                    <div><label for="quiet_hours_end" class="block mb-1">Tichý režim do</label><input type="time" id="quiet_hours_end" name="quiet_hours_end" class="w-full p-2 rounded bg-gray-800 border border-gray-600"></div>
                                </div>
                                <div><button type="button" id="testPushoverBtn" class="btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg w-full flex items-center justify-center gap-2"><i class="fas fa-paper-plane"></i> Otestovať Notifikáciu</button></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-6 border-t border-gray-700"><button type="button" id="cancelSettingsBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zrušiť</button><button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Uložiť nastavenia</button></div>
            </form>
        </div>
    </div>

    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-md modal-content">
            <h2 class="text-2xl font-bold text-white mb-6">Zmeniť heslo</h2>
            <div id="passwordChangeMessage" class="hidden p-3 rounded-md mb-4 text-sm"></div>
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label for="oldPassword" class="block mb-1 font-semibold">Staré heslo</label>
                    <input type="password" id="oldPassword" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                </div>
                <div>
                    <label for="newPassword" class="block mb-1 font-semibold">Nové heslo</label>
                    <input type="password" id="newPassword" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                </div>
                <div>
                    <label for="newPasswordConfirm" class="block mb-1 font-semibold">Potvrdenie nového hesla</label>
                    <input type="password" id="newPasswordConfirm" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancelPasswordChangeBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zrušiť</button>
                    <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Uložiť zmeny</button>
                </div>
            </form>
        </div>
    </div>

    <div id="manage2faModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-lg modal-content">
            <h2 class="text-2xl font-bold text-white mb-6">🔐 Správa dvojfaktorového overenia</h2>
            <div id="manage2faMessage" class="hidden p-3 rounded-md mb-4 text-sm"></div>
            
            <div id="backup2faStatus" class="mb-6">
                <div class="flex justify-center items-center py-4">
                    <i class="fas fa-spinner fa-spin text-2xl text-sky-500 mr-3"></i>
                    <span class="text-lg">Načítavam stav 2FA...</span>
                </div>
            </div>
            
            <div id="backup2faControls" class="hidden space-y-4">
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-white mb-2">📱 Záložné kódy</h3>
                    <p class="text-gray-400 text-sm mb-3">Záložné kódy umožňujú prístup k vášmu účtu aj keď nemáte k dispozícii svoje zariadenie s autentifikátorom.</p>
                    <div id="backupCodesInfo" class="mb-3">
                        <p class="text-sm text-gray-300">Zostáva vám: <span id="remainingCodes" class="font-semibold text-sky-400">-</span> kódov</p>
                    </div>
                    <button id="generateBackupCodesBtn" class="btn bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-4 rounded-lg">
                        <i class="fas fa-key mr-2"></i>Regenerovať záložné kódy
                    </button>
                </div>
            </div>
            
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" id="close2faModalBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zatvoriť</button>
            </div>
        </div>
    </div>

    <!-- Password Confirmation Modal for Backup Codes -->
    <div id="confirmPasswordModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-md modal-content">
            <h2 class="text-xl font-bold text-white mb-4">Potvrdenie hesla</h2>
            <p class="text-gray-400 text-sm mb-4">Pre regeneráciu záložných kódov je potrebné potvrdiť vaše heslo.</p>
            <div id="confirmPasswordMessage" class="hidden p-3 rounded-md mb-4 text-sm"></div>
            <form id="confirmPasswordForm" class="space-y-4">
                <div>
                    <label for="confirmPasswordInput" class="block mb-1 font-semibold">Heslo</label>
                    <input type="password" id="confirmPasswordInput" class="w-full p-2 rounded bg-gray-800 border border-gray-600" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancelConfirmPasswordBtn" class="btn bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Zrušiť</button>
                    <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Potvrdiť</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Backup Codes Display Modal -->
    <div id="backupCodesModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="card p-8 rounded-lg w-full max-w-lg modal-content">
            <h2 class="text-xl font-bold text-white mb-4">🔑 Vaše nové záložné kódy</h2>
            <div class="bg-red-800 p-4 rounded-lg mb-4">
                <p class="text-red-200 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i><strong>Dôležité:</strong> Uložte si tieto kódy na bezpečné miesto. Každý kód možno použiť iba jedenkrát!</p>
            </div>
            <div id="backupCodesDisplay" class="grid grid-cols-2 gap-2 mb-6 font-mono text-sm">
                <!-- Backup codes will be inserted here -->
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <button id="downloadCodesBtn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                    <i class="fas fa-download mr-2"></i>Stiahnuť ako súbor
                </button>
                <button id="printCodesBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                    <i class="fas fa-print mr-2"></i>Vytlačiť
                </button>
            </div>
            <div class="flex justify-end">
                <button id="closeBackupCodesBtn" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Dokončiť</button>
            </div>
        </div>
    </div>

    <div id="snmpStatusModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="card p-8 rounded-lg w-full max-w-4xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">🛡️ SNMP Monitoring Stav</h2>
                <div class="flex gap-2">
                    <button id="refreshSnmpStatusBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-lg text-sm opacity-70 hover:opacity-100 transition-opacity" title="Obnoviť SNMP stav">
                        <i class="fas fa-sync-alt text-xs"></i>
                    </button>
                    <button id="closeSnmpStatusBtn" class="btn bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-lg">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="snmpStatusContent">
                <div class="flex justify-center items-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-sky-500 mr-3"></i>
                    <span class="text-lg">Načítavam SNMP stav...</span>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const API_URL = '';
    const devicesGrid = document.getElementById('devicesGrid');
    const logsContainer = document.getElementById('logsContainer');
    const deviceModal = document.getElementById('deviceModal');
    const settingsModal = document.getElementById('settingsModal');
    const changePasswordModal = document.getElementById('changePasswordModal');
    const manage2faModal = document.getElementById('manage2faModal');
    const confirmPasswordModal = document.getElementById('confirmPasswordModal');
    const backupCodesModal = document.getElementById('backupCodesModal');
    const snmpStatusModal = document.getElementById('snmpStatusModal');
    const deviceForm = document.getElementById('deviceForm');
    const settingsForm = document.getElementById('settingsForm');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const notificationTypes = {
        notify_device_offline: "🔴 Zariadenie offline", notify_device_online: "✅ Zariadenie online",
        notify_backup_success: "✅ Záloha úspešná",
        notify_high_temperature: "🌡️ Vysoká teplota", notify_high_cpu: "⚡ Vysoké CPU",
        notify_low_memory: "💾 Málo pamäte",
        notify_reboot_detected: "🔄 Reboot detekovaný", notify_version_change: "🆕 Zmena verzie OS",
    };

    // --- Štandardizovaný pomocník pre API volania ---
    const api = {
        _handleResponse: async (res) => {
            if (res.status === 401) {
                window.location.href = '/login';
                return {};
            }
            
            try {
                const data = await res.json();
                
                // Ak server vráti chybu, ale JSON je validný
                if (!res.ok) {
                    throw new Error(data.message || `HTTP ${res.status}: ${res.statusText}`);
                }
                
                return data;
            } catch (error) {
                // Ak JSON parsing zlyhá
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                throw error;
            }
        },
        
        get: async function(endpoint) {
            const res = await fetch(`${API_URL}/api/${endpoint}`);
            return this._handleResponse(res);
        },
        
        post: async function(endpoint, body) {
            const res = await fetch(`${API_URL}/api/${endpoint}`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(body) 
            });
            return this._handleResponse(res);
        },
        
        delete: async function(endpoint) {
            const res = await fetch(`${API_URL}/api/${endpoint}`, { method: 'DELETE' });
            return this._handleResponse(res);
        }
    };    const loadUserStatus = async () => {
        try {
            const data = await api.get('user/status');
            if (data.username) {
                document.getElementById('userStatus').innerHTML = `
                    <p class="text-sm text-gray-400">Prihlásený ako: <strong class="font-semibold text-gray-200">${data.username}</strong></p>
                    <div>
                        <a href="#" id="changePasswordLink" class="text-sm text-sky-500 hover:text-sky-400 hover:underline">Zmeniť heslo</a>
                        <span class="text-gray-600 mx-1">|</span>
                        <a href="#" id="manage2faLink" class="text-sm text-sky-500 hover:text-sky-400 hover:underline">Správa 2FA</a>
                        <span class="text-gray-600 mx-1">|</span>
                        <a href="/logout" class="text-sm text-sky-500 hover:text-sky-400 hover:underline">Odhlásiť sa</a>
                    </div>
                `;
                document.getElementById('changePasswordLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    changePasswordModal.classList.remove('hidden');
                });
                
                document.getElementById('manage2faLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    manage2faModal.classList.remove('hidden');
                    load2faStatus();
                });
            }
        } catch (error) {
            console.error('Chyba pri načítaní stavu používateľa:', error);
        }
    };

    const socket = io();
    let isWebSocketConnected = false;
    
    // WebSocket event handlers
    socket.on('connect', () => {
        console.log('WebSocket pripojenie nadviazané.');
        isWebSocketConnected = true;
        // Logy sa načítajú v initializeApp(), nie tu
    });
    
    socket.on('disconnect', () => {
        console.log('WebSocket pripojenie prerušené.');
        isWebSocketConnected = false;
        // Logy sa budú obnovovať len manuálne cez refresh tlačidlo
    });
    
    socket.on('log_update', (log) => {
        // Pridáme log len ak je WebSocket pripojený
        if (isWebSocketConnected) {
            addLog(log.level, log.message, log.device_ip, log.timestamp);
        }
    });
    
    socket.on('snmp_update', ({ id, data, status }) => updateDeviceCard(id, { last_snmp_data: JSON.stringify(data), status }));
    socket.on('backup_status', ({ ip, id, status, last_backup }) => {
        const card = document.querySelector(`[data-id="${id}"]`);
        if (card) {
            card.querySelector('.backup-btn i').classList.remove('spinning');
            if (last_backup) card.querySelector('.last-backup-val').textContent = new Date(last_backup).toLocaleString('sk-SK');
            
            // Ak bola záloha zastavená, zobrazíme správu
            if (status === 'stopped') {
                addLog('warning', `Záloha pre ${ip} bola zastavená používateľom.`, ip);
            }
        }
    });

    const createDeviceCard = (device) => {
        const snmpData = device.last_snmp_data ? JSON.parse(device.last_snmp_data) : {};
        const statusClass = device.status === 'online' ? 'status-online' : 'status-offline';
        const card = document.createElement('div');
        card.className = 'card p-6 rounded-lg flex flex-col gap-4';
        card.dataset.id = device.id;
        card.dataset.ip = device.ip;
        card.innerHTML = `
            <div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold text-white">${device.name}</h3>
                    <span class="font-mono text-sm font-semibold ${statusClass}"><i class="fas fa-circle mr-2"></i>${device.status}</span>
                </div>
                <p class="font-mono text-gray-400">${device.ip}</p>
            </div>
            <div class="grid grid-cols-2 gap-2 text-sm">
                <p><strong>Verzia:</strong> <span class="font-mono text-gray-300">${snmpData.version || 'N/A'}</span></p>
                <p><strong>Board:</strong> <span class="font-mono text-gray-300">${snmpData.board_name || 'N/A'}</span></p>
                <p><strong>Uptime:</strong> <span class="font-mono text-gray-300">${snmpData.uptime || 'N/A'}</span></p>
                <p><strong>CPU:</strong> <span class="font-mono text-gray-300">${snmpData.cpu_load || 'N/A'}%</span></p>
                <p><strong>Teplota:</strong> <span class="font-mono text-gray-300">${snmpData.temperature || 'N/A'} °C</span></p>
                <p><strong>CPU jadrá:</strong> <span class="font-mono text-gray-300">${snmpData.cpu_count || 'N/A'}</span></p>
                <p><strong>SNMP interval:</strong> <span class="font-mono text-gray-300">${device.snmp_interval_minutes ? device.snmp_interval_minutes + 'min' : 'globálny'}</span></p>
                <p><strong>Posl. záloha:</strong> <span class="font-mono text-gray-300 last-backup-val">${device.last_backup ? new Date(device.last_backup).toLocaleString('sk-SK') : 'Nikdy'}</span></p>
            </div>
            <div class="flex gap-2 mt-auto pt-4 border-t border-gray-700">
                <button class="backup-btn btn flex-grow bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-sm flex items-center justify-center gap-2"><i class="fas fa-save"></i> Zálohovať</button>
                <button class="snmp-btn btn flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm flex items-center justify-center gap-2"><i class="fas fa-sync"></i> SNMP</button>
                <button class="edit-btn btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-pencil-alt"></i></button>
                <button class="delete-btn btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm"><i class="fas fa-trash"></i></button>
            </div>`;
        card.querySelector('.backup-btn').addEventListener('click', (e) => { e.currentTarget.querySelector('i').classList.add('spinning'); api.post(`backup/${device.id}`); });
        card.querySelector('.snmp-btn').addEventListener('click', () => api.get(`snmp/${device.id}`));
        card.querySelector('.edit-btn').addEventListener('click', () => openDeviceModal(device));
        card.querySelector('.delete-btn').addEventListener('click', () => deleteDevice(device.id, device.ip));
        return card;
    };
    
    const updateDeviceCard = (id, data) => {
        const card = document.querySelector(`[data-id="${id}"]`);
        if (!card) return;
        
        // Pridáme subtle updating animáciu
        card.style.transition = 'opacity 0.3s ease-in-out, transform 0.3s ease-in-out';
        card.style.opacity = '0.8';
        card.style.transform = 'scale(0.98)';
        
        // Po krátkom oneskorení aktualizujeme údaje
        setTimeout(() => {
            if (data.last_snmp_data) {
                const snmpData = JSON.parse(data.last_snmp_data);
                const statusEl = card.querySelector('.font-mono.text-sm.font-semibold');
                
                // Plynulá zmena statusu
                statusEl.style.transition = 'color 0.3s ease-in-out';
                statusEl.innerHTML = `<i class="fas fa-circle mr-2"></i>${data.status}`;
                statusEl.className = `font-mono text-sm font-semibold status-${data.status}`;
                
                // Aktualizujeme hodnoty s plynulou animáciou
                const updateValueWithAnimation = (selector, newValue) => {
                    const element = card.querySelector(selector);
                    if (element && element.textContent !== newValue) {
                        element.style.transition = 'opacity 0.2s ease-in-out';
                        element.style.opacity = '0.5';
                        setTimeout(() => {
                            element.textContent = newValue;
                            element.style.opacity = '1';
                        }, 100);
                    } else if (element) {
                        element.textContent = newValue;
                    }
                };
                
                updateValueWithAnimation('p:nth-child(1) span', snmpData.version || 'N/A');
                updateValueWithAnimation('p:nth-child(2) span', snmpData.board_name || 'N/A');
                updateValueWithAnimation('p:nth-child(3) span', snmpData.uptime || 'N/A');
                updateValueWithAnimation('p:nth-child(4) span', (snmpData.cpu_load || 'N/A') + '%');
                updateValueWithAnimation('p:nth-child(5) span', (snmpData.temperature || 'N/A') + ' °C');
                updateValueWithAnimation('p:nth-child(6) span', snmpData.cpu_count || 'N/A');
            }
            
            if (data.last_backup) {
                const backupEl = card.querySelector('.last-backup-val');
                if (backupEl) {
                    backupEl.style.transition = 'opacity 0.2s ease-in-out';
                    backupEl.style.opacity = '0.5';
                    setTimeout(() => {
                        backupEl.textContent = new Date(data.last_backup).toLocaleString('sk-SK');
                        backupEl.style.opacity = '1';
                    }, 100);
                }
            }
            
            // Vrátime kartu do normálneho stavu
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'scale(1)';
            }, 150);
        }, 100);
    };

    // Filtrovanie logov
    let currentFilters = {
        device: '',
        type: '',
        level: 'all'
    };
    
    // Funkcia na kategorizáciu logov podľa typu
    const categorizeLogMessage = (message) => {
        const msgLower = message.toLowerCase();
        // Najprv kontrolujeme notifikácie (má prioritu pred backup)
        if (msgLower.includes('notifikácia') || msgLower.includes('notification') || msgLower.includes('pushover')) return 'notification';
        // Všetky zálohovacie správy vrátane "spúšťam pokročilú zálohu"
        if (msgLower.includes('záloha') || msgLower.includes('backup') || msgLower.includes('spúšťam pokročilú zálohu')) return 'backup';
        if (msgLower.includes('online') || msgLower.includes('offline') || msgLower.includes('pripojené') || msgLower.includes('nedostupné')) return 'status';
        return 'system';
    };

    const addLogToContainer = (level, message, device_ip = '', timestamp = new Date().toISOString(), isSticky = false) => {
        // Upravíme level pre zelené správy
        if (message.includes('Automatické zálohovanie je aktívne:')) {
            level = 'success'; // Zelená farba
            isSticky = true; // Automaticky označíme ako sticky
        }
        if (message.includes('Nastavenia boli uložené.')) {
            level = 'success'; // Zelená farba
            isSticky = true; // Automaticky označíme ako sticky
        }
        // Startup správu už nezobrazujeme
        
        const logType = categorizeLogMessage(message);
        const createLogEntry = () => {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry p-2 border-l-4 log-${level} bg-gray-800 text-sm`;
            logEntry.setAttribute('data-level', level);
            logEntry.setAttribute('data-device', device_ip || '');
            logEntry.setAttribute('data-type', logType);
            logEntry.setAttribute('data-timestamp', timestamp);
            
            // Pre sticky správy pridáme špeciálny atribút
            if (isSticky) {
                if (message.includes('Automatické zálohovanie je aktívne:')) {
                    logEntry.setAttribute('data-sticky', 'backup_schedule');
                } else if (message.includes('Nastavenia boli uložené.')) {
                    logEntry.setAttribute('data-sticky', 'settings_saved');
                }
            }
            
            logEntry.innerHTML = `<p><strong class="text-gray-400">${new Date(timestamp).toLocaleTimeString('sk-SK')}</strong> ${device_ip ? `<span class="font-mono text-sky-400">${device_ip}</span>` : ''}: ${message}</p>`;
            return logEntry;
        };
        
        // Desktop logs - pridávame na začiatok rovnako ako v addLog
        const desktopLogEntry = createLogEntry();
        logsContainer.prepend(desktopLogEntry);
        
        // Mobile logs - pridávame na začiatok rovnako ako v addLog
        const mobileLogsContainer = document.getElementById('logsContainerMobile');
        if (mobileLogsContainer) {
            const mobileLogEntry = createLogEntry();
            mobileLogsContainer.prepend(mobileLogEntry);
            
            // Udržujeme maximálne 200 logov v mobile UI, ale chránime sticky správy
            while (mobileLogsContainer.children.length > 200) {
                const lastChild = mobileLogsContainer.lastChild;
                if (!lastChild.getAttribute('data-sticky')) {
                    lastChild.remove();
                } else {
                    break;
                }
            }
        }
        
        // Udržujeme maximálne 200 logov v desktop UI, ale chránime sticky správy
        while (logsContainer.children.length > 200) {
            const lastChild = logsContainer.lastChild;
            if (!lastChild.getAttribute('data-sticky')) {
                lastChild.remove();
            } else {
                break;
            }
        }
    };

    // Globálna pamäť pre dôležité správy - načítaj z localStorage ak existuje
    let stickyMessages = new Map();
    
    // Funkcia na uloženie sticky správ do localStorage
    const saveStickyMessages = () => {
        const stickyArray = Array.from(stickyMessages.entries());
        localStorage.setItem('mikrotik_sticky_messages', JSON.stringify(stickyArray));
    };
    
    // Funkcia na načítanie sticky správ z localStorage
    const loadStickyMessages = () => {
        try {
            const saved = localStorage.getItem('mikrotik_sticky_messages');
            if (saved) {
                const stickyArray = JSON.parse(saved);
                stickyMessages = new Map(stickyArray);
                console.log(`Načítané sticky správy z localStorage: ${stickyMessages.size}`);
            }
        } catch (error) {
            console.warn('Chyba pri načítaní sticky správ z localStorage:', error);
            stickyMessages = new Map();
        }
    };
    
    // Načítaj sticky správy pri štarte
    loadStickyMessages();
    
    // Odstráň startup správu ak existuje
    if (stickyMessages.has('startup_message')) {
        stickyMessages.delete('startup_message');
        saveStickyMessages();
    }
    
    const addLog = (level, message, device_ip = '', timestamp = new Date().toISOString()) => {
        // Úplne ignorujeme startup správy
        if (message.includes('MikroTik Backup Manager') && message.includes('úspešne načítaný!')) {
            return; // Túto správu už nezobrazujeme vôbec
        }
        
        // Upravíme level pre zelené správy
        if (message.includes('Automatické zálohovanie je aktívne:')) {
            level = 'success'; // Zelená farba
            // Uložíme si túto dôležitú správu
            stickyMessages.set('backup_schedule', { level, message, device_ip, timestamp });
            saveStickyMessages(); // Uložíme do localStorage
        }
        
        // Uložíme si aj "Nastavenia boli uložené" ako sticky správu
        if (message.includes('Nastavenia boli uložené.')) {
            level = 'success'; // Zelená farba
            stickyMessages.set('settings_saved', { level, message, device_ip, timestamp });
            saveStickyMessages(); // Uložíme do localStorage
        }
        
        // Filtruj len menej dôležité duplicitné správy
        const duplicateMessages = [
            { pattern: 'Nastavenia boli aktualizované.', timeWindow: 30 } // 30 minút
        ];
        
        // Pre backup schedule správy - len aktualizuj existujúcu, ale neodstraňuj
        if (message.includes('Automatické zálohovanie je aktívne:')) {
            const existingEntries = logsContainer.querySelectorAll('.log-entry');
            for (let entry of existingEntries) {
                const entryMessage = entry.textContent || '';
                if (entryMessage.includes('Automatické zálohovanie je aktívne:')) {
                    // Aktualizuj čas v existujúcej správe
                    const timeElement = entry.querySelector('strong');
                    if (timeElement) {
                        timeElement.textContent = new Date(timestamp).toLocaleTimeString('sk-SK');
                        entry.setAttribute('data-timestamp', timestamp);
                    }
                    // Aktualizuj aj v mobile kontajneri
                    const mobileContainer = document.getElementById('logsContainerMobile');
                    if (mobileContainer) {
                        const mobileEntries = mobileContainer.querySelectorAll('.log-entry');
                        mobileEntries.forEach(mobileEntry => {
                            const mobileMessage = mobileEntry.textContent || '';
                            if (mobileMessage.includes('Automatické zálohovanie je aktívne:')) {
                                const mobileTimeElement = mobileEntry.querySelector('strong');
                                if (mobileTimeElement) {
                                    mobileTimeElement.textContent = new Date(timestamp).toLocaleTimeString('sk-SK');
                                    mobileEntry.setAttribute('data-timestamp', timestamp);
                                }
                            }
                        });
                    }
                    return; // Ukončíme, správa je už aktualizovaná
                }
            }
        }
        
        // Pre "Nastavenia boli uložené" - tiež len aktualizuj existujúcu
        if (message.includes('Nastavenia boli uložené.')) {
            const existingEntries = logsContainer.querySelectorAll('.log-entry');
            for (let entry of existingEntries) {
                const entryMessage = entry.textContent || '';
                if (entryMessage.includes('Nastavenia boli uložené.')) {
                    // Aktualizuj čas v existujúcej správe
                    const timeElement = entry.querySelector('strong');
                    if (timeElement) {
                        timeElement.textContent = new Date(timestamp).toLocaleTimeString('sk-SK');
                        entry.setAttribute('data-timestamp', timestamp);
                    }
                    // Aktualizuj aj v mobile kontajneri
                    const mobileContainer = document.getElementById('logsContainerMobile');
                    if (mobileContainer) {
                        const mobileEntries = mobileContainer.querySelectorAll('.log-entry');
                        mobileEntries.forEach(mobileEntry => {
                            const mobileMessage = mobileEntry.textContent || '';
                            if (mobileMessage.includes('Nastavenia boli uložené.')) {
                                const mobileTimeElement = mobileEntry.querySelector('strong');
                                if (mobileTimeElement) {
                                    mobileTimeElement.textContent = new Date(timestamp).toLocaleTimeString('sk-SK');
                                    mobileEntry.setAttribute('data-timestamp', timestamp);
                                }
                            }
                        });
                    }
                    return; // Ukončíme, správa je už aktualizovaná
                }
            }
        }
        
        // Standardné duplikátové filtrovanie pre ostatné správy
        for (let duplicateInfo of duplicateMessages) {
            if (message.includes(duplicateInfo.pattern)) {
                const existingEntries = logsContainer.querySelectorAll('.log-entry');
                const timeWindowAgo = Date.now() - (duplicateInfo.timeWindow * 60 * 1000);
                
                for (let entry of existingEntries) {
                    const entryTime = new Date(entry.getAttribute('data-timestamp')).getTime();
                    const entryMessage = entry.textContent || '';
                    
                    if (entryTime > timeWindowAgo && entryMessage.includes(duplicateInfo.pattern)) {
                        entry.remove();
                        const mobileContainer = document.getElementById('logsContainerMobile');
                        if (mobileContainer) {
                            const mobileEntries = mobileContainer.querySelectorAll('.log-entry');
                            mobileEntries.forEach(mobileEntry => {
                                const mobileMessage = mobileEntry.textContent || '';
                                if (mobileMessage.includes(duplicateInfo.pattern)) {
                                    mobileEntry.remove();
                                }
                            });
                        }
                        break;
                    }
                }
                break;
            }
        }
        
        const logType = categorizeLogMessage(message);
        const createLogEntry = () => {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry p-2 border-l-4 log-${level} bg-gray-800 text-sm`;
            logEntry.setAttribute('data-level', level);
            logEntry.setAttribute('data-device', device_ip || '');
            logEntry.setAttribute('data-type', logType);
            logEntry.setAttribute('data-timestamp', timestamp);
            
            // Pre dôležité správy pridáme špeciálny atribút
            if (message.includes('Automatické zálohovanie je aktívne:')) {
                logEntry.setAttribute('data-sticky', 'backup_schedule');
            }
            if (message.includes('Nastavenia boli uložené.')) {
                logEntry.setAttribute('data-sticky', 'settings_saved');
            }
            // Startup správu už nezobrazujeme
            
            logEntry.innerHTML = `<p><strong class="text-gray-400">${new Date(timestamp).toLocaleTimeString('sk-SK')}</strong> ${device_ip ? `<span class="font-mono text-sky-400">${device_ip}</span>` : ''}: ${message}</p>`;
            return logEntry;
        };
        
        // Desktop logs
        const desktopLogEntry = createLogEntry();
        logsContainer.prepend(desktopLogEntry);
        
        // Mobile logs
        const mobileLogsContainer = document.getElementById('logsContainerMobile');
        if (mobileLogsContainer) {
            const mobileLogEntry = createLogEntry();
            mobileLogsContainer.prepend(mobileLogEntry);
            
            // Udržujeme maximálne 200 logov v mobile UI, ale chránime sticky správy
            while (mobileLogsContainer.children.length > 200) {
                const lastChild = mobileLogsContainer.lastChild;
                if (!lastChild.getAttribute('data-sticky')) {
                    lastChild.remove();
                } else {
                    break; // Ak je posledný element sticky, zastavíme mazanie
                }
            }
        }
        
        // Udržujeme maximálne 200 logov v desktop UI, ale chránime sticky správy
        while (logsContainer.children.length > 200) {
            const lastChild = logsContainer.lastChild;
            if (!lastChild.getAttribute('data-sticky')) {
                lastChild.remove();
            } else {
                break; // Ak je posledný element sticky, zastavíme mazanie
            }
        }
        
        // Aplikujeme filtre na nové logy
        applyLogFilters();
        
        // Automatické skrolovanie k najnovšiemu logu (len ak je log viditeľný)
        if (!desktopLogEntry.classList.contains('filtered')) {
            desktopLogEntry.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    };

    const openDeviceModal = (device = null) => {
        deviceForm.reset();
        document.getElementById('deviceId').value = device ? device.id : '';
        document.getElementById('deviceName').value = device ? device.name : '';
        document.getElementById('deviceIp').value = device ? device.ip : '';
        document.getElementById('deviceUsername').value = device ? device.username : ''; 
        document.getElementById('deviceSnmpCommunity').value = device ? device.snmp_community : 'public';
        document.getElementById('deviceSnmpInterval').value = device ? (device.snmp_interval_minutes || 0) : 0;
        document.getElementById('deviceLowMemory').checked = device ? device.low_memory : false;
        // Heslo sa nikdy neposiela späť na frontend, takže ho nevyplňujeme
        document.getElementById('devicePassword').value = '';
        document.getElementById('devicePassword').required = !device; // Heslo je povinné len pre nové zariadenia
        
        // Dynamický placeholder text pre heslo
        const passwordField = document.getElementById('devicePassword');
        if (device) {
            passwordField.placeholder = '●●●●●●●●';
        } else {
            passwordField.placeholder = 'Zadajte heslo pre SSH pripojenie';
        }
        
        deviceModal.classList.remove('hidden');
    };
    
    const openSettingsModal = async () => {
        const settings = await api.get('settings');
        Object.keys(settings).forEach(key => {
            const el = document.getElementById(key);
            if (el) el.type === 'checkbox' ? el.checked = (settings[key] === 'true') : el.value = settings[key];
        });
        Object.keys(notificationTypes).forEach(key => {
            const el = document.getElementById(key);
            if(el) el.checked = settings[key] === 'true';
        });
        toggleWeeklySettings();
        settingsModal.classList.remove('hidden');
    };

    const closeModal = () => {
        deviceModal.classList.add('hidden');
        settingsModal.classList.add('hidden');
        changePasswordModal.classList.add('hidden');
        snmpStatusModal.classList.add('hidden');
    };

    const loadDevices = async () => {
        const devices = await api.get('devices');
        if (!devices) return;
        devicesGrid.innerHTML = '';
        devices.forEach(device => devicesGrid.appendChild(createDeviceCard(device)));
        // Aktualizuj device filtre po načítaní zariadení
        await updateDeviceFilters();
    };

    const loadLogs = async () => {
        try {
            // Pridáme timeout pre API request
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 sekúnd timeout
            
            const logs = await fetch(`${API_URL}/api/logs`, { 
                signal: controller.signal 
            }).then(res => {
                clearTimeout(timeoutId);
                return api._handleResponse(res);
            });
            
            if (!logs || !Array.isArray(logs)) {
                console.warn('Nepodarilo sa načítať logy alebo neplatný formát');
                return;
            }
            
            // Vyčistíme existujúce logy len ak máme nové dáta
            logsContainer.innerHTML = '';
            const mobileLogsContainer = document.getElementById('logsContainerMobile');
            if (mobileLogsContainer) {
                mobileLogsContainer.innerHTML = '';
            }
            
            // Prefiltrujeme duplicitné logy pred pridaním
            const filteredLogs = [];
            const seenMessages = new Map();
            
            // Ideme od najnovších k najstarším
            const reversedLogs = logs.reverse();
            
            for (let log of reversedLogs) {
                let shouldAdd = true;
                
                // Špeciálne spracovanie pre sticky správy - aktualizuj v Map-ke ale nepridal do filteredLogs
                if (log.message.includes('Automatické zálohovanie je aktívne:')) {
                    // Aktualizuj sticky správu v Map-ke
                    stickyMessages.set('backup_schedule', {
                        level: 'success',
                        message: log.message,
                        device_ip: log.device_ip,
                        timestamp: log.timestamp
                    });
                    saveStickyMessages(); // Uložíme do localStorage
                    shouldAdd = false; // Nepridal do bežných logov
                } else if (log.message.includes('Nastavenia boli uložené.')) {
                    // Aktualizuj sticky správu v Map-ke
                    stickyMessages.set('settings_saved', {
                        level: 'success',
                        message: log.message,
                        device_ip: log.device_ip,
                        timestamp: log.timestamp
                    });
                    saveStickyMessages(); // Uložíme do localStorage
                    shouldAdd = false; // Nepridal do bežných logov
                } else if (log.message.includes('MikroTik Backup Manager') && log.message.includes('úspešne načítaný!')) {
                    // Startup správu už vôbec nezobrazujeme ani neukladáme
                    shouldAdd = false; // Nepridal do bežných logov
                } else {
                    // Kontrolujeme duplicitné správy pre ostatné typy (nie sticky správy)
                    const duplicatePatterns = [
                        'Nastavenia boli aktualizované.'
                    ];
                    
                    for (let pattern of duplicatePatterns) {
                        if (log.message.includes(pattern)) {
                            const logTime = new Date(log.timestamp).getTime();
                            
                            // Skontrolujeme či už máme podobnú správu
                            if (seenMessages.has(pattern)) {
                                const existingTime = seenMessages.get(pattern);
                                const timeDiff = Math.abs(logTime - existingTime) / (1000 * 60); // v minútach
                                
                                // Ak je rozdiel menší ako 30 minút, preskočíme
                                if (timeDiff < 30) {
                                    shouldAdd = false;
                                    break;
                                }
                            }
                            
                            // Zapamätáme si čas tejto správy
                            seenMessages.set(pattern, logTime);
                            break;
                        }
                    }
                }
                
                if (shouldAdd) {
                    filteredLogs.push(log);
                }
            }
            
            // Najprv pridáme zvyšné filtrované logy (v obrátenom poradí)
            const batchSize = 50;
            for (let i = 0; i < filteredLogs.length; i += batchSize) {
                const batch = filteredLogs.slice(i, i + batchSize);
                batch.forEach(log => {
                    // Pridáme všetky filtrované logy (sticky správy už nie sú vo filteredLogs)
                    addLogToContainer(log.level, log.message, log.device_ip, log.timestamp);
                });
                
                // Malé oneskorenie medzi batch-mi aby neblokoval UI
                if (i + batchSize < filteredLogs.length) {
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            // NAMIESTO pridávania sticky správ na koniec, vložíme ich do správneho chronologického poradia
            // Získame všetky existujúce logy s ich časmi
            const allLogEntries = Array.from(logsContainer.children);
            const stickyMessagesToInsert = Array.from(stickyMessages.entries());
            
            // Pre každú sticky správu nájdeme správne miesto podľa času
            for (let [key, stickyMsg] of stickyMessagesToInsert) {
                const stickyTime = new Date(stickyMsg.timestamp).getTime();
                let insertIndex = 0;
                
                // Nájdeme pozíciu kde vložiť sticky log (hľadáme prvý log čo je starší)
                for (let i = 0; i < allLogEntries.length; i++) {
                    const entryTime = new Date(allLogEntries[i].getAttribute('data-timestamp')).getTime();
                    if (stickyTime > entryTime) {
                        insertIndex = i;
                        break;
                    }
                    insertIndex = i + 1;
                }
                
                // Vytvoríme sticky log element
                const stickyElement = document.createElement('div');
                stickyElement.className = `log-entry p-2 border-l-4 log-success bg-gray-800 text-sm`;
                stickyElement.setAttribute('data-level', stickyMsg.level);
                stickyElement.setAttribute('data-device', stickyMsg.device_ip || '');
                stickyElement.setAttribute('data-type', 'system');
                stickyElement.setAttribute('data-timestamp', stickyMsg.timestamp);
                stickyElement.setAttribute('data-sticky', key);
                stickyElement.innerHTML = `<p><strong class="text-gray-400">${new Date(stickyMsg.timestamp).toLocaleTimeString('sk-SK')}</strong> ${stickyMsg.device_ip ? `<span class="font-mono text-sky-400">${stickyMsg.device_ip}</span>` : ''}: ${stickyMsg.message}</p>`;
                
                // Vložíme na správne miesto
                if (insertIndex >= allLogEntries.length) {
                    logsContainer.appendChild(stickyElement);
                } else {
                    logsContainer.insertBefore(stickyElement, allLogEntries[insertIndex]);
                }
                
                // Aktualizujeme pole pre ďalšie iterácie
                allLogEntries.splice(insertIndex, 0, stickyElement);
            }
            
            // Spravíme to isté pre mobile kontajner
            const mobileLogs = document.getElementById('logsContainerMobile');
            if (mobileLogs) {
                const allMobileLogEntries = Array.from(mobileLogs.children);
                
                for (let [key, stickyMsg] of stickyMessagesToInsert) {
                    const stickyTime = new Date(stickyMsg.timestamp).getTime();
                    let insertIndex = 0;
                    
                    for (let i = 0; i < allMobileLogEntries.length; i++) {
                        const entryTime = new Date(allMobileLogEntries[i].getAttribute('data-timestamp')).getTime();
                        if (stickyTime > entryTime) {
                            insertIndex = i;
                            break;
                        }
                        insertIndex = i + 1;
                    }
                    
                    const stickyMobileElement = document.createElement('div');
                    stickyMobileElement.className = `log-entry p-2 border-l-4 log-success bg-gray-800 text-sm`;
                    stickyMobileElement.setAttribute('data-level', stickyMsg.level);
                    stickyMobileElement.setAttribute('data-device', stickyMsg.device_ip || '');
                    stickyMobileElement.setAttribute('data-type', 'system');
                    stickyMobileElement.setAttribute('data-timestamp', stickyMsg.timestamp);
                    stickyMobileElement.setAttribute('data-sticky', key);
                    stickyMobileElement.innerHTML = `<p><strong class="text-gray-400">${new Date(stickyMsg.timestamp).toLocaleTimeString('sk-SK')}</strong> ${stickyMsg.device_ip ? `<span class="font-mono text-sky-400">${stickyMsg.device_ip}</span>` : ''}: ${stickyMsg.message}</p>`;
                    
                    if (insertIndex >= allMobileLogEntries.length) {
                        mobileLogs.appendChild(stickyMobileElement);
                    } else {
                        mobileLogs.insertBefore(stickyMobileElement, allMobileLogEntries[insertIndex]);
                    }
                    
                    allMobileLogEntries.splice(insertIndex, 0, stickyMobileElement);
                }
            }
            
            // Po načítaní logov aplikujeme aktuálne filtre
            applyLogFilters();
            
            console.log(`Načítaných ${filteredLogs.length} z ${logs.length} logov (${logs.length - filteredLogs.length} duplicitných odfiltrovaných), sticky: ${stickyMessages.size}`);
        } catch (error) {
            if (error.name === 'AbortError') {
                console.warn('Načítanie logov bolo prerušené kvôli timeout');
                addLogToContainer('warning', 'Načítanie logov trvalo príliš dlho a bolo prerušené', '', new Date().toISOString());
            } else {
                console.error('Chyba pri načítaní logov:', error);
                addLogToContainer('error', 'Chyba pri načítaní logov zo servera', '', new Date().toISOString());
            }
        }
    };

    const deleteDevice = async (id, ip) => {
        const confirmation = await showConfirmation(`Naozaj chcete odstrániť zariadenie ${ip}?`);
        if (confirmation) {
            await api.delete(`devices/${id}`);
            loadDevices();
        }
    };
    
    const showConfirmation = (message) => {
        return new Promise((resolve) => {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="card p-8 rounded-lg w-full max-w-sm modal-content text-center">
                    <p class="text-lg mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button class="btn-cancel btn bg-gray-600 hover:bg-gray-700 py-2 px-6 rounded-lg">Zrušiť</button>
                        <button class="btn-confirm btn btn-primary font-bold py-2 px-6 rounded-lg">Potvrdiť</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
            confirmModal.querySelector('.btn-confirm').onclick = () => {
                resolve(true);
                document.body.removeChild(confirmModal);
            };
            confirmModal.querySelector('.btn-cancel').onclick = () => {
                resolve(false);
                document.body.removeChild(confirmModal);
            };
        });
    };

    const toggleWeeklySettings = () => {
        document.getElementById('weeklySettings').style.display = document.getElementById('backup_schedule_type').value === 'weekly' ? 'block' : 'none';
    };
    
    const populateNotificationTypes = () => {
        const container = document.getElementById('notificationTypes');
        container.innerHTML = Object.entries(notificationTypes).map(([key, label]) => `
            <div class="flex items-center">
                <input type="checkbox" id="${key}" name="${key}" class="h-4 w-4 rounded text-sky-500 focus:ring-sky-500">
                <label for="${key}" class="ml-2 text-sm">${label}</label>
            </div>`).join('');
    };
    
    // Funkcie pre filtrovanie logov
    const updateDeviceFilters = async () => {
        const devices = await api.get('devices');
        const deviceSelect = document.getElementById('deviceFilter');
        const deviceSelectMobile = document.getElementById('deviceFilterMobile');
        
        const options = '<option value="">Všetky zariadenia</option>' + 
            devices.map(device => `<option value="${device.ip}">${device.name} (${device.ip})</option>`).join('');
        
        deviceSelect.innerHTML = options;
        deviceSelectMobile.innerHTML = options;
    };
    
    const applyLogFilters = () => {
        const entries = document.querySelectorAll('.log-entry');
        
        entries.forEach(entry => {
            const deviceFilter = entry.getAttribute('data-device');
            const typeFilter = entry.getAttribute('data-type');
            const levelFilter = entry.getAttribute('data-level');
            const messageText = entry.textContent || '';
            
            let visible = true;
            
            // Filter by device - hľadáme IP aj v data-device aj v texte správy
            if (currentFilters.device) {
                const deviceMatches = deviceFilter === currentFilters.device || 
                                    messageText.includes(currentFilters.device);
                if (!deviceMatches) {
                    visible = false;
                }
            }
            
            // Filter by type
            if (currentFilters.type && typeFilter !== currentFilters.type) {
                visible = false;
            }
            
            // Filter by level
            if (currentFilters.level !== 'all' && levelFilter !== currentFilters.level) {
                visible = false;
            }
            
            entry.classList.toggle('filtered', !visible);
        });
    };
    
    const setupLogFilters = () => {
        // Desktop filtre
        const deviceFilter = document.getElementById('deviceFilter');
        const typeFilter = document.getElementById('typeFilter');
        const levelButtons = document.querySelectorAll('.filter-level-btn');
        
        // Mobile filtre
        const deviceFilterMobile = document.getElementById('deviceFilterMobile');
        const typeFilterMobile = document.getElementById('typeFilterMobile');
        const levelButtonsMobile = document.querySelectorAll('.filter-level-btn-mobile');
        
        // Device filter events
        [deviceFilter, deviceFilterMobile].forEach(filter => {
            filter.addEventListener('change', (e) => {
                currentFilters.device = e.target.value;
                applyLogFilters();
                // Sync both selects
                deviceFilter.value = e.target.value;
                deviceFilterMobile.value = e.target.value;
            });
        });
        
        // Type filter events
        [typeFilter, typeFilterMobile].forEach(filter => {
            filter.addEventListener('change', (e) => {
                currentFilters.type = e.target.value;
                applyLogFilters();
                // Sync both selects
                typeFilter.value = e.target.value;
                typeFilterMobile.value = e.target.value;
            });
        });
        
        // Level filter events
        [...levelButtons, ...levelButtonsMobile].forEach(btn => {
            btn.addEventListener('click', (e) => {
                const level = e.target.id.replace('level', '').replace('Mobile', '').toLowerCase();
                currentFilters.level = level;
                
                // Update active states
                [...levelButtons, ...levelButtonsMobile].forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`#level${level.charAt(0).toUpperCase() + level.slice(1)}, #level${level.charAt(0).toUpperCase() + level.slice(1)}Mobile`).forEach(b => b.classList.add('active'));
                
                applyLogFilters();
            });
        });
    };

    document.getElementById('addDeviceBtn').addEventListener('click', () => openDeviceModal());
    document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
    document.getElementById('cancelDeviceBtn').addEventListener('click', closeModal);
    document.getElementById('cancelSettingsBtn').addEventListener('click', closeModal);
    document.getElementById('closeSettingsBtn').addEventListener('click', closeModal);
    document.getElementById('cancelPasswordChangeBtn').addEventListener('click', closeModal);
    document.getElementById('closeSnmpStatusBtn').addEventListener('click', closeModal);
    document.getElementById('refreshSnmpStatusBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshSnmpStatusBtn');
        const icon = btn.querySelector('i');
        const contentDiv = document.getElementById('snmpStatusContent');
        
        // Animácia len refresh tlačidla - žiadny overlay
        icon.classList.add('fa-spin');
        btn.disabled = true;
        
        try {
            const status = await api.get('snmp/status');
            
            // Vytvoríme obsah pre modál (rovnaký kód ako v hlavnom event listeneri)
            let content = `
                <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                    <h3 class="text-lg font-semibold text-sky-400 mb-3">📊 Globálne informácie</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Globálny interval:</strong> <span class="text-green-400">${status.global_interval} minút</span></div>
                        <div><strong>Čas kontroly:</strong> <span class="text-gray-300">${new Date(status.current_time).toLocaleString('sk-SK')}</span></div>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold text-sky-400 mb-4">🔧 Stav zariadení</h3>
                <div class="grid gap-4">
            `;
            
            status.devices.forEach(device => {
                const intervalText = device.interval_setting > 0 
                    ? `${device.interval_setting} min (vlastný)` 
                    : `${status.global_interval} min (globálny)`;
                const statusClass = device.is_due ? 'text-red-400' : 'text-green-400';
                const statusIcon = device.is_due ? '🔴' : '🟢';
                const statusText = device.is_due ? 'TREBA KONTROLA' : 'Čaká';
                
                content += `
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-sky-300">${device.name}</h4>
                            <span class="font-mono text-sm text-gray-400">${device.ip}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><strong>Interval:</strong> <span class="text-gray-300">${intervalText}</span></div>
                            <div><strong>Posledná kontrola:</strong> <span class="text-gray-300">${device.last_check}</span></div>
                            <div><strong>Ďalšia kontrola:</strong> <span class="text-gray-300">${device.next_check}</span></div>
                            <div><strong>Stav:</strong> <span class="${statusClass}">${statusIcon} ${statusText}</span></div>
                        </div>
                    </div>
                `;
            });
            
            content += `</div>`;
            
            // Priamo nastavíme nový obsah modálu - žiadne fade efekty
            contentDiv.innerHTML = content;
            
        } catch (error) {
            // Zobrazíme chybu bez fade efektov
            contentDiv.innerHTML = `
                <div class="bg-red-900/20 border border-red-500 p-4 rounded-lg text-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-400 font-semibold">Chyba pri obnovovaní SNMP stavu</p>
                    <p class="text-gray-400 text-sm mt-2">Skúste to znova alebo skontrolujte pripojenie k serveru.</p>
                </div>
            `;
        } finally {
            // Vrátime tlačidlo do normálneho stavu
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }
    });
    document.getElementById('backupAllBtn').addEventListener('click', async () => {
        const btn = document.getElementById('backupAllBtn');
        const stopBtn = document.getElementById('stopAllBackupsBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Spúšťam...';
        btn.disabled = true;
        
        try {
            const result = await api.post('backup/all');
            if (result.status === 'success') {
                btn.innerHTML = '<i class="fas fa-clock"></i> Prebieha...';
                stopBtn.classList.remove('hidden'); // Zobrazíme stop tlačidlo
                
                // Každých 5 sekúnd kontrolujeme stav
                const checkStatus = setInterval(async () => {
                    const status = await api.get('backup/status');
                    if (status.total_running === 0 && !status.sequential_backup_running) {
                        clearInterval(checkStatus);
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        stopBtn.classList.add('hidden'); // Skryjeme stop tlačidlo
                    } else {
                        btn.innerHTML = `<i class="fas fa-clock"></i> Prebieha (${status.total_running})`;
                    }
                }, 5000);
            } else {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (error) {
            btn.innerHTML = originalText;
            btn.disabled = false;
            stopBtn.classList.add('hidden');
        }
    });

    document.getElementById('stopAllBackupsBtn').addEventListener('click', async () => {
        const stopBtn = document.getElementById('stopAllBackupsBtn');
        const backupBtn = document.getElementById('backupAllBtn');
        
        stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Zastavujem...';
        stopBtn.disabled = true;
        
        try {
            const result = await api.post('backup/stop-all');
            addLog('warning', result.message || 'Zálohy boli zastavené.');
            
            // Skryjeme stop tlačidlo a obnovíme backup tlačidlo
            stopBtn.classList.add('hidden');
            backupBtn.innerHTML = '<i class="fas fa-save"></i> Zálohovať všetky';
            backupBtn.disabled = false;
        } catch (error) {
            addLog('error', 'Chyba pri zastavovaní záloh.');
        } finally {
            stopBtn.innerHTML = '<i class="fas fa-stop"></i> Zastaviť zálohy';
            stopBtn.disabled = false;
        }
    });
    document.getElementById('refreshAllSnmpBtn').addEventListener('click', () => {
        const btn = document.getElementById('refreshAllSnmpBtn');
        const icon = btn.querySelector('i');
        const originalText = btn.innerHTML;
        
        // Animácia tlačidla
        icon.classList.add('fa-spin');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aktualizujem...';
        
        // Postupný refresh všetkých SNMP namiesto súčasného
        const cards = document.querySelectorAll('[data-id]');
        let completedRequests = 0;
        
        cards.forEach((card, index) => {
            // Pridáme visual feedback pre každú kartu
            setTimeout(() => {
                // Subtle loading indikátor na kartu
                card.style.opacity = '0.7';
                card.style.transition = 'opacity 0.3s ease-in-out';
                
                api.get(`snmp/${card.dataset.id}`).then(() => {
                    // Po dokončení requesto vrátime kartu do normálneho stavu
                    setTimeout(() => {
                        card.style.opacity = '1';
                    }, 200);
                    
                    completedRequests++;
                    
                    // Ak sú všetky requesty dokončené, vrátime tlačidlo do normálneho stavu
                    if (completedRequests === cards.length) {
                        setTimeout(() => {
                            icon.classList.remove('fa-spin');
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }, 500); // Malé oneskorenie pre lepší UX
                    }
                }).catch(() => {
                    // Aj pri chybe vrátime kartu do normálneho stavu
                    card.style.opacity = '1';
                    completedRequests++;
                    
                    if (completedRequests === cards.length) {
                        setTimeout(() => {
                            icon.classList.remove('fa-spin');
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }, 500);
                    }
                });
            }, index * 750); // Zvýšené na 750ms medzi každým requestom
        });
        
        // Fallback timeout pre prípad, že niektoré requesty nezodpovedajú
        setTimeout(() => {
            icon.classList.remove('fa-spin');
            btn.disabled = false;
            btn.innerHTML = originalText;
            
            // Vrátime všetky karty do normálneho stavu
            cards.forEach(card => {
                card.style.opacity = '1';
            });
        }, cards.length * 750 + 5000); // Počkáme na všetky requesty + 5 sekúnd buffer
    });
    document.getElementById('snmpStatusBtn').addEventListener('click', async () => {
        // Otvoríme modál s loading stavom
        snmpStatusModal.classList.remove('hidden');
        document.getElementById('snmpStatusContent').innerHTML = `
            <div class="flex justify-center items-center py-8">
                <i class="fas fa-spinner fa-spin text-2xl text-sky-500 mr-3"></i>
                <span class="text-lg">Načítavam SNMP stav...</span>
            </div>
        `;
        
        try {
            const status = await api.get('snmp/status');
            
            // Vytvoríme obsah pre modál
            let content = `
                <div class="bg-gray-800 p-4 rounded-lg mb-6 border border-gray-600">
                    <h3 class="text-lg font-semibold text-sky-400 mb-3">📊 Globálne informácie</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Globálny interval:</strong> <span class="text-green-400">${status.global_interval} minút</span></div>
                        <div><strong>Čas kontroly:</strong> <span class="text-gray-300">${new Date(status.current_time).toLocaleString('sk-SK')}</span></div>
                    </div>
                </div>
                
                <h3 class="text-lg font-semibold text-sky-400 mb-4">🔧 Stav zariadení</h3>
                <div class="grid gap-4">
            `;
            
            status.devices.forEach(device => {
                const intervalText = device.interval_setting > 0 
                    ? `${device.interval_setting} min (vlastný)` 
                    : `${status.global_interval} min (globálny)`;
                const statusClass = device.is_due ? 'text-red-400' : 'text-green-400';
                const statusIcon = device.is_due ? '🔴' : '🟢';
                const statusText = device.is_due ? 'TREBA KONTROLA' : 'Čaká';
                
                content += `
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-600">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-sky-300">${device.name}</h4>
                            <span class="font-mono text-sm text-gray-400">${device.ip}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><strong>Interval:</strong> <span class="text-gray-300">${intervalText}</span></div>
                            <div><strong>Posledná kontrola:</strong> <span class="text-gray-300">${device.last_check}</span></div>
                            <div><strong>Ďalšia kontrola:</strong> <span class="text-gray-300">${device.next_check}</span></div>
                            <div><strong>Stav:</strong> <span class="${statusClass}">${statusIcon} ${statusText}</span></div>
                        </div>
                    </div>
                `;
            });
            
            content += `</div>`;
            
            // Nastavíme obsah modálu
            document.getElementById('snmpStatusContent').innerHTML = content;
            
        } catch (error) {
            document.getElementById('snmpStatusContent').innerHTML = `
                <div class="bg-red-900/20 border border-red-500 p-4 rounded-lg text-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-400 font-semibold">Chyba pri načítaní SNMP stavu</p>
                    <p class="text-gray-400 text-sm mt-2">Skúste to znova alebo skontrolujte pripojenie k serveru.</p>
                </div>
            `;
        }
    });
    document.getElementById('backup_schedule_type').addEventListener('change', toggleWeeklySettings);
    document.getElementById('testPushoverBtn').addEventListener('click', () => api.post('notifications/test'));
    
    // Event listenery pre logy
    document.getElementById('refreshLogsBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshLogsBtn');
        const icon = btn.querySelector('i');
        const logsContainer = document.getElementById('logsContainer');
        const mobileLogsContainer = document.getElementById('logsContainerMobile');
        const originalText = btn.innerHTML;
        
        // Animácia refresh tlačidla
        icon.classList.add('fa-spin');
        btn.disabled = true;
        
        // Pridáme velmi diskrétny loading overlay bez zmeny obsahu
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'logsLoadingOverlay';
        loadingOverlay.className = 'absolute top-2 right-2 z-10 opacity-0';
        loadingOverlay.style.transition = 'opacity 0.2s ease-in-out';
        loadingOverlay.innerHTML = `
            <div class="bg-gray-800/80 backdrop-blur-sm p-1 rounded border border-gray-600/40">
                <i class="fas fa-spinner fa-spin text-xs text-sky-500"></i>
            </div>
        `;
        
        // Pre mobile logy - rovnako diskrétny
        const mobileLoadingOverlay = document.createElement('div');
        mobileLoadingOverlay.id = 'mobileLogsLoadingOverlay';
        mobileLoadingOverlay.className = 'absolute top-2 right-2 z-10 opacity-0';
        mobileLoadingOverlay.style.transition = 'opacity 0.2s ease-in-out';
        mobileLoadingOverlay.innerHTML = `
            <div class="bg-gray-800/80 backdrop-blur-sm p-1 rounded border border-gray-600/40">
                <i class="fas fa-spinner fa-spin text-xs text-sky-500"></i>
            </div>
        `;
        
        // Nastavíme relatívnu pozíciu pre kontajnery ak ju nemajú
        const logsCardParent = logsContainer.closest('.card');
        const mobileLogsCardParent = mobileLogsContainer ? mobileLogsContainer.closest('.card') : null;
        
        if (logsCardParent) {
            logsCardParent.style.position = 'relative';
            logsCardParent.appendChild(loadingOverlay);
            // Postupne zobrazíme overlay v rohu
            setTimeout(() => loadingOverlay.style.opacity = '1', 50);
        }
        
        if (mobileLogsCardParent) {
            mobileLogsCardParent.style.position = 'relative';
            mobileLogsCardParent.appendChild(mobileLoadingOverlay);
            // Postupne zobrazíme overlay v rohu
            setTimeout(() => mobileLoadingOverlay.style.opacity = '1', 50);
        }
        
        try {
            // Zavoláme pôvodnú loadLogs funkciu - NEMENENÉ!
            await loadLogs();
            
        } catch (error) {
            // Pôvodná funkcionalita pre chyby - NEMENENÉ!
            addLog('error', 'Chyba pri obnovovaní logov');
        } finally {
            // Jemne odstránime loading overlay
            if (loadingOverlay && loadingOverlay.parentNode) {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    if (loadingOverlay.parentNode) {
                        loadingOverlay.remove();
                    }
                }, 150);
            }
            
            if (mobileLoadingOverlay && mobileLoadingOverlay.parentNode) {
                mobileLoadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    if (mobileLoadingOverlay.parentNode) {
                        mobileLoadingOverlay.remove();
                    }
                }, 150);
            }
            
            // Vrátime tlačidlo do normálneho stavu
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }
    });
    
    // Filter tlačidlá pre logy
    document.getElementById('logsFilterBtn').addEventListener('click', () => {
        const filters = document.getElementById('logsFilters');
        filters.classList.toggle('hidden');
    });
    
    document.getElementById('logsFilterBtnMobile').addEventListener('click', () => {
        const filters = document.getElementById('logsFiltersMobile');
        filters.classList.toggle('hidden');
    });

    // Event listenery pre mobilné tlačidlá
    document.getElementById('refreshLogsBtnMobile').addEventListener('click', () => {
        document.getElementById('refreshLogsBtn').click();
    });

    deviceForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
            id: document.getElementById('deviceId').value,
            name: document.getElementById('deviceName').value,
            ip: document.getElementById('deviceIp').value,
            username: document.getElementById('deviceUsername').value,
            password: document.getElementById('devicePassword').value,
            snmp_community: document.getElementById('deviceSnmpCommunity').value,
            snmp_interval_minutes: parseInt(document.getElementById('deviceSnmpInterval').value) || 0,
            low_memory: document.getElementById('deviceLowMemory').checked,
        };
        const result = await api.post('devices', body);
        closeModal();
        loadDevices();
        
        // Ak je to nové zariadenie (bez ID), automaticky spusť SNMP check
        if (!body.id && result.status === 'success' && result.device_id) {
            setTimeout(() => {
                api.get(`snmp/${result.device_id}`);
            }, 1000); // Krátke oneskorenie pre načítanie zariadenia
        }
    });
    
    settingsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {};
        new FormData(settingsForm).forEach((value, key) => body[key] = value);
        settingsForm.querySelectorAll('input[type="checkbox"]').forEach(cb => body[cb.name] = cb.checked.toString());
        const result = await api.post('settings', body);
        closeModal();
        
        // Zobrazíme úspešné uloženie nastavení
        addLog('success', 'Nastavenia boli uložené.');
        
        // Ak máme informácie o pláne automatického zálohovania, zobrazíme ich
        if (result && result.schedule_info) {
            addLog('info', result.schedule_info);
        }
    });

    changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageDiv = document.getElementById('passwordChangeMessage');
        const body = {
            old_password: document.getElementById('oldPassword').value,
            new_password: document.getElementById('newPassword').value,
            new_password_confirm: document.getElementById('newPasswordConfirm').value,
        };
        const result = await api.post('user/change-password', body);
        messageDiv.textContent = result.message;
        messageDiv.classList.remove('hidden', 'bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
        if (result.status === 'success') {
            messageDiv.classList.add('bg-green-900/50', 'text-green-300');
            changePasswordForm.reset();
            setTimeout(() => {
                closeModal();
                messageDiv.classList.add('hidden');
            }, 2000);
        } else {
            messageDiv.classList.add('bg-red-900/50', 'text-red-300');
        }
    });

    // === 2FA Management Functions ===
    
    // Load 2FA status
    const load2faStatus = async () => {
        try {
            const statusDiv = document.getElementById('backup2faStatus');
            const controlsDiv = document.getElementById('backup2faControls');
            
            const data = await api.get('user/backup-codes');
            
            if (data && typeof data.remaining_codes !== 'undefined') {
                const remainingCodes = data.remaining_codes || 0;
                document.getElementById('remainingCodes').textContent = remainingCodes;
                
                statusDiv.classList.add('hidden');
                controlsDiv.classList.remove('hidden');
            } else {
                throw new Error('Neplatná odpoveď zo servera');
            }
            
        } catch (error) {
            console.error('Chyba pri načítavaní 2FA stavu:', error);
            const statusDiv = document.getElementById('backup2faStatus');
            
            let errorMessage = 'Chyba pri načítavaní stavu 2FA';
            if (error.message.includes('404')) {
                errorMessage = '2FA nie je aktivované pre tento účet';
            } else if (error.message.includes('500')) {
                errorMessage = 'Chyba servera. Skúste obnoviť stránku.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            statusDiv.innerHTML = `<div class="text-red-400 text-center">${errorMessage}</div>`;
        }
    };
    
    // Generate backup codes
    const generateBackupCodes = async (password) => {
        const messageDiv = document.getElementById('confirmPasswordMessage');
        
        try {
            // Skryje predchádzajúce chybové správy
            messageDiv.classList.add('hidden');
            
            const data = await api.post('user/backup-codes', { password });
            
            if (data && data.status === 'success' && data.backup_codes) {
                displayBackupCodes(data.backup_codes);
                confirmPasswordModal.classList.add('hidden');
                backupCodesModal.classList.remove('hidden');
                return true;
            } else {
                throw new Error(data?.message || 'Neplatná odpoveď zo servera');
            }
        } catch (error) {
            console.error('Chyba pri generovaní záložných kódov:', error);
            
            let errorMessage = 'Chyba pri generovaní záložných kódov';
            
            if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                errorMessage = 'Nesprávne heslo';
            } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                errorMessage = 'Nemáte oprávnenie na túto operáciu';
            } else if (error.message.includes('500')) {
                errorMessage = 'Chyba servera. Skúste to znova neskôr.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            messageDiv.textContent = errorMessage;
            messageDiv.classList.remove('hidden', 'bg-green-900/50', 'text-green-300', 'bg-red-900/50', 'text-red-300');
            messageDiv.classList.add('bg-red-900/50', 'text-red-300');
            return false;
        }
    };
    
    // Display backup codes
    const displayBackupCodes = (codes) => {
        const container = document.getElementById('backupCodesDisplay');
        container.innerHTML = '';
        
        codes.forEach(code => {
            const codeDiv = document.createElement('div');
            codeDiv.className = 'bg-gray-800 p-2 rounded text-center text-gray-200';
            codeDiv.textContent = code;
            container.appendChild(codeDiv);
        });
    };
    
    // Download backup codes as file
    const downloadBackupCodes = () => {
        const codes = Array.from(document.getElementById('backupCodesDisplay').children)
            .map(div => div.textContent)
            .join('\n');
        
        const blob = new Blob([
            `MikroTik Manager - Záložné kódy pre 2FA\n` +
            `Vygenerované: ${new Date().toLocaleString('sk-SK')}\n\n` +
            `DÔLEŽITÉ:\n` +
            `- Každý kód možno použiť iba jedenkrát\n` +
            `- Uložte si tieto kódy na bezpečné miesto\n` +
            `- Nikomu ich neposkytujte\n\n` +
            `Záložné kódy:\n${codes}`
        ], { type: 'text/plain' });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mikrotik-backup-codes-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };
    
    // Print backup codes
    const printBackupCodes = () => {
        const codes = Array.from(document.getElementById('backupCodesDisplay').children)
            .map(div => div.textContent);
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>MikroTik Manager - Záložné kódy</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .warning { background-color: #fee; border: 1px solid #fcc; padding: 15px; margin: 20px 0; border-radius: 5px; }
                        .codes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
                        .code { background-color: #f9f9f9; padding: 10px; text-align: center; font-family: monospace; font-size: 14px; border: 1px solid #ddd; border-radius: 3px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>MikroTik Manager</h1>
                        <h2>Záložné kódy pre dvojfaktorové overenie</h2>
                        <p>Vygenerované: ${new Date().toLocaleString('sk-SK')}</p>
                    </div>
                    <div class="warning">
                        <h3>⚠️ DÔLEŽITÉ UPOZORNENIE</h3>
                        <ul>
                            <li>Každý kód možno použiť iba jedenkrát</li>
                            <li>Uložte si tieto kódy na bezpečné miesto</li>
                            <li>Nikomu ich neposkytujte</li>
                            <li>Po použití kódu ho vyškrtnite zo zoznamu</li>
                        </ul>
                    </div>
                    <div class="codes">
                        ${codes.map(code => `<div class="code">${code}</div>`).join('')}
                    </div>
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    };
    
    // Event listeners for 2FA modals
    document.getElementById('close2faModalBtn').addEventListener('click', () => {
        manage2faModal.classList.add('hidden');
    });
    
    document.getElementById('generateBackupCodesBtn').addEventListener('click', () => {
        manage2faModal.classList.add('hidden');
        confirmPasswordModal.classList.remove('hidden');
        document.getElementById('confirmPasswordInput').focus();
    });
    
    document.getElementById('cancelConfirmPasswordBtn').addEventListener('click', () => {
        confirmPasswordModal.classList.add('hidden');
        manage2faModal.classList.remove('hidden');
        document.getElementById('confirmPasswordForm').reset();
        document.getElementById('confirmPasswordMessage').classList.add('hidden');
    });
    
    document.getElementById('confirmPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('confirmPasswordInput').value;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generujem...';
        
        try {
            await generateBackupCodes(password);
        } finally {
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
    
    document.getElementById('closeBackupCodesBtn').addEventListener('click', () => {
        backupCodesModal.classList.add('hidden');
        manage2faModal.classList.remove('hidden');
        load2faStatus(); // Refresh the status
        document.getElementById('confirmPasswordForm').reset();
        document.getElementById('confirmPasswordMessage').classList.add('hidden');
    });
    
    document.getElementById('downloadCodesBtn').addEventListener('click', downloadBackupCodes);
    document.getElementById('printCodesBtn').addEventListener('click', printBackupCodes);
    
    // Close modals when clicking outside
    [manage2faModal, confirmPasswordModal, backupCodesModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                if (modal === confirmPasswordModal || modal === backupCodesModal) {
                    manage2faModal.classList.remove('hidden');
                }
            }
        });
    });

    // Inicializácia aplikácie
    const initializeApp = async () => {
        try {
            // Načítavame postupne, nie všetko naraz
            await loadUserStatus();
            populateNotificationTypes();
            setupLogFilters();
            
            // Malé oneskorenie medzi operáciami
            await new Promise(resolve => setTimeout(resolve, 100));
            await updateDeviceFilters();
            
            await new Promise(resolve => setTimeout(resolve, 100));
            await loadDevices();
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Načítanie logov bez startup správy
            await loadLogs();
        } catch (error) {
            console.error('Chyba pri inicializácii aplikácie:', error);
            addLogToContainer('error', 'Chyba pri inicializácii aplikácie', '', new Date().toISOString());
        }
    };
    
    // Spustenie inicializácie
    initializeApp();

    // Po načítaní stránky automaticky obnov SNMP pre všetky zariadenia - postupne
    window.addEventListener('DOMContentLoaded', function() {
        // Oneskorenie pred SNMP refresh, aby sa stihla načítať aplikácia
        setTimeout(() => {
            fetch('/api/devices')
                .then(resp => resp.json())
                .then(devices => {
                    // SNMP refresh pre každé zariadenie s oneskorením
                    devices.forEach((device, index) => {
                        setTimeout(() => {
                            fetch(`/api/snmp/${device.id}`)
                                .then(() => {/* SNMP refresh prebehol */})
                                .catch(() => {/* Ignoruj chyby */});
                        }, index * 1500); // Zvýšené na 1.5 sekundy medzi requestmi
                    });
                })
                .catch(error => console.error('Chyba pri automatickom SNMP refresh:', error));
        }, 3000); // Zvýšené na 3 sekundy po načítaní aplikácie
    });
    
    // Funkcie pre prepínanie témy
    function initTheme() {
        const savedTheme = localStorage.getItem('mikrotik-theme') || 'dark';
        document.body.className = savedTheme === 'light' ? 'light-theme p-4 md:p-8' : 'p-4 md:p-8';
        updateThemeIcon();
    }
    
    function toggleTheme() {
        const isLight = document.body.classList.contains('light-theme');
        if (isLight) {
            document.body.className = 'p-4 md:p-8';
            localStorage.setItem('mikrotik-theme', 'dark');
        } else {
            document.body.className = 'light-theme p-4 md:p-8';
            localStorage.setItem('mikrotik-theme', 'light');
        }
        updateThemeIcon();
    }
    
    function updateThemeIcon() {
        const icon = document.getElementById('theme-icon');
        const isLight = document.body.classList.contains('light-theme');
        icon.className = isLight ? 'fas fa-moon' : 'fas fa-sun';
    }
    
    // Inicializácia témy pri načítaní stránky
    initTheme();
    
    // Event listener pre prepínač témy
    document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);
});
</script>
</body>
</html>