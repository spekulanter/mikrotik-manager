#!/bin/bash
#
# MikroTik Backup Manager - Smart Installer/Updater
# Deteguje existuj√∫cu in≈°tal√°ciu a spust√≠ buƒè in≈°tal√°ciu alebo update
#
set -e

# Funkcie pre farebn√Ω v√Ωstup
function msg_info() { echo -e "\\033[1;34mINFO\\033[0m: $1"; }
function msg_ok() { echo -e "\\033[1;32mSUCCESS\\033[0m: $1"; }
function msg_warn() { echo -e "\\033[1;33mWARNING\\033[0m: $1"; }

# Premenn√©
REPO_URL="https://github.com/spekulanter/mikrotik-manager.git"
APP_DIR="/opt/mikrotik-manager"
DATA_DIR="/var/lib/mikrotik-manager"
SERVICE_FILE="/etc/systemd/system/mikrotik-manager.service"

# Kontrola, ƒçi u≈æ existuje in≈°tal√°cia
if [ -d "${APP_DIR}" ] && [ -f "${SERVICE_FILE}" ] && systemctl is-enabled mikrotik-manager.service &>/dev/null; then
    echo "üîÑ Detegovan√° existuj√∫ca in≈°tal√°cia - sp√∫≈°≈•am aktualiz√°ciu..."
    
    # UPDATE PROCES
    msg_info "Zastavujem slu≈æbu MikroTik Backup Manager..."
    systemctl stop mikrotik-manager.service &>/dev/null
    msg_ok "Slu≈æba zastaven√°."
    
    msg_info "Z√°lohujem aktu√°lnu konfigur√°ciu..."
    # Z√°loha datab√°zy a konfiguraƒçn√Ωch s√∫borov
    if [ -d "${DATA_DIR}/data" ]; then
        cp -r ${DATA_DIR}/data ${DATA_DIR}/data.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
    fi
    msg_ok "Konfigur√°cia z√°lohovan√°."
    
    msg_info "S≈•ahujem najnov≈°ie zmeny z ${REPO_URL}..."
    cd ${APP_DIR}
    # Resetuj na najnov≈°√≠ main branch (prep√≠≈°e lok√°lne zmeny)
    git fetch origin
    git reset --hard origin/main
    msg_ok "K√≥d aktualizovan√Ω."
    
    msg_info "Aktualizujem Python z√°vislosti..."
    source ${APP_DIR}/venv/bin/activate
    pip install -r ${APP_DIR}/requirements.txt &>/dev/null
    deactivate
    msg_ok "Z√°vislosti aktualizovan√©."
    
    msg_info "Sp√∫≈°≈•am slu≈æbu..."
    systemctl start mikrotik-manager.service &>/dev/null
    msg_ok "Slu≈æba spusten√°."
    
    echo "‚úÖ Aktualiz√°cia dokonƒçen√°!"
    echo "üåê Aplik√°cia je dostupn√° na: http://$(hostname -I | awk '{print $1}'):5000"
    
else
    echo "üÜï Sp√∫≈°≈•am ƒçerstv√∫ in≈°tal√°ciu..."
    
    # IN≈†TALAƒåN√ù PROCES
    # Aktualiz√°cia syst√©mu a in≈°tal√°cia z√°vislost√≠
    msg_info "Aktualizujem syst√©m a in≈°talujem potrebn√© bal√≠ƒçky..."
    apt-get update &>/dev/null
    apt-get install -y git python3-pip python3-venv curl wget unzip openjdk-17-jdk &>/dev/null
    msg_ok "Syst√©mov√© z√°vislosti s√∫ nain≈°talovan√©."
    
    # In≈°tal√°cia Node.js 18.x
    msg_info "In≈°talujem Node.js 18.x pre Android development..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash - &>/dev/null
    apt-get install -y nodejs &>/dev/null
    msg_ok "Node.js nain≈°talovan√©: $(node -v)"
    
    # In≈°tal√°cia Android SDK
    msg_info "In≈°talujem Android SDK pre APK building..."
    mkdir -p /opt/android-sdk
    cd /tmp
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
    unzip -q commandlinetools-linux-11076708_latest.zip -d /opt/android-sdk/
    mv /opt/android-sdk/cmdline-tools /opt/android-sdk/cmdline-tools-temp
    mkdir -p /opt/android-sdk/cmdline-tools/latest
    mv /opt/android-sdk/cmdline-tools-temp/* /opt/android-sdk/cmdline-tools/latest/
    rmdir /opt/android-sdk/cmdline-tools-temp
    rm commandlinetools-linux-11076708_latest.zip
    
    # Nastavenie Android SDK environment
    export ANDROID_HOME=/opt/android-sdk
    export ANDROID_SDK_ROOT=/opt/android-sdk
    export PATH=${PATH}:${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools
    
    # In≈°tal√°cia Android SDK komponentov
    yes | /opt/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses &>/dev/null
    /opt/android-sdk/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-35" "build-tools;35.0.0" &>/dev/null
    msg_ok "Android SDK nain≈°talovan√©."
    
    # In≈°tal√°cia Gradle
    msg_info "In≈°talujem Gradle build system..."
    wget -q https://services.gradle.org/distributions/gradle-8.13-bin.zip -O /tmp/gradle.zip
    unzip -q /tmp/gradle.zip -d /opt/
    mv /opt/gradle-8.13 /opt/gradle
    rm /tmp/gradle.zip
    export PATH=${PATH}:/opt/gradle/bin
    msg_ok "Gradle nain≈°talovan√©: $(gradle -v | head -n1)"
    
    # In≈°tal√°cia Cordova CLI
    msg_info "In≈°talujem Cordova CLI pre mobile app development..."
    npm install -g cordova &>/dev/null
    msg_ok "Cordova nain≈°talovan√©: $(cordova -v)"
    
    # Vytvorenie environment setup file
    msg_info "Vytv√°ram environment setup s√∫bor..."
    cat << 'ENVEOF' > /etc/environment
ANDROID_HOME=/opt/android-sdk
ANDROID_SDK_ROOT=/opt/android-sdk
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/android-sdk/cmdline-tools/latest/bin:/opt/android-sdk/platform-tools:/opt/gradle/bin"
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENVEOF
    
    # Vytvorenie profile setup
    cat << 'PROFEOF' > /etc/profile.d/android-dev.sh
export ANDROID_HOME=/opt/android-sdk
export ANDROID_SDK_ROOT=/opt/android-sdk
export PATH=${PATH}:${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:/opt/gradle/bin
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
PROFEOF
    chmod +x /etc/profile.d/android-dev.sh
    msg_ok "Android development prostredie nastaven√©."
    
    # Vytvorenie adres√°rov
    msg_info "Vytv√°ram adres√°re aplik√°cie a pre d√°ta..."
    mkdir -p ${APP_DIR}
    mkdir -p ${DATA_DIR}/data/backups
    chown -R root:root ${APP_DIR}
    chown -R root:root ${DATA_DIR}
    msg_ok "Adres√°re s√∫ pripraven√©."

    # Klonovanie repozit√°ra
    msg_info "S≈•ahujem aplik√°ciu z ${REPO_URL}..."
    git clone ${REPO_URL} ${APP_DIR} &>/dev/null
    msg_ok "Aplik√°cia stiahnut√°."
    
    # Vytvorenie Python Virtual Environment
    msg_info "Vytv√°ram izolovan√© Python prostredie (venv)..."
    python3 -m venv ${APP_DIR}/venv
    msg_ok "Virtual environment vytvoren√©."
    
    # In≈°tal√°cia Python kni≈æn√≠c
    msg_info "In≈°talujem potrebn√© Python kni≈ænice..."
    source ${APP_DIR}/venv/bin/activate
    pip install -r ${APP_DIR}/requirements.txt &>/dev/null
    deactivate
    msg_ok "Kni≈ænice nain≈°talovan√©."
    
    # Vytvorenie a nastavenie systemd slu≈æby
    msg_info "Vytv√°ram systemd slu≈æbu pre automatick√© sp√∫≈°≈•anie..."
    cat << EOF > ${SERVICE_FILE}
[Unit]
Description=MikroTik Backup Manager
After=network.target

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=${APP_DIR}
ExecStart=/opt/mikrotik-manager/venv/bin/gunicorn --worker-class eventlet -w 1 --bind 0.0.0.0:5000 "app:app"
Restart=always
RestartSec=10
Environment="DATA_DIR=${DATA_DIR}/data"

[Install]
WantedBy=multi-user.target
EOF
    msg_ok "S√∫bor pre slu≈æbu vytvoren√Ω."
    
    # Povolenie a spustenie slu≈æby
    msg_info "Povoƒæujem a sp√∫≈°≈•am slu≈æbu MikroTik Backup Manager..."
    systemctl daemon-reload
    systemctl enable --now mikrotik-manager.service &>/dev/null
    msg_ok "Slu≈æba mikrotik-manager.service je akt√≠vna a be≈æ√≠."
    
    echo "üéâ In≈°tal√°cia dokonƒçen√°!"
    echo "üåê Web aplik√°cia je dostupn√° na: http://$(hostname -I | awk '{print $1}'):5000"
    echo "üìã Prv√© prihl√°senie: vytvorte si √∫ƒçet cez registraƒçn√Ω formul√°r"
    echo ""
    echo "üì± Android Development Tools nain≈°talovan√©:"
    echo "   ‚Ä¢ Node.js $(node -v 2>/dev/null || echo 'N/A')"
    echo "   ‚Ä¢ Java $(java -version 2>&1 | head -n1 | cut -d'"' -f2 2>/dev/null || echo 'N/A')"
    echo "   ‚Ä¢ Android SDK v35.0.0"
    echo "   ‚Ä¢ Gradle $(gradle -v 2>/dev/null | head -n1 | awk '{print $2}' || echo 'N/A')"
    echo "   ‚Ä¢ Cordova $(cordova -v 2>/dev/null || echo 'N/A')"
    echo ""
    echo "üõ†Ô∏è  APK Building:"
    echo "   cd /opt/mikrotik-manager-app && cordova build android"
    
fi

echo ""
echo "üìñ U≈æitoƒçn√© pr√≠kazy:"
echo "   Re≈°tart slu≈æby:    systemctl restart mikrotik-manager.service"
echo "   Stav slu≈æby:       systemctl status mikrotik-manager.service"  
echo "   Logy slu≈æby:       journalctl -u mikrotik-manager.service -f"
echo "   Manu√°lny update:   cd ${APP_DIR} && ./update.sh"
echo ""
echo "üì± Android APK Development:"
echo "   Build APK:         cd ${APP_DIR} && ./build-apk.sh"
echo "   Cordova projekt:   /opt/mikrotik-manager-app/"
echo "   Fin√°lny APK:       /opt/MikroTikManager.apk"