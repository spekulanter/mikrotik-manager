<!DOCTYPE html>
<html lang="sk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroTik Aktualizátor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-bg: #111827;
            --card-bg: #1f2937;
            --border-color: #374151;
            --text-color: #d1d5db;
            --accent-color: #38bdf8;
            --accent-color-hover: #0ea5e9;
            --success-color: #4ade80;
            --warning-color: #facc15;
            --danger-color: #f87171;
        }

        body {
            background-color: var(--main-bg);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .main-container {
            margin: 20px auto;
            max-width: 1400px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        .header-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-back {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .btn-back:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .btn-refresh {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-refresh:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
        }

        .btn-refresh.loading i {
            animation: spin 0.8s linear infinite;
        }

        .btn-bulk-update {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            color: white;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
        }

        .btn-bulk-update:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.35);
        }

        .btn-bulk-update:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .info-card {
            background-color: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .table-container {
            background-color: #111827;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            min-width: 1050px;
        }

        .table thead th {
            background-color: var(--card-bg);
            color: var(--accent-color);
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            text-transform: uppercase;
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
        }

        .table thead th.th-sortable {
            cursor: pointer;
            user-select: none;
        }

        .table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .table tbody tr:hover {
            background-color: rgba(56, 189, 248, 0.05);
        }

        .table tbody td {
            padding: 12px 16px;
            font-size: 14px;
            vertical-align: middle;
        }

        .action-btn {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .action-btn:hover {
            border-color: var(--accent-color);
            color: white;
            background-color: rgba(56, 189, 248, 0.1);
        }

        .action-btn.primary {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .action-btn.primary:hover {
            background-color: var(--accent-color-hover);
        }

        .action-btn.danger {
            background-color: transparent;
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .action-btn.danger:hover {
            background-color: rgba(248, 113, 113, 0.1);
        }

        /* Button group: main button + dropdown toggle */
        .btn-group-main {
            display: inline-flex;
            border-radius: 6px;
            overflow: hidden;
        }

        .btn-group-main .full-update-btn {
            border-radius: 6px 0 0 6px;
            border-right: none;
        }

        .btn-group-main .dropdown-toggle-btn {
            border-radius: 0 6px 6px 0;
            padding: 6px 10px;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-group-main .full-update-btn.primary+.dropdown-toggle-btn {
            background-color: var(--accent-color-hover);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-group-main .full-update-btn.primary+.dropdown-toggle-btn:hover {
            background-color: #0284c7;
        }

        .btn-group-main .full-update-btn.danger+.dropdown-toggle-btn {
            background-color: transparent;
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-group-main .full-update-btn.danger+.dropdown-toggle-btn:hover {
            background-color: rgba(248, 113, 113, 0.1);
        }

        /* Dropdown */
        .update-dropdown-wrap {
            position: relative;
            display: inline-block;
        }

        .update-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            z-index: 200;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            min-width: 180px;
            padding: 4px 0;
            display: none;
        }

        .update-dropdown .dropdown-item {
            width: 100%;
            border: none;
            border-radius: 0;
            padding: 8px 14px;
            text-align: left;
            background: transparent;
            justify-content: flex-start;
        }

        .update-dropdown .dropdown-item:hover {
            background-color: rgba(56, 189, 248, 0.1);
        }

        .update-dropdown .dropdown-item.disabled-item {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .update-dropdown .dropdown-item.disabled-item:hover {
            background-color: transparent;
        }

        .update-dropdown .dropdown-divider {
            border-top: 1px solid var(--border-color);
            margin: 4px 0;
        }

        .update-dropdown .dropdown-label {
            padding: 8px 14px 4px;
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .update-dropdown .dropdown-input-row {
            padding: 6px 14px 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .update-dropdown .dropdown-input-row input {
            background-color: #111827;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
            padding: 4px 8px;
            width: 70px;
            font-size: 13px;
        }

        /* Inline progress in Akcie cell */
        .inline-progress {
            font-size: 12px;
            line-height: 1.75;
        }

        .inline-step {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6b7280;
        }

        .inline-step.active {
            color: var(--accent-color);
            font-weight: 600;
        }

        .inline-step.done {
            color: var(--success-color);
        }

        .inline-step.error {
            color: var(--danger-color);
        }

        .inline-status {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
            line-height: 1.4;
        }

        .inline-decision {
            display: none;
            gap: 6px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Light Theme */
        body.light-theme {
            --main-bg: #cddbf2;
            --card-bg: #deeafa;
            --border-color: #b8c9e6;
            --text-color: #1f2937;
            --accent-color: #0369a1;
            --accent-color-hover: #0284c7;
            --success-color: #059669;
            --danger-color: #dc2626;
        }

        body.light-theme .table-container,
        body.light-theme .update-dropdown .dropdown-input-row input {
            background-color: #deeafa;
        }

        body.light-theme .update-dropdown {
            background-color: #deeafa;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        pre.changelog {
            white-space: pre-wrap;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            color: var(--text-color);
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
        }

        body.light-theme pre.changelog {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Checkbox column */
        .table thead th.th-checkbox,
        .table tbody td.td-checkbox {
            width: 36px;
            padding: 12px 8px 12px 16px;
            text-align: center;
        }

        /* ── Table row checkboxes (device list + select-all) ──────────────────── */
        .device-select-cb,
        #selectAllCb {
            appearance: none;
            -webkit-appearance: none;
            width: 17px;
            height: 17px;
            background-color: var(--card-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 4px;
            display: inline-grid;
            place-content: center;
            cursor: pointer;
            margin: 0;
            transition: border-color 0.18s, background-color 0.18s, box-shadow 0.18s;
            flex-shrink: 0;
            vertical-align: middle;
        }

        .device-select-cb:hover,
        #selectAllCb:hover {
            border-color: var(--success-color);
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.15);
        }

        .device-select-cb::before,
        #selectAllCb::before {
            content: "";
            width: 10px;
            height: 10px;
            transform: scale(0);
            transition: 140ms transform ease-in-out;
            background-color: var(--success-color);
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        .device-select-cb:checked,
        #selectAllCb:checked {
            background-color: rgba(74, 222, 128, 0.12);
            border-color: var(--success-color);
        }

        .device-select-cb:checked::before,
        #selectAllCb:checked::before {
            transform: scale(1);
        }

        /* Indeterminate – "vybrať všetky" keď sú niektoré zaškrtnuté */
        #selectAllCb:indeterminate {
            background-color: rgba(74, 222, 128, 0.08);
            border-color: var(--success-color);
        }

        #selectAllCb:indeterminate::before {
            transform: scale(1);
            clip-path: polygon(0 38%, 100% 38%, 100% 62%, 0 62%);
            background-color: var(--success-color);
        }

        /* Light theme variants */
        body.light-theme .device-select-cb,
        body.light-theme #selectAllCb {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }

        body.light-theme .device-select-cb:hover,
        body.light-theme #selectAllCb:hover {
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.15);
        }

        body.light-theme .device-select-cb:checked,
        body.light-theme #selectAllCb:checked {
            background-color: rgba(22, 163, 74, 0.08);
            border-color: #16a34a;
        }

        body.light-theme .device-select-cb:checked::before,
        body.light-theme #selectAllCb:checked::before {
            background-color: #16a34a;
        }

        body.light-theme #selectAllCb:indeterminate {
            background-color: rgba(22, 163, 74, 0.06);
            border-color: #16a34a;
        }

        body.light-theme #selectAllCb:indeterminate::before {
            background-color: #16a34a;
        }

        /* Dropdown custom checkbox */
        .dropdown-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 14px !important;
            height: 14px !important;
            min-width: 14px !important;
            min-height: 14px !important;
            padding: 0 !important;
            flex-shrink: 0;
            background-color: var(--main-bg);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            display: inline-grid;
            place-content: center;
            cursor: pointer;
            margin: 0;
            transition: all 0.2s;
        }

        body.light-theme .dropdown-checkbox {
            background-color: rgba(255, 255, 255, 0.7);
            border-color: #d1d5db;
        }

        .dropdown-checkbox::before {
            content: "";
            width: 8px;
            height: 8px;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            background-color: var(--success-color);
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }

        .dropdown-checkbox:checked::before {
            transform: scale(1);
        }

        /* ── Version-check toast notification ─────────────────────────────────── */
        .update-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(0);
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 12px 20px;
            color: #d1d5db;
            font-size: 14px;
            z-index: 9999;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 520px;
            animation: toastIn 0.25s ease;
            pointer-events: none;
        }

        .update-toast.info  { border-color: #3b82f6; }
        .update-toast.success { border-color: #4ade80; }
        .update-toast.warning { border-color: #facc15; }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-12px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="header-actions">
            <button id="refreshDevicesBtn" class="btn-refresh" onclick="refreshDevices()"
                title="Obnoviť stav zariadení">
                <i class="fas fa-sync"></i>
                <span>Obnoviť</span>
            </button>
            <button onclick="window.location.href='/settings.html'" class="btn-back" title="Nastavenia">
                <i class="fas fa-cog"></i> <span>Nastavenia</span>
            </button>
            <button id="themeToggle" class="btn-back" onclick="toggleTheme()" title="Prepnúť tému">
                <i class="fas fa-moon"></i>
            </button>
            <a href="/" class="btn-back">
                <i class="fas fa-arrow-left"></i>
                <span>Späť</span>
            </a>
        </div>

        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="font-size: 2.2rem; font-weight: 600; color: var(--accent-color); margin-bottom: 10px;">
                <i class="fa-solid fa-arrows-rotate"></i> MikroTik Aktualizátor
            </h1>
            <p style="color: #9ca3af;">Verzie RouterOS, Firmware a konfigurácia SSL Certifikátov</p>
        </div>

        <!-- RSS info card – bulk update button moved here -->
        <div class="info-card" id="rssInfoCard">
            <div>
                <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; color: var(--accent-color);">
                    Najnovšia verzia (z mikrotik.com)</h3>
                <p id="rssLatestVersion">Načítavam dáta z RSS feedu...</p>
            </div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <button id="bulkUpdateBtn" class="btn-bulk-update" onclick="bulkUpdateDevices()" disabled
                    title="Aktualizovať vybrané zariadenia">
                    <i class="fas fa-download"></i>
                    <span>Aktualizovať vybrané</span>
                </button>
                <button onclick="openChangelogModal()" class="action-btn primary" id="btnShowChangelog"
                    style="display:none;">
                    <i class="fas fa-list-alt"></i> Zobraziť Changelog
                </button>
            </div>
        </div>

        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th class="th-checkbox">
                            <input type="checkbox" id="selectAllCb" title="Vybrať všetky"
                                onchange="toggleSelectAll(this)">
                        </th>
                        <th class="th-sortable" onclick="handleThClick(1)" style="text-align: center;">Zariadenie / IP
                        </th>
                        <th class="th-sortable" onclick="handleThClick(2)" width="10%" style="text-align: center;">
                            Status</th>
                        <th class="th-sortable" onclick="handleThClick(3)" width="20%" style="text-align: center;">
                            RouterOS verzia</th>
                        <th class="th-sortable" onclick="handleThClick(4)" width="20%" style="text-align: center;">
                            Firmware (RouterBOARD)</th>
                        <th width="35%" style="text-align: center;">Akcie</th>
                    </tr>
                </thead>
                <tbody id="devicesTableBody">
                    <tr>
                        <td colspan="6" style="text-align:center; padding: 30px;">
                            <div style="display:inline-block; margin-bottom: 10px;" class="loading-spinner"></div><br>
                            Načítavam zoznam zariadení z databázy...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scheduled updates panel -->
    <div id="scheduledUpdatesPanel" style="display:none; max-width:1100px; margin:0 auto 32px; padding:0 16px;">
        <div style="background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <h3 style="font-size:1rem;font-weight:600;color:var(--accent-color);margin:0;">
                    <i class="fas fa-calendar-clock" style="margin-right:8px;"></i>Naplánované aktualizácie
                </h3>
            </div>
            <div id="scheduledUpdatesTable"></div>
        </div>
    </div>

    <!-- Schedule modal -->
    <div id="scheduleModal" class="modal-overlay" onclick="closeScheduleModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width:420px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
                <h2 style="font-size:1.15rem; font-weight:600; color:var(--accent-color);">
                    <i class="fas fa-calendar-plus" style="margin-right:8px;"></i>Naplánovať update
                </h2>
                <button onclick="closeScheduleModal()" style="background:none;border:none;color:var(--text-color);font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <p style="color:var(--text-muted);font-size:13px;margin-bottom:4px;">Zariadenie:</p>
            <p style="font-weight:600;margin-bottom:16px;" id="scheduleDeviceName"></p>
            <label style="font-size:13px;color:var(--text-muted);display:block;margin-bottom:6px;">Dátum a čas aktualizácie:</label>
            <input type="datetime-local" id="scheduleDateTime"
                style="width:100%;padding:8px 10px;border-radius:6px;border:1px solid var(--border-color);background:var(--input-bg,#1f2937);color:var(--text-color);font-size:14px;box-sizing:border-box;margin-bottom:14px;">
            <p style="font-size:12px;color:var(--text-muted);margin-bottom:20px;">
                <i class="fas fa-info-circle"></i> Vykoná sa automaticky: RouterOS update → Firmware update → Reštart. Zariadenie nemusí byť otvorené v prehliadači.
            </p>
            <div id="scheduleModalError" style="display:none;color:var(--danger-color);font-size:13px;margin-bottom:12px;"></div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button onclick="closeScheduleModal()" class="action-btn" style="background:var(--border-color);">Zrušiť</button>
                <button onclick="confirmSchedule()" class="action-btn primary" id="confirmScheduleBtn">
                    <i class="fas fa-calendar-check"></i> Naplánovať
                </button>
            </div>
        </div>
    </div>

    <!-- Changelog modal -->
    <div id="changelogModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="font-size: 1.3rem; font-weight: 600; color: var(--accent-color);" id="modalTitle">Changelog
                </h2>
                <button onclick="closeModal()"
                    style="background:none; border:none; color:var(--text-color); font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <pre class="changelog" id="modalContent">Načítavam...</pre>
        </div>
    </div>

    <script>
        let rssData = null;
        let devicesList = [];
        let deviceDataMap = {};
        let originalOrder = [];
        let sortState = { column: null, direction: 'asc' };

        // Per-device inline update state
        let _deviceUpdateState = JSON.parse(localStorage.getItem('mikrotik_updater_state') || '{}');

        // Module-level Socket.IO instance (shared by SocketIO handler and other functions)
        let _socket = null;

        // Setup clear storage on logout if needed, but not here
        function saveUpdateState() {
            // Nemôžeme serializovať funkcie ako decideResolve
            const stateToSave = {};
            for (const [id, state] of Object.entries(_deviceUpdateState)) {
                if (state.active || state.persistedResult) {
                    stateToSave[id] = {
                        active: state.active,
                        persistedResult: state.persistedResult,
                        currentStep: state.currentStep || null,
                        htmlContent: document.getElementById(`actions-${id}`)?.innerHTML || state.htmlContent
                    };
                }
            }
            localStorage.setItem('mikrotik_updater_state', JSON.stringify(stateToSave));
        }

        // ─── Theme ───────────────────────────────────────────────────────────────
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('mikrotik_theme', isLight ? 'light' : 'dark');
            document.querySelector('#themeToggle i').className = isLight ? 'fas fa-sun' : 'fas fa-moon';
        }

        // ─── UPDATE SOCKET PROGRESS (manual + scheduled) ─────────────────────────
        function initScheduledUpdateSocket() {
            _socket = io();

            _socket.on('scheduled_update_progress', function (data) {
                const id = data.device_id;
                const isScheduled = data.schedule_id !== 0;
                const state = data.state;
                const step = data.step;
                const msg = data.msg || '';

                if (state === 'start') {
                    // Start inline update UI (replaces action buttons with step list)
                    if (!(_deviceUpdateState[id] && _deviceUpdateState[id].active)) {
                        startInlineUpdate(id);
                    }
                    // Remove schedule badge – 7-step progress is sufficient feedback
                    const statusEl = document.getElementById(`status-${id}`);
                    if (statusEl) {
                        const badge = statusEl.querySelector('.schedule-badge');
                        if (badge) badge.remove();
                    }
                    if (msg) setInlineStatus(id, msg);
                } else if (state === 'step_active') {
                    if (!(_deviceUpdateState[id] && _deviceUpdateState[id].active)) {
                        startInlineUpdate(id);
                    }
                    setInlineStep(id, step, 'active');
                    if (msg) setInlineStatus(id, msg);
                } else if (state === 'step_done') {
                    setInlineStep(id, step, 'done');
                    if (msg) setInlineStatus(id, msg);
                } else if (state === 'step_error') {
                    setInlineStep(id, step, 'error');
                } else if (state === 'done') {
                    endInlineUpdate(id, true, msg || '✅ Aktualizácia dokončená!');
                    setTimeout(() => {
                        clearUpdateState(id);
                        if (isScheduled) loadSchedules();
                    }, 4000);
                } else if (state === 'failed') {
                    endInlineUpdate(id, false, msg || '❌ Aktualizácia zlyhala.');
                    setTimeout(() => {
                        clearUpdateState(id);
                        if (isScheduled) loadSchedules();
                    }, 5000);
                }
            });
        }

        // ─── INIT ─────────────────────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('mikrotik_theme') === 'light') {
                document.body.classList.add('light-theme');
                document.querySelector('#themeToggle i').className = 'fas fa-sun';
            }
            // Close all dropdowns on outside click
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.update-dropdown-wrap')) {
                    document.querySelectorAll('.update-dropdown').forEach(d => d.style.display = 'none');
                }
            });
            initScheduledUpdateSocket();
            fetchRssData();
            fetchDevices();
        });

        // ─── RSS ──────────────────────────────────────────────────────────────────
        async function fetchRssData() {
            try {
                const res = await fetch('/api/updater/rss');
                const json = await res.json();
                if (json.status === 'success' && json.data.latest) {
                    rssData = json.data.latest;
                    document.getElementById('rssLatestVersion').innerHTML =
                        `<strong>RouterOS ${rssData.version}</strong> (Vydané: ${rssData.pubDate})`;
                    document.getElementById('btnShowChangelog').style.display = 'inline-flex';
                } else {
                    document.getElementById('rssLatestVersion').innerText = 'Nepodarilo sa načítať stabilnú verziu z RSS.';
                }
            } catch (err) {
                document.getElementById('rssLatestVersion').innerText = 'Chyba API pri načítaní RSS.';
            }
        }

        function openChangelogModal() {
            if (rssData) {
                document.getElementById('modalTitle').innerText = rssData.title;
                const div = document.createElement('div');
                div.innerHTML = rssData.description;
                document.getElementById('modalContent').innerHTML = div.innerHTML;
                document.getElementById('changelogModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(e) {
            if (e && e.target !== document.getElementById('changelogModal')) return;
            document.getElementById('changelogModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // ─── Devices ─────────────────────────────────────────────────────────────
        async function fetchDevices() {
            try {
                const res = await fetch('/api/devices');
                const devices = await res.json();
                devicesList = devices;
                originalOrder = [...devices];
                renderTableShells();
                // Clean up stale localStorage states – updates are now server-side
                devices.forEach(d => {
                    const st = _deviceUpdateState[d.id];
                    if (!st) return;
                    if (st.active) {
                        // Clear stale active state – restoreRunningUpdates() will rebuild UI from server
                        delete _deviceUpdateState[d.id];
                        saveUpdateState();
                    } else if (st.persistedResult) {
                        // Completed result shown – ping to check if device is back, then clear
                        fetch(`/api/updater/ping/${d.id}`)
                            .then(r => r.json())
                            .then(j => { if (j.status === 'online') clearUpdateState(d.id); })
                            .catch(() => {});
                    }
                });
                // Restore running updates FIRST (sets active=true) so fetchDeviceDetails skips them
                await restoreRunningUpdates();
                devices.forEach(d => fetchDeviceDetails(d.id));
                loadSchedules();
            } catch (err) {
                document.getElementById('devicesTableBody').innerHTML =
                    `<tr><td colspan="6" style="text-align:center; color: var(--danger-color);">Chyba pri načítaní databázy zariadení.</td></tr>`;
            }
        }

        async function refreshDevices() {
            const btn = document.getElementById('refreshDevicesBtn');
            btn.classList.add('loading');
            btn.disabled = true;

            devicesList.forEach(d => {
                // Clear finished (non-active) update state so fetchDeviceDetails can render normal actions
                if (_deviceUpdateState[d.id] && !_deviceUpdateState[d.id].active) {
                    delete _deviceUpdateState[d.id];
                    saveUpdateState();
                }
                // Skip loading indicators for devices with active update
                if (_deviceUpdateState[d.id]?.active) return;
                const statusEl = document.getElementById(`status-${d.id}`);
                const osEl = document.getElementById(`os-${d.id}`);
                const fwEl = document.getElementById(`fw-${d.id}`);
                if (statusEl) statusEl.innerHTML = `<span style="color:#9ca3af"><i class="fas fa-spinner fa-spin"></i> Načítavam...</span>`;
                if (osEl) osEl.innerHTML = `<span style="color:#9ca3af">...</span>`;
                if (fwEl) fwEl.innerHTML = `<span style="color:#9ca3af">...</span>`;
            });

            // Restore running updates FIRST (sets active=true) so fetchDeviceDetails skips them
            await restoreRunningUpdates();
            await Promise.all(devicesList.map(d => fetchDeviceDetails(d.id)));
            loadSchedules();

            btn.classList.remove('loading');
            btn.disabled = false;
        }

        function renderTableShells() {
            const tbody = document.getElementById('devicesTableBody');
            tbody.innerHTML = '';
            devicesList.forEach(dev => {
                const tr = document.createElement('tr');
                tr.id = `row-${dev.id}`;

                // Restore logic
                let isRestored = false;
                let restoredHtml = '';
                if (_deviceUpdateState[dev.id] && (_deviceUpdateState[dev.id].active || _deviceUpdateState[dev.id].persistedResult)) {
                    isRestored = true;
                    restoredHtml = _deviceUpdateState[dev.id].htmlContent || '';
                }

                tr.innerHTML = `
                    <td class="td-checkbox">
                        <input type="checkbox" class="device-select-cb" data-id="${dev.id}" onchange="onCbChange()">
                    </td>
                    <td>
                        <strong>${dev.name}</strong><br>
                        <span style="color:#9ca3af; font-size:12px;">${dev.ip}</span>
                        <div id="model-${dev.id}" style="font-size:11px; color:#9ca3af; margin-top:4px;"></div>
                    </td>
                    <td id="status-${dev.id}" style="text-align: center;">
                        <span class="loading-spinner" style="width:12px; height:12px; border-width: 2px;"></span> Zisťujem
                    </td>
                    <td id="os-${dev.id}" style="text-align: center;">Načítavam...</td>
                    <td id="fw-${dev.id}" style="text-align: center;">Načítavam...</td>
                    <td>
                        <div id="actions-${dev.id}" style="display:flex; flex-wrap:wrap; gap:8px; opacity:0.5;">
                            ${isRestored ? restoredHtml : 'Čaká sa na spojenie...'}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function fetchDeviceDetails(id) {
            // Do not overwrite the cell if an update is actively running on this device
            if (_deviceUpdateState[id]?.active) return;

            try {
                const res = await fetch(`/api/updater/device/${id}`);
                if (!res.ok) throw new Error('API Chyba');
                const data = await res.json();
                deviceDataMap[id] = data;

                if (data.status === 'success') {
                    // Status cell
                    let statusHtml = `<span style="color:var(--success-color)"><i class="fas fa-check-circle"></i> Online</span>`;
                    if (!data.ssl_ok) {
                        statusHtml += `<br><span style="color:var(--warning-color); font-size:11px;"><i class="fas fa-exclamation-triangle"></i> Bez TLS certifikátu</span>`;
                    }
                    // Cert expiry badge
                    if (data.cert_expiry !== null && data.cert_expiry !== undefined) {
                        const d = data.cert_expiry.days_remaining;
                        const warnDays = data.cert_expiry_warning_days || 10;
                        const effectiveWarn = warnDays + 3; // Zobraziť žltú farbu 3 dni pred naplánovanou automatickou obnovou
                        let certColor, certIcon;
                        if (d <= 0) {
                            certColor = 'var(--danger-color)'; certIcon = '⛔';
                        } else if (d <= effectiveWarn) {
                            certColor = 'var(--warning-color)'; certIcon = '⚠️';
                        } else {
                            certColor = 'var(--success-color)'; certIcon = '';
                        }
                        const certText = d <= 0 ? `${certIcon} Cert: vypršaný` : `${certIcon} Cert: ${d}d`;
                        statusHtml += `<br><span style="color:${certColor}; font-size:11px;">${certText}</span>`;
                    }
                    document.getElementById(`status-${id}`).innerHTML = statusHtml;
                    appendScheduleBadge(id);

                    // OS cell
                    document.getElementById(`os-${id}`).innerHTML = `
                        <div style="display: grid; grid-template-columns: max-content max-content; text-align: left; justify-content: center; column-gap: 16px; font-size: 14px;">
                            <span style="color: #9ca3af; text-align: center;">Aktuálna:</span> 
                            <strong>${data.os['installed-version']}</strong>
                            <span style="color: #9ca3af; text-align: center;">Dostupná:</span> 
                            <strong style="${data.os['installed-version'] !== data.os['latest-version'] ? 'color:var(--danger-color)' : 'color:var(--success-color)'}">${data.os['latest-version']}</strong>
                        </div>
                    `;

                    // Firmware cell
                    // upgrade-firmware is based on installed RouterOS, not latest available.
                    // If firmware appears up-to-date but OS has a pending update, project the
                    // future firmware target from os.latest-version so the user sees it correctly.
                    const fwCurrent = data.firmware['current-firmware'];
                    const fwUpgrade = data.firmware['upgrade-firmware'];
                    const hasOsUpdateFw = data.os['installed-version'] !== 'N/A' && data.os['installed-version'] !== data.os['latest-version'];
                    const fwAvailable = (fwCurrent !== 'N/A' && fwCurrent === fwUpgrade && hasOsUpdateFw && data.os['latest-version'] !== 'N/A')
                        ? data.os['latest-version']
                        : fwUpgrade;
                    document.getElementById(`fw-${id}`).innerHTML = `
                        <div style="display: grid; grid-template-columns: max-content max-content; text-align: left; justify-content: center; column-gap: 16px; font-size: 14px;">
                            <span style="color: #9ca3af; text-align: center;">Aktuálny:</span>
                            <strong>${fwCurrent}</strong>
                            <span style="color: #9ca3af; text-align: center;">Dostupný:</span>
                            <strong style="${fwCurrent !== fwAvailable ? 'color:var(--danger-color)' : 'color:var(--success-color)'}">${fwAvailable}</strong>
                        </div>
                    `;
                    document.getElementById(`model-${id}`).innerHTML = data.firmware['model'];

                    // Only render actions if no update is currently running/persisted
                    if (!(_deviceUpdateState[id] && (_deviceUpdateState[id].active || _deviceUpdateState[id].persistedResult))) {
                        renderActions(id, data);
                    } else {
                        document.getElementById(`actions-${id}`).style.opacity = '1';
                    }
                } else {
                    // Don't overwrite cells if an update is actively running on this device
                    if (_deviceUpdateState[id]?.active) return;
                    document.getElementById(`status-${id}`).innerHTML = `<span style="color:var(--danger-color)"><i class="fas fa-times-circle"></i> Offline/Chyba</span>`;
                    document.getElementById(`os-${id}`).innerHTML = `Chyba spojenia API`;
                    document.getElementById(`fw-${id}`).innerHTML = `N/A`;
                    document.getElementById(`actions-${id}`).innerHTML = `<span style="color:var(--danger-color); font-size:13px;">Zariadenie nedostupné</span>`;
                    document.getElementById(`actions-${id}`).style.opacity = '1';
                }
            } catch (err) {
                // Don't overwrite cells if an update is actively running on this device
                if (_deviceUpdateState[id]?.active) return;
                document.getElementById(`status-${id}`).innerHTML = `<span style="color:var(--danger-color)"><i class="fas fa-times-circle"></i> Offline/Chyba</span>`;
                document.getElementById(`os-${id}`).innerHTML = `N/A`;
                document.getElementById(`fw-${id}`).innerHTML = `N/A`;
                document.getElementById(`actions-${id}`).innerHTML = `<span style="color:var(--danger-color); font-size:13px;">Zariadenie nedostupné</span>`;
                document.getElementById(`actions-${id}`).style.opacity = '1';
            }
        }

        function renderActions(id, data) {
            const hasOsUpdate = data.os['installed-version'] !== 'N/A' && data.os['installed-version'] !== data.os['latest-version'];
            const _fwCur = data.firmware['current-firmware'];
            const _fwUpg = data.firmware['upgrade-firmware'];
            const _fwAvail = (_fwCur !== 'N/A' && _fwCur === _fwUpg && hasOsUpdate && data.os['latest-version'] !== 'N/A')
                ? data.os['latest-version'] : _fwUpg;
            const noFirmware = _fwCur === 'N/A';  // VM/CHR – no routerboard
            const hasFwUpdate = !noFirmware && _fwCur !== _fwAvail;
            const anyUpdate = hasOsUpdate || hasFwUpdate;
            const noSsl = !data.ssl_ok;
            const certLabel = noSsl ? 'Vytvoriť TLS Cert ⚠️' : 'Obnoviť TLS Cert';
            const certClass = noSsl ? 'danger' : '';

            let certDropdownSub = '';
            if (data.cert_expiry && data.cert_expiry.days_remaining !== undefined) {
                let remaining = data.cert_expiry.days_remaining;
                let warning = data.cert_expiry_warning_days || 10;
                let diff = remaining - warning;
                if (diff > 0) {
                    certDropdownSub = `<span style="font-size:11px; color:#9ca3af; display:block; margin-bottom:8px;">(Auto-obnova o ${diff} dní)</span>`;
                } else {
                    certDropdownSub = `<span style="font-size:11px; color:var(--warning-color); display:block; margin-bottom:8px;">(Čaká na auto-obnovu)</span>`;
                }
            }

            const html = `
                <div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center;">
                    <!-- Main update button + dropdown -->
                    <div class="update-dropdown-wrap">
                        <div class="btn-group-main">
                            <button onclick="fullUpdateDevice(${id})" class="action-btn full-update-btn ${anyUpdate ? 'primary' : ''}" title="Spustiť plný update: OS → Firmware → Reštart">
                                <i class="fas fa-sync-alt"></i> Update MikroTik
                            </button>
                            <button onclick="toggleDropdown('dropdown-${id}', event)" class="action-btn dropdown-toggle-btn ${anyUpdate ? 'primary' : ''}" title="Jednotlivé akcie">
                                <i class="fas fa-chevron-down" style="font-size:11px;"></i>
                            </button>
                        </div>
                        <div class="update-dropdown" id="dropdown-${id}" onclick="event.stopPropagation()">
                            <button onclick="installOsWithCheck(${id}, this)" class="action-btn dropdown-item ${hasOsUpdate ? 'primary' : ''}">
                                <i class="fas fa-download"></i> Update RouterOS
                            </button>
                            <button onclick="installFirmwareWithCheck(${id}, this)" class="action-btn dropdown-item ${hasFwUpdate ? 'primary' : ''} ${noFirmware ? 'disabled-item' : ''}" title="${noFirmware ? 'Zariadenie nemá routerboard (VM/CHR) – firmware update nie je dostupný' : ''}">
                                <i class="fas fa-microchip"></i> Update Firmware
                            </button>
                            <div class="dropdown-divider"></div>
                            <button onclick="openScheduleModal(${id}, (devicesList.find(d=>d.id===${id})||{}).name||'', ${anyUpdate})" class="action-btn dropdown-item ${anyUpdate ? '' : 'disabled-item'}" title="${anyUpdate ? 'Naplánovať automatický update' : 'Zariadenie je na aktuálnej verzii'}">
                                <i class="fas fa-calendar-plus"></i> Naplánovať update
                            </button>
                            <div class="dropdown-divider"></div>
                            <button onclick="rebootDevice(${id}, this)" class="action-btn dropdown-item danger">
                                <i class="fas fa-power-off"></i> Reštart
                            </button>
                        </div>
                    </div>

                    <!-- Cert button + dropdown (days input) -->
                    <div class="update-dropdown-wrap" style="margin-left: 10px;">
                        <div class="btn-group-main">
                            <button onclick="renewSSL(${id})" id="cert-btn-${id}" class="action-btn full-update-btn ${certClass}" title="${certLabel}">
                                <i class="fas fa-shield-alt"></i> ${certLabel}
                            </button>
                            <button onclick="toggleDropdown('cert-dd-${id}', event)" class="action-btn dropdown-toggle-btn ${certClass}" title="Nastaviť platnosť certifikátu">
                                <i class="fas fa-chevron-down" style="font-size:11px;"></i>
                            </button>
                        </div>
                        <div class="update-dropdown" id="cert-dd-${id}" style="min-width: max-content;" onclick="event.stopPropagation()">
                            <div class="dropdown-label" style="padding-bottom: 2px;">${certDropdownSub}Platnosť certifikátu</div>
                            <div class="dropdown-input-row" style="display: flex; align-items: center; justify-content: flex-start; gap: 14px; margin-bottom: 4px; padding-top: 2px;">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="number" id="cert-days-${id}" value="${data.cert_auto_renewal_days || 180}" min="1" max="3650" style="width: 70px;">
                                    <span style="font-size:13px;">dní</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 4px; margin-left: auto;">
                                    <button onclick="saveCertSettings(${id}, true)" class="action-btn" style="padding: 4px 8px; font-size: 11.5px;" title="${data.is_custom_cert_days ? 'Aktualizovať trvalú hodnotu pre toto zariadenie' : 'Uložiť ako trvalú hodnotu'}">
                                        <i class="fas fa-save" style="${data.is_custom_cert_days ? 'color:var(--success-color)' : ''}"></i> Uložiť
                                    </button>
                                    ${data.is_custom_cert_days ? `<button onclick="saveCertSettings(${id}, false)" class="action-btn danger" style="padding: 4px 8px; font-size: 11px;" title="Zmazať individuálnu hodnotu a vrátiť sa ku globálnej"><i class="fas fa-trash"></i></button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById(`actions-${id}`).style.opacity = '1';
            document.getElementById(`actions-${id}`).innerHTML = html;
        }

        // ─── Generic dropdown toggle ──────────────────────────────────────────────
        function toggleDropdown(ddId, event) {
            event.stopPropagation();
            const dd = document.getElementById(ddId);
            const isOpen = dd.style.display === 'block';
            document.querySelectorAll('.update-dropdown').forEach(d => {
                d.style.display = 'none';
                d.style.top = '';
                d.style.bottom = '';
            });
            if (!isOpen) {
                dd.style.display = 'block';
                const rect = dd.getBoundingClientRect();
                const spaceBelow = window.innerHeight - rect.bottom;
                if (spaceBelow < 0) {
                    dd.style.top = 'auto';
                    dd.style.bottom = 'calc(100% + 4px)';
                } else {
                    dd.style.top = 'calc(100% + 4px)';
                    dd.style.bottom = 'auto';
                }
            }
        }

        // ─── Toast notification ───────────────────────────────────────────────────
        function showToast(message, type = 'info', duration = 4500) {
            const existing = document.getElementById('updateToast');
            if (existing) existing.remove();

            const icons   = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-triangle' };
            const colors  = { info: '#3b82f6', success: '#4ade80', warning: '#facc15' };

            const toast = document.createElement('div');
            toast.id = 'updateToast';
            toast.className = `update-toast ${type}`;
            toast.innerHTML = `<i class="fas ${icons[type] || 'fa-info-circle'}" style="color:${colors[type] || '#3b82f6'}; font-size:16px; flex-shrink:0;"></i><span>${message}</span>`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s ease';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 320);
            }, duration);
        }

        // ─── Version-aware individual update wrappers ─────────────────────────────
        async function installOsWithCheck(id, btn) {
            const data = deviceDataMap[id];
            if (data && data.os) {
                const installed = data.os['installed-version'];
                const latest    = data.os['latest-version'];
                if (installed && latest && installed !== 'N/A' && latest !== 'N/A' && installed === latest) {
                    showToast(`RouterOS je už aktuálny (${installed}) – aktualizácia nebola spustená.`, 'info');
                    return;
                }
            }
            apiCall(`/api/updater/install-os/${id}`, btn);
        }

        async function installFirmwareWithCheck(id, btn) {
            const data = deviceDataMap[id];
            if (data && data.firmware) {
                const current = data.firmware['current-firmware'];
                const upgrade = data.firmware['upgrade-firmware'];
                if (current === 'N/A') {
                    showToast('Toto zariadenie nemá routerboard (VM/CHR) – firmware update nie je dostupný.', 'warning');
                    return;
                }
                if (current && upgrade && current !== 'N/A' && upgrade !== 'N/A' && current === upgrade) {
                    showToast(`Firmware je už na aktuálnej verzii (${current}) – aktualizácia nebola spustená.`, 'info');
                    return;
                }
            }
            apiCall(`/api/updater/install-firmware/${id}`, btn);
        }

        // ─── Individual action wrappers ───────────────────────────────────────────
        async function apiCall(endpoint, btn) {
            const prevHtml = btn.innerHTML;
            btn.innerHTML = `<span class="loading-spinner" style="width:12px; height:12px; border-width: 2px; border-top-color: currentColor;"></span>`;
            btn.disabled = true;
            try {
                const res = await fetch(endpoint, { method: 'POST' });
                const json = await res.json();
                if (json.status === 'success') {
                    alert('Úspech: ' + json.message);
                } else {
                    alert('Chyba: ' + (json.message || 'Neznáma chyba'));
                }
            } catch (err) {
                alert('Chyba siete: ' + err.message);
            } finally {
                btn.innerHTML = prevHtml;
                btn.disabled = false;
            }
        }

        async function rebootDevice(id, btn) {
            if (!confirm("Skutočne chcete reštartovať (reboot) toto zariadenie?")) return;
            apiCall(`/api/updater/reboot/${id}`, btn);
        }

        async function renewSSL(id) {
            const btn = document.getElementById(`cert-btn-${id}`);
            const daysEl = document.getElementById(`cert-days-${id}`);
            const days = parseInt(daysEl ? daysEl.value : 180) || 180;

            // Close cert dropdown
            const dd = document.getElementById(`cert-dd-${id}`);
            if (dd) dd.style.display = 'none';

            const prevHtml = btn.innerHTML;
            btn.innerHTML = `<span class="loading-spinner" style="width:12px; height:12px; border-width: 2px; border-top-color: currentColor;"></span>`;
            btn.disabled = true;
            try {
                const res = await fetch(`/api/updater/certificate/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days })
                });
                const json = await res.json();
                if (json.status !== 'success') {
                    showToast('Chyba TLS certifikátu: ' + (json.message || 'Neznáma chyba API'), 'error', 6000);
                }
            } catch (err) {
                showToast('Chyba siete pri obnove TLS certifikátu: ' + err.message, 'error', 6000);
            } finally {
                btn.innerHTML = prevHtml;
                btn.disabled = false;
                refreshDevices();
            }
        }

        async function saveCertSettings(id, save) {
            const daysEl = document.getElementById(`cert-days-${id}`);
            const days = parseInt(daysEl ? daysEl.value : 180) || 180;
            try {
                await fetch(`/api/updater/certificate/save_settings/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ days, save_for_device: save })
                });
                refreshDevices();
            } catch (err) {
                console.error('Nepodarilo sa uložiť nastavenia certifikátu na pozadí:', err);
            }
        }

        // ─── Column sorting (2-state: asc ↔ desc) ────────────────────────────────
        function handleThClick(col) {
            if (sortState.column === col) {
                // Toggle direction: asc → desc → asc
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = col;
                sortState.direction = 'asc';
            }
            sortTable();
        }

        function compareVersions(a, b) {
            const pa = (a || '').split('.').map(n => parseInt(n) || 0);
            const pb = (b || '').split('.').map(n => parseInt(n) || 0);
            const len = Math.max(pa.length, pb.length);
            for (let i = 0; i < len; i++) {
                const diff = (pa[i] || 0) - (pb[i] || 0);
                if (diff !== 0) return diff;
            }
            return 0;
        }

        function getSortKey(devId, col) {
            const dev = devicesList.find(d => d.id === devId);
            const dd = deviceDataMap[devId];
            switch (col) {
                case 1: return (dev ? dev.name.toLowerCase() : '');
                case 2: return (dd && dd.status === 'success') ? 0 : 1;
                case 3: return (dd && dd.os) ? dd.os['installed-version'] || '' : '';
                case 4: return (dd && dd.firmware) ? dd.firmware['current-firmware'] || '' : '';
                default: return '';
            }
        }

        function sortTable() {
            const tbody = document.getElementById('devicesTableBody');
            const ordered = [...devicesList].sort((a, b) => {
                const ak = getSortKey(a.id, sortState.column);
                const bk = getSortKey(b.id, sortState.column);
                let cmp;
                if (sortState.column === 3 || sortState.column === 4) {
                    cmp = compareVersions(ak, bk);
                } else if (typeof ak === 'number') {
                    cmp = ak - bk;
                } else {
                    cmp = ak < bk ? -1 : ak > bk ? 1 : 0;
                }
                return sortState.direction === 'asc' ? cmp : -cmp;
            });
            ordered.forEach(dev => {
                const row = document.getElementById(`row-${dev.id}`);
                if (row) tbody.appendChild(row);
            });
        }

        // ─── Checkbox / bulk select ───────────────────────────────────────────────
        function toggleSelectAll(masterCb) {
            document.querySelectorAll('.device-select-cb').forEach(cb => {
                cb.checked = masterCb.checked;
            });
            onCbChange();
        }

        function onCbChange() {
            const checked = document.querySelectorAll('.device-select-cb:checked').length;
            const total = document.querySelectorAll('.device-select-cb').length;
            document.getElementById('selectAllCb').checked = (checked === total && total > 0);
            document.getElementById('selectAllCb').indeterminate = (checked > 0 && checked < total);
            document.getElementById('bulkUpdateBtn').disabled = (checked === 0);
        }

        function getCheckedDeviceIds() {
            return Array.from(document.querySelectorAll('.device-select-cb:checked'))
                .map(cb => parseInt(cb.getAttribute('data-id')));
        }

        // ─── Inline progress helpers ──────────────────────────────────────────────
        const STEP_LABELS = ['', 'Update RouterOS', 'Čakám na reštart', 'Čakám na boot', '120s pauza', 'Update Firmware', '20s pauza', 'Finálny reštart'];
        const STEP_ICONS = { '': '○', active: '⟳', done: '✓', error: '✗' };

        function startInlineUpdate(id) {
            _deviceUpdateState[id] = { active: true, decideResolve: null, persistedResult: false };
            const actionsEl = document.getElementById(`actions-${id}`);
            if (!actionsEl) return;
            actionsEl.style.opacity = '1';

            let stepsHtml = '';
            for (let i = 1; i <= 7; i++) {
                stepsHtml += `<div id="istep-${id}-${i}" class="inline-step">○ ${STEP_LABELS[i]}</div>`;
            }

            actionsEl.innerHTML = `
                <div>
                    <div class="inline-progress">${stepsHtml}</div>
                    <div id="istatus-${id}" class="inline-status"></div>
                    <div id="idecision-${id}" class="inline-decision">
                        <button onclick="inlineDecisionAnswer(${id}, 'continue')" class="action-btn primary" style="font-size:12px; padding:4px 10px;">
                            <i class="fas fa-forward"></i> Pokračovať
                        </button>
                        <button onclick="inlineDecisionAnswer(${id}, 'stop')" class="action-btn danger" style="font-size:12px; padding:4px 10px;">
                            <i class="fas fa-stop"></i> Zastaviť
                        </button>
                    </div>
                </div>
            `;
            saveUpdateState();
        }

        // Add clearState helper
        function clearUpdateState(id) {
            if (_deviceUpdateState[id]) {
                delete _deviceUpdateState[id];
                saveUpdateState();
            }
            fetchDeviceDetails(id);
        }

        function endInlineUpdate(id, success, message) {
            if (_deviceUpdateState[id]) {
                _deviceUpdateState[id].active = false;
                _deviceUpdateState[id].persistedResult = true;
            }
            const statusEl = document.getElementById(`istatus-${id}`);
            if (statusEl) {
                statusEl.style.color = success ? 'var(--success-color)' : 'var(--danger-color)';
                statusEl.innerHTML = `${message} <button onclick="clearUpdateState(${id})" style="background:none; border:none; color:var(--accent-color); cursor:pointer; font-size:12px; text-decoration:underline; padding:0; margin-left:4px;">Zatvoriť</button>`;
            }
            saveUpdateState();
        }

        function setInlineStep(id, stepNum, state) {
            const el = document.getElementById(`istep-${id}-${stepNum}`);
            if (!el) return;
            el.className = 'inline-step' + (state ? ` ${state}` : '');
            el.textContent = `${STEP_ICONS[state] || '○'} ${STEP_LABELS[stepNum]}`;
            if (state === 'active' && _deviceUpdateState[id]) {
                _deviceUpdateState[id].currentStep = stepNum;
            }
            saveUpdateState();
        }

        function setInlineStatus(id, msg, color) {
            const el = document.getElementById(`istatus-${id}`);
            if (!el) return;
            el.textContent = msg;
            el.style.color = color || '#9ca3af';
            saveUpdateState();
        }

        function inlineCountdown(id, stepNum, seconds) {
            return new Promise(resolve => {
                let remaining = seconds;
                const tick = () => {
                    const el = document.getElementById(`istep-${id}-${stepNum}`);
                    if (el) el.textContent = `⟳ ${STEP_LABELS[stepNum]} (${remaining}s)`;
                    setInlineStatus(id, `Čakám ${remaining}s...`);
                    if (remaining <= 0) { resolve(); return; }
                    remaining--;
                    setTimeout(tick, 1000);
                };
                tick();
            });
        }

        function waitInlineDecision(id) {
            return new Promise(resolve => {
                if (_deviceUpdateState[id]) _deviceUpdateState[id].decideResolve = resolve;
                const decEl = document.getElementById(`idecision-${id}`);
                if (decEl) decEl.style.display = 'flex';
                saveUpdateState();
            });
        }

        function inlineDecisionAnswer(id, answer) {
            const decEl = document.getElementById(`idecision-${id}`);
            if (decEl) decEl.style.display = 'none';
            saveUpdateState();

            const resolve = _deviceUpdateState[id]?.decideResolve;
            if (resolve) {
                _deviceUpdateState[id].decideResolve = null;
                resolve(answer);
            } else {
                // Obnova stateu bez resolve? Pravdepodobne bol refresh stranky.
                // Ulozime zamer, ale updater bol strateny
                setInlineStatus(id, "Zastavené. Úloha bola ukončená pri obnove stránky.", "var(--warning-color)");
                endInlineUpdate(id, false, "Kroky neprešli kvôli obnove spojenia.");
            }
        }

        // Sleep helper
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        // Poll device offline
        async function pollOffline(deviceId, timeoutMs, intervalMs) {
            const start = Date.now();
            while (Date.now() - start < timeoutMs) {
                await sleep(intervalMs);
                try {
                    const r = await fetch(`/api/updater/ping/${deviceId}`);
                    const j = await r.json();
                    if (j.status === 'offline') return true;
                } catch (e) {
                    return true; // fetch error = device likely offline
                }
            }
            return false;
        }

        // Poll device online
        async function pollOnline(deviceId, timeoutMs, intervalMs) {
            const start = Date.now();
            while (Date.now() - start < timeoutMs) {
                await sleep(intervalMs);
                try {
                    const r = await fetch(`/api/updater/ping/${deviceId}`);
                    const j = await r.json();
                    if (j.status === 'online') return true;
                } catch (e) { /* continue */ }
            }
            return false;
        }

        // After final reboot: wait for device to go offline then come back, then refresh row
        async function waitOnlineThenRefresh(id, isLowMem) {
            // Wait for device to go offline (up to 60s)
            await pollOffline(id, 60000, 2000);
            // Then wait for it to come back online
            const onlineTimeout = isLowMem ? 300000 : 180000;
            setInlineStatus(id, 'Čakám kým zariadenie nabootuje...');
            const cameOnline = await pollOnline(id, onlineTimeout, 5000);
            if (cameOnline) {
                setInlineStatus(id, '✅ Zariadenie online. Obnovujem údaje...', 'var(--success-color)');
                await sleep(3000); // Brief settle time for services
                clearUpdateState(id); // This will restore normal buttons
            } else {
                const statusEl = document.getElementById(`istatus-${id}`);
                if (statusEl) {
                    statusEl.style.color = 'var(--warning-color)';
                    statusEl.innerHTML = `⚠️ Zariadenie sa nevrátilo online. <button onclick="clearUpdateState(${id})" style="background:none; border:none; color:var(--accent-color); cursor:pointer; font-size:12px; text-decoration:underline; padding:0; margin-left:4px;">Zatvoriť</button>`;
                }
            }
        }

        // ─── Shared helper: steps 5-6-7 (firmware check + optional reboot) ─────────
        async function _doFirmwareAndReboot(id, isLowMem) {
            // Step 5 – Check firmware versions (fetch fresh data)
            setInlineStep(id, 5, 'active');
            setInlineStatus(id, 'Kontrolujem verzie firmware...');
            let fwUpdateNeeded = true;
            try {
                const freshRes = await fetch(`/api/updater/device/${id}`);
                const freshData = await freshRes.json();
                if (freshData.status === 'success') {
                    deviceDataMap[id] = freshData;
                    const cur = freshData.firmware['current-firmware'];
                    const upg = freshData.firmware['upgrade-firmware'];
                    // cur === 'N/A' means no routerboard (VM/CHR) → skip; cur === upg → already up to date
                    if (cur === 'N/A' || cur === upg) fwUpdateNeeded = false;
                }
            } catch (e) { /* keep fwUpdateNeeded = true */ }

            if (!fwUpdateNeeded) {
                setInlineStep(id, 5, 'done');
                setInlineStep(id, 6, 'done');
                setInlineStep(id, 7, 'done');
                endInlineUpdate(id, true, '✅ Firmware je aktuálny. Aktualizácia dokončená!');
                setTimeout(() => { if (!(_deviceUpdateState[id] && _deviceUpdateState[id].active)) clearUpdateState(id); }, 2000);
                return;
            }

            const fwRes = await fetch(`/api/updater/install-firmware/${id}`, { method: 'POST' });
            const fwData = await fwRes.json();
            if (fwData.status !== 'success') {
                setInlineStep(id, 5, 'error');
                endInlineUpdate(id, false, `❌ Chyba Update Firmware: ${fwData.message}`);
                return;
            }
            setInlineStep(id, 5, 'done');

            // Step 6 – 20s countdown
            setInlineStep(id, 6, 'active');
            await inlineCountdown(id, 6, 20);
            setInlineStep(id, 6, 'done');

            await _doFinalReboot(id, isLowMem);
        }

        async function _doFinalReboot(id, isLowMem) {
            // Step 7 – Final reboot
            setInlineStep(id, 7, 'active');
            setInlineStatus(id, 'Odosielam príkaz na finálny reštart...');
            const rebootRes = await fetch(`/api/updater/reboot/${id}`, { method: 'POST' });
            const rebootData = await rebootRes.json();
            if (rebootData.status !== 'success') {
                setInlineStep(id, 7, 'error');
                endInlineUpdate(id, false, `❌ Chyba Reštart: ${rebootData.message}`);
                return;
            }
            setInlineStep(id, 7, 'done');
            endInlineUpdate(id, true, '✅ Aktualizácia dokončená!');
            await waitOnlineThenRefresh(id, isLowMem);
        }

        // ─── Auto-resume after page navigation / reload ───────────────────────────
        async function resumeUpdateAfterReload(id) {
            const state = _deviceUpdateState[id];
            if (!state || !state.active) return;

            const dev = devicesList.find(d => d.id === id);
            const isLowMem = dev && dev.low_memory;

            const actionsEl = document.getElementById(`actions-${id}`);
            if (actionsEl) actionsEl.style.opacity = '1';

            const step = state.currentStep || 2;

            setInlineStatus(id, '⟳ Obnova procesu po navigácii...', '#9ca3af');

            try {
                if (step <= 4) {
                    // Was waiting for reboot or boot – check current device status
                    let isOnline = false;
                    try {
                        const r = await fetch(`/api/updater/ping/${id}`);
                        const j = await r.json();
                        isOnline = (j.status === 'online');
                    } catch (e) { isOnline = false; }

                    if (!isOnline) {
                        // Device still offline – wait for it to boot
                        setInlineStep(id, 2, 'done');
                        setInlineStep(id, 3, 'active');
                        setInlineStatus(id, 'Čakám kým zariadenie nabootuje...');
                        const onlineTimeout = isLowMem ? 300000 : 180000;
                        const cameOnline = await pollOnline(id, onlineTimeout, 5000);
                        if (!cameOnline) {
                            setInlineStep(id, 3, 'error');
                            endInlineUpdate(id, false, `❌ Zariadenie sa nevrátilo online v časovom limite (${onlineTimeout / 1000}s).`);
                            return;
                        }
                        setInlineStep(id, 3, 'done');

                        // VM/CHR (no routerboard) – skip 120s + firmware steps entirely
                        const _resumeDevData = deviceDataMap[id];
                        if (_resumeDevData && _resumeDevData.firmware && _resumeDevData.firmware['current-firmware'] === 'N/A') {
                            setInlineStep(id, 4, 'done');
                            setInlineStep(id, 5, 'done');
                            setInlineStep(id, 6, 'done');
                            setInlineStep(id, 7, 'done');
                            endInlineUpdate(id, true, '✅ RouterOS aktualizovaný. (VM/CHR – firmware nie je potrebný)');
                            setTimeout(() => clearUpdateState(id), 3000);
                            return;
                        }

                        setInlineStep(id, 4, 'active');
                        await inlineCountdown(id, 4, 120);
                        setInlineStep(id, 4, 'done');
                    } else {
                        // Device already online – skip steps 2-4
                        setInlineStep(id, 2, 'done');
                        setInlineStep(id, 3, 'done');
                        setInlineStep(id, 4, 'done');
                    }
                    await _doFirmwareAndReboot(id, isLowMem);

                } else if (step === 5) {
                    await _doFirmwareAndReboot(id, isLowMem);

                } else if (step === 6) {
                    // Was in 20s countdown after firmware install – skip to reboot
                    setInlineStep(id, 6, 'done');
                    await _doFinalReboot(id, isLowMem);

                } else if (step === 7) {
                    await _doFinalReboot(id, isLowMem);
                }

            } catch (err) {
                endInlineUpdate(id, false, `❌ Chyba pri obnovení procesu: ${err.message}`);
            }
        }

        // ─── Full update sequence (server-side, F5-resilient) ────────────────────
        async function fullUpdateDevice(id) {
            // Pre-check: skip if both OS and Firmware are already up to date
            const data = deviceDataMap[id];
            if (data) {
                const hasOsUpdate = data.os &&
                    data.os['installed-version'] !== 'N/A' &&
                    data.os['installed-version'] !== data.os['latest-version'];
                const hasFwUpdate = data.firmware &&
                    data.firmware['current-firmware'] !== 'N/A' &&
                    data.firmware['current-firmware'] !== data.firmware['upgrade-firmware'];

                if (!hasOsUpdate && !hasFwUpdate) {
                    const osVer = (data.os && data.os['installed-version']) ? data.os['installed-version'] : '–';
                    const fwVer = (data.firmware && data.firmware['current-firmware']) ? data.firmware['current-firmware'] : '–';
                    showToast(
                        `Zariadenie má najnovšie verzie – RouterOS ${osVer}, Firmware ${fwVer}. Aktualizácia nebola spustená.`,
                        'success',
                        5500
                    );
                    return;
                }
            }

            // Show inline progress UI immediately for instant feedback
            if (!(_deviceUpdateState[id] && _deviceUpdateState[id].active)) {
                startInlineUpdate(id);
            }
            setInlineStep(id, 1, 'active');
            setInlineStatus(id, 'Spúšťam aktualizáciu na serveri...');

            try {
                const res = await fetch(`/api/updater/run-update/${id}`, { method: 'POST' });
                const json = await res.json();

                if (res.status === 409) {
                    // Already running – keep showing the UI (SocketIO events will update it)
                    setInlineStatus(id, 'Aktualizácia pre toto zariadenie už prebieha...');
                    return;
                }
                if (json.status !== 'success') {
                    endInlineUpdate(id, false, `❌ Chyba pri spustení aktualizácie: ${json.message}`);
                    return;
                }
                // Backend started – SocketIO events drive the rest of the UI
            } catch (err) {
                endInlineUpdate(id, false, `❌ Chyba pri spustení: ${err.message}`);
            }
        }

        // ─── Bulk update ──────────────────────────────────────────────────────────
        async function bulkUpdateDevices() {
            const ids = getCheckedDeviceIds();
            if (ids.length === 0) return;

            const bulkBtn = document.getElementById('bulkUpdateBtn');
            bulkBtn.disabled = true;

            // Fire all updates – each runs independently server-side, returns quickly
            for (let i = 0; i < ids.length; i++) {
                await fullUpdateDevice(ids[i]);
                if (i < ids.length - 1) await sleep(300);
            }

            // Uncheck all after all requests are fired
            document.querySelectorAll('.device-select-cb').forEach(cb => cb.checked = false);
            document.getElementById('selectAllCb').checked = false;
            document.getElementById('selectAllCb').indeterminate = false;
            bulkBtn.disabled = true;
        }

        // ─── Restore running manual updates after F5 ─────────────────────────────
        async function restoreRunningUpdates() {
            try {
                const res = await fetch('/api/updater/running-updates');
                const data = await res.json();
                if (!data.running || data.running.length === 0) return;

                for (const ru of data.running) {
                    const id = ru.device_id;
                    // Skip if SocketIO already started showing progress for this device
                    if (_deviceUpdateState[id] && _deviceUpdateState[id].active) continue;

                    startInlineUpdate(id);
                    for (const step of (ru.steps_done || [])) {
                        setInlineStep(id, step, 'done');
                    }
                    if (ru.current_step > 0) {
                        setInlineStep(id, ru.current_step, 'active');
                    }
                    if (ru.current_msg) setInlineStatus(id, ru.current_msg);
                }
            } catch (e) {
                // Silently ignore – updates are still running server-side
            }
        }

        // ─── Scheduled Updates ──────────────────────────────────────────────────────

        let _scheduleTargetDeviceId = null;
        let _deviceSchedules = {}; // device_id -> schedule (iba pending/running)

        function formatScheduleTime(isoStr) {
            if (!isoStr) return '–';
            const d = new Date(isoStr);
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        function scheduleStatusLabel(status) {
            const map = {
                pending:   '<span style="color:#a78bfa;">⏳ Čaká</span>',
                running:   '<span style="color:#fbbf24;"><i class="fas fa-spinner fa-spin"></i> Prebieha</span>',
                done:      '<span style="color:var(--success-color);">✅ Hotovo</span>',
                failed:    '<span style="color:var(--danger-color);">❌ Chyba</span>',
                cancelled: '<span style="color:#6b7280;">🚫 Zrušený</span>'
            };
            return map[status] || status;
        }

        // Priamo pridá/aktualizuje badge na riadku zariadenia (nemaže status cell)
        function appendScheduleBadge(deviceId) {
            const schedule = _deviceSchedules[deviceId];
            const statusEl = document.getElementById(`status-${deviceId}`);
            if (!statusEl) return;
            const existing = statusEl.querySelector('.schedule-badge');
            if (existing) existing.remove();
            if (!schedule) return;
            const badge = document.createElement('div');
            badge.className = 'schedule-badge';
            badge.style.cssText = 'margin-top:5px;font-size:11px;color:#a78bfa;display:flex;align-items:center;justify-content:center;gap:4px;';
            if (schedule.status === 'running') {
                // Running: show scheduled time centered, no cancel button (7-step progress in actions cell is sufficient)
                badge.innerHTML = `<i class="fas fa-calendar-clock"></i> <span>Naplánovaný: ${formatScheduleTime(schedule.scheduled_time)}</span>`;
            } else {
                badge.innerHTML = `<i class="fas fa-calendar-clock"></i> <span>Naplánovaný: ${formatScheduleTime(schedule.scheduled_time)}</span>`
                    + ` <button onclick="cancelSchedule(${schedule.id})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:11px;padding:0;margin-left:2px;" title="Zrušiť plán"><i class="fas fa-times-circle"></i></button>`;
            }
            statusEl.appendChild(badge);
        }

        function openScheduleModal(deviceId, deviceName, hasUpdate) {
            if (!hasUpdate) {
                showToast('Zariadenie je na aktuálnej verzii – nie je čo aktualizovať.', 'info');
                return;
            }
            // Zabraniť dvojitému plánovaniu
            const existing = _deviceSchedules[deviceId];
            if (existing && existing.status === 'pending') {
                showToast(`Zariadenie už má naplánovaný update na ${formatScheduleTime(existing.scheduled_time)}. Zrušte ho najprv.`, 'warning');
                return;
            }
            _scheduleTargetDeviceId = deviceId;
            document.getElementById('scheduleDeviceName').textContent = deviceName || ('ID ' + deviceId);
            document.getElementById('scheduleModalError').style.display = 'none';
            const minDt = new Date(Date.now() + 5 * 60000);
            const pad = n => String(n).padStart(2, '0');
            const minStr = `${minDt.getFullYear()}-${pad(minDt.getMonth()+1)}-${pad(minDt.getDate())}T${pad(minDt.getHours())}:${pad(minDt.getMinutes())}`;
            const dtInput = document.getElementById('scheduleDateTime');
            dtInput.min = minStr;
            dtInput.value = '';
            document.getElementById('scheduleModal').style.display = 'flex';
        }

        function closeScheduleModal(e) {
            if (e && e.target !== document.getElementById('scheduleModal')) return;
            document.getElementById('scheduleModal').style.display = 'none';
            _scheduleTargetDeviceId = null;
        }

        async function confirmSchedule() {
            const id = _scheduleTargetDeviceId;
            if (!id) return;
            const val = document.getElementById('scheduleDateTime').value;
            const errEl = document.getElementById('scheduleModalError');
            if (!val) { errEl.textContent = 'Vyberte dátum a čas.'; errEl.style.display = 'block'; return; }
            if (new Date(val) <= new Date()) { errEl.textContent = 'Čas musí byť v budúcnosti.'; errEl.style.display = 'block'; return; }
            errEl.style.display = 'none';
            const btn = document.getElementById('confirmScheduleBtn');
            btn.disabled = true;
            try {
                const res = await fetch(`/api/updater/schedule/${id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({scheduled_time: val})
                });
                const data = await res.json();
                if (data.status === 'success') {
                    document.getElementById('scheduleModal').style.display = 'none';
                    // Close the action dropdown for the device
                    const dd = document.getElementById(`dropdown-${id}`);
                    if (dd) dd.style.display = 'none';
                    _scheduleTargetDeviceId = null;
                    showToast('Update naplánovaný.', 'success');
                    await loadSchedules();
                } else {
                    errEl.textContent = data.message || 'Chyba pri plánovaní.';
                    errEl.style.display = 'block';
                }
            } catch (e) {
                errEl.textContent = 'Chyba spojenia.';
                errEl.style.display = 'block';
            } finally {
                btn.disabled = false;
            }
        }

        async function cancelSchedule(scheduleId) {
            if (!confirm('Zrušiť naplánovaný update?')) return;
            try {
                const res = await fetch(`/api/updater/schedule/${scheduleId}`, {method: 'DELETE'});
                const data = await res.json();
                if (data.status === 'success') {
                    showToast('Plán zrušený.', 'info');
                    await loadSchedules();
                } else {
                    showToast(data.message || 'Chyba pri rušení.', 'warning');
                }
            } catch (e) {
                showToast('Chyba spojenia.', 'warning');
            }
        }

        async function loadSchedules() {
            try {
                const res = await fetch('/api/updater/schedules');
                const schedules = await res.json();

                // Aktualizuj globálnu cache (iba pending – running nemá badge, update prebieha)
                _deviceSchedules = {};
                schedules.filter(s => s.status === 'pending')
                    .forEach(s => { _deviceSchedules[s.device_id] = s; });

                // Obnov badges na všetkých riadkoch
                devicesList.forEach(d => appendScheduleBadge(d.id));

                // Renderuj panel
                const panel = document.getElementById('scheduledUpdatesPanel');
                const container = document.getElementById('scheduledUpdatesTable');
                if (!schedules.length) { panel.style.display = 'none'; return; }
                panel.style.display = 'block';
                let html = `<table style="width:100%;border-collapse:collapse;font-size:13px;">
                    <thead><tr style="color:var(--text-muted);border-bottom:1px solid var(--border-color);">
                        <th style="text-align:left;padding:6px 10px;">Zariadenie</th>
                        <th style="text-align:left;padding:6px 10px;">Naplánovaný čas</th>
                        <th style="text-align:left;padding:6px 10px;">Stav</th>
                        <th style="text-align:left;padding:6px 10px;">Výsledok</th>
                        <th style="padding:6px 10px;"></th>
                    </tr></thead><tbody>`;
                schedules.forEach(s => {
                    html += `<tr style="border-bottom:1px solid var(--border-color);">
                        <td style="padding:8px 10px;font-weight:500;">${s.device_name}<br><span style="color:var(--text-muted);font-size:11px;">${s.device_ip}</span></td>
                        <td style="padding:8px 10px;">${formatScheduleTime(s.scheduled_time)}</td>
                        <td style="padding:8px 10px;">${scheduleStatusLabel(s.status)}</td>
                        <td style="padding:8px 10px;color:var(--text-muted);font-size:12px;max-width:260px;word-break:break-word;">${s.result_message || '–'}</td>
                        <td style="padding:8px 10px;">
                            ${s.status === 'pending' ? `<button onclick="cancelSchedule(${s.id})" class="action-btn danger" style="font-size:12px;padding:4px 10px;"><i class="fas fa-times"></i> Zrušiť</button>` : ''}
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) {}
        }

        // Auto-refresh schedules every 60s
        setInterval(() => loadSchedules(), 60000);
    </script>
</body>

</html>